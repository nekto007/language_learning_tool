{% extends "base.html" %}

{% block title %}{{ deck.name }} | Learning Cards{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/deck_detail.css') }}">
{% endblock %}

{% block content %}
<main>
  <!-- Header -->
  <header class="page-header">
    <div class="container">
      <div class="header-content">
        <div class="header-info">
          <div class="back-link-container">
            <a href="{{ url_for('srs.decks_list') }}" class="back-link">
              <i class="bi bi-arrow-left"></i>
              <span data-i18n="backToDecks">Back to Decks</span>
            </a>
          </div>
          <h1 class="deck-title">{{ deck.name }}</h1>
          {% if deck.description %}
          <p class="deck-description">{{ deck.description }}</p>
          {% endif %}
        </div>
      </div>
            <!-- Moved header actions to a separate row for better alignment -->
      <div class="header-actions-row mt-3">
        <div class="d-flex justify-content-between align-items-center">
          <button type="button" class="btn-primary add-words-btn" data-bs-toggle="modal" data-bs-target="#addWordModal">
            <i class="bi bi-plus-lg"></i>
            <span data-i18n="addWords">Add Words</span>
          </button>

          <div class="dropdown actions-dropdown">
            <button class="btn-secondary dropdown-toggle" type="button" id="actionMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-three-dots-vertical"></i>
              <span class="d-none d-md-inline" data-i18n="actions">Actions</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionMenuButton">
              <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editDeckModal">
                  <i class="bi bi-pencil me-2"></i> <span data-i18n="editDeck">Edit Deck</span>
              </a></li>
              <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#deckSettingsModal">
                  <i class="bi bi-gear me-2"></i> <span data-i18n="deckSettings">Deck Settings</span>
              </a></li>
              {% if deck.name != "Main Deck" %}
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteDeckModal">
                  <i class="bi bi-trash me-2"></i> <span data-i18n="deleteDeck">Delete Deck</span>
              </a></li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container mt-4">
    <!-- Study Progress Section -->
    <section class="deck-study-progress mb-4" aria-labelledby="study-progress-title">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h2 class="card-title h5 mb-3" id="study-progress-title" data-i18n="cardsToStudy">Карточки для изучения</h2>

          <!-- Card Counter Display -->
          <div class="card-counter-container">
            <div class="counter-wrapper">
              <div class="counter counter-new">{{ card_counts.new }}</div>
              <div class="counter-label" data-i18n="new">НОВЫЕ</div>
            </div>
            <span class="counter-separator">+</span>
            <div class="counter-wrapper">
              <div class="counter counter-learning">{{ card_counts.learning }}</div>
              <div class="counter-label" data-i18n="learning">ИЗУЧАЕМЫЕ</div>
            </div>
            <span class="counter-separator">+</span>
            <div class="counter-wrapper">
              <div class="counter counter-review">{{ card_counts.review }}</div>
              <div class="counter-label" data-i18n="review">ПОВТОРЕНИЕ</div>
            </div>
          </div>

          {% if card_counts.new > 0 or card_counts.learning > 0 or card_counts.review > 0 %}
          <!-- Показываем кнопку начать повторение, если есть карточки -->
          <div class="mt-4">
            <a href="{{ url_for('srs.start_review', deck_id=deck.id) }}" class="btn btn-primary start-review-btn">
              <i class="bi bi-play-fill me-2"></i> <span data-i18n="startReview">Начать повторение</span>
            </a>
          </div>
          {% else %}
          <!-- Показываем сообщение, что нечего изучать сегодня -->
          <div class="no-cards-message mt-4">
            <div class="no-cards-icon">
              <i class="bi bi-calendar-check"></i>
            </div>
            <h3 class="no-cards-title" data-i18n="nothingToStudy">Сегодня нечего изучать</h3>
            <p class="no-cards-text" data-i18n="noCardsToday">
              На сегодня нет запланированных карточек для изучения.
            </p>
            <div class="mt-3 text-center">
              <a href="{{ url_for('srs.start_extra_session', deck_id=deck.id) }}" class="btn btn-primary btn-sm">
                <i class="bi bi-play-fill me-1"></i> <span data-i18n="extraSession">Начать допзанятие</span>
              </a>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Cards List Section -->
    <section class="deck-cards mb-4" aria-labelledby="cards-list-title">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0" id="cards-list-title" data-i18n="wordsInDeck">Words in Deck</h2>

          <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addWordModal">
            <i class="bi bi-plus-lg me-1"></i> <span data-i18n="addWords">Add Words</span>
          </button>
        </div>
        <div class="card-body p-0">
          {% if cards %}
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th data-i18n="word">Word</th>
                  <th data-i18n="translation">Translation</th>
                  <th class="text-center" data-i18n="interval">Interval</th>
                  <th class="text-center" data-i18n="repetitions">Repetitions</th>
                  <th class="text-center" data-i18n="nextReview">Next Review</th>
                  <th class="text-center" data-i18n="actions">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for card in cards %}
                {% set word = words.get(card.word_id, {}) %}
                <tr data-card-id="{{ card.id }}" data-word-id="{{ card.word_id }}">
                  <td>
                    <a href="{{ url_for('word_detail', word_id=card.word_id) }}" class="word-link">
                      {{ word.get('english_word', 'Unknown word') }}
                    </a>
                  </td>
                  <td>{{ word.get('russian_word', '') }}</td>
                  <td class="text-center">
                    {% if card.interval == 0 %}
                    <span class="badge bg-info" data-i18n="new">New</span>
                    {% else %}
                    {{ card.interval }} {% if card.interval == 1 %}<span data-i18n="day">day</span>{% else %}<span data-i18n="days">days</span>{% endif %}
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {{ card.repetitions }}
                    {% if card.repetitions >= 7 %}
                    <i class="bi bi-check-circle-fill text-success ms-1" title="{{ translate('mastered') }}"></i>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {% if card.next_review_date %}
                    {% if card.next_review_date <= today %}
                    <span class="badge bg-primary" data-i18n="today">Today</span>
                    {% else %}
                    {{ card.next_review_date.strftime('%d %b %Y') }}
                    {% endif %}
                    {% else %}
                    -
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <div class="dropdown card-actions-dropdown">
                      <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-i18n="actions">
                        Actions
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                        <li><button class="dropdown-item move-card-btn" data-card-id="{{ card.id }}">
                            <i class="bi bi-arrow-left-right me-2"></i> <span data-i18n="moveCard">Move Card</span>
                          </button></li>
                        <li><button class="dropdown-item reset-card-btn" data-card-id="{{ card.id }}">
                            <i class="bi bi-arrow-counterclockwise me-2"></i> <span data-i18n="resetProgress">Reset Progress</span>
                          </button></li>
                        <li>
                          <hr class="dropdown-divider">
                        </li>
                        <li><button class="dropdown-item text-danger remove-card-btn" data-card-id="{{ card.id }}">
                            <i class="bi bi-x-lg me-2"></i> <span data-i18n="removeFromDeck">Remove from Deck</span>
                          </button></li>
                      </ul>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">
              <i class="bi bi-card-text"></i>
            </div>
            <h3 class="empty-state-title" data-i18n="noWordsInDeck">There are no words in this deck yet</h3>
            <p class="empty-state-description" data-i18n="addWordsToBegin">Add words to begin studying with this deck</p>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWordModal">
              <i class="bi bi-plus-lg me-2"></i> <span data-i18n="addWords">Add Words</span>
            </button>
          </div>
          {% endif %}
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Add Word Modal -->
<div class="modal fade" id="addWordModal" tabindex="-1" aria-labelledby="addWordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title h5" id="addWordModalLabel" data-i18n="addWordsToDeck">Add Words to Deck</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p data-i18n="selectWordStatus">Select word status to add:</p>

                <div class="mb-3">
                    <select class="form-select" id="wordStatusSelect">
                        <option value="0" selected data-i18n="newWords">New Words</option>
                        <option value="2" data-i18n="queuedWords">Queued Words</option>
                        <option value="3" data-i18n="activeWords">Active Words</option>
                        <option value="4" data-i18n="learnedWords">Learned Words</option>
                    </select>
                </div>

                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="wordSearchInput" placeholder="Search by word or translation..." data-i18n-placeholder="searchWordPlaceholder">
                    </div>
                </div>

                <div class="table-responsive word-selection-table" style="max-height: 350px; overflow-y: auto;">
                    <table class="table table-hover mb-0">
                        <thead class="sticky-top bg-light">
                            <tr>
                                <th width="40">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAllWords">
                                    </div>
                                </th>
                                <th data-i18n="word">Word</th>
                                <th data-i18n="translation">Translation</th>
                            </tr>
                        </thead>
                        <tbody id="wordsList">
                            <!-- Words will be loaded here via JavaScript -->
                            <tr id="wordsLoadingRow">
                                <td colspan="3" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2" data-i18n="loadingWords">Loading words...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="addSelectedWordsBtn">
                    <i class="bi bi-plus-lg me-1"></i> <span data-i18n="addSelected">Add Selected</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Deck Modal -->
<div class="modal fade" id="editDeckModal" tabindex="-1" aria-labelledby="editDeckModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title h5" id="editDeckModalLabel" data-i18n="editDeck">Edit Deck</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editDeckForm">
                    <div class="mb-3">
                        <label for="deckNameInput" class="form-label" data-i18n="deckName">Deck Name</label>
                        <input type="text" class="form-control" id="deckNameInput" value="{{ deck.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="deckDescriptionInput" class="form-label" data-i18n="description">Description</label>
                        <textarea class="form-control" id="deckDescriptionInput" rows="3" placeholder="Enter deck description" data-i18n-placeholder="enterDeckDescription">{{ deck.description or '' }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDeckBtn">
                    <i class="bi bi-save me-1"></i> <span data-i18n="saveChanges">Save Changes</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Deck Modal -->
<div class="modal fade" id="deleteDeckModal" tabindex="-1" aria-labelledby="deleteDeckModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title h5" id="deleteDeckModalLabel" data-i18n="deleteDeck">Delete Deck</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong data-i18n="warning">Warning:</strong> <span data-i18n="actionCannotBeUndone">This action cannot be undone.</span>
                </div>
                <p><span data-i18n="areYouSureDelete">Are you sure you want to delete the deck</span> <strong>{{ deck.name }}</strong>?</p>
                <p data-i18n="allCardsRemoved">All cards in this deck will be removed.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteDeckBtn">
                    <i class="bi bi-trash me-1"></i> <span data-i18n="delete">Delete</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Move Card Modal -->
<div class="modal fade" id="moveCardModal" tabindex="-1" aria-labelledby="moveCardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title h5" id="moveCardModalLabel" data-i18n="moveCard">Move Card</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p data-i18n="selectTargetDeck">Select the target deck to move this card to:</p>
                <div class="mb-3">
                    <select class="form-select" id="targetDeckSelect">
                        <!-- Decks will be loaded here via JavaScript -->
                        <option value="" disabled selected data-i18n="loadingDecks">Loading decks...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmMoveCardBtn">
                    <i class="bi bi-arrow-left-right me-1"></i> <span data-i18n="moveCard">Move Card</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Deck Settings Modal -->
<div class="modal fade" id="deckSettingsModal" tabindex="-1" aria-labelledby="deckSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title h5" id="deckSettingsModalLabel" data-i18n="deckSettings">Deck Settings</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily-settings" type="button" role="tab" aria-controls="daily-settings" aria-selected="true" data-i18n="dailyLimits">Daily Limits</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="new-cards-tab" data-bs-toggle="tab" data-bs-target="#new-cards-settings" type="button" role="tab" aria-controls="new-cards-settings" aria-selected="false" data-i18n="newCards">New Cards</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="forgotten-tab" data-bs-toggle="tab" data-bs-target="#forgotten-settings" type="button" role="tab" aria-controls="forgotten-settings" aria-selected="false" data-i18n="forgotten">Forgotten</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="order-tab" data-bs-toggle="tab" data-bs-target="#order-settings" type="button" role="tab" aria-controls="order-settings" aria-selected="false" data-i18n="orderDisplay">Order Display</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="timer-tab" data-bs-toggle="tab" data-bs-target="#timer-settings" type="button" role="tab" aria-controls="timer-settings" aria-selected="false" data-i18n="timer">Timer</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="audio-tab" data-bs-toggle="tab" data-bs-target="#audio-settings" type="button" role="tab" aria-controls="audio-settings" aria-selected="false" data-i18n="audio">Audio</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced-settings" type="button" role="tab" aria-controls="advanced-settings" aria-selected="false" data-i18n="additional">Additional</button>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="settingsTabContent">
                    <!-- Daily Limits Tab -->
                    <div class="tab-pane fade show active" id="daily-settings" role="tabpanel" aria-labelledby="daily-tab">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h4 class="h6 mb-3" data-i18n="newCardsPerDay">New cards per day</h4>
                                <div class="btn-group w-100 mb-3" role="group" aria-label="Scope for new cards limit">
                                    <input type="radio" class="btn-check" name="newCardsScope" id="newCardsPreset" value="preset" checked>
                                    <label class="btn btn-outline-secondary" for="newCardsPreset" data-i18n="preset">Preset</label>
                                    <input type="radio" class="btn-check" name="newCardsScope" id="newCardsDeck" value="deck" checked>
                                    <label class="btn btn-outline-primary" for="newCardsDeck" data-i18n="thisDeck">This deck</label>
                                    <input type="radio" class="btn-check" name="newCardsScope" id="newCardsToday" value="today">
                                    <label class="btn btn-outline-secondary" for="newCardsToday" data-i18n="todayOnly">Today only</label>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <input type="range" class="form-range flex-grow-1 me-2" min="0" max="200" step="5" id="newCardsRange" value="10">
                                        <input type="number" class="form-control" style="width: 80px;" id="newCardsValue" min="0" max="200" value="10">
                                        <button class="btn btn-outline-secondary ms-2" id="resetNewCards" title="Reset to default">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </div>
                                </div>

                                <h4 class="h6 mb-3 mt-4" data-i18n="maxReviewsPerDay">Maximum reviews per day</h4>
                                <div class="btn-group w-100 mb-3" role="group" aria-label="Scope for review limit">
                                    <input type="radio" class="btn-check" name="reviewScope" id="reviewPreset" value="preset">
                                    <label class="btn btn-outline-secondary" for="reviewPreset" data-i18n="preset">Preset</label>
                                    <input type="radio" class="btn-check" name="reviewScope" id="reviewDeck" value="deck" checked>
                                    <label class="btn btn-outline-primary" for="reviewDeck" data-i18n="thisDeck">This deck</label>
                                    <input type="radio" class="btn-check" name="reviewScope" id="reviewToday" value="today">
                                    <label class="btn btn-outline-secondary" for="reviewToday" data-i18n="todayOnly">Today only</label>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <input type="range" class="form-range flex-grow-1 me-2" min="0" max="1000" step="25" id="maxReviewsRange" value="100">
                                        <input type="number" class="form-control" style="width: 80px;" id="maxReviewsValue" min="0" max="1000" value="100">
                                        <button class="btn btn-outline-secondary ms-2" id="resetMaxReviews" title="Reset to default">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="form-check mb-3 mt-4">
                                    <input class="form-check-input" type="checkbox" id="reviewLimitAffectsNew">
                                    <label class="form-check-label" for="reviewLimitAffectsNew" data-i18n="reviewLimitNoAffectNew">
                                        Review limit doesn't affect new cards
                                        <i class="bi bi-globe ms-1 text-primary" title="Global setting"></i>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="limitsStartFromTop">
                                    <label class="form-check-label" for="limitsStartFromTop" data-i18n="limitsStartFromTop">
                                        Limits start from top
                                        <i class="bi bi-globe ms-1 text-primary" title="Global setting"></i>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- New Cards Tab -->
                    <div class="tab-pane fade" id="new-cards-settings" role="tabpanel" aria-labelledby="new-cards-tab">
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="learningSteps" class="form-label" data-i18n="learningSteps">Learning steps</label>
                                    <input type="text" class="form-control" id="learningSteps" value="1m 10m">
                                </div>
                                <div class="mb-3">
                                    <label for="graduatingInterval" class="form-label" data-i18n="graduatingInterval">Graduating interval</label>
                                    <input type="number" class="form-control" id="graduatingInterval" min="1" max="30" value="1">
                                </div>
                                <div class="mb-3">
                                    <label for="easyInterval" class="form-label" data-i18n="easyInterval">Easy interval</label>
                                    <input type="number" class="form-control" id="easyInterval" min="1" max="30" value="4">
                                </div>
                                <div class="mb-3">
                                    <label for="insertionOrder" class="form-label" data-i18n="insertionOrder">Insertion order</label>
                                    <select class="form-select" id="insertionOrder">
                                        <option value="sequential" selected data-i18n="sequential">Sequential (oldest first)</option>
                                        <option value="random" data-i18n="random">Random</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Forgotten Tab -->
                    <div class="tab-pane fade" id="forgotten-settings" role="tabpanel" aria-labelledby="forgotten-tab">
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="relearningSteps" class="form-label" data-i18n="relearningSteps">Relearning steps</label>
                                    <input type="text" class="form-control" id="relearningSteps" value="10m">
                                </div>
                                <div class="mb-3">
                                    <label for="minLapseInterval" class="form-label" data-i18n="minimumInterval">Minimum interval</label>
                                    <input type="number" class="form-control" id="minLapseInterval" min="0" max="30" value="1">
                                </div>
                                <div class="mb-3">
                                    <label for="lapseThreshold" class="form-label" data-i18n="lapseThreshold">Lapse threshold</label>
                                    <input type="number" class="form-control" id="lapseThreshold" min="0" max="20" value="8">
                                </div>
                                <div class="mb-3">
                                    <label for="lapseAction" class="form-label" data-i18n="lapseAction">Lapse action</label>
                                    <select class="form-select" id="lapseAction">
                                        <option value="tag" selected data-i18n="tagOnly">Tag only</option>
                                        <option value="suspend" data-i18n="suspend">Suspend</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Settings Tab -->
                    <div class="tab-pane fade" id="order-settings" role="tabpanel" aria-labelledby="order-tab">
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="newCardGathering" class="form-label" data-i18n="newCardGathering">New card gathering</label>
                                    <select class="form-select" id="newCardGathering">
                                        <option value="deck" selected data-i18n="byDeck">By deck</option>
                                        <option value="random" data-i18n="random">Random</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="newCardSort" class="form-label" data-i18n="newCardOrder">New card order</label>
                                    <select class="form-select" id="newCardSort">
                                        <option value="cardType" selected data-i18n="byCardType">By card type</option>
                                        <option value="added" data-i18n="byTimeAdded">By time added</option>
                                        <option value="random" data-i18n="random">Random</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="newReviewMix" class="form-label" data-i18n="newAndReviewOrder">New and review order</label>
                                    <select class="form-select" id="newReviewMix">
                                        <option value="mix" selected data-i18n="interleaveWithReviews">Interleave with reviews</option>
                                        <option value="newFirst" data-i18n="newFirst">New first</option>
                                        <option value="reviewFirst" data-i18n="reviewFirst">Review first</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="interDayOrder" class="form-label" data-i18n="interDayLearningOrder">Inter-day learning order</label>
                                    <select class="form-select" id="interDayOrder">
                                        <option value="mix" selected data-i18n="interleaveWithReviews">Interleave with reviews</option>
                                        <option value="dueFirst" data-i18n="byDue">By due</option>
                                        <option value="random" data-i18n="random">Random</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="reviewOrder" class="form-label" data-i18n="reviewOrder">Review order</label>
                                    <select class="form-select" id="reviewOrder">
                                        <option value="dueRandom" selected data-i18n="dueThenRandom">Due then random</option>
                                        <option value="due" data-i18n="strictlyByDue">Strictly by due</option>
                                        <option value="random" data-i18n="random">Random</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h4 class="h6 mb-3" data-i18n="burying">Burying</h4>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="buryNewRelated">
                                    <label class="form-check-label" for="buryNewRelated" data-i18n="buryNewRelated">
                                        Bury new related until next day
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="buryReviewsRelated">
                                    <label class="form-check-label" for="buryReviewsRelated" data-i18n="buryReviewsRelated">
                                        Bury reviews related until next day
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="buryInterday">
                                    <label class="form-check-label" for="buryInterday" data-i18n="buryInterday">
                                        Bury interday learning related cards
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timer Settings Tab -->
                    <div class="tab-pane fade" id="timer-settings" role="tabpanel" aria-labelledby="timer-tab">
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="maxAnswerTime" class="form-label" data-i18n="maxAnswerTime">Maximum seconds for answer</label>
                                    <input type="number" class="form-control" id="maxAnswerTime" min="0" max="300" value="60">
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="showAnswerTimer">
                                    <label class="form-check-label" for="showAnswerTimer" data-i18n="showAnswerTimer">
                                        Show answer timer
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="stopTimerOnAnswer">
                                    <label class="form-check-label" for="stopTimerOnAnswer" data-i18n="stopTimerOnAnswer">
                                        Stop timer on answer
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h4 class="h6 mb-3" data-i18n="autoPreview">Auto Preview</h4>
                                <div class="mb-3">
                                    <label for="secondsShowQuestion" class="form-label" data-i18n="secondsShowQuestion">Seconds to show question for</label>
                                    <input type="number" class="form-control" id="secondsShowQuestion" min="0" max="60" step="0.1" value="0.0">
                                </div>
                                <div class="mb-3">
                                    <label for="secondsShowAnswer" class="form-label" data-i18n="secondsShowAnswer">Seconds to show answer for</label>
                                    <input type="number" class="form-control" id="secondsShowAnswer" min="0" max="60" step="0.1" value="0.0">
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="waitForAudio">
                                    <label class="form-check-label" for="waitForAudio" data-i18n="waitForAudio">
                                        Wait for audio
                                    </label>
                                </div>
                                <div class="mb-3">
                                    <label for="answerAction" class="form-label" data-i18n="answerAction">Answer action</label>
                                    <select class="form-select" id="answerAction">
                                        <option value="bury" selected data-i18n="buryCard">Bury card</option>
                                        <option value="again" data-i18n="again">Again</option>
                                        <option value="good" data-i18n="good">Good</option>
                                        <option value="easy" data-i18n="easy">Easy</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Settings Tab -->
                    <div class="tab-pane fade" id="audio-settings" role="tabpanel" aria-labelledby="audio-tab">
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="disableAutoPlay">
                                    <label class="form-check-label" for="disableAutoPlay" data-i18n="disableAutoPlay">
                                        Disable auto-play
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="skipQuestionAudio">
                                    <label class="form-check-label" for="skipQuestionAudio" data-i18n="skipQuestionAudio">
                                        Skip question on replay answer
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Settings Tab -->
                    <div class="tab-pane fade" id="advanced-settings" role="tabpanel" aria-labelledby="advanced-tab">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="fsrsEnabled" checked>
                            <label class="form-check-label" for="fsrsEnabled" data-i18n="fsrs">
                                FSRS
                                <i class="bi bi-globe ms-1 text-primary" title="Global setting"></i>
                            </label>
                        </div>
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="maxInterval" class="form-label" data-i18n="maxInterval">Maximum interval</label>
                                    <input type="number" class="form-control" id="maxInterval" min="0" max="99999" value="36500">
                                </div>
                                <div class="mb-3">
                                    <label for="startingEase" class="form-label" data-i18n="startingEase">Starting ease</label>
                                    <input type="number" class="form-control" id="startingEase" min="1.0" max="5.0" step="0.05" value="2.50">
                                </div>
                                <div class="mb-3">
                                    <label for="easyBonus" class="form-label" data-i18n="easyBonus">Easy bonus</label>
                                    <input type="number" class="form-control" id="easyBonus" min="1.0" max="2.0" step="0.05" value="1.30">
                                </div>
                                <div class="mb-3">
                                    <label for="intervalModifier" class="form-label" data-i18n="intervalModifier">Interval modifier</label>
                                    <input type="number" class="form-control" id="intervalModifier" min="0.5" max="2.0" step="0.05" value="1.00">
                                </div>
                                <div class="mb-3">
                                    <label for="hardInterval" class="form-label" data-i18n="hardInterval">Hard interval</label>
                                    <input type="number" class="form-control" id="hardInterval" min="0.5" max="1.5" step="0.05" value="1.20">
                                </div>
                                <div class="mb-3">
                                    <label for="newInterval" class="form-label" data-i18n="newInterval">New interval</label>
                                    <input type="number" class="form-control" id="newInterval" min="0.0" max="1.0" step="0.05" value="0.00">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary" id="specialSchedulingBtn">
                                <i class="bi bi-play-fill me-1"></i> <span data-i18n="specialScheduling">Special scheduling</span>
                                <i class="bi bi-globe ms-1 text-primary" title="Global setting"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDeckSettingsBtn">
                    <i class="bi bi-save me-1"></i> <span data-i18n="saveChanges">Save Changes</span>
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script type="module">
  import { LanguageManager } from "{{ url_for('static', filename='js/language-manager.js') }}";

  document.addEventListener('DOMContentLoaded', function() {
    // Initialize language manager
    const languageManager = new LanguageManager();

    // Make the language manager available globally if needed
    window.languageManager = languageManager;

    // Скрываем стандартное flash сообщение при наличии параметра no_cards_today
    if (window.location.search.includes('no_cards_today=true')) {
      // Если был редирект и есть flash-сообщение
      const flashMessages = document.querySelectorAll('.alert-info');
      for (let i = 0; i < flashMessages.length; i++) {
        if (flashMessages[i].textContent.includes('No cards due for review today')) {
          // Скрываем стандартное сообщение
          flashMessages[i].style.display = 'none';
        }
      }
    }
  });
</script>
<script type="module" src="{{ url_for('static', filename='js/custom-ui.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/deck_detail.js') }}"></script>
<script>
  // Pass essential data to JavaScript
  window.appData = {
    deckId: {{ deck.id }},
    // Add words data directly to the window.appData object
    words: {{ words|tojson }},
    apiUrls: {
      addCard: "{{ url_for('srs.api_add_card', deck_id=deck.id) }}",
      updateDeck: "{{ url_for('srs.api_update_deck', deck_id=deck.id) }}",
      deleteDeck: "{{ url_for('srs.api_delete_deck', deck_id=deck.id) }}",
      getDecks: "{{ url_for('srs.api_get_decks') }}",
      deleteCard: "{{ url_for('srs.api_delete_card', card_id=0) }}",
      reviewCard: "{{ url_for('srs.api_review_card', card_id=0) }}",
      moveCard: "{{ url_for('srs.api_move_card', card_id=0) }}",
      wordsList: "{{ url_for('words_list') }}"
    },
    urls: {
      decksList: "{{ url_for('srs.decks_list') }}"
    }
  };

  // Function to help translate text - useful in templates
  window.translate = function(key) {
    return window.languageManager ? window.languageManager.translate(key) : key;
  };
</script>
{% endblock %}
{% endblock %}