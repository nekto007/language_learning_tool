{% extends 'base.html' %}

{% block title %}–°–ª–æ–≤–∞ - –ò–∑—É—á–µ–Ω–∏–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ{% endblock %}

{% block content %}
<div class="book-list-page">
  <div class="row mb-4">
      <div class="col-md-8">
          <h1>–°–ª–æ–≤–∞</h1>
      </div>
      <div class="col-md-4 text-end">
          <div class="btn-group">
              <a href="#" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#exportModal">–≠–∫—Å–ø–æ—Ä—Ç –≤ Anki</a>
          </div>
      </div>
  </div>
</div>
<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('words.word_list') }}" class="row g-3">
            <!-- Search -->
            <div class="col-md-4">
                {{ search_form.search.label(class="form-label") }}
                {{ search_form.search(class="form-control", placeholder="–ü–æ–∏—Å–∫ —Å–ª–æ–≤...") }}
            </div>

            <!-- Status Filter -->
            <div class="col-md-3">
                {{ filter_form.status.label(class="form-label") }}
                {{ filter_form.status(class="form-select") }}
            </div>

            <!-- Book Filter -->
            <div class="col-md-3">
                {{ filter_form.book_id.label(class="form-label") }}
                {{ filter_form.book_id(class="form-select") }}
            </div>

            <!-- Submit Button -->
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">–ü–æ–∏—Å–∫</button>
            </div>

            <!-- Letter Filter -->
            <div class="col-12">
                <div class="letter-filter d-flex flex-wrap gap-1 mt-2">
                    <a href="{{ url_for('words.word_list') }}" class="btn btn-sm {{ 'btn-primary' if not filter_form.letter.data else 'btn-outline-secondary' }}">–í—Å–µ</a>
                    {% for letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
                    <a href="{{ url_for('words.word_list', letter=letter) }}" class="btn btn-sm {{ 'btn-primary' if filter_form.letter.data == letter else 'btn-outline-secondary' }}">{{ letter }}</a>
                    {% endfor %}
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Word List -->
<div class="card">
    <div class="card-body">
        {% if words %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th width="40">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                            </div>
                        </th>
                        <th>
                            <a href="{{ url_for('words.word_list', **url_params(sort='english_word', order='desc' if sort_field == 'english_word' and sort_order == 'asc' else 'asc')) }}">
                                –ê–ù–ì–õ–ò–ô–°–ö–û–ï
                                {% if sort_field == 'english_word' %}
                                <i class="fas fa-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th width="50" class="text-center">–ê–£–î–ò–û</th>
                        <th>–†–£–°–°–ö–û–ï</th>
                        <th>
                            <a href="{{ url_for('words.word_list', **url_params(sort='level', order='desc' if sort_field == 'level' and sort_order == 'asc' else 'asc')) }}">
                                –£–†–û–í–ï–ù–¨
                                {% if sort_field == 'level' %}
                                <i class="fas fa-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{{ url_for('words.word_list', **url_params(sort='status', order='desc' if sort_field == 'status' and sort_order == 'asc' else 'asc')) }}">
                                –°–¢–ê–¢–£–°
                                {% if sort_field == 'status' %}
                                <i class="fas fa-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>–î–ï–ô–°–¢–í–ò–Ø</th>
                    </tr>
                </thead>
                <tbody>
                    {% for word in words %}
                    <tr>
                        <td>
                            <div class="form-check">
                                <input class="form-check-input word-checkbox" type="checkbox" value="{{ word.id }}">
                            </div>
                        </td>
                        <td>
                            <a href="{{ url_for('words.word_detail', word_id=word.id) }}">{{ word.english_word }}</a>
                        </td>
                        <td class="text-center">
                            {% if word.get_download and word.listening %}
                            <span class="word-pronunciation" data-audio="{{ url_for('static', filename='audio/' + (word.listening|audio_filename)) }}" title="–ü—Ä–æ—Å–ª—É—à–∞—Ç—å –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ">
                                <i class="fas fa-volume-up"></i>
                            </span>
                            {% endif %}
                        </td>
                        <td>{{ word.russian_word }}</td>
                        <td>
                            {% if word.level %}
                            <span class="badge bg-{{ {
                                'A1': 'success',
                                'A2': 'success',
                                'B1': 'info',
                                'B2': 'info',
                                'C1': 'warning',
                                'C2': 'warning'
                            }[word.level] }}">{{ word.level }}</span>
                            {% else %}
                            <span class="badge bg-secondary">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ {
                                0: 'secondary',
                                1: 'success',
                                2: 'info',
                                3: 'primary'
                            }[word_statuses[word.id]] }}">
                                {{ {
                                    0: '–ù–æ–≤–æ–µ',
                                    1: '–ò–∑—É—á–∞—é',
                                    2: '–ü–æ–≤—Ç–æ—Ä—è—é',
                                    3: '–í—ã—É—á–µ–Ω–æ'
                                }[word_statuses[word.id]] }}
                            </span>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="statusDropdown{{ word.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                    –°—Ç–∞—Ç—É—Å
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="statusDropdown{{ word.id }}">
                                    <li>
                                        <form action="{{ url_for('words.update_word_status', word_id=word.id, status=1) }}" method="POST">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="dropdown-item">–î–æ–±–∞–≤–∏—Ç—å –∫ –∏–∑—É—á–µ–Ω–∏—é</button>
                                        </form>
                                    </li>
                                    <li>
                                        <form action="{{ url_for('words.update_word_status', word_id=word.id, status=3) }}" method="POST">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="dropdown-item">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã—É—á–µ–Ω–Ω–æ–µ</button>
                                        </form>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form action="{{ url_for('words.update_word_status', word_id=word.id, status=0) }}" method="POST">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="dropdown-item">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Bulk Actions -->
        <div class="mt-3 mb-3">
            <div class="dropdown d-inline-block">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="bulkActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                </button>
                <ul class="dropdown-menu" aria-labelledby="bulkActionsDropdown">
                    <li><a class="dropdown-item bulk-action" data-status="1" href="#">–î–æ–±–∞–≤–∏—Ç—å –∫ –∏–∑—É—á–µ–Ω–∏—é</a></li>
                    <li><a class="dropdown-item bulk-action" data-status="3" href="#">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã—É—á–µ–Ω–Ω—ã–µ</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item bulk-action" data-status="0" href="#">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å</a></li>
                </ul>
            </div>

            <button class="btn btn-outline-primary ms-2" id="bulkExportBtn">–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
        </div>

        <!-- Pagination -->
        <nav>
            <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('words.word_list', **url_params(page=pagination.prev_num)) }}">–ù–∞–∑–∞–¥</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">–ù–∞–∑–∞–¥</span>
                </li>
                {% endif %}

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                <li class="page-item {{ 'active' if page_num == pagination.page else '' }}">
                    <a class="page-link" href="{{ url_for('words.word_list', **url_params(page=page_num)) }}">{{ page_num }}</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">‚Ä¶</span>
                </li>
                {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('words.word_list', **url_params(page=pagination.next_num)) }}">–í–ø–µ—Ä—ë–¥</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">–í–ø–µ—Ä—ë–¥</span>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% else %}
        <div class="text-center py-5">
            <p class="mb-0">–°–ª–æ–≤ –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">–≠–∫—Å–ø–æ—Ä—Ç –≤ Anki</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label for="deckName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã</label>
                        <input type="text" class="form-control" id="deckName" value="English Words">
                    </div>
                    <div class="mb-3">
                        <label for="cardFormat" class="form-label">–§–æ—Ä–º–∞—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</label>
                        <select class="form-select" id="cardFormat">
                            <option value="basic">–ë–∞–∑–æ–≤—ã–π (–õ–∏—Ü–æ: –ê–Ω–≥–ª–∏–π—Å–∫–∏–π, –û–±–æ—Ä–æ—Ç: –†—É—Å—Å–∫–∏–π)</option>
                            <option value="reversed">–î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π (–û–±–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è)</option>
                            <option value="cloze">–ü—Ä–æ–ø—É—Å–∫ (–∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="includePronunciation" checked>
                        <label class="form-check-label" for="includePronunciation">–í–∫–ª—é—á–∏—Ç—å –∞—É–¥–∏–æ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="includeExamples" checked>
                        <label class="form-check-label" for="includeExamples">–í–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="updateStatus" checked>
                        <label class="form-check-label" for="updateStatus">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–ê–∫—Ç–∏–≤–Ω—ã–π" –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤</label>
                    </div>
                    <div id="exportWordsCount" class="alert alert-info">
                        –°–ª–æ–≤–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="exportSubmitBtn" disabled>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- Audio Element (Hidden) -->
<audio id="wordAudio" style="display: none;" preload="auto"></audio>

<!-- Inline Script for Audio Playback -->
<script>
    // Setup audio element event listeners for debugging
    (function() {
        const audio = document.getElementById('wordAudio');

        audio.addEventListener('loadstart', () => console.log('üéµ Audio: loadstart'));
        audio.addEventListener('loadeddata', () => console.log('üéµ Audio: loadeddata'));
        audio.addEventListener('canplay', () => console.log('üéµ Audio: canplay'));
        audio.addEventListener('playing', () => console.log('üéµ Audio: playing'));
        audio.addEventListener('pause', () => console.log('üéµ Audio: pause'));
        audio.addEventListener('ended', () => console.log('üéµ Audio: ended'));
        audio.addEventListener('error', (e) => console.error('üéµ Audio error:', e, audio.error));
    })();

    // Global function to play audio - must be defined before buttons are rendered
    window.playAudio = function(audioUrl) {
        console.log('üîä playAudio called with URL:', audioUrl);

        const wordAudio = document.getElementById('wordAudio');

        if (!wordAudio) {
            console.error('‚ùå Audio element not found');
            alert('Audio element not found');
            return;
        }

        if (!audioUrl) {
            console.error('‚ùå No audio URL provided');
            alert('No audio URL provided');
            return;
        }

        console.log('üîä Setting audio source to:', audioUrl);
        wordAudio.src = audioUrl;
        wordAudio.load(); // Explicitly load the audio

        console.log('üîä Calling play()...');
        const playPromise = wordAudio.play();

        if (playPromise !== undefined) {
            playPromise.then(() => {
                console.log('‚úÖ Audio playback started successfully');
            }).catch(error => {
                console.error('‚ùå Error playing audio:', error.name, error.message);
                alert('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ' + error.message + '\n–¢–∏–ø –æ—à–∏–±–∫–∏: ' + error.name);
            });
        }
    };

    console.log('‚úì playAudio function registered as:', typeof window.playAudio);
</script>

<!-- Bulk Action Form (hidden) -->
<form id="bulkActionForm" method="POST" action="/api/batch-update-status" style="display: none;">
    <input type="hidden" name="status" id="bulkActionStatus">
    <input type="hidden" name="word_ids" id="bulkActionWordIds">
</form>
{% endblock %}

{% block scripts %}
<script>
    // –ü–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è JavaScript
    const translations = {
        selectWord: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–ª–æ–≤–æ.",
        errorOccurred: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.",
        selectWordExport: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–ª–æ–≤–æ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.",
        wordsSelected: "—Å–ª–æ–≤ –≤—ã–±—Ä–∞–Ω–æ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.",
        enterDeckName: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–¥—ã.",
        error: "–û—à–∏–±–∫–∞:"
    };

    // Global function to play audio (called from onclick)
    function playAudio(audioUrl) {
        console.log('playAudio called with URL:', audioUrl);

        try {
            const wordAudio = document.getElementById('wordAudio');
            console.log('Audio element:', wordAudio);

            if (!wordAudio) {
                console.error('Audio element not found');
                alert('Audio element not found');
                return;
            }

            if (!audioUrl) {
                console.error('No audio URL provided');
                alert('No audio URL provided');
                return;
            }

            console.log('Setting audio source to:', audioUrl);
            wordAudio.src = audioUrl;

            console.log('Calling play()...');
            const playPromise = wordAudio.play();

            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('‚úì Audio playback started successfully');
                }).catch(error => {
                    console.error('‚úó Error playing audio:', error);
                    alert('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ' + error.message);
                });
            }
        } catch (error) {
            console.error('Exception in playAudio:', error);
            alert('Exception: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Word pronunciation functionality
        const wordAudio = document.getElementById('wordAudio');
        const pronunciationButtons = document.querySelectorAll('.word-pronunciation');

        pronunciationButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Get the audio source from the data attribute
                const audioSrc = this.getAttribute('data-audio');

                if (!audioSrc) {
                    console.error('No audio source found for this word');
                    return;
                }

                console.log('Playing audio:', audioSrc);

                // Set the audio source and play
                wordAudio.src = audioSrc;

                // Play with error handling
                const playPromise = wordAudio.play();

                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('Audio playback started successfully');
                        // Visual feedback - add a class to show it's playing
                        this.classList.add('playing');
                    }).catch(error => {
                        console.error('Error playing audio:', error);
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞—É–¥–∏–æ. –§–∞–π–ª: ' + audioSrc);
                    });
                }

                // Remove the class when audio ends
                wordAudio.onended = () => {
                    this.classList.remove('playing');
                };
            });
        });

        // Select all checkbox functionality
        const selectAllCheckbox = document.getElementById('selectAll');
        const wordCheckboxes = document.querySelectorAll('.word-checkbox');

        selectAllCheckbox.addEventListener('change', function() {
            wordCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateExportButton();
        });

        wordCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectAllCheckbox();
                updateExportButton();
            });
        });

        function updateSelectAllCheckbox() {
            const checkedCount = document.querySelectorAll('.word-checkbox:checked').length;
            selectAllCheckbox.checked = checkedCount === wordCheckboxes.length && wordCheckboxes.length > 0;
        }

        // Bulk actions
        const bulkActions = document.querySelectorAll('.bulk-action');
        bulkActions.forEach(action => {
            action.addEventListener('click', function(e) {
                e.preventDefault();

                const status = this.dataset.status;
                const selectedWordIds = getSelectedWordIds();

                if (selectedWordIds.length === 0) {
                    alert(translations.selectWord);
                    return;
                }

                // Submit via AJAX
                fetch('/api/batch-update-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        word_ids: selectedWordIds,
                        status: parseInt(status)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to show updated statuses
                        window.location.reload();
                    } else {
                        alert(translations.error + ' ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(translations.errorOccurred);
                });
            });
        });

        // Export functionality
        const bulkExportBtn = document.getElementById('bulkExportBtn');
        const exportSubmitBtn = document.getElementById('exportSubmitBtn');
        const exportWordsCount = document.getElementById('exportWordsCount');

        bulkExportBtn.addEventListener('click', function() {
            const selectedWordIds = getSelectedWordIds();

            if (selectedWordIds.length === 0) {
                alert(translations.selectWordExport);
                return;
            }

            // Show the number of selected words in the modal
            exportWordsCount.textContent = `${selectedWordIds.length} ${translations.wordsSelected}`;
            exportSubmitBtn.disabled = false;

            // Show the export modal
            const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
            exportModal.show();
        });

        exportSubmitBtn.addEventListener('click', function() {
            const selectedWordIds = getSelectedWordIds();
            const deckName = document.getElementById('deckName').value;
            const cardFormat = document.getElementById('cardFormat').value;
            const includePronunciation = document.getElementById('includePronunciation').checked;
            const includeExamples = document.getElementById('includeExamples').checked;
            const updateStatus = document.getElementById('updateStatus').checked;

            if (!deckName) {
                alert(translations.enterDeckName);
                return;
            }

            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/api/export-anki';
            form.style.display = 'none';

            // Add parameters as hidden fields
            const params = {
                deckName: deckName,
                cardFormat: cardFormat,
                includePronunciation: includePronunciation,
                includeExamples: includeExamples,
                updateStatus: updateStatus,
                wordIds: selectedWordIds
            };

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'exportData';
            input.value = JSON.stringify(params);
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();
        });

        function getSelectedWordIds() {
            const checkboxes = document.querySelectorAll('.word-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => parseInt(checkbox.value));
        }

        function updateExportButton() {
            const selectedCount = document.querySelectorAll('.word-checkbox:checked').length;
            if (selectedCount > 0) {
                bulkExportBtn.disabled = false;
            } else {
                bulkExportBtn.disabled = true;
            }
        }

        // Initialize state
        updateExportButton();
    });
</script>
{% endblock %}