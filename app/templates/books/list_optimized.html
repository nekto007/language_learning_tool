{% extends 'base.html' %}

{% block title %}{{ _('–ö–Ω–∏–≥–∏ - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ') }}{% endblock %}

{% block content %}
<!-- Modern Header with Search -->
<div class="page-header-primary">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="mb-2">üìö {{ _('–ö–æ–ª–ª–µ–∫—Ü–∏—è –∫–Ω–∏–≥') }}</h1>
            <p class="mb-0 opacity-75">{{ _('–û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –∫–Ω–∏–≥–∏ –∏ —É–ª—É—á—à–∞–π—Ç–µ —Å–≤–æ–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å') }}</p>
        </div>
        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="col-md-4 text-end">
            <a href="{{ url_for('books.add_book_redirect') }}" class="btn btn-light">
                <i class="fas fa-plus"></i> {{ _('–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É') }}
            </a>
        </div>
        {% endif %}
    </div>
    
    <!-- Quick Search -->
    <div class="row mt-3">
        <div class="col-12">
            <form method="GET" action="{{ url_for('books.book_list') }}">
                <div class="input-group">
                    <input type="text" name="search" class="form-control form-control-lg" 
                           placeholder="{{ _('–ü–æ–∏—Å–∫ –∫–Ω–∏–≥ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞–≤—Ç–æ—Ä—É...') }}" 
                           value="{{ request.args.get('search', '') }}">
                    <button class="btn btn-light" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                    {% if request.args.get('search') %}
                    <a href="{{ url_for('books.book_list') }}" class="btn btn-outline-light">
                        <i class="fas fa-times"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quick Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex flex-wrap align-items-center">
            <span class="me-3 fw-bold">{{ _('–ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:') }}</span>
            
            <!-- Level Filters -->
            <a href="{{ url_for('books.book_list', search=request.args.get('search', '')) }}" 
               class="filter-chip {{ 'active' if not request.args.get('level') else '' }}">
                {{ _('–í—Å–µ —É—Ä–æ–≤–Ω–∏') }}
            </a>
            
            {% for level in ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'] %}
            <a href="{{ url_for('books.book_list', level=level, search=request.args.get('search', '')) }}" 
               class="filter-chip {{ 'active' if request.args.get('level') == level else '' }}">
                {{ level }}
            </a>
            {% endfor %}
            
            <!-- Letter Filter Dropdown -->
            <div class="dropdown ms-3">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    {{ request.args.get('letter', 'A-Z') }}
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('books.book_list', search=request.args.get('search', ''), level=request.args.get('level', '')) }}">{{ _('–í—Å–µ –±—É–∫–≤—ã') }}</a></li>
                    <li><hr class="dropdown-divider"></li>
                    {% for letter in 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' %}
                    <li><a class="dropdown-item" href="{{ url_for('books.book_list', letter=letter, search=request.args.get('search', ''), level=request.args.get('level', '')) }}">{{ letter }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Active Filters -->
{% if request.args.get('search') or request.args.get('level') or request.args.get('letter') %}
<div class="alert alert-info">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <strong>{{ _('–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:') }}</strong>
            {% if request.args.get('search') %}
                <span class="badge bg-primary ms-1">{{ _('–ü–æ–∏—Å–∫:') }} "{{ request.args.get('search') }}"</span>
            {% endif %}
            {% if request.args.get('level') %}
                <span class="badge bg-success ms-1">{{ _('–£—Ä–æ–≤–µ–Ω—å:') }} {{ request.args.get('level') }}</span>
            {% endif %}
            {% if request.args.get('letter') %}
                <span class="badge bg-info ms-1">{{ _('–ë—É–∫–≤–∞:') }} {{ request.args.get('letter') }}</span>
            {% endif %}
        </div>
        <a href="{{ url_for('books.book_list') }}" class="btn btn-sm btn-outline-secondary">
            {{ _('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ') }}
        </a>
    </div>
</div>
{% endif %}

<!-- Books Grid -->
{% if books %}
<div class="row g-4">
    {% for book in books %}
    <div class="col-lg-3 col-md-4 col-sm-6">
        <div class="card h-100">
            <!-- Book Cover -->
            <div class="book-cover">
                {% if book.cover_image %}
                    <img src="{{ url_for('static', filename=book.cover_image) }}" alt="{{ book.title }}">
                {% else %}
                    <i class="fas fa-book book-cover-placeholder"></i>
                {% endif %}
            </div>
            
            <div class="card-body d-flex flex-column">
                <!-- Title and Author -->
                <h6 class="card-title mb-2" title="{{ book.title }}">
                    {{ book.title[:50] }}{% if book.title|length > 50 %}...{% endif %}
                </h6>
                
                {% if book.author %}
                <p class="card-text text-muted small mb-2">{{ book.author }}</p>
                {% endif %}
                
                <!-- Level Badge -->
                {% if book.level %}
                <span class="badge bg-{{ 'primary' if book.level.startswith('A') else 'info' if book.level.startswith('B') else 'warning' }} text-xs mb-2">
                    {{ book.level }}
                </span>
                {% endif %}
                
                <!-- Chapter Info -->
                {% if chapter_counts.get(book.id, 0) > 0 %}
                <div class="small text-muted mb-2">
                    <i class="fas fa-book-open"></i> {{ chapter_counts[book.id] }} {{ _('–≥–ª–∞–≤') }}
                </div>
                {% endif %}
                
                <!-- Quick Stats -->
                {% if current_user.is_authenticated and book_stats[book.id] %}
                {% set stats = book_stats[book.id] %}
                <div class="mb-2">
                    <div class="d-flex justify-content-between small text-muted mb-1">
                        <span>{{ _('–ü—Ä–æ–≥—Ä–µ—Å—Å') }}</span>
                        <span>{{ stats.mastered }}/{{ stats.total }}</span>
                    </div>
                    <div class="progress progress-mini">
                        <div class="progress-bar bg-success" style="width: {{ (stats.mastered / stats.total * 100) if stats.total > 0 else 0 }}%"></div>
                        <div class="progress-bar bg-warning" style="width: {{ (stats.learning / stats.total * 100) if stats.total > 0 else 0 }}%"></div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Actions -->
                <div class="mt-auto">
                    <div class="d-grid">
                        <a href="{{ url_for('books.book_details', book_id=book.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i> {{ _('–ü–æ–¥—Ä–æ–±–Ω–µ–µ') }}
                        </a>
                    </div>
                    
                    {% if current_user.is_authenticated %}
                    <div class="d-grid mt-2">
                        {% set chapter_progress = current_user.chapter_progress | selectattr('chapter.book_id', 'equalto', book.id) | sort(attribute='updated_at', reverse=true) | first %}
                        {% if chapter_progress %}
                            {% set last_chapter_num = chapter_progress.chapter.chap_num if chapter_progress else 1 %}
                            
                            {# Show Continue button for books with progress #}
                            {% if chapter_counts.get(book.id, 0) > 0 %}
                                {% if book.slug %}
                                <a href="{{ url_for('books.read_book_chapters', book_slug=book.slug, chapter_num=last_chapter_num) }}" class="btn btn-success btn-sm">
                                    <i class="fas fa-play"></i> {{ _('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å') }}
                                </a>
                                {% else %}
                                <a href="{{ url_for('books.read_book_chapters', book_id=book.id) }}?chapter={{ last_chapter_num }}" class="btn btn-success btn-sm">
                                    <i class="fas fa-play"></i> {{ _('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å') }}
                                </a>
                                {% endif %}
                            {% else %}
                                <a href="{{ url_for('books.read_book', book_id=book.id) }}" class="btn btn-success btn-sm">
                                    <i class="fas fa-play"></i> {{ _('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å') }}
                                </a>
                            {% endif %}
                        {% else %}
                            {# Show Read button for new books #}
                            {% if chapter_counts.get(book.id, 0) > 0 %}
                                {% if book.slug %}
                                <a href="{{ url_for('books.read_book_chapters', book_slug=book.slug, chapter_num=1) }}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-book-open"></i> {{ _('–ß–∏—Ç–∞—Ç—å') }}
                                </a>
                                {% else %}
                                <a href="{{ url_for('books.read_book_chapters', book_id=book.id) }}?chapter=1" class="btn btn-primary btn-sm">
                                    <i class="fas fa-book-open"></i> {{ _('–ß–∏—Ç–∞—Ç—å') }}
                                </a>
                                {% endif %}
                            {% else %}
                                <a href="{{ url_for('books.read_book', book_id=book.id) }}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-book-open"></i> {{ _('–ß–∏—Ç–∞—Ç—å') }}
                                </a>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<nav aria-label="{{ _('–ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∫–Ω–∏–≥') }}" class="mt-5">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('books.book_list', page=pagination.prev_num, search=request.args.get('search', ''), level=request.args.get('level', ''), letter=request.args.get('letter', '')) }}">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
        {% endif %}
        
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if page_num %}
                {% if page_num != pagination.page %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('books.book_list', page=page_num, search=request.args.get('search', ''), level=request.args.get('level', ''), letter=request.args.get('letter', '')) }}">
                        {{ page_num }}
                    </a>
                </li>
                {% else %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">‚Ä¶</span>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('books.book_list', page=pagination.next_num, search=request.args.get('search', ''), level=request.args.get('level', ''), letter=request.args.get('letter', '')) }}">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="text-center py-5">
    <i class="fas fa-book-open fa-4x text-muted mb-3"></i>
    <h4>{{ _('–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã') }}</h4>
    <p class="text-muted">
        {% if request.args.get('search') or request.args.get('level') or request.args.get('letter') %}
            {{ _('–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∏–ª–∏') }} <a href="{{ url_for('books.book_list') }}">{{ _('–ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫–Ω–∏–≥–∏') }}</a>.
        {% else %}
            {{ _('–ö–Ω–∏–≥–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.') }}
        {% endif %}
    </p>
    
    {% if current_user.is_authenticated and current_user.is_admin %}
    <a href="{{ url_for('books.add_book_redirect') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> {{ _('–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –∫–Ω–∏–≥—É') }}
    </a>
    {% endif %}
</div>
{% endif %}

{% endblock %}