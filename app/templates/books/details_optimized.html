{% extends 'base.html' %}

{% block title %}{{ book.title }} - {{ _('Информация о книге') }}{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="book-hero">
    <div class="container book-hero-content">
        <div class="row align-items-center">
            <div class="col-md-3">
                {% if book.cover_image %}
                <img src="{{ url_for('static', filename=book.cover_image) }}" 
                     alt="{{ book.title }}" 
                     class="book-cover-hero">
                {% else %}
                <div class="book-cover-hero bg-secondary d-flex align-items-center justify-content-center">
                    <i class="fas fa-book fa-3x text-white-50"></i>
                </div>
                {% endif %}
            </div>
            <div class="col-md-9">
                <h1 class="h4 fw-bold mb-1">{{ book.title }}</h1>
                {% if book.author %}
                <p class="mb-1 text-light">{{ _('Автор:') }} {{ book.author }}</p>
                {% endif %}
                
                <div class="book-meta">
                    {% if book.level %}
                    <div class="meta-item">
                        <i class="fas fa-signal me-2"></i>{{ book.level }}
                    </div>
                    {% endif %}
                    <div class="meta-item">
                        <i class="fas fa-font me-2"></i>{{ "{:,}".format(book.words_total or 0) }} {{ _('слов') }}
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-bookmark me-2"></i>{{ "{:,}".format(book.unique_words or 0) }} {{ _('уникальных') }}
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-calendar me-2"></i>{{ book.created_at.strftime('%b %Y') if book.created_at else 'Unknown' }}
                    </div>
                </div>
                
                <div class="action-buttons mt-1">
                    <a href="{{ url_for('books.read_book', book_id=book.id) }}" 
                       class="btn-action btn-primary-gradient">
                        <i class="fas fa-book-reader"></i>
                        {{ _('Начать чтение') }}
                    </a>
                    <a href="{{ url_for('books.book_words', book_id=book.id) }}" 
                       class="btn-action btn-success-gradient">
                        <i class="fas fa-list"></i>
                        {{ _('Посмотреть слова') }}
                    </a>
                    {% if current_user.is_admin %}
                    <!-- Content editing removed - use chapter-based books -->
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Progress Overview -->
    <div class="progress-section">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="h5 mb-2">{{ _('Ваш прогресс') }}</h2>
                <div class="stats-grid">
                    <div class="stat-card new">
                        <div class="stat-icon new">
                            <i class="fas fa-sparkles"></i>
                        </div>
                        <div class="stat-value">{{ word_stats.new }}</div>
                        <div class="stat-label">{{ _('Новые слова') }}</div>
                    </div>
                    
                    <div class="stat-card learning">
                        <div class="stat-icon learning">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="stat-value">{{ word_stats.learning }}</div>
                        <div class="stat-label">{{ _('Изучаются') }}</div>
                    </div>
                    
                    <div class="stat-card review">
                        <div class="stat-icon review">
                            <i class="fas fa-redo"></i>
                        </div>
                        <div class="stat-value">{{ word_stats.review }}</div>
                        <div class="stat-label">{{ _('Повторение') }}</div>
                    </div>
                    
                    <div class="stat-card mastered">
                        <div class="stat-icon mastered">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-value">{{ word_stats.mastered }}</div>
                        <div class="stat-label">{{ _('Изучено') }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <svg class="progress-ring" viewBox="0 0 80 80">
                    <circle cx="40" cy="40" r="30" fill="none" stroke="#e2e8f0" stroke-width="6"/>
                    <circle class="progress-ring-circle" 
                            cx="40" cy="40" r="30" 
                            fill="none" 
                            stroke="url(#gradient)" 
                            stroke-width="6"
                            stroke-dasharray="{{ 2 * 3.14159 * 30 }}"
                            stroke-dashoffset="{{ 2 * 3.14159 * 30 * (1 - progress / 100) }}"/>
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <text x="40" y="40" text-anchor="middle" dy="0.3em" 
                          style="font-size: 1rem; font-weight: bold; fill: #2d3748;">
                        {{ progress }}%
                    </text>
                </svg>
                <p class="mt-1 text-muted" style="font-size: 0.7rem;">{{ _('Прогресс чтения') }}</p>
            </div>
        </div>
    </div>

    <!-- {{ _('Chapters') }} Section -->
    {% if chapters %}
    <div class="book-chapters-section mb-5">
        <h3 class="mb-4">{{ _('Главы') }}</h3>
        <div class="chapters-list">
            {% for chapter in chapters %}
            <div class="chapter-item d-flex justify-content-between align-items-center p-3 mb-2 bg-light rounded">
                <div>
                    <h5 class="mb-1">{{ _('Глава') }} {{ chapter.chap_num }}: {{ chapter.title }}</h5>
                    <small class="text-muted">{{ chapter.words }} {{ _('слов') }}</small>
                </div>
                <a href="{{ url_for('books.read_book_chapters', book_id=book.id, chapter=chapter.chap_num) }}" 
                   class="btn btn-sm btn-primary">
                    <i class="fas fa-book-reader"></i> {{ _('Читать') }}
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- {{ _('Book Preview') }} Section -->
    {% if not chapters %}
    <div class="book-preview-section">
        <h3 class="mb-4">{{ _('Информация') }}</h3>
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            {{ _('Эта книга использует старый формат. Пожалуйста, загрузите книгу в формате FB2 или TXT с главами.') }}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Animate stats on scroll
const observerOptions = {
    threshold: 0.5,
    rootMargin: '0px'
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const statValues = entry.target.querySelectorAll('.stat-value');
            statValues.forEach(stat => {
                const finalValue = parseInt(stat.textContent);
                let currentValue = 0;
                const increment = Math.ceil(finalValue / 20);
                
                const counter = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        currentValue = finalValue;
                        clearInterval(counter);
                    }
                    stat.textContent = currentValue;
                }, 50);
            });
            observer.unobserve(entry.target);
        }
    });
}, observerOptions);

// Observe stats section
const statsSection = document.querySelector('.progress-section');
if (statsSection) {
    observer.observe(statsSection);
}

// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Initialize Bootstrap tabs
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all tabs
    var triggerTabList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tab"]'));
    triggerTabList.forEach(function (triggerEl) {
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            var tab = new bootstrap.Tab(triggerEl);
            tab.show();
        });
    });
});

</script>
{% endblock %}