{% extends "admin/base.html" %}
{% block title %}–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å-–∫–Ω–∏–≥—É{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üìö –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å-–∫–Ω–∏–≥—É</h1>
    <a href="{{ url_for('admin.book_courses') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
    </a>
</div>

{% if not available_books %}
<div class="alert alert-warning">
    <h5><i class="fas fa-exclamation-triangle"></i> –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–∏–≥</h5>
    <p>–í—Å–µ –∫–Ω–∏–≥–∏ —É–∂–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω—ã –≤ –∫—É—Ä—Å—ã –∏–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –Ω–µ—Ç –∫–Ω–∏–≥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—É—Ä—Å–æ–≤.</p>
    <a href="{{ url_for('admin.books') }}" class="btn btn-primary btn-sm">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥–∞–º–∏
    </a>
</div>
{% else %}

<form id="createCourseForm" method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <!-- Book Selection -->
    <div class="create-form-card">
        <h3><i class="fas fa-book"></i> –í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É</h3>
        <p class="text-muted mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∫—É—Ä—Å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞</p>
        
        <input type="hidden" name="book_id" id="selectedBookId" required>
        
        <div class="row">
            {% for book in available_books %}
            <div class="col-md-6">
                <div class="book-selection-card" onclick="selectBook({{ book.id }}, this)">
                    <div class="book-info">
                        <div class="book-meta">
                            <div class="book-title">{{ book.title }}</div>
                            <div class="book-author">
                                <i class="fas fa-user"></i> {{ book.author or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä' }}
                            </div>
                            <div class="book-stats">
                                <span><i class="fas fa-list"></i> {{ book.chapters|length }} –≥–ª–∞–≤</span>
                                {% if book.language %}
                                <span><i class="fas fa-language"></i> {{ book.language }}</span>
                                {% endif %}
                                {% if book.publication_year %}
                                <span><i class="fas fa-calendar"></i> {{ book.publication_year }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Course Settings -->
    <div class="create-form-card">
        <h3><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—É—Ä—Å–∞</h3>
        
        <div class="row">
            <div class="col-md-6">
                <div class="option-group">
                    <label class="form-label" for="courseTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                    <input type="text" class="form-control" id="courseTitle" name="course_title" 
                           placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏">
                    <small class="text-muted">–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</small>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="option-group">
                    <label class="form-label" for="courseLevel">–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</label>
                    <select class="form-control" id="courseLevel" name="level" required>
                        <option value="A1">A1 - –ù–∞—á–∞–ª—å–Ω—ã–π</option>
                        <option value="A2">A2 - –≠–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã–π</option>
                        <option value="B1" selected>B1 - –°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="B2">B2 - –í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ</option>
                        <option value="C1">C1 - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π</option>
                        <option value="C2">C2 - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="option-group">
            <label class="form-label" for="courseDescription">–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
            <textarea class="form-control" id="courseDescription" name="course_description" rows="3"
                      placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"></textarea>
            <small class="text-muted">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</small>
        </div>
        
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="isFeatured" name="is_featured">
            <label class="form-check-label" for="isFeatured">
                ‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∫—É—Ä—Å—ã
            </label>
        </div>
    </div>
    
    <!-- Creation Method -->
    <div class="create-form-card">
        <h3><i class="fas fa-magic"></i> –°–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è</h3>
        <p class="text-muted mb-3">–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</p>
        
        <input type="hidden" name="auto_generate" id="autoGenerate" value="on">
        
        <div class="creation-method selected" onclick="selectMethod('auto', this)">
            <div class="method-title">üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</div>
            <div class="method-description">
                –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫—É—Ä—Å–∞ —Å –º–æ–¥—É–ª—è–º–∏, —É—Ä–æ–∫–∞–º–∏ –∏ –∑–∞–¥–∞–Ω–∏—è–º–∏
            </div>
            <ul class="method-features">
                <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –∫–Ω–∏–≥–∏ –Ω–∞ –º–æ–¥—É–ª–∏</li>
                <li>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–æ–≤–∞—Ä–Ω—ã—Ö —É—Ä–æ–∫–æ–≤</li>
                <li>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ</li>
                <li>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</li>
                <li>–ì–æ—Ç–æ–≤—ã–π –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∫—É—Ä—Å</li>
            </ul>
        </div>
        
        <div class="creation-method" onclick="selectMethod('manual', this)">
            <div class="method-title">‚úã –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</div>
            <div class="method-description">
                –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫—É—Ä—Å–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </div>
            <ul class="method-features">
                <li>–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫—É—Ä—Å–∞</li>
                <li>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª–µ–π</li>
                <li>–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º —É—Ä–æ–∫–æ–≤</li>
                <li>–ì–∏–±–∫–æ—Å—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∑–∞–¥–∞–Ω–∏–π</li>
            </ul>
        </div>
    </div>
    
    <!-- Submit Button -->
    <div class="text-center">
        <button type="submit" class="btn-create" id="submitBtn">
            <i class="fas fa-spinner fa-spin loading-spinner"></i>
            <i class="fas fa-magic"></i> –°–æ–∑–¥–∞—Ç—å –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å
        </button>
    </div>
</form>

{% endif %}

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–°–æ–∑–¥–∞–Ω–∏–µ –∫—É—Ä—Å–∞</h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <h6 id="progressTitle">–°–æ–∑–¥–∞–Ω–∏–µ –∫—É—Ä—Å–∞...</h6>
                <p class="text-muted" id="progressDescription">
                    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –°–æ–∑–¥–∞–Ω–∏–µ –∫—É—Ä—Å–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.
                </p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="progressBar"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedBookId = null;
let selectedMethod = 'auto';

function selectBook(bookId, element) {
    // Remove previous selection
    document.querySelectorAll('.book-selection-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selection to clicked card
    element.classList.add('selected');
    
    // Store selection
    selectedBookId = bookId;
    document.getElementById('selectedBookId').value = bookId;
    
    // Update course title placeholder if empty
    const titleInput = document.getElementById('courseTitle');
    if (!titleInput.value.trim()) {
        const bookTitle = element.querySelector('.book-title').textContent;
        titleInput.placeholder = `English Course: ${bookTitle}`;
    }
}

function selectMethod(method, element) {
    // Remove previous selection
    document.querySelectorAll('.creation-method').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selection to clicked card
    element.classList.add('selected');
    
    // Store selection
    selectedMethod = method;
    document.getElementById('autoGenerate').value = method === 'auto' ? 'on' : 'off';
    
    // Update button text
    const submitBtn = document.getElementById('submitBtn');
    const btnIcon = submitBtn.querySelector('i:not(.loading-spinner)');
    const btnTextNode = submitBtn.childNodes[2];
    
    if (method === 'auto') {
        btnIcon.className = 'fas fa-magic';
        btnTextNode.textContent = ' –°–æ–∑–¥–∞—Ç—å –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å';
    } else {
        btnIcon.className = 'fas fa-plus';
        btnTextNode.textContent = ' –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫—É—Ä—Å–∞';
    }
}

// Form submission
document.getElementById('createCourseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!selectedBookId) {
        showAlert('warning', '–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—É—Ä—Å–∞');
        return;
    }
    
    const submitBtn = document.getElementById('submitBtn');
    const loadingSpinner = submitBtn.querySelector('.loading-spinner');
    
    // Disable form
    submitBtn.disabled = true;
    loadingSpinner.style.display = 'inline-block';
    
    // Show progress modal for auto generation
    if (selectedMethod === 'auto') {
        const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
        progressModal.show();
        
        // Simulate progress updates
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            
            document.getElementById('progressBar').style.width = progress + '%';
            
            if (progress > 20) {
                document.getElementById('progressTitle').textContent = '–ê–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∫–Ω–∏–≥–∏...';
            }
            if (progress > 40) {
                document.getElementById('progressTitle').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π...';
            }
            if (progress > 60) {
                document.getElementById('progressTitle').textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ä–æ–∫–æ–≤...';
            }
            if (progress > 80) {
                document.getElementById('progressTitle').textContent = '–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∫—É—Ä—Å–∞...';
            }
        }, 500);
        
        // Clean up interval when request completes
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            return originalFetch.apply(this, args).finally(() => {
                clearInterval(progressInterval);
                window.fetch = originalFetch;
            });
        };
    }
    
    // Submit form
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            
            // Complete progress bar
            if (selectedMethod === 'auto') {
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressTitle').textContent = '–ö—É—Ä—Å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!';
                
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 2000);
            } else {
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1500);
            }
        } else {
            showAlert('danger', '–û—à–∏–±–∫–∞: ' + data.error);
            
            // Hide progress modal
            const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
            if (progressModal) {
                progressModal.hide();
            }
            
            // Re-enable form
            submitBtn.disabled = false;
            loadingSpinner.style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫—É—Ä—Å–∞');
        
        // Hide progress modal
        const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
        if (progressModal) {
            progressModal.hide();
        }
        
        // Re-enable form
        submitBtn.disabled = false;
        loadingSpinner.style.display = 'none';
    });
});

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}