{% extends 'admin/base.html' %}
{% from 'admin/components.html' import page_header, breadcrumb %}

{% block title %}{% if exercise %}Edit{% else %}Create{% endif %} Exercise - Admin{% endblock %}

{% block breadcrumb %}
{{ breadcrumb([
    ('Dashboard', url_for('admin.dashboard')),
    ('Grammar Lab', url_for('grammar_lab_admin.grammar_lab_index')),
    (topic.title, url_for('grammar_lab_admin.edit_topic', topic_id=topic.id)),
    ('Exercise' if exercise else 'New Exercise', '')
]) }}
{% endblock %}

{% block content %}
{{ page_header('Edit Exercise' if exercise else 'Create Exercise', 'For topic: ' + topic.title) }}

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Exercise Details</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Exercise Type <span class="text-danger">*</span></label>
                            <select name="exercise_type" class="form-select" required id="exercise-type">
                                {% set types = ['fill_blank', 'multiple_choice', 'reorder', 'translation', 'error_correction', 'transformation', 'matching', 'true_false'] %}
                                {% for t in types %}
                                <option value="{{ t }}" {% if exercise and exercise.exercise_type == t %}selected{% endif %}>{{ t }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Order</label>
                            <input type="number" name="order" class="form-control" value="{{ exercise.order if exercise else 0 }}" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Difficulty (1-3)</label>
                            <input type="number" name="difficulty" class="form-control" value="{{ exercise.difficulty if exercise else 1 }}" min="1" max="3">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Content (JSON) <span class="text-danger">*</span></label>
                        <textarea name="content" class="form-control font-monospace" rows="15" id="content-json" required>{{ exercise.content | tojson(indent=2) if exercise and exercise.content else '' }}</textarea>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Save Exercise
                        </button>
                        <a href="{{ url_for('grammar_lab_admin.edit_topic', topic_id=topic.id) }}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Type Templates -->
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-file-code me-1"></i> Content Templates</h6>
            </div>
            <div class="card-body small">
                <p>Click a type to insert template:</p>

                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm text-start" onclick="insertTemplate('fill_blank')">
                        fill_blank
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm text-start" onclick="insertTemplate('multiple_choice')">
                        multiple_choice
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm text-start" onclick="insertTemplate('reorder')">
                        reorder
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm text-start" onclick="insertTemplate('translation')">
                        translation
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm text-start" onclick="insertTemplate('error_correction')">
                        error_correction
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm text-start" onclick="insertTemplate('transformation')">
                        transformation
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm text-start" onclick="insertTemplate('true_false')">
                        true_false
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm text-start" onclick="insertTemplate('matching')">
                        matching
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const templates = {
    fill_blank: {
        "question": "She ___ (work) here for 5 years.",
        "correct_answer": "has worked",
        "alternatives": ["has been working"],
        "explanation": "Present Perfect for action that started in the past and continues"
    },
    multiple_choice: {
        "question": "Which sentence is correct?",
        "options": [
            "I have seen him yesterday.",
            "I saw him yesterday.",
            "I have saw him yesterday.",
            "I seen him yesterday."
        ],
        "correct_answer": 1,
        "explanation": "With specific time (yesterday) use Past Simple"
    },
    reorder: {
        "words": ["have", "never", "I", "to", "been", "Paris"],
        "correct_answer": "I have never been to Paris.",
        "explanation": "Adverb 'never' goes between have and V3"
    },
    translation: {
        "sentence": "Я никогда не был в Лондоне.",
        "correct_answer": "I have never been to London.",
        "alternatives": ["I've never been to London."],
        "key_grammar": "Present Perfect + never"
    },
    error_correction: {
        "sentence": "He don't like coffee.",
        "error_word": "don't",
        "correct_answer": "doesn't",
        "full_correct": "He doesn't like coffee.",
        "explanation": "With he/she/it use doesn't"
    },
    transformation: {
        "instruction": "Transform into a question",
        "original": "She has finished her homework.",
        "correct_answer": "Has she finished her homework?",
        "explanation": "In questions, have/has comes before the subject"
    },
    true_false: {
        "statement": "'I have been to Paris' means I visited Paris at some point in my life.",
        "correct_answer": true,
        "explanation": "Present Perfect is used for life experiences"
    },
    matching: {
        "pairs": [
            {"left": "I", "right": "am"},
            {"left": "He/She", "right": "is"},
            {"left": "We/They", "right": "are"}
        ],
        "instruction": "Match pronouns with the correct form of 'to be'"
    }
};

function insertTemplate(type) {
    const textarea = document.getElementById('content-json');
    const typeSelect = document.getElementById('exercise-type');

    if (templates[type]) {
        textarea.value = JSON.stringify(templates[type], null, 2);
        typeSelect.value = type;
    }
}

// Format JSON on blur
document.getElementById('content-json')?.addEventListener('blur', function() {
    try {
        const parsed = JSON.parse(this.value);
        this.value = JSON.stringify(parsed, null, 2);
        this.classList.remove('is-invalid');
    } catch (e) {
        this.classList.add('is-invalid');
    }
});
</script>
{% endblock %}
