<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Панель управления{% endblock %} | LLT English</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 6 (local) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='fonts/fontawesome.min.css') }}">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">

    {% block extra_css %}{% endblock %}
</head>
<body>
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <!-- Header -->
    <header class="admin-header">
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <a href="{{ url_for('admin.dashboard') }}" class="header-brand">
            <img src="{{ url_for('static', filename='media/logo_mini.png') }}" alt="Logo">
            <span>LLT Admin</span>
        </a>

        <!-- Global Search -->
        <div class="admin-search-container">
            <div class="admin-search-input-wrapper">
                <i class="fas fa-search admin-search-icon"></i>
                <input type="text"
                       id="admin-global-search"
                       class="admin-search-input"
                       placeholder="Поиск... (⌘K)"
                       autocomplete="off">
                <kbd class="admin-search-kbd">⌘K</kbd>
            </div>
            <div id="admin-search-results" class="admin-search-results"></div>
        </div>

        <div class="header-actions">
            <a href="{{ url_for('words.dashboard') }}" class="btn btn-sm btn-outline-primary" target="_blank">
                <i class="fas fa-external-link-alt me-1"></i> На сайт
            </a>

            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-user-circle me-1"></i> {{ current_user.username }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                        <i class="fas fa-sign-out-alt me-2"></i> Выход
                    </a></li>
                </ul>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="admin-sidebar" id="sidebar">
        <div class="sidebar-nav">
            <div class="nav-section" data-section="main">
                <div class="nav-section-title" onclick="toggleNavSection('main')">
                    <span>Главное</span>
                    <i class="fas fa-chevron-down nav-section-chevron"></i>
                </div>
                <div class="nav-section-content">
                    <a href="{{ url_for('admin.dashboard') }}" class="nav-link {{ 'active' if request.endpoint == 'admin.dashboard' }}">
                        <i class="fas fa-home"></i>
                        <span>Главная</span>
                    </a>
                    <a href="{{ url_for('user_admin.users') }}" class="nav-link {{ 'active' if request.endpoint == 'admin.users' }}">
                        <i class="fas fa-users"></i>
                        <span>Пользователи</span>
                    </a>
                    <a href="{{ url_for('user_admin.stats') }}" class="nav-link {{ 'active' if request.endpoint == 'admin.stats' }}">
                        <i class="fas fa-chart-bar"></i>
                        <span>Статистика</span>
                    </a>
                </div>
            </div>

            <div class="nav-section" data-section="content">
                <div class="nav-section-title" onclick="toggleNavSection('content')">
                    <span>Контент</span>
                    <i class="fas fa-chevron-down nav-section-chevron"></i>
                </div>
                <div class="nav-section-content">
                <a href="{{ url_for('admin_curriculum.curriculum') }}" class="nav-link {{ 'active' if request.endpoint == 'admin.curriculum' }}">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Учебный план</span>
                </a>
                <a href="{{ url_for('admin_curriculum.level_list') }}"
                   class="nav-link ps-5 {{ 'active' if request.endpoint.startswith('admin.level_list') }}">
                    <i class="fas fa-book-open"></i>
                    <span>Уровни</span>
                </a>
                <!-- Подразделы для Curriculum -->
                <a href="{{ url_for('admin_curriculum.module_list') }}"
                   class="nav-link ps-5 {{ 'active' if request.endpoint.startswith('admin.module_list') }}">
                    <i class="fas fa-book-open"></i>
                    <span>Модули</span>
                </a>
                <a href="{{ url_for('admin_curriculum.lesson_list') }}"
                   class="nav-link ps-5 {{ 'active' if request.endpoint == 'admin.lesson_list' }}">
                    <i class="fas fa-file-alt"></i>
                    <span>Уроки</span>
                </a>
                <a href="{{ url_for('topic_admin.topic_list') }}" class="nav-link {{ 'active' if request.endpoint == 'admin.topic_list' }}">
                    <i class="fas fa-tags"></i>
                    <span>Темы</span>
                </a>
                <a href="{{ url_for('collection_admin.collection_list') }}" class="nav-link {{ 'active' if request.endpoint == 'admin.collection_list' }}">
                    <i class="fas fa-layer-group"></i>
                    <span>Коллекции</span>
                </a>
                <a href="{{ url_for('word_admin.word_management') }}" class="nav-link {{ 'active' if request.endpoint.startswith('admin.word_') }}">
                    <i class="fas fa-spell-check"></i>
                    <span>Слова</span>
                </a>
                <a href="{{ url_for('book_admin.books') }}" class="nav-link {{ 'active' if request.endpoint.startswith('admin.book_') and not request.endpoint.startswith('admin.book_courses') }}">
                    <i class="fas fa-book"></i>
                    <span>Книги</span>
                </a>
                <a href="{{ url_for('admin.book_courses') }}" class="nav-link {{ 'active' if request.endpoint.startswith('admin.book_courses') }}">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Книжные курсы</span>
                </a>
                <a href="{{ url_for('admin.quiz_decks_list') }}" class="nav-link {{ 'active' if request.endpoint.startswith('admin.quiz_deck') }}">
                    <i class="fas fa-layer-group"></i>
                    <span>Quiz-колоды</span>
                </a>
                <a href="{{ url_for('grammar_lab_admin.grammar_lab_index') }}" class="nav-link {{ 'active' if request.endpoint.startswith('grammar_lab_admin.') }}">
                    <i class="fas fa-pencil-ruler"></i>
                    <span>Grammar Lab</span>
                </a>
                </div>
            </div>

            <div class="nav-section" data-section="tools">
                <div class="nav-section-title" onclick="toggleNavSection('tools')">
                    <span>Инструменты</span>
                    <i class="fas fa-chevron-down nav-section-chevron"></i>
                </div>
                <div class="nav-section-content">
                    <a href="{{ url_for('reminders.reminder_dashboard') }}" class="nav-link {{ 'active' if request.endpoint.startswith('reminders.') }}">
                        <i class="fas fa-bell"></i>
                        <span>Напоминания</span>
                    </a>
                    <a href="{{ url_for('admin.modules_list') }}" class="nav-link {{ 'active' if request.endpoint.startswith('admin.modules_') }}">
                        <i class="fas fa-puzzle-piece"></i>
                        <span>JSON-модули</span>
                    </a>
                    <a href="{{ url_for('admin_curriculum.import_curriculum') }}" class="nav-link {{ 'active' if request.endpoint == 'admin.import_curriculum' }}">
                        <i class="fas fa-upload"></i>
                        <span>Импорт программы</span>
                    </a>
                    <a href="{{ url_for('system_admin.system') }}" class="nav-link {{ 'active' if request.endpoint == 'admin.system' }}">
                        <i class="fas fa-cogs"></i>
                        <span>Система</span>
                    </a>
                    <a href="{{ url_for('system_admin.database_management') }}" class="nav-link {{ 'active' if request.endpoint == 'admin.database_management' }}">
                        <i class="fas fa-database"></i>
                        <span>База данных</span>
                    </a>
                    <a href="{{ url_for('audio_admin.audio_management') }}" class="nav-link {{ 'active' if request.endpoint.startswith('admin.audio_') }}">
                        <i class="fas fa-volume-up"></i>
                        <span>Аудио</span>
                    </a>
                    <a href="{{ url_for('curriculum_admin.audio_stats') }}" class="nav-link {{ 'active' if request.endpoint == 'curriculum_admin.audio_stats' }}">
                        <i class="fas fa-chart-pie"></i>
                        <span>Аудио статистика</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Breadcrumb Navigation -->
        {% block breadcrumb %}{% endblock %}

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // Collapsible Nav Sections with localStorage
        function toggleNavSection(sectionId) {
            const section = document.querySelector(`.nav-section[data-section="${sectionId}"]`);
            if (!section) return;

            section.classList.toggle('collapsed');

            // Save state to localStorage
            const collapsedSections = JSON.parse(localStorage.getItem('adminNavCollapsed') || '[]');
            const isCollapsed = section.classList.contains('collapsed');

            if (isCollapsed && !collapsedSections.includes(sectionId)) {
                collapsedSections.push(sectionId);
            } else if (!isCollapsed) {
                const index = collapsedSections.indexOf(sectionId);
                if (index > -1) collapsedSections.splice(index, 1);
            }

            localStorage.setItem('adminNavCollapsed', JSON.stringify(collapsedSections));
        }

        // Restore collapsed state from localStorage
        function restoreNavState() {
            const collapsedSections = JSON.parse(localStorage.getItem('adminNavCollapsed') || '[]');
            collapsedSections.forEach(sectionId => {
                const section = document.querySelector(`.nav-section[data-section="${sectionId}"]`);
                if (section) section.classList.add('collapsed');
            });
        }

        // Global Search
        const adminSearchData = [
            { title: 'Dashboard', url: '{{ url_for("admin.dashboard") }}', icon: 'fa-home', section: 'Main' },
            { title: 'Users', url: '{{ url_for("user_admin.users") }}', icon: 'fa-users', section: 'Main' },
            { title: 'Statistics', url: '{{ url_for("user_admin.stats") }}', icon: 'fa-chart-bar', section: 'Main' },
            { title: 'Curriculum', url: '{{ url_for("admin_curriculum.curriculum") }}', icon: 'fa-graduation-cap', section: 'Content' },
            { title: 'Levels', url: '{{ url_for("admin_curriculum.level_list") }}', icon: 'fa-book-open', section: 'Content' },
            { title: 'Modules', url: '{{ url_for("admin_curriculum.module_list") }}', icon: 'fa-book-open', section: 'Content' },
            { title: 'Lessons', url: '{{ url_for("admin_curriculum.lesson_list") }}', icon: 'fa-file-alt', section: 'Content' },
            { title: 'Topics', url: '{{ url_for("topic_admin.topic_list") }}', icon: 'fa-tags', section: 'Content' },
            { title: 'Collections', url: '{{ url_for("collection_admin.collection_list") }}', icon: 'fa-layer-group', section: 'Content' },
            { title: 'Words', url: '{{ url_for("word_admin.word_management") }}', icon: 'fa-spell-check', section: 'Content' },
            { title: 'Books', url: '{{ url_for("book_admin.books") }}', icon: 'fa-book', section: 'Content' },
            { title: 'Book Courses', url: '{{ url_for("admin.book_courses") }}', icon: 'fa-graduation-cap', section: 'Content' },
            { title: 'Quiz Decks', url: '{{ url_for("admin.quiz_decks_list") }}', icon: 'fa-layer-group', section: 'Content' },
            { title: 'Grammar Lab', url: '{{ url_for("grammar_lab_admin.grammar_lab_index") }}', icon: 'fa-pencil-ruler', section: 'Content' },
            { title: 'Reminders', url: '{{ url_for("reminders.reminder_dashboard") }}', icon: 'fa-bell', section: 'Tools' },
            { title: 'Modules (System)', url: '{{ url_for("admin.modules_list") }}', icon: 'fa-puzzle-piece', section: 'Tools' },
            { title: 'Import Curriculum', url: '{{ url_for("admin_curriculum.import_curriculum") }}', icon: 'fa-upload', section: 'Tools' },
            { title: 'System Info', url: '{{ url_for("system_admin.system") }}', icon: 'fa-cogs', section: 'Tools' },
            { title: 'Database', url: '{{ url_for("system_admin.database_management") }}', icon: 'fa-database', section: 'Tools' },
            { title: 'Audio', url: '{{ url_for("audio_admin.audio_management") }}', icon: 'fa-volume-up', section: 'Tools' }
        ];

        function initGlobalSearch() {
            const searchInput = document.getElementById('admin-global-search');
            const searchResults = document.getElementById('admin-search-results');

            if (!searchInput || !searchResults) return;

            // Keyboard shortcut (Cmd+K / Ctrl+K)
            document.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    searchInput.focus();
                }
                if (e.key === 'Escape') {
                    searchInput.blur();
                    searchResults.classList.remove('show');
                }
            });

            // Search functionality
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();

                if (query.length < 1) {
                    searchResults.classList.remove('show');
                    return;
                }

                const results = adminSearchData.filter(item =>
                    item.title.toLowerCase().includes(query) ||
                    item.section.toLowerCase().includes(query)
                );

                if (results.length > 0) {
                    searchResults.innerHTML = results.map(item => `
                        <a href="${item.url}" class="admin-search-result-item">
                            <i class="fas ${item.icon}"></i>
                            <span>${item.title}</span>
                            <small>${item.section}</small>
                        </a>
                    `).join('');
                    searchResults.classList.add('show');
                } else {
                    searchResults.innerHTML = '<div class="admin-search-no-results">Ничего не найдено</div>';
                    searchResults.classList.add('show');
                }
            });

            // Hide results on blur (with delay for click)
            searchInput.addEventListener('blur', () => {
                setTimeout(() => searchResults.classList.remove('show'), 200);
            });

            // Show results on focus if has value
            searchInput.addEventListener('focus', (e) => {
                if (e.target.value.trim().length > 0) {
                    e.target.dispatchEvent(new Event('input'));
                }
            });
        }

        // Auto-hide alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            // Restore nav state
            restoreNavState();

            // Initialize global search
            initGlobalSearch();

            // Auto-hide alerts
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>