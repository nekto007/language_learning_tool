{% extends "admin/base.html" %}
{% from 'admin/components.html' import page_header, breadcrumb %}

{% block title %}Редактировать: {{ deck.title }}{% endblock %}

{% block breadcrumb %}
{{ breadcrumb([('Dashboard', url_for('admin.dashboard')), ('Quiz Decks', url_for('admin.quiz_decks_list')), (deck.title|truncate(20), url_for('admin.quiz_deck_view', deck_id=deck.id)), ('Edit', '')]) }}
{% endblock %}

{% block content %}
{{ page_header('Редактировать колоду', deck.title) }}

<!-- Deck Settings -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Настройки колоды</h5>
    </div>
    <div class="card-body">
        <form method="post" id="deck-settings-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="title" class="form-label">Название *</label>
                    <input type="text" class="form-control" id="title" name="title"
                           value="{{ deck.title }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="form-check mt-4">
                        <input type="checkbox" class="form-check-input" id="is_public" name="is_public"
                               {% if deck.is_public %}checked{% endif %}>
                        <label class="form-check-label" for="is_public">
                            Публичная колода
                        </label>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Описание</label>
                <textarea class="form-control" id="description" name="description" rows="2">{{ deck.description or '' }}</textarea>
            </div>

            <div id="share-link-container" {% if not (deck.is_public and deck.share_code) %}class="d-none"{% endif %}>
                <div class="alert alert-success">
                    <i class="fas fa-share-alt me-2"></i>
                    <strong>Ссылка для шаринга:</strong>
                    <code id="share-link">{{ url_for('study.quiz_deck_shared', code=deck.share_code, _external=True) if deck.share_code else '' }}</code>
                    <button type="button" class="btn btn-sm btn-outline-success ms-2"
                            onclick="copyShareLink(document.getElementById('share-link').textContent)">
                        <i class="fas fa-copy"></i> Копировать
                    </button>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Сохранить изменения
            </button>
        </form>
    </div>
</div>

<!-- Add Word (placed before word list for better UX) -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Добавить слово</h5>
    </div>
    <div class="card-body">
        <form method="post" action="{{ url_for('admin.quiz_deck_add_word', deck_id=deck.id) }}" id="add-word-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="word_id" id="word-id-input" value="">

            <div class="row">
                <div class="col-md-5">
                    <label for="new-word-english" class="form-label">English *</label>
                    <div class="autocomplete-wrapper position-relative">
                        <input type="text"
                               class="form-control"
                               id="new-word-english"
                               name="custom_english"
                               placeholder="Начните вводить слово..."
                               autocomplete="off"
                               required>
                        <div id="autocomplete-dropdown" class="autocomplete-dropdown"></div>
                    </div>
                    <small class="form-text text-muted">
                        При вводе подтянется перевод из базы (если есть)
                    </small>
                </div>
                <div class="col-md-5">
                    <label for="new-word-russian" class="form-label">Русский *</label>
                    <input type="text"
                           class="form-control"
                           id="new-word-russian"
                           name="custom_russian"
                           placeholder="Перевод"
                           required>
                    <small class="form-text text-muted">
                        Можно изменить перевод для этой колоды
                    </small>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-plus me-2"></i>Добавить
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Words in Deck -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Слова в колоде ({{ words|length }})</h5>
    </div>
    <div class="card-body">
        {% if words %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th class="col-index">#</th>
                        <th>English</th>
                        <th>Русский</th>
                        <th class="col-actions-md">Действия</th>
                    </tr>
                </thead>
                <tbody id="deck-words-list">
                    {% for word in words %}
                    <tr data-word-id="{{ word.id }}" id="word-row-{{ word.id }}">
                        <td>{{ loop.index }}</td>
                        <td class="word-display" id="eng-display-{{ word.id }}">
                            {{ word.english_word }}
                            {% if word.custom_english %}
                            <i class="fas fa-pen text-primary ms-1"
                               title="Переопределен для этой колоды"></i>
                            {% endif %}
                        </td>
                        <td class="word-display" id="rus-display-{{ word.id }}">
                            {{ word.russian_word }}
                            {% if word.custom_russian %}
                            <i class="fas fa-pen text-primary ms-1"
                               title="Переопределен для этой колоды"></i>
                            {% endif %}
                        </td>
                        <td>
                            <!-- Edit form (hidden by default) -->
                            <form method="post"
                                  action="{{ url_for('admin.quiz_deck_update_word', deck_id=deck.id, word_id=word.id) }}"
                                  class="edit-form d-none"
                                  id="edit-form-{{ word.id }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            </form>

                            <!-- View mode buttons -->
                            <div class="view-mode" id="view-mode-{{ word.id }}">
                                <button type="button"
                                        class="btn btn-sm btn-outline-primary"
                                        data-word-id="{{ word.id }}"
                                        data-english="{{ word.english_word }}"
                                        data-russian="{{ word.russian_word }}"
                                        onclick="enableEdit(this)"
                                        title="Редактировать перевод для этой колоды">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        data-word-id="{{ word.id }}"
                                        data-deck-id="{{ deck.id }}"
                                        onclick="deleteWord(this)"
                                        title="Удалить из колоды">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>

                            <!-- Edit mode buttons -->
                            <div class="edit-mode d-none" id="edit-mode-{{ word.id }}">
                                <button type="button"
                                        class="btn btn-sm btn-success"
                                        data-word-id="{{ word.id }}"
                                        onclick="saveEdit(this)">
                                    <i class="fas fa-save"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-sm btn-secondary"
                                        onclick="cancelEdit({{ word.id }})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>
            В колоде пока нет слов. Добавьте первое слово выше.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/quiz-deck-editor.js') }}"></script>
<script>
    // Initialize the quiz deck editor
    document.addEventListener('DOMContentLoaded', function() {
        const editor = new QuizDeckEditor({{ deck.id }}, '{{ csrf_token() }}');

        // Store word ID in hidden input when selected from autocomplete
        const originalSelectWord = editor.selectWord.bind(editor);
        editor.selectWord = function(item) {
            originalSelectWord(item);
            document.getElementById('word-id-input').value = item.dataset.wordId;
        };

        // Clear word ID when typing new word
        document.getElementById('new-word-english').addEventListener('input', function() {
            if (!editor.selectedWordId) {
                document.getElementById('word-id-input').value = '';
            }
        });

        // Prevent all edit forms from submitting normally (we use AJAX)
        document.querySelectorAll('.edit-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submission blocked - use AJAX instead');
                return false;
            });
        });

        // Handle deck settings form submission
        const deckSettingsForm = document.getElementById('deck-settings-form');
        if (deckSettingsForm) {
            deckSettingsForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(this);

                try {
                    const response = await fetch(window.location.href, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json'
                        },
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Update page title if changed
                        const titleInput = document.getElementById('title');
                        document.querySelector('h1').innerHTML = `<i class="fas fa-edit me-2"></i>Редактировать: ${titleInput.value}`;

                        // Show/hide share link based on is_public
                        const isPublicCheckbox = document.getElementById('is_public');
                        const shareLinkContainer = document.getElementById('share-link-container');
                        const shareLink = document.getElementById('share-link');

                        if (isPublicCheckbox.checked && data.share_code) {
                            shareLink.textContent = data.share_link;
                            shareLinkContainer.classList.remove('d-none');
                        } else {
                            shareLinkContainer.classList.add('d-none');
                        }

                        showToast(data.message || 'Колода успешно обновлена', 'success');
                    } else {
                        const data = await response.json().catch(() => ({}));
                        showToast(data.message || 'Ошибка при сохранении', 'danger');
                    }
                } catch (error) {
                    console.error('Error saving deck settings:', error);
                    showToast('Ошибка при сохранении настроек', 'danger');
                }
            });
        }
    });
</script>
{% endblock %}
