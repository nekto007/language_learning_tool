{% extends 'admin/base.html' %}
{% from 'admin/components.html' import page_header, stat_card, status_badge, action_btn, action_group, quick_stats %}

{% block title %}Главная{% endblock %}

{% block content %}
{{ page_header('Панель управления', 'Добро пожаловать! Вот что происходит на вашей платформе.', show_date=true, date_str=now().strftime('%d %B %Y')) }}

<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-sm-6 col-xl-3">
        {{ stat_card('Всего пользователей', total_users, 'fa-users', 'primary') }}
    </div>
    <div class="col-sm-6 col-xl-3">
        {{ stat_card('Активных', active_users, 'fa-user-check', 'success') }}
    </div>
    <div class="col-sm-6 col-xl-3">
        {{ stat_card('Новых (7 дней)', new_users, 'fa-user-plus', 'info') }}
    </div>
    <div class="col-sm-6 col-xl-3">
        {{ stat_card('Недавно активных', active_recently, 'fa-clock', 'warning') }}
    </div>
</div>

<div class="row g-4">
    <!-- User Activity Chart -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2 text-muted"></i>Активность пользователей</h5>
            </div>
            <div class="card-body">
                <canvas id="activityChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- Platform Stats -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2 text-muted"></i>Статистика платформы</h5>
            </div>
            <div class="card-body">
                {{ quick_stats([
                    ('Всего книг', total_books, 'fa-book'),
                    ('Всего слов', "{:,}".format(words_total), 'fa-spell-check'),
                    ('Слов с аудио', "{:,}".format(words_with_audio), 'fa-volume-up'),
                    ('Всего уроков', total_lessons, 'fa-file-alt'),
                    ('Активных уроков', active_lessons, 'fa-check-circle')
                ]) }}

                <hr class="my-3">

                <canvas id="progressChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Users Table -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-users me-2 text-muted"></i>Последние пользователи</h5>
        <a href="{{ url_for('user_admin.users') }}" class="btn btn-sm btn-primary">
            <i class="fas fa-arrow-right me-1"></i>Все
        </a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Имя</th>
                        <th>Email</th>
                        <th>Регистрация</th>
                        <th>Последний вход</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in recent_users[:5] %}
                    <tr>
                        <td><span class="text-muted">#</span>{{ user.id }}</td>
                        <td><strong>{{ user.username }}</strong></td>
                        <td>{{ user.email or '-' }}</td>
                        <td>{{ user.created_at.strftime('%d %b %Y') }}</td>
                        <td>
                            {% if user.last_login %}
                                {{ user.last_login.strftime('%d %b %Y') }}
                            {% else %}
                                <span class="text-muted">Никогда</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ status_badge('Активен' if user.active else 'Неактивен', 'success' if user.active else 'danger') }}
                            {% if user.is_admin %}
                                {{ status_badge('Админ', 'info') }}
                            {% endif %}
                        </td>
                        <td>
                            {% call action_group() %}
                                {{ action_btn(
                                    'Деактивировать' if user.active else 'Активировать',
                                    'fa-ban' if user.active else 'fa-check',
                                    url_for('user_admin.toggle_user_status', user_id=user.id),
                                    'outline-danger' if user.active else 'outline-success',
                                    'sm',
                                    'POST'
                                ) }}
                            {% endcall %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Get CSS variables for chart colors
const styles = getComputedStyle(document.documentElement);
const chartColors = {
    primary: styles.getPropertyValue('--chart-primary').trim(),
    primaryLight: styles.getPropertyValue('--chart-primary-light').trim(),
    success: styles.getPropertyValue('--chart-success').trim(),
    successLight: styles.getPropertyValue('--chart-success-light').trim(),
    danger: styles.getPropertyValue('--chart-danger').trim(),
    info: styles.getPropertyValue('--chart-info').trim()
};

// Activity Chart
const activityCtx = document.getElementById('activityChart').getContext('2d');
new Chart(activityCtx, {
    type: 'line',
    data: {
        labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
        datasets: [{
            label: 'Новые пользователи',
            data: [12, 19, 3, 5, 2, 3, {{ new_users }}],
            borderColor: chartColors.primary,
            backgroundColor: chartColors.primaryLight,
            tension: 0.4
        }, {
            label: 'Активные пользователи',
            data: [30, 45, 28, 40, 35, 48, {{ active_recently }}],
            borderColor: chartColors.success,
            backgroundColor: chartColors.successLight,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Progress Chart (Doughnut)
const progressCtx = document.getElementById('progressChart').getContext('2d');
new Chart(progressCtx, {
    type: 'doughnut',
    data: {
        labels: ['Активные', 'Неактивные', 'Новые'],
        datasets: [{
            data: [{{ active_users }}, {{ total_users - active_users - new_users }}, {{ new_users }}],
            backgroundColor: [chartColors.success, chartColors.danger, chartColors.info],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});
</script>
{% endblock %}