{% extends "base.html" %}

{% block title %}{{ _('Настройки изучения') }}{% endblock %}

{% block styles %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Hero Section -->
    <div class="card bg-primary text-white shadow-lg mb-4 text-center" style="border-radius: var(--radius-lg);">
        <div class="card-body p-4">
            <h1 class="display-6 fw-bold mb-2">{{ _('Настройки изучения') }}</h1>
            <p class="lead mb-0 opacity-90">{{ _('Персонализируйте свой опыт изучения') }}</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">{{ _('Основные настройки') }}</h2>
                    <a href="{{ url_for('study.index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> {{ _('Назад') }}
                    </a>
                </div>
                <form method="POST" action="{{ url_for('study.settings') }}">
                    {{ form.csrf_token }}

                    <h4 class="mb-3">{{ _('Ежедневные лимиты') }}</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">{{ form.new_words_per_day.label }}</label>
                                    {{ form.new_words_per_day(class="form-control") }}
                                    <small class="form-text text-muted">
                                        {{ _('Максимальное количество новых слов в день') }}
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">{{ form.reviews_per_day.label }}</label>
                                    {{ form.reviews_per_day(class="form-control") }}
                                    <small class="form-text text-muted">
                                        {{ _('Максимальное количество повторений в день') }}
                                    </small>
                                </div>
                            </div>
                        </div>

                    <h4 class="mt-4 mb-3">{{ _('Настройки обучения') }}</h4>
                        <div class="form-check mb-3">
                            {{ form.include_translations(class="form-check-input") }}
                            <label class="form-check-label">
                                {{ form.include_translations.label }}
                            </label>
                            <small class="form-text text-muted d-block">
                                {{ _('Показывать переводы слов во время изучения') }}
                            </small>
                        </div>

                        <div class="form-check mb-3">
                            {{ form.include_examples(class="form-check-input") }}
                            <label class="form-check-label">
                                {{ form.include_examples.label }}
                            </label>
                            <small class="form-text text-muted d-block">
                                {{ _('Показывать примеры предложений во время изучения') }}
                            </small>
                        </div>

                        <div class="form-check mb-3">
                            {{ form.include_audio(class="form-check-input") }}
                            <label class="form-check-label">
                                {{ form.include_audio.label }}
                            </label>
                            <small class="form-text text-muted d-block">
                                {{ _('Автоматически воспроизводить произношение слов при показе карточек') }}
                            </small>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">{{ form.show_hint_time.label }}</label>
                            {{ form.show_hint_time(class="form-control") }}
                            <small class="form-text text-muted">
                                {{ _('Время в секундах до появления подсказок (0 для отключения)') }}
                            </small>
                        </div>

                    <div class="mt-4">
                        {{ form.submit(class="btn btn-primary btn-lg") }}
                    </div>
                </form>
                </div>
            </div>

            <!-- Telegram Integration -->
            <div class="card shadow-sm mb-4" id="telegram-section">
                <div class="card-body">
                    <h3 class="mb-3">Telegram-бот</h3>
                    <p class="text-muted mb-3">
                        Бот напоминает о занятиях, присылает сводку дня и защищает стрик.
                    </p>

                    <div>
                        <div id="telegram-loading" class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            Загрузка...
                        </div>

                        <!-- Linked state -->
                        <div id="telegram-linked" class="d-none">
                            <div class="alert alert-success d-flex align-items-center mb-3">
                                <i class="fab fa-telegram fa-lg me-2"></i>
                                <div>
                                    Привязан: <strong id="telegram-username"></strong>
                                    <small class="text-muted d-block" id="telegram-linked-at"></small>
                                </div>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="unlinkTelegram()">
                                Отвязать Telegram
                            </button>
                        </div>

                        <!-- Not linked state -->
                        <div id="telegram-not-linked" class="d-none">
                            <ol class="mb-3">
                                <li>Нажмите кнопку «Получить код привязки» ниже</li>
                                <li>Откройте бота <a href="https://t.me/{{ telegram_bot_username }}" target="_blank">@{{ telegram_bot_username }}</a> в Telegram</li>
                                <li>Отправьте боту команду <code>/link</code> и затем полученный 6-значный код</li>
                            </ol>

                            <p class="text-muted small mb-3">
                                После привязки бот будет присылать утреннее напоминание, вечернюю сводку дня
                                и предупреждение о потере стрика. Всё можно настроить командой <code>/settings</code> в боте.
                            </p>

                            <div id="telegram-code-area" class="d-none mb-3">
                                <div class="alert alert-info">
                                    Ваш код: <strong id="telegram-code" class="fs-4 font-monospace"></strong>
                                    <br>
                                    <small>Действителен <span id="telegram-code-ttl"></span> минут</small>
                                </div>
                            </div>

                            <button class="btn btn-primary" id="btn-generate-code" onclick="generateCode()">
                                <i class="fab fa-telegram me-1"></i> Получить код привязки
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="mb-4">{{ _('О методе интервального повторения') }}</h3>
                <p>
                    {{ _('Это приложение использует улучшенный алгоритм SM-2 (похожий на Anki) для эффективного запоминания словаря. Система корректирует интервалы между повторениями на основе того, насколько хорошо вы знаете каждое слово.') }}
                </p>

                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>{{ _('Кнопка') }}</th>
                                    <th>{{ _('Качество') }}</th>
                                    <th>{{ _('Значение') }}</th>
                                    <th>{{ _('Влияние на следующий повтор') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="badge bg-danger">{{ _('Повторить') }}</span></td>
                                    <td>0-2</td>
                                    <td>{{ _('Неправильный ответ или полная потеря памяти') }}</td>
                                    <td>{{ _('Сброс интервала до 0, снижение коэффициента легкости на 0.20') }}</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-warning text-dark">{{ _('Трудно') }}</span></td>
                                    <td>3</td>
                                    <td>{{ _('Правильно, но с большими трудностями') }}</td>
                                    <td>{{ _('Применяет 20%% штраф к расчету интервала') }}</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-primary">{{ _('Хорошо') }}</span></td>
                                    <td>4</td>
                                    <td>{{ _('Правильно с небольшими колебаниями') }}</td>
                                    <td>{{ _('Стандартное увеличение интервала на основе коэффициента легкости') }}</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-success">{{ _('Легко') }}</span></td>
                                    <td>5</td>
                                    <td>{{ _('Перфектное воспоминание, без колебаний') }}</td>
                                    <td>{{ _('Применяет 30%% бонус к расчету интервала') }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                <h5 class="mt-4">{{ _('Как работает алгоритм') }}</h5>
                <p>
                    {{ _('Для каждой карточки система отслеживает:') }}
                </p>
                <ul>
                    <li>{{ _('Коэффициент легкости (EF) - начинается с 2.5 и корректируется на основе вашей эффективности') }}</li>
                    <li>{{ _('Интервал - количество дней до следующего повторения') }}</li>
                    <li>{{ _('Повторения - количество раз, когда вы успешно повторили карточку') }}</li>
                </ul>

                <p>
                    {{ _('Когда вы впервые изучаете карточку и отвечаете правильно:') }}
                </p>
                <ul>
                    <li>{{ _('1-е правильное повторение: Следующий интервал = 1 день') }}</li>
                    <li>{{ _('2-е правильное повторение: Следующий интервал = 6 дней') }}</li>
                    <li>{{ _('Последующие повторения: Интервал рассчитывается на основе предыдущего интервала, коэффициента легкости и качества вашего ответа') }}</li>
                </ul>

                <p>
                    {{ _('Слово считается "изученным", когда его интервал достигает 30 дней или больше.') }}
                </p>

                    <div class="alert alert-info mt-3">
                        <strong>{{ _('Совет') }}:</strong> {{ _('Будьте честны в оценках для лучших результатов. Постоянное использование "Легко" для слов, которые вы считаете сложными, приведет к забыванию.') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;

function checkTelegramStatus() {
    fetch('/telegram/status')
        .then(r => r.json())
        .then(data => {
            document.getElementById('telegram-loading').classList.add('d-none');
            if (data.linked) {
                document.getElementById('telegram-linked').classList.remove('d-none');
                document.getElementById('telegram-username').textContent = '@' + (data.username || '—');
                if (data.linked_at) {
                    const d = new Date(data.linked_at);
                    document.getElementById('telegram-linked-at').textContent =
                        'Привязан ' + d.toLocaleDateString('ru-RU');
                }
            } else {
                document.getElementById('telegram-not-linked').classList.remove('d-none');
            }
        })
        .catch(() => {
            document.getElementById('telegram-loading').innerHTML =
                '<span class="text-danger">Ошибка загрузки</span>';
        });
}

function generateCode() {
    const btn = document.getElementById('btn-generate-code');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Генерация...';

    fetch('/telegram/generate-code', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('telegram-code').textContent = data.code;
            document.getElementById('telegram-code-ttl').textContent = data.expires_in_minutes;
            document.getElementById('telegram-code-area').classList.remove('d-none');
            btn.textContent = 'Получить новый код';
        } else {
            alert(data.error || 'Ошибка');
        }
        btn.disabled = false;
    })
    .catch(() => {
        alert('Ошибка сети');
        btn.disabled = false;
        btn.innerHTML = '<i class="fab fa-telegram me-1"></i> Получить код привязки';
    });
}

function unlinkTelegram() {
    if (!confirm('Отвязать Telegram? Уведомления перестанут приходить.')) return;

    fetch('/telegram/unlink', {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('telegram-linked').classList.add('d-none');
            document.getElementById('telegram-not-linked').classList.remove('d-none');
        } else {
            alert(data.error || 'Ошибка');
        }
    });
}

document.addEventListener('DOMContentLoaded', checkTelegramStatus);
</script>
{% endblock %}