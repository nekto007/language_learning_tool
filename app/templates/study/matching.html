{% extends "base.html" %}

{% block title %}Подбери пару{% endblock %}

{% block styles %}
{{ super() }}
<style>
@import url('https://fonts.googleapis.com/css2?family=Onest:wght@400;500;600;700&display=swap');

.match-page {
  --match-font: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
  --match-primary: #f59e0b;
  --match-primary-dark: #d97706;
  --match-gradient: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
  --match-surface: #ffffff;
  --match-surface-alt: #f8fafc;
  --match-text: #0f172a;
  --match-text-muted: #64748b;
  --match-border: #e2e8f0;
  --match-radius: 16px;
  --match-radius-sm: 10px;
  font-family: var(--match-font);
  max-width: 900px;
  margin: 0 auto;
  padding: 0 1rem 3rem;
}

/* ── Hero strip ── */
.match-hero {
  background: var(--match-gradient);
  border-radius: 0 0 var(--match-radius) var(--match-radius);
  padding: 1.25rem 1.5rem;
  margin: 0 -1rem 1.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  box-shadow: 0 4px 16px rgba(245, 158, 11, 0.25);
}

.match-hero__left {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.match-hero__back {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.2);
  color: #fff;
  text-decoration: none;
  transition: background 0.2s;
  flex-shrink: 0;
}

.match-hero__back:hover {
  background: rgba(255, 255, 255, 0.35);
  color: #fff;
}

.match-hero__title {
  color: #fff;
  font-size: 1.25rem;
  font-weight: 700;
  margin: 0;
  line-height: 1.2;
}

.match-hero__subtitle {
  color: rgba(255, 255, 255, 0.85);
  font-size: 0.8rem;
  margin: 2px 0 0;
  font-weight: 400;
}

/* ── Progress bar (shell restyle) ── */
.match-progress {
  background: var(--match-surface);
  border: 1px solid var(--match-border);
  border-radius: var(--match-radius);
  padding: 1.25rem 1.5rem;
  margin-bottom: 1.25rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}

.match-progress__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
  gap: 0.75rem;
}

.match-progress__title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--match-text);
  margin: 0;
}

.match-progress__stats {
  display: flex;
  align-items: center;
  gap: 1.25rem;
}

.match-progress__stat {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.85rem;
  color: var(--match-text-muted);
}

.match-progress__stat svg {
  color: var(--match-primary);
  flex-shrink: 0;
}

.match-progress__stat-value {
  font-weight: 700;
  color: var(--match-text);
}

.match-progress__end-btn {
  background: var(--match-surface);
  border: 1px solid var(--match-border);
  border-radius: var(--match-radius-sm);
  padding: 0.4rem 1rem;
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--match-text-muted);
  cursor: pointer;
  transition: all 0.2s;
  font-family: var(--match-font);
}

.match-progress__end-btn:hover {
  background: var(--match-surface-alt);
  border-color: #cbd5e1;
  color: var(--match-text);
}

/* ── Loading spinner ── */
.match-loading {
  text-align: center;
  padding: 3rem 1rem;
}

.match-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--match-border);
  border-top-color: var(--match-primary);
  border-radius: 50%;
  animation: match-spin 0.7s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes match-spin {
  to { transform: rotate(360deg); }
}

.match-loading__text {
  color: var(--match-text-muted);
  font-size: 0.9rem;
}

/* ── Setup screen (shell restyle) ── */
.match-setup__title {
  text-align: center;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--match-text);
  margin-bottom: 0.75rem;
}

.match-setup__desc {
  text-align: center;
  color: var(--match-text-muted);
  font-size: 0.95rem;
  margin-bottom: 2rem;
  max-width: 500px;
  margin-left: auto;
  margin-right: auto;
  line-height: 1.5;
}

.match-setup__start-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: var(--match-gradient);
  color: #fff;
  border: none;
  border-radius: var(--match-radius-sm);
  padding: 0.75rem 2rem;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.2s;
  font-family: var(--match-font);
  box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
}

.match-setup__start-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
}

.match-setup__start-btn:active {
  transform: translateY(0);
}

/* ── Game header restyle ── */
.match-game__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.match-game__title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--match-text);
  margin: 0;
}

.match-game__level {
  display: inline-block;
  background: rgba(245, 158, 11, 0.1);
  color: var(--match-primary-dark);
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.8rem;
  margin-top: 0.25rem;
}

.match-game__timer {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: var(--match-surface-alt);
  padding: 0.4rem 1rem;
  border-radius: 20px;
  border: 1px solid var(--match-border);
}

.match-game__timer svg {
  color: var(--match-primary);
}

.match-game__timer-value {
  font-size: 1.15rem;
  font-weight: 700;
  color: var(--match-text);
  min-width: 50px;
  text-align: center;
}

/* ── Controls ── */
.match-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 2rem;
}

.match-hint-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
  border: 2px solid #fcd34d;
  color: #92400e;
  cursor: pointer;
  border-radius: var(--match-radius-sm);
  padding: 0.5rem 1.25rem;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s;
  font-family: var(--match-font);
}

.match-hint-btn:hover {
  background: linear-gradient(135deg, #fde68a 0%, #fef3c7 100%);
  border-color: #f59e0b;
  transform: translateY(-1px);
}

/* ── Results card ── */
.match-results {
  text-align: center;
  display: none;
}

.match-results__header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  font-size: 1.75rem;
  font-weight: 700;
  color: #16a34a;
  margin-bottom: 1.5rem;
}

.match-results__xp-banner {
  background: var(--match-gradient);
  border-radius: var(--match-radius);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  color: #fff;
  box-shadow: 0 4px 16px rgba(245, 158, 11, 0.25);
}

.match-results__xp-icon {
  font-size: 2.5rem;
  margin-bottom: 0.35rem;
}

.match-results__xp-value {
  font-size: 2rem;
  font-weight: 700;
  color: #fef3c7;
}

.match-results__xp-label {
  font-size: 0.85rem;
  color: rgba(255, 255, 255, 0.85);
  margin-top: 0.35rem;
}

.match-results__score-card {
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  border-radius: var(--match-radius);
  padding: 1.5rem;
  max-width: 340px;
  margin: 0 auto 1.5rem;
}

.match-results__score-title {
  font-size: 1rem;
  color: var(--match-text-muted);
  margin-bottom: 0.5rem;
}

.match-results__score-value {
  font-size: 3rem;
  font-weight: 700;
  color: var(--match-primary-dark);
  margin: 0;
}

.match-results__stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  max-width: 500px;
  margin: 1.5rem auto;
}

.match-results__stat {
  background: var(--match-surface);
  border: 1px solid var(--match-border);
  border-radius: var(--match-radius-sm);
  padding: 1rem;
  text-align: center;
}

.match-results__stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--match-text);
  margin-bottom: 0.25rem;
}

.match-results__stat-label {
  color: var(--match-text-muted);
  font-size: 0.8rem;
}

.match-results__actions {
  display: flex;
  justify-content: center;
  gap: 0.75rem;
  margin-top: 2rem;
  flex-wrap: wrap;
}

.match-results__btn {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.65rem 1.5rem;
  border-radius: var(--match-radius-sm);
  font-size: 0.95rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s;
  font-family: var(--match-font);
  border: none;
}

.match-results__btn--primary {
  background: var(--match-gradient);
  color: #fff;
  box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
}

.match-results__btn--primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
  color: #fff;
}

.match-results__btn--secondary {
  background: var(--match-surface);
  color: var(--match-text-muted);
  border: 1px solid var(--match-border);
}

.match-results__btn--secondary:hover {
  background: var(--match-surface-alt);
  color: var(--match-text);
  border-color: #cbd5e1;
}

/* ── Responsive ── */
@media (max-width: 576px) {
  .match-hero {
    flex-direction: column;
    text-align: center;
    padding: 1rem;
    gap: 0.5rem;
  }

  .match-hero__left {
    flex-direction: column;
    gap: 0.35rem;
  }

  .match-progress__header {
    flex-direction: column;
    align-items: flex-start;
  }

  .match-game__header {
    flex-direction: column;
    gap: 0.75rem;
    text-align: center;
  }

  .match-results__stats {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }

  .match-results__actions {
    flex-direction: column;
    align-items: stretch;
  }

  .match-results__btn {
    justify-content: center;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="match-page" id="matching-game-app">
    <!-- Hero strip -->
    <div class="match-hero">
        <div class="match-hero__left">
            <a href="{{ url_for('study.index') }}" class="match-hero__back" title="Назад">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
            </a>
            <div>
                <h1 class="match-hero__title">Подбери пару</h1>
                <p class="match-hero__subtitle">Соедини слово с переводом</p>
            </div>
        </div>
    </div>

    <!-- Progress and stats bar -->
    <div class="match-progress">
        <div class="match-progress__header">
            <h2 class="match-progress__title">Прогресс игры</h2>
            <div class="match-progress__stats">
                <div class="match-progress__stat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
                    </svg>
                    <span>Пар:</span>
                    <span class="match-progress__stat-value" id="pairs-counter">0/0</span>
                </div>
                <div class="match-progress__stat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/>
                    </svg>
                    <span>Ходов:</span>
                    <span class="match-progress__stat-value" id="moves-counter">0</span>
                </div>
                <button id="end-game-btn" class="match-progress__end-btn">Завершить</button>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>

    <!-- Loading spinner -->
    <div id="loading-spinner" class="match-loading">
        <div class="match-spinner"></div>
        <p class="match-loading__text">Загрузка игры...</p>
    </div>

    <!-- Game setup (shown first) -->
    <div id="game-setup" class="game-container" style="display: none;">
        <h2 class="match-setup__title">Подбери пару - Слова</h2>

        <p class="match-setup__desc">
            Соедините английские слова с их русскими переводами. Чем быстрее вы найдёте все пары, тем выше ваш счёт!
        </p>

        <div class="difficulty-selector">
            <button class="difficulty-btn selected" data-difficulty="easy">Легко</button>
            <button class="difficulty-btn" data-difficulty="medium">Средне</button>
            <button class="difficulty-btn" data-difficulty="hard">Сложно</button>
        </div>

        <div style="text-align: center;">
            <button id="start-game-btn" class="match-setup__start-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                Начать игру
            </button>
        </div>
    </div>

    <!-- Game area -->
    <div id="game-container" class="game-container" style="display: none;">
        <div class="match-game__header">
            <div>
                <h2 class="match-game__title">Подбери пару</h2>
                <div class="match-game__level" id="game-level">Уровень: <span class="level-easy">Легко</span></div>
            </div>
            <div class="match-game__timer">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
                <span class="match-game__timer-value" id="timer-value">00:00</span>
            </div>
        </div>

        <!-- Matching cards grid -->
        <div class="matching-grid" id="matching-grid">
            <!-- Cards will be inserted here by JavaScript -->
        </div>

        <div class="match-controls">
            <button id="hint-btn" class="match-hint-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 18h6"/><path d="M10 22h4"/>
                    <path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0018 8 6 6 0 006 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 019 14"/>
                </svg>
                Подсказка
            </button>
        </div>
    </div>

    <!-- Game completion screen -->
    <div id="game-complete" class="game-container match-results">
        <div class="match-results__header">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 9H4.5a2.5 2.5 0 010-5C7 4 7 7 7 7"/>
                <path d="M18 9h1.5a2.5 2.5 0 000-5C17 4 17 7 17 7"/>
                <path d="M4 22h16"/>
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20 7 22"/>
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20 17 22"/>
                <path d="M18 2H6v7a6 6 0 0012 0V2z"/>
            </svg>
            Игра завершена!
        </div>

        <!-- XP Earned Banner -->
        <div id="matching-xp-banner" class="match-results__xp-banner">
            <div class="match-results__xp-icon">&#9889;</div>
            <div class="match-results__xp-value">
                +<span id="matching-xp-amount">0</span> XP
            </div>
            <div class="match-results__xp-label">
                Уровень <span id="matching-level">1</span> &bull; <span id="matching-total-xp">0</span> XP
            </div>
        </div>

        <div class="match-results__score-card">
            <p class="match-results__score-title">Ваш счёт</p>
            <p class="match-results__score-value" id="final-score">850</p>
        </div>

        <div class="match-results__stats">
            <div class="match-results__stat">
                <div class="match-results__stat-value" id="stat-pairs">8</div>
                <div class="match-results__stat-label">Пар найдено</div>
            </div>
            <div class="match-results__stat">
                <div class="match-results__stat-value" id="stat-moves">16</div>
                <div class="match-results__stat-label">Ходов</div>
            </div>
            <div class="match-results__stat">
                <div class="match-results__stat-value" id="stat-time">01:23</div>
                <div class="match-results__stat-label">Время</div>
            </div>
        </div>

        <div class="match-results__actions">
            <a href="{{ url_for('study.matching') }}" class="match-results__btn match-results__btn--primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
                </svg>
                Играть снова
            </a>
            <a href="{{ url_for('study.index') }}" class="match-results__btn match-results__btn--secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
                Вернуться к обучению
            </a>
        </div>
    </div>

    <!-- Flashcard popup for matched pairs -->
    <div id="flashcard" class="flashcard-popup">
        <div class="flashcard-word" id="flashcard-word">Hello</div>
        <div class="flashcard-translation" id="flashcard-translation">Привет</div>

        <button id="flashcard-audio-btn" class="audio-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/>
            </svg>
            Произношение
        </button>

        <div class="flashcard-example" id="flashcard-example">
            Hello, how are you today?
            <div style="color: var(--match-text-muted); margin-top: 0.25rem;">Привет, как ты сегодня?</div>
        </div>

        <div class="flashcard-buttons">
            <button class="flashcard-btn primary" id="flashcard-continue-btn">Продолжить</button>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>
</div>

<!-- Audio element (hidden) -->
<audio id="word-audio" class="audio-hidden"></audio>

<!-- Game sounds (hidden) -->
<audio id="match-sound" src="{{ url_for('static', filename='audio/match.mp3') }}" preload="auto"></audio>
<audio id="flip-sound" src="{{ url_for('static', filename='audio/flip.mp3') }}" preload="auto"></audio>
<audio id="success-sound" src="{{ url_for('static', filename='audio/success.mp3') }}" preload="auto"></audio>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Config from server
        const sessionId = {{ session_id }};
        const wordSource = '{{ word_source }}';
        const showTranslations = {{ settings.include_translations|lower }};
        const showExamples = {{ settings.include_examples|lower }};
        const playAudio = {{ settings.include_audio|lower }};

        // Get CSRF token for POST requests
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

        // Game elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const gameSetup = document.getElementById('game-setup');
        const gameContainer = document.getElementById('game-container');
        const gameComplete = document.getElementById('game-complete');
        const matchingGrid = document.getElementById('matching-grid');
        const progressFill = document.getElementById('progress-fill');
        const pairsCounter = document.getElementById('pairs-counter');
        const movesCounter = document.getElementById('moves-counter');
        const timerValue = document.getElementById('timer-value');
        const gameLevel = document.getElementById('game-level');
        const hintBtn = document.getElementById('hint-btn');
        const endGameBtn = document.getElementById('end-game-btn');
        const startGameBtn = document.getElementById('start-game-btn');

        // Flashcard elements
        const flashcard = document.getElementById('flashcard');
        const overlay = document.getElementById('overlay');
        const flashcardWord = document.getElementById('flashcard-word');
        const flashcardTranslation = document.getElementById('flashcard-translation');
        const flashcardExample = document.getElementById('flashcard-example');
        const flashcardAudioBtn = document.getElementById('flashcard-audio-btn');
        const flashcardContinueBtn = document.getElementById('flashcard-continue-btn');

        // Audio elements
        const wordAudio = document.getElementById('word-audio');
        const matchSound = document.getElementById('match-sound');
        const flipSound = document.getElementById('flip-sound');
        const successSound = document.getElementById('success-sound');

        // Completion stats elements
        const finalScore = document.getElementById('final-score');
        const statPairs = document.getElementById('stat-pairs');
        const statMoves = document.getElementById('stat-moves');
        const statTime = document.getElementById('stat-time');

        // Game state
        let gameWords = [];
        let cards = [];
        let firstCard = null;
        let secondCard = null;
        let lockBoard = false;
        let gameStartTime = 0;
        let gameTimer = null;
        let gameSeconds = 0;
        let matchedPairs = 0;
        let totalPairs = 0;
        let moves = 0;
        let difficulty = 'easy';
        let showingHint = false;
        let hintTimeout = null;

        // Difficulty settings
        const difficultySettings = {
            easy: {
                pairs: 6,
                timeLimit: 60, // 1 minutes
                hintDuration: 4000 // 4 seconds
            },
            medium: {
                pairs: 8,
                timeLimit: 120, // 2 minutes
                hintDuration: 3000 // 3 seconds
            },
            hard: {
                pairs: 12,
                timeLimit: 180, // 3 minutes
                hintDuration: 2000 // 2 seconds
            }
        };

        // Initialize game
        function init() {
            loadingSpinner.style.display = 'none';
            gameSetup.style.display = 'block';

            // Set up difficulty selector
            const difficultyButtons = document.querySelectorAll('.difficulty-btn');
            difficultyButtons.forEach(button => {
                button.addEventListener('click', () => {
                    difficultyButtons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    difficulty = button.getAttribute('data-difficulty');
                });
            });

            // Set up start button
            startGameBtn.addEventListener('click', startGame);
        }

        // Start the game
        async function startGame() {
            gameSetup.style.display = 'none';
            loadingSpinner.style.display = 'block';

            try {
                // Fetch words
                await fetchWords();

                // Update difficulty label
                updateDifficultyLabel();

                // Update board
                createBoard();

                // Hide loading spinner and show game
                loadingSpinner.style.display = 'none';
                gameContainer.style.display = 'block';

                // Start timer
                startTimer();
            } catch (error) {
                console.error('Error starting game:', error);
                loadingSpinner.style.display = 'none';

                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger text-center';
                errorDiv.textContent = _('Failed to load game. Please try again.');
                document.querySelector('#matching-game-app').appendChild(errorDiv);
            }
        }

        // Fetch words from API
        async function fetchWords() {
            const requiredPairs = difficultySettings[difficulty].pairs;

            try {
                const response = await fetch(`/study/api/get-matching-words?source=${wordSource}&count=${requiredPairs}`);

                if (!response.ok) {
                    throw new Error('Failed to fetch words');
                }

                const data = await response.json();

                if (data.status === 'success') {
                    gameWords = data.words.slice(0, requiredPairs);
                    totalPairs = gameWords.length;

                    // Update pairs counter
                    pairsCounter.textContent = `0/${totalPairs}`;

                    return true;
                } else {
                    console.error('API error:', data.message);
                    return false;
                }
            } catch (error) {
                console.error('Error fetching words:', error);
                return false;
            }
        }

        // Update difficulty label
        function updateDifficultyLabel() {
            const levelText = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
            gameLevel.innerHTML = `Уровень: <span class="level-${difficulty}">${levelText === 'Easy' ? "Легко" : levelText === 'Medium' ? "Средне" : "Сложно"}</span>`;
        }

        // Create the game board
        function createBoard() {
            // Clear existing board
            matchingGrid.innerHTML = '';

            // Create array with English words and translations
            const cardItems = [];

            gameWords.forEach(word => {
                // Add English word
                cardItems.push({
                    id: word.id,
                    text: word.word,
                    type: 'english',
                    matched: false,
                    pairId: word.id
                });

                // Add Russian translation
                cardItems.push({
                    id: word.id,
                    text: word.translation,
                    type: 'russian',
                    matched: false,
                    pairId: word.id
                });
            });

            // Shuffle the cards
            cards = shuffleArray([...cardItems]);

            // Create card elements
            cards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'flip-card';
                cardElement.dataset.index = index;

                cardElement.innerHTML = `
                    <div class="flip-card-inner">
                        <div class="flip-card-front">
                            <i class="fas fa-language"></i>
                        </div>
                        <div class="flip-card-back">
                            ${card.text}
                        </div>
                    </div>
                `;

                cardElement.addEventListener('click', () => flipCard(cardElement, index));
                matchingGrid.appendChild(cardElement);
            });

            // Update grid columns based on number of cards
            const columns = Math.min(4, Math.ceil(Math.sqrt(cards.length)));
            matchingGrid.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
        }

        // Flip a card
        function flipCard(cardElement, index) {
            // Ignore if board is locked or card is already flipped or matched
            if (lockBoard || cardElement.classList.contains('flipped') ||
                cardElement.classList.contains('matched')) {
                return;
            }

            // Play flip sound
            if (playAudio) {
                flipSound.currentTime = 0;
            }

            // Flip the card
            cardElement.classList.add('flipped');

            // Check which card was flipped
            if (!firstCard) {
                // First card flipped
                firstCard = { element: cardElement, index: index };
                return;
            }

            // Second card flipped
            secondCard = { element: cardElement, index: index };
            moves++;
            movesCounter.textContent = moves;

            // Check for match
            checkForMatch();
        }

        // Check if the two flipped cards match
        function checkForMatch() {
            // Lock the board temporarily
            lockBoard = true;

            const firstCardData = cards[firstCard.index];
            const secondCardData = cards[secondCard.index];

            // Check if the cards form a pair
            const isMatch = firstCardData.pairId === secondCardData.pairId &&
                            firstCardData.type !== secondCardData.type;

            if (isMatch) {
                // Match found
                handleMatch(firstCardData.pairId);
            } else {
                // No match
                setTimeout(() => {
                    firstCard.element.classList.remove('flipped');
                    secondCard.element.classList.remove('flipped');
                    resetBoard();
                }, 1000);
            }
        }

        // Handle a matched pair
        function handleMatch(wordId) {
            // Play match sound
            if (playAudio) {
                matchSound.currentTime = 0;
            }

            // Mark cards as matched
            firstCard.element.classList.add('matched');
            secondCard.element.classList.add('matched');

            // Update matched count
            matchedPairs++;
            pairsCounter.textContent = `${matchedPairs}/${totalPairs}`;

            // Update progress bar
            const progress = (matchedPairs / totalPairs) * 100;
            progressFill.style.width = `${progress}%`;

            // Reset board for next pair
            resetBoard();

            // Show flashcard for the matched pair
            const matchedWord = gameWords.find(word => word.id === wordId);
            if (matchedWord) {
                showFlashcard(matchedWord);
            }

            // Check if game is complete
            if (matchedPairs === totalPairs) {
                setTimeout(() => {
                    completeGame();
                }, 500);
            }
        }

        // Show flashcard with word details
        function showFlashcard(word) {
            // Populate flashcard
            flashcardWord.textContent = word.word;
            flashcardTranslation.textContent = word.translation;

            // Set up audio if available
            if (word.audio_url && playAudio) {
                flashcardAudioBtn.style.display = 'inline-flex';
                wordAudio.src = word.audio_url;
            } else {
                flashcardAudioBtn.style.display = 'none';
            }

            // Set up example if available
            if (word.example && showExamples) {
                flashcardExample.innerHTML = word.example.replace('\n', '<div class="text-muted mt-1">') + '</div>';
                flashcardExample.style.display = 'block';
            } else {
                flashcardExample.style.display = 'none';
            }

            // Show flashcard and overlay
            overlay.style.display = 'block';
            flashcard.style.display = 'block';
        }

        // Reset board after a turn
        function resetBoard() {
            firstCard = null;
            secondCard = null;
            lockBoard = false;
        }

        // Show hint (briefly flip all cards)
        function showHint() {
            // Return if hint is already showing
            if (showingHint || hintTimeout) {
                return;
            }

            // Lock the board
            lockBoard = true;
            showingHint = true;

            // Flip all unmatched cards
            const unmatched = document.querySelectorAll('.card:not(.matched)');
            unmatched.forEach(card => {
                card.classList.add('flipped');
            });

            // Add a small penalty for using hint
            moves += 2;
            movesCounter.textContent = moves;

            // Set timeout to flip cards back
            hintTimeout = setTimeout(() => {
                unmatched.forEach(card => {
                    if (!card.classList.contains('matched')) {
                        card.classList.remove('flipped');
                    }
                });

                lockBoard = false;
                showingHint = false;
                hintTimeout = null;
            }, difficultySettings[difficulty].hintDuration);
        }

        // Start the game timer
        function startTimer() {
            gameStartTime = Date.now();
            gameSeconds = 0;

            // Reset timer display
            timerValue.textContent = '00:00';

            // Start timer interval
            gameTimer = setInterval(() => {
                gameSeconds++;
                const minutes = Math.floor(gameSeconds / 60);
                const seconds = gameSeconds % 60;

                timerValue.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Check if time limit reached
                if (difficultySettings[difficulty].timeLimit && gameSeconds >= difficultySettings[difficulty].timeLimit) {
                    endGame(false);
                }
            }, 1000);
        }

        // Complete the game (success)
        async function completeGame() {
            // Stop timer
            if (gameTimer) {
                clearInterval(gameTimer);
            }

            // Play success sound
            if (playAudio) {
                successSound.currentTime = 0;
            }

            // Calculate score

            // Получение настроек уровня сложности
            const settings = difficultySettings[difficulty] ?? { timeLimit: 60 };
            const timeLimit = settings.timeLimit;

            // 1. Расчёт бонуса за время
            const timeBonus = Math.max(0, timeLimit - gameSeconds);

            // 2. Эффективность ходов (избегаем деления на 0)
            let moveEfficiency = 0;

            if (moves > 0) {
                moveEfficiency = (totalPairs * 2) / moves;

                // optionally, ограничим нереально высокий результат
                if (moveEfficiency > 1) {
                    console.warn('[SCORE] Слишком высокая эффективность — ограничено до 1. moveEfficiency =', moveEfficiency);
                    moveEfficiency = 1;
                }
            } else {
                console.warn('[SCORE] Деление на 0 при расчёте moveEfficiency. moves =', moves);
            }

            // 3. Множитель сложности
            const difficultyMultiplierMap = {
                easy: 1,
                medium: 1.5,
                hard: 2
            };
            const difficultyMultiplier = difficultyMultiplierMap[difficulty] ?? 1;

            // 4. Предварительный лог
                {
                    difficulty,
                    timeLimit,
                    gameSeconds,
                    timeBonus,
                    totalPairs,
                    moves,
                    moveEfficiency,
                    difficultyMultiplier
                }
            );

            // 5. Финальный расчёт score
            let score = 0;

            if (totalPairs === 0 || moves === 0) {
                console.warn('[SCORE] 0 пар или 0 ходов. Score = 0.');
            } else {
                score = Math.round((
                    (totalPairs * 5) +
                    (timeBonus * 5) +
                    (moveEfficiency * 10)
                ) * difficultyMultiplier);
            }

            // 6. Финальный лог результата
            //const timeBonus = Math.max(0, difficultySettings[difficulty].timeLimit - gameSeconds);


            // Send completion to server
            try {
                // Extract unique word IDs from game words for SRS integration
                const word_ids = [...new Set(gameWords.map(w => w.id))];

                const response = await fetch('/study/api/complete-matching-game', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        difficulty,
                        pairs_matched: matchedPairs,
                        total_pairs: totalPairs,
                        moves,
                        time_taken: gameSeconds,
                        score,
                        word_ids  // Include word IDs for SRS integration
                    }),
                });

                const data = await response.json();

                if (!data.success) {
                    console.error('Error saving game result:', data.error);
                    alert('There was a problem saving your score. Please try again.');
                } else {
                }

                // Update completion screen
                gameContainer.style.display = 'none';
                gameComplete.style.display = 'block';

                finalScore.textContent = score;
                statPairs.textContent = matchedPairs;
                statMoves.textContent = moves;

                const minutes = Math.floor(gameSeconds / 60);
                const seconds = gameSeconds % 60;
                statTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Update XP display
                if (data.xp_earned) {
                    document.getElementById('matching-xp-amount').textContent = data.xp_earned;
                    document.getElementById('matching-level').textContent = data.level || 1;
                    document.getElementById('matching-total-xp').textContent = data.total_xp || 0;
                }

                // Add rank information if available
                if (data.rank) {
                    // Create rank display
                    const rankDisplay = document.createElement('div');
                    rankDisplay.className = 'mt-4 text-center';

                    let rankHTML = `
                        <h3>Ваше место: <span class="text-primary">#${data.rank}</span></h3>
                    `;

                    if (data.is_personal_best) {
                        rankHTML += `
                            <div class="alert alert-success mt-2">
                                <i class="fas fa-trophy me-2"></i>
                                Новый личный рекорд!
                            </div>
                        `;
                    }

                    rankHTML += `
                        <a href="{{ url_for('study.leaderboard') }}" class="btn btn-outline-primary mt-3">
                            <i class="fas fa-list me-2"></i>
                            Таблица лидеров
                        </a>
                    `;

                    rankDisplay.innerHTML = rankHTML;

                    // Insert before the existing buttons
                    const buttonsContainer = document.querySelector('#game-complete .match-results__actions');
                    buttonsContainer.parentNode.insertBefore(rankDisplay, buttonsContainer);
                }

            } catch (error) {
                console.error('Error completing game:', error);
                // Still show completion screen but without rank info
                gameContainer.style.display = 'none';
                gameComplete.style.display = 'block';

                finalScore.textContent = score;
                statPairs.textContent = matchedPairs;
                statMoves.textContent = moves;

                const minutes = Math.floor(gameSeconds / 60);
                const seconds = gameSeconds % 60;
                statTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // End game early or timeout
        function endGame(userInitiated = true) {
            // Stop timer
            if (gameTimer) {
                clearInterval(gameTimer);
            }

            // If user initiated (clicked end button), confirm
                            if (userInitiated) {
                if (!confirm("Вы уверены, что хотите завершить игру досрочно?")) {
                    // Resume timer if they cancel
                    startTimer();
                    return;
                }
            }

            // Handle incomplete game
            completeGame();
        }

        // Shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Event listeners
        hintBtn.addEventListener('click', showHint);

        endGameBtn.addEventListener('click', () => {
            endGame(true);
        });

        flashcardAudioBtn.addEventListener('click', () => {
            wordAudio.play();
        });

        flashcardContinueBtn.addEventListener('click', () => {
            overlay.style.display = 'none';
            flashcard.style.display = 'none';
        });

        // Initialize
        init();
    });
</script>
{% endblock %}