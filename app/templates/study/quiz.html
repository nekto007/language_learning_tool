{% extends "base.html" %}

{% block title %}Режим квиза{% endblock %}

{% block styles %}
{{ super() }}
<style>

/* ── Scoped Variables ── */
.qz-page {
  --qz-font: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
  --qz-primary: #f59e0b;
  --qz-primary-dark: #d97706;
  --qz-gradient: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
  --qz-surface: #ffffff;
  --qz-surface-alt: #f8fafc;
  --qz-text: #0f172a;
  --qz-text-muted: #64748b;
  --qz-text-light: #94a3b8;
  --qz-border: #e2e8f0;
  --qz-radius: 16px;
  --qz-radius-sm: 10px;
  --qz-success: #10b981;
  --qz-danger: #ef4444;
  --qz-warning: #f59e0b;
  font-family: var(--qz-font);
  max-width: 700px;
  margin: 0 auto;
  padding: 0 1rem 3rem;
}

/* ── Animations ── */
@keyframes qzSlideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes qzFloat1 {
  0%, 100% { transform: translate(0, 0) scale(1); }
  50% { transform: translate(-18px, 18px) scale(1.06); }
}

@keyframes qzFloat2 {
  0%, 100% { transform: translate(0, 0) rotate(0deg); }
  50% { transform: translate(22px, -16px) rotate(10deg); }
}

@keyframes qzPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes qzFadeInScale {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.qz-page .progress-container {
  animation: qzSlideUp 0.4s ease-out;
}

.qz-page #quiz-view {
  animation: qzSlideUp 0.4s ease-out 0.1s both;
}

/* ── Progress Header ── */
.qz-page .progress-container {
  background: var(--qz-gradient);
  border-radius: var(--qz-radius) var(--qz-radius) 0 0;
  padding: 1.25rem 1.5rem;
  margin-bottom: 0;
  color: #fff;
  position: relative;
  overflow: hidden;
}

.qz-page .progress-container::before,
.qz-page .progress-container::after {
  content: '';
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.08);
  pointer-events: none;
}

.qz-page .progress-container::before {
  width: 160px;
  height: 160px;
  top: -60px;
  right: -40px;
  animation: qzFloat1 18s ease-in-out infinite;
}

.qz-page .progress-container::after {
  width: 80px;
  height: 80px;
  bottom: -30px;
  left: 10%;
  animation: qzFloat2 14s ease-in-out infinite;
}

.qz-page .progress-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.75rem;
  position: relative;
  z-index: 1;
}

.qz-page .progress-title {
  font-size: 1.1rem;
  font-weight: 700;
  margin: 0;
  color: #fff;
}

.qz-page .progress-title .badge {
  background: rgba(255, 255, 255, 0.2) !important;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
  padding: 0.25rem 0.75rem;
  backdrop-filter: blur(5px);
}

.qz-page .question-counter {
  font-size: 0.875rem;
  color: rgba(255, 255, 255, 0.95);
  margin: 0.25rem 0 0;
  font-weight: 600;
}

.qz-page .progress-stats {
  display: flex;
  gap: 0.5rem;
}

.qz-page .stat-counter {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 32px;
  height: 32px;
  padding: 0 0.625rem;
  border-radius: 999px;
  font-size: 0.875rem;
  font-weight: 700;
}

.qz-page .stat-correct {
  background: rgba(255, 255, 255, 0.9);
  color: #059669;
}

.qz-page .stat-incorrect {
  background: rgba(255, 255, 255, 0.9);
  color: #dc2626;
}

.qz-page .end-session-btn {
  padding: 0.5rem 1rem;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: var(--qz-radius-sm);
  color: #fff;
  font-size: 0.8125rem;
  font-weight: 600;
  font-family: var(--qz-font);
  cursor: pointer;
  transition: all 0.2s;
  backdrop-filter: blur(5px);
}

.qz-page .end-session-btn:hover {
  background: rgba(255, 255, 255, 0.25);
}

.qz-page .progress-bar {
  height: 6px;
  background: rgba(255, 255, 255, 0.2) !important;
  border-radius: 3px;
  overflow: hidden;
  position: relative;
  z-index: 1;
}

.qz-page .progress-fill {
  height: 100%;
  background: #fff !important;
  border-radius: 3px;
  transition: width 0.4s ease;
}

/* ── Quiz Container ── */
.qz-page .quiz-container {
  background: var(--qz-surface);
  border: 1px solid var(--qz-border);
  border-top: none;
  border-radius: 0 0 var(--qz-radius) var(--qz-radius);
  padding: 2rem;
  position: relative;
}

/* ── Timer ── */
.qz-page .timer-container {
  display: flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.375rem 0.875rem;
  background: var(--qz-surface-alt);
  border: 1px solid var(--qz-border);
  border-radius: 999px;
  position: absolute;
  top: 1rem;
  right: 1rem;
  font-size: 0.8125rem;
  font-weight: 700;
  color: var(--qz-text);
  font-family: var(--qz-font);
  transition: all 0.3s;
}

.qz-page .timer-container.warning {
  background: #fef2f2;
  border-color: #fecaca;
}

.qz-page .timer-container.warning .timer-icon,
.qz-page .timer-container.warning .timer-value {
  color: var(--qz-danger);
}

.qz-page .timer-icon {
  color: var(--qz-text-muted);
  flex-shrink: 0;
}

.qz-page .timer-value {
  font-size: 0.875rem;
  font-weight: 700;
  color: var(--qz-text);
}

/* ── Question ── */
.qz-page .quiz-header {
  margin-bottom: 0.5rem;
}

.qz-page .quiz-question-label {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--qz-primary);
  display: none;
}

.qz-page .quiz-question-container {
  margin-bottom: 1.5rem;
}

.qz-page .quiz-word-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.qz-page .quiz-question-text {
  font-size: 1.75rem;
  font-weight: 800;
  color: var(--qz-text);
  margin: 0;
  line-height: 1.2;
  letter-spacing: -0.02em;
}

.qz-page .audio-btn-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #fef3c7;
  border: none;
  color: var(--qz-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
}

.qz-page .audio-btn-icon:hover {
  background: #fde68a;
  transform: scale(1.05);
}

.qz-page .audio-btn-icon::after {
  display: none;
}

/* ── Feedback ── */
.qz-page .feedback-container {
  display: none;
  padding: 0.875rem 1.25rem;
  border-radius: var(--qz-radius-sm);
  margin-bottom: 1rem;
  font-size: 0.9rem;
  font-weight: 600;
}

.qz-page .feedback-container p {
  margin: 0;
}

.qz-page .feedback-correct {
  background: #ecfdf5;
  border: 1px solid #a7f3d0;
  color: #065f46;
}

.qz-page .feedback-incorrect {
  background: #fef2f2;
  border: 1px solid #fecaca;
  color: #991b1b;
}

.qz-page .correct-answer {
  font-size: 0.8125rem;
  font-weight: 500;
  margin-top: 0.375rem;
  opacity: 0.85;
}

/* ── Options Grid ── */
.qz-page .options-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
  margin-bottom: 0;
}

.qz-page .option-btn {
  padding: 1rem 1.25rem;
  background: var(--qz-surface);
  border: 1.5px solid var(--qz-border);
  border-radius: var(--qz-radius-sm);
  font-size: 0.95rem;
  font-weight: 600;
  font-family: var(--qz-font);
  color: var(--qz-text);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.qz-page .option-btn:hover {
  border-color: var(--qz-primary);
  background: #fffbeb;
}

.qz-page .option-btn.selected {
  border-color: var(--qz-primary);
  background: #fef3c7;
  color: var(--qz-primary-dark);
}

.qz-page .option-btn.correct {
  border-color: var(--qz-success);
  background: #ecfdf5;
  color: #065f46;
}

.qz-page .option-btn.incorrect {
  border-color: var(--qz-danger);
  background: #fef2f2;
  color: #991b1b;
}

/* ── Fill Blank ── */
.qz-page .quiz-fill-blank {
  margin-bottom: 0;
}

.qz-page .quiz-fill-input {
  width: 300px;
  max-width: 100%;
  padding: 0.875rem 1.25rem;
  border: 1.5px solid var(--qz-border);
  border-radius: var(--qz-radius-sm);
  font-size: 1.1rem;
  font-weight: 600;
  font-family: var(--qz-font);
  color: var(--qz-text);
  text-align: center;
  transition: all 0.2s;
  background: var(--qz-surface);
}

.qz-page .quiz-fill-input:focus {
  outline: none;
  border-color: var(--qz-primary);
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.12);
}

.qz-page .quiz-fill-input::placeholder {
  color: var(--qz-text-light);
  font-weight: 400;
}

/* ── Buttons ── */
.qz-page .quiz-buttons-row {
  display: flex;
  justify-content: center;
  gap: 0.75rem;
  margin: 1.5rem 0;
}

.qz-page .hint-btn {
  padding: 0.625rem 1.25rem;
  background: var(--qz-surface);
  border: 1.5px solid var(--qz-border);
  border-radius: var(--qz-radius-sm);
  font-size: 0.875rem;
  font-weight: 600;
  font-family: var(--qz-font);
  color: var(--qz-text-muted);
  cursor: pointer;
  transition: all 0.2s;
}

.qz-page .hint-btn:hover {
  border-color: var(--qz-warning);
  color: var(--qz-warning);
}

.qz-page .submit-answer-btn {
  padding: 0.625rem 1.5rem;
  background: var(--qz-gradient);
  border: none;
  border-radius: var(--qz-radius-sm);
  font-size: 0.875rem;
  font-weight: 600;
  font-family: var(--qz-font);
  color: #fff;
  cursor: pointer;
  transition: all 0.2s;
}

.qz-page .submit-answer-btn:hover:not(:disabled) {
  opacity: 0.9;
  transform: translateY(-1px);
}

.qz-page .submit-answer-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.qz-page .submit-answer-btn:disabled::after {
  display: none;
}

.qz-page .next-btn {
  padding: 0.625rem 1.5rem;
  background: var(--qz-gradient);
  border: none;
  border-radius: var(--qz-radius-sm);
  font-size: 0.875rem;
  font-weight: 600;
  font-family: var(--qz-font);
  color: #fff;
  cursor: pointer;
  transition: all 0.2s;
  display: none;
}

.qz-page .next-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

/* ── Hint ── */
.qz-page .hint-container {
  text-align: center;
}

.qz-page .hint-text {
  display: none;
  padding: 0.875rem;
  background: #fffbeb;
  border: 1px solid #fde68a;
  border-radius: var(--qz-radius-sm);
  font-size: 0.875rem;
  color: #92400e;
  font-weight: 500;
}

/* ── Session Complete ── */
.qz-page .quiz-session-complete {
  background: var(--qz-surface);
  border: 1px solid var(--qz-border);
  border-radius: var(--qz-radius);
  padding: 2.5rem;
  text-align: center;
  animation: qzFadeInScale 0.5s ease-out;
}

.qz-page .quiz-complete-title {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--qz-text);
  margin: 0 0 1rem;
  letter-spacing: -0.02em;
}

.qz-page .quiz-score {
  font-size: 3.5rem;
  font-weight: 800;
  line-height: 1;
  margin: 0 0 0.25rem;
  letter-spacing: -0.03em;
}

.qz-page .quiz-score-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--qz-text-muted);
  margin: 0 0 1rem;
}

.qz-page .quiz-stats-summary {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1.25rem;
  background: var(--qz-surface-alt);
  border-radius: 999px;
  margin-bottom: 1rem;
  font-size: 0.9rem;
}

.qz-page .quiz-xp-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.5rem 1.25rem;
  background: var(--qz-gradient);
  color: #fff;
  border-radius: 999px;
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 1rem;
}

.qz-page .quiz-achievements {
  margin-bottom: 1rem;
}

.qz-page .quiz-achievements-label {
  font-size: 0.8125rem;
  font-weight: 600;
  color: var(--qz-text-muted);
  margin-bottom: 0.5rem;
}

.qz-page .quiz-achievement-badges {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
}

.qz-page .quiz-action-buttons {
  display: flex;
  gap: 0.75rem;
  justify-content: center;
  margin-top: 0.5rem;
}

.qz-page .quiz-action-buttons .btn {
  padding: 0.625rem 1.25rem;
  border-radius: var(--qz-radius-sm);
  font-size: 0.875rem;
  font-weight: 600;
  font-family: var(--qz-font);
  text-decoration: none;
  transition: all 0.2s;
}

.qz-page .quiz-action-buttons .btn-primary {
  background: var(--qz-gradient);
  border: none;
  color: #fff;
}

.qz-page .quiz-action-buttons .btn-primary:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.qz-page .quiz-action-buttons .btn-outline-secondary {
  background: var(--qz-surface);
  border: 1.5px solid var(--qz-border);
  color: var(--qz-text-muted);
}

.qz-page .quiz-action-buttons .btn-outline-secondary:hover {
  border-color: var(--qz-primary);
  color: var(--qz-primary);
}

/* ── No questions message ── */
.qz-page .alert-info {
  background: var(--qz-surface);
  border: 1px solid var(--qz-border);
  border-radius: var(--qz-radius);
  padding: 2.5rem;
  text-align: center;
  color: var(--qz-text);
}

.qz-page .alert-info h4 {
  font-weight: 700;
  color: var(--qz-text);
  margin-bottom: 0.5rem;
}

.qz-page .alert-info p {
  color: var(--qz-text-muted);
}

.qz-page .alert-info .btn-primary {
  background: var(--qz-gradient);
  border: none;
  border-radius: var(--qz-radius-sm);
  font-family: var(--qz-font);
  font-weight: 600;
}

/* ── Responsive ── */
@media (max-width: 640px) {
  .qz-page {
    padding: 0 0.75rem 2rem;
  }

  .qz-page .progress-container {
    padding: 1rem 1.25rem;
  }

  .qz-page .quiz-container {
    padding: 1.25rem;
  }

  .qz-page .quiz-question-text {
    font-size: 1.35rem;
  }

  .qz-page .options-container {
    grid-template-columns: 1fr;
  }

  .qz-page .quiz-session-complete {
    padding: 1.5rem;
    border-radius: var(--qz-radius);
  }

  .qz-page .quiz-score {
    font-size: 2.75rem;
  }

  .qz-page .quiz-action-buttons {
    flex-direction: column;
  }

  .qz-page .quiz-buttons-row {
    flex-direction: column;
    align-items: center;
  }

  .qz-page .progress-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="qz-page" id="quiz-app">
    <!-- Progress bar and stats -->
    <div class="progress-container">
        <div class="progress-header">
            <div>
                <h2 class="progress-title">
                    Прогресс квиза
                    {% if deck_title %}
                    <span class="badge bg-primary ms-2">{{ deck_title }}</span>
                    {% endif %}
                </h2>
                <p class="question-counter" id="question-counter">Вопрос 1 из 20</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="progress-stats">
                    <span class="stat-counter stat-correct" id="correct-counter">0</span>
                    <span class="stat-counter stat-incorrect" id="incorrect-counter">0</span>
                </div>
                <button id="end-session-btn" class="end-session-btn">Завершить квиз</button>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>

    <!-- Loading spinner -->
    <div id="loading-spinner" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-2" style="color: var(--qz-text-muted);">Загрузка вопросов...</p>
    </div>

    <!-- Quiz container -->
    <div id="quiz-view" style="display: none;">
        <div id="quiz-container" class="quiz-container">
            <!-- Timer (optional) -->
            <div class="timer-container quiz-timer" id="timer-container">
                <svg class="timer-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <span class="timer-value" id="timer-value">30</span>
            </div>

            <!-- Question header with label -->
            <div class="quiz-header">
                <span class="quiz-question-label" id="question-label"></span>
            </div>

            <!-- Question text (the word to translate) with audio -->
            <div class="quiz-question-container">
                <div class="quiz-word-row">
                    <h2 class="quiz-question-text" id="question-text"></h2>
                    <button id="audio-btn" class="audio-btn-icon" style="display: none;" title="Прослушать">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                    </button>
                </div>
            </div>

            <!-- Feedback container (compact, above answer options) -->
            <div id="feedback-container" class="feedback-container quiz-feedback">
                <p id="feedback-text"></p>
                <p id="correct-answer" class="correct-answer"></p>
            </div>

            <!-- Multiple choice options (2x2 grid) -->
            <div class="options-container quiz-options-grid" id="multiple-choice-container" style="display: none;">
                <button class="option-btn quiz-option-btn" data-option="0">Option 1</button>
                <button class="option-btn quiz-option-btn" data-option="1">Option 2</button>
                <button class="option-btn quiz-option-btn" data-option="2">Option 3</button>
                <button class="option-btn quiz-option-btn" data-option="3">Option 4</button>
            </div>

            <!-- Fill in the blank -->
            <div class="quiz-fill-blank" id="fill-blank-container" style="display: none; justify-content: center;">
                <input type="text" class="quiz-fill-input" id="fill-blank-input"
                       style="width: 300px; max-width: 100%; text-align: center;"
                       placeholder="Введите ваш ответ здесь...">
            </div>

            <!-- Buttons row - centered -->
            <div class="quiz-buttons-row" style="display: flex; justify-content: center; gap: 16px; margin: 24px 0;">
                <button id="hint-btn" class="hint-btn">Подсказка</button>
                <button id="submit-answer-btn" class="submit-answer-btn">Отправить</button>
                <button id="next-btn" class="next-btn">Далее</button>
            </div>

            <!-- Hint text -->
            <div class="hint-container">
                <p id="hint-text" class="hint-text"></p>
            </div>
        </div>

        <!-- Session complete message - COMPACT VERSION with XP -->
        <div id="session-complete" class="quiz-session-complete" style="display: none;">
            <!-- Title -->
            <h3 class="quiz-complete-title">Квиз завершен</h3>

            <!-- Score display -->
            <div class="mb-3">
                <div class="quiz-score" id="final-score">85%</div>
                <div class="quiz-score-label">правильно</div>
            </div>

            <!-- Compact stats - one line -->
            <div class="quiz-stats-summary">
                <span id="stats-summary" class="d-flex align-items-center gap-2">
                    <span id="stats-correct" class="text-success fw-semibold">17</span>/<span id="stats-questions" class="fw-semibold">20</span>
                    <span class="text-muted">&bull;</span>
                    <span id="stats-time" class="fw-medium">5:23</span>
                </span>
            </div>

            <!-- XP Earned -->
            <div id="xp-earned" class="quiz-xp-badge">
                +<span id="xp-amount">0</span> XP
            </div>

            <!-- Achievements (hidden by default, shown if earned) -->
            <div id="achievements-earned" class="quiz-achievements" style="display: none;">
                <div class="quiz-achievements-label">Новые достижения:</div>
                <div id="achievement-badges" class="quiz-achievement-badges">
                    <!-- Achievement badges will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Action buttons - compact row -->
            <div id="action-buttons" class="quiz-action-buttons">
                <a id="retry-quiz-btn" href="#" class="btn btn-primary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;vertical-align:-1px"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>Еще раз
                </a>
                <a href="{{ url_for('study.index') }}" class="btn btn-outline-secondary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;vertical-align:-1px"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Назад
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Audio element (hidden) -->
<audio id="word-audio" style="display: none;"></audio>
{% endblock %}

{% block scripts %}
<!-- Canvas Confetti Library -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
    // Confetti animation function
    function celebrateWithConfetti() {
        const duration = 3 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

        function randomInRange(min, max) {
            return Math.random() * (max - min) + min;
        }

        const interval = setInterval(function() {
            const timeLeft = animationEnd - Date.now();

            if (timeLeft <= 0) {
                return clearInterval(interval);
            }

            const particleCount = 50 * (timeLeft / duration);

            confetti({
                ...defaults,
                particleCount,
                origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
            });
            confetti({
                ...defaults,
                particleCount,
                origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
            });
        }, 250);
    }

    // Animate number counting
    function animateValue(element, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const value = Math.floor(progress * (end - start) + start);
            element.textContent = value;
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // Pulse animation for XP badge
    function pulseElement(element) {
        element.style.animation = 'qzPulse 0.6s ease-in-out 3';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Config from server
        const sessionId = {{ session_id }};
        const wordSource = '{{ word_source }}';
        const deckId = {{ deck_id|tojson }};
        // Get word limit from URL parameter if not set by server
        const urlParams = new URLSearchParams(window.location.search);
        const wordLimit = {{ word_limit|tojson }} || parseInt(urlParams.get('limit')) || null;
        const showTranslations = {{ settings.include_translations|tojson }};
        const showExamples = {{ settings.include_examples|tojson }};
        const playAudio = {{ settings.include_audio|tojson }};

        // Get CSRF token once
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // App state
        let questions = [];
        let currentQuestionIndex = 0;
        let sessionStartTime = Date.now();
        let timer = null;
        let timeRemaining = 30; // Seconds per question
        let selectedOption = null;
        let sessionStats = {
            total: 0,
            correct: 0,
            incorrect: 0,
            timeSpent: 0
        };

        // Track incorrect questions for retry at the end
        let incorrectQuestions = [];
        let isRetryPhase = false;
        const MAX_RETRY_ATTEMPTS = 2; // Maximum times a question can be retried

        // DOM elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const quizView = document.getElementById('quiz-view');
        const quizContainer = document.getElementById('quiz-container');
        const sessionComplete = document.getElementById('session-complete');
        const questionCounter = document.getElementById('question-counter');
        const progressFill = document.getElementById('progress-fill');
        const correctCounter = document.getElementById('correct-counter');
        const incorrectCounter = document.getElementById('incorrect-counter');
        const questionText = document.getElementById('question-text');
        const multipleChoiceContainer = document.getElementById('multiple-choice-container');
        const fillBlankContainer = document.getElementById('fill-blank-container');
        const fillBlankInput = document.getElementById('fill-blank-input');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');
        const nextBtn = document.getElementById('next-btn');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackText = document.getElementById('feedback-text');
        const correctAnswer = document.getElementById('correct-answer');
        const audioBtn = document.getElementById('audio-btn');
        const wordAudio = document.getElementById('word-audio');
        const hintBtn = document.getElementById('hint-btn');
        const hintText = document.getElementById('hint-text');
        const endSessionBtn = document.getElementById('end-session-btn');
        const timerContainer = document.getElementById('timer-container');
        const timerValue = document.getElementById('timer-value');

        // Stats elements
        const finalScore = document.getElementById('final-score');
        const statsQuestions = document.getElementById('stats-questions');
        const statsCorrect = document.getElementById('stats-correct');
        const statsTime = document.getElementById('stats-time');

        // Fetch questions from API
        async function fetchQuestions() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const lang = urlParams.get('lang') || '{{ g.locale }}';

                let url = `/study/api/get-quiz-questions?source=${wordSource}&lang=${lang}`;
                if (deckId) {
                    url += `&deck_id=${deckId}`;
                }
                if (wordLimit && wordLimit !== null) {
                    url += `&count=${wordLimit}`;
                }

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error('Failed to fetch questions');
                }

                const data = await response.json();

                if (data.status === 'success') {
                    return data.questions;
                } else {
                    console.error('API error:', data.message);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching questions:', error);
                return [];
            }
        }

        function getQuizStateKey() {
            const quizKey = deckId ? `deck_${deckId}` : 'auto';
            return `quizState_${quizKey}`;
        }

        function saveQuizState() {
            const state = {
                deckId: deckId,
                wordSource: wordSource,
                questions: questions,
                currentQuestionIndex: currentQuestionIndex,
                sessionStats: sessionStats,
                sessionStartTime: sessionStartTime,
                incorrectQuestions: incorrectQuestions,
                isRetryPhase: isRetryPhase,
                timestamp: Date.now()
            };
            localStorage.setItem(getQuizStateKey(), JSON.stringify(state));
        }

        function loadQuizState() {
            const completedKey = getQuizStateKey() + '_completed';
            if (localStorage.getItem(completedKey)) {
                localStorage.removeItem(completedKey);
                clearQuizState();
                return null;
            }

            const savedState = localStorage.getItem(getQuizStateKey());
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);

                    const maxAge = 24 * 60 * 60 * 1000;
                    if (state.timestamp && (Date.now() - state.timestamp) > maxAge) {
                        clearQuizState();
                        return null;
                    }

                    if (state.deckId === deckId && state.wordSource === wordSource) {
                        return state;
                    }
                } catch (error) {
                    console.error('Error loading quiz state:', error);
                }
            }
            return null;
        }

        function clearQuizState() {
            localStorage.removeItem(getQuizStateKey());
        }

        async function initQuiz() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const forceFresh = urlParams.get('fresh') === 'true';

                const savedState = forceFresh ? null : loadQuizState();

                if (savedState && savedState.questions && savedState.questions.length > 0) {
                    const savedIndex = savedState.currentQuestionIndex || 0;
                    if (savedIndex >= savedState.questions.length) {
                        clearQuizState();
                        questions = await fetchQuestions();

                        if (!questions || questions.length === 0) {
                            showNoQuestionsMessage();
                            return;
                        }

                        loadingSpinner.style.display = 'none';
                        quizView.style.display = 'block';
                        showQuestion(0);
                        return;
                    }

                    questions = savedState.questions;
                    currentQuestionIndex = savedIndex;
                    sessionStats = savedState.sessionStats || {total: 0, correct: 0, incorrect: 0, timeSpent: 0};
                    sessionStartTime = savedState.sessionStartTime || Date.now();
                    incorrectQuestions = savedState.incorrectQuestions || [];
                    isRetryPhase = savedState.isRetryPhase || false;

                    correctCounter.textContent = sessionStats.correct;
                    incorrectCounter.textContent = sessionStats.incorrect;

                    loadingSpinner.style.display = 'none';
                    quizView.style.display = 'block';

                    showQuestion(currentQuestionIndex);
                } else {
                    questions = await fetchQuestions();

                    if (!questions || questions.length === 0) {
                        showNoQuestionsMessage();
                        return;
                    }

                    loadingSpinner.style.display = 'none';
                    quizView.style.display = 'block';

                    showQuestion(0);

                    saveQuizState();
                }
            } catch (error) {
                console.error('Error initializing quiz:', error);
                showNoQuestionsMessage();
            }
        }

        function showQuestion(index) {
            if (index >= questions.length) {
                if (incorrectQuestions.length > 0) {
                    questions.push(...incorrectQuestions);
                    incorrectQuestions = [];
                    isRetryPhase = true;
                } else {
                    completeQuiz();
                    return;
                }
            }

            const question = questions[index];
            currentQuestionIndex = index;

            if (!question) {
                console.error('Invalid question at index:', index);
                return;
            }

            resetQuestionState();

            const progress = ((index + 1) / questions.length) * 100;
            progressFill.style.width = `${progress}%`;

            if (question.retryCount) {
                questionCounter.textContent = `Повтор ${question.retryCount}/${MAX_RETRY_ATTEMPTS}: Вопрос ${index + 1} из ${questions.length}`;
                questionCounter.style.color = '#fde68a';
            } else {
                questionCounter.textContent = `Вопрос ${index + 1} из ${questions.length}`;
                questionCounter.style.color = '';
            }

            questionText.textContent = question.text || '';

            const questionLabel = document.getElementById('question-label');
            if (question.question_label) {
                questionLabel.textContent = question.question_label;
                questionLabel.style.display = 'block';
            } else {
                questionLabel.style.display = 'none';
            }

            if (question.audio_url && playAudio) {
                audioBtn.style.display = 'inline-flex';
                wordAudio.src = question.audio_url;
            } else {
                audioBtn.style.display = 'none';
            }

            hintText.textContent = question.hint || '';

            setupAnswerInterface(question);

            startQuestionTimer();
        }

        function setupAnswerInterface(question) {
            switch (question.type) {
                case 'multiple_choice':
                    setupMultipleChoice(question);
                    break;
                case 'fill_blank':
                    setupFillBlank(question);
                    break;
                default:
                    console.error('Unknown question type:', question.type);
            }
        }

        function setupMultipleChoice(question) {
            multipleChoiceContainer.style.setProperty('display', 'grid', 'important');
            fillBlankContainer.style.setProperty('display', 'none', 'important');

            submitAnswerBtn.style.display = 'none';

            const optionButtons = multipleChoiceContainer.querySelectorAll('.option-btn');

            if (!question.options || !Array.isArray(question.options)) {
                console.error('Invalid options:', question.options);
                return;
            }

            optionButtons.forEach((button, index) => {
                if (index < question.options.length) {
                    button.textContent = question.options[index];
                    button.style.display = 'block';
                } else {
                    button.style.display = 'none';
                }
                button.classList.remove('selected', 'correct', 'incorrect');
            });

            optionButtons.forEach(button => {
                button.onclick = function() {
                    if (this.style.display !== 'none' && nextBtn.style.display === 'none') {
                        optionButtons.forEach(btn => btn.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedOption = this.getAttribute('data-option');
                        submitAnswer();
                    }
                };
            });
        }

        function setupFillBlank(question) {
            multipleChoiceContainer.style.setProperty('display', 'none', 'important');
            fillBlankContainer.style.setProperty('display', 'block', 'important');

            submitAnswerBtn.style.display = 'block';
            submitAnswerBtn.disabled = true;

            fillBlankInput.value = '';

            setTimeout(() => {
                fillBlankInput.focus();
            }, 100);

            fillBlankInput.oninput = function() {
                selectedOption = this.value.trim();
                submitAnswerBtn.disabled = selectedOption === '';
            };

            fillBlankInput.onkeydown = function(e) {
                if (e.key === 'Enter' && this.value.trim() !== '') {
                    submitAnswer();
                }
            };
        }

        function resetQuestionState() {
            selectedOption = null;

            submitAnswerBtn.style.display = 'block';
            submitAnswerBtn.disabled = true;
            nextBtn.style.display = 'none';

            feedbackContainer.style.display = 'none';
            feedbackContainer.className = 'feedback-container';

            hintText.style.display = 'none';

            multipleChoiceContainer.style.setProperty('display', 'none', 'important');
            fillBlankContainer.style.setProperty('display', 'none', 'important');

            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        function startQuestionTimer() {
            timeRemaining = 30;
            timerValue.textContent = timeRemaining;
            timerContainer.classList.remove('warning');

            if (timer) {
                clearInterval(timer);
            }

            timer = setInterval(() => {
                timeRemaining--;
                timerValue.textContent = timeRemaining;

                if (timeRemaining <= 10) {
                    timerContainer.classList.add('warning');
                } else {
                    timerContainer.classList.remove('warning');
                }

                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    timer = null;

                    if (submitAnswerBtn.style.display !== 'none') {
                        submitAnswer();
                    }
                }
            }, 1000);
        }

        async function submitAnswer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }

            const question = questions[currentQuestionIndex];
            let userAnswer = '';
            let isCorrect = false;

            switch (question.type) {
                case 'multiple_choice':
                    userAnswer = selectedOption !== null ? question.options[parseInt(selectedOption)] : '';
                    isCorrect = userAnswer === question.answer;
                    break;
                case 'fill_blank':
                    userAnswer = fillBlankInput.value.trim().toLowerCase();

                    if (Array.isArray(question.acceptable_answers)) {
                        isCorrect = question.acceptable_answers.some(answer =>
                            userAnswer === answer.toLowerCase());
                    } else {
                        isCorrect = userAnswer === question.answer.toLowerCase();
                    }
                    break;
            }

            feedbackContainer.style.display = 'block';
            feedbackContainer.classList.add(isCorrect ? 'feedback-correct' : 'feedback-incorrect');
            feedbackText.textContent = isCorrect ?
                "Правильно!" :
                "Неправильно.";

            if (!isCorrect) {
                correctAnswer.textContent = `Правильный ответ: ${question.answer}`;
                correctAnswer.style.display = 'block';
            } else {
                correctAnswer.style.display = 'none';
            }

            if (question.type === 'multiple_choice') {
                const optionButtons = multipleChoiceContainer.querySelectorAll('.option-btn');

                optionButtons.forEach((button, index) => {
                    const optionText = question.options[index];

                    if (optionText === question.answer) {
                        button.classList.add('correct');
                    } else if (selectedOption === index.toString()) {
                        button.classList.add('incorrect');
                    }
                });
            }

            sessionStats.total++;

            if (isCorrect) {
                sessionStats.correct++;
                correctCounter.textContent = sessionStats.correct;
            } else {
                sessionStats.incorrect++;
                incorrectCounter.textContent = sessionStats.incorrect;

                const retryCount = question.retryCount || 0;
                if (retryCount < MAX_RETRY_ATTEMPTS) {
                    incorrectQuestions.push({
                        ...question,
                        retryCount: retryCount + 1
                    });
                }
            }

            try {
                const response = await fetch('/study/api/submit-quiz-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        question_id: question.id,
                        word_id: question.word_id,
                        direction: question.direction,
                        user_answer: userAnswer,
                        is_correct: isCorrect,
                        time_taken: 30 - timeRemaining
                    }),
                });

                const data = await response.json();
            } catch (error) {
                console.error('Error submitting answer:', error);
            }

            submitAnswerBtn.style.display = 'none';
            nextBtn.style.display = 'block';

            saveQuizState();
        }

        function nextQuestion() {
            showQuestion(currentQuestionIndex + 1);
            saveQuizState();
        }

        async function completeQuiz() {
            try {
                localStorage.setItem(getQuizStateKey() + '_completed', Date.now().toString());
                clearQuizState();

                const scorePercentage = sessionStats.total > 0 ?
                    Math.round((sessionStats.correct / sessionStats.total) * 100) : 0;

                const timeSpent = Math.floor((Date.now() - sessionStartTime) / 1000);

                const response = await fetch('/study/api/complete-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        deck_id: deckId,
                        score: scorePercentage,
                        total_questions: sessionStats.total,
                        correct_answers: sessionStats.correct,
                        time_taken: timeSpent
                    }),
                });

                const data = await response.json();

                quizContainer.style.display = 'none';

                sessionComplete.style.display = 'block';

                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                const timeFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                finalScore.textContent = `${scorePercentage}%`;
                statsQuestions.textContent = sessionStats.total;
                statsCorrect.textContent = sessionStats.correct;
                statsTime.textContent = timeFormatted;

                if (scorePercentage >= 90) {
                    finalScore.style.color = '#10b981';
                } else if (scorePercentage >= 75) {
                    finalScore.style.color = '#3b82f6';
                } else if (scorePercentage >= 60) {
                    finalScore.style.color = '#f59e0b';
                } else {
                    finalScore.style.color = '#ef4444';
                }

                const xpAmount = data.xp_earned || 0;
                const xpAmountEl = document.getElementById('xp-amount');
                if (xpAmountEl && xpAmount > 0) {
                    animateValue(xpAmountEl, 0, xpAmount, 1500);

                    const xpContainer = document.getElementById('xp-earned');
                    if (xpContainer) {
                        pulseElement(xpContainer);
                    }
                }

                if (data.achievements && data.achievements.length > 0) {
                    const achievementsContainer = document.getElementById('achievements-earned');
                    const badgesContainer = document.getElementById('achievement-badges');
                    badgesContainer.innerHTML = '';

                    setTimeout(() => celebrateWithConfetti(), 500);

                    data.achievements.forEach((achievement, index) => {
                        const badge = document.createElement('div');
                        badge.style.cssText = `background: #fff; border: 2px solid #ffd700; border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; animation: qzSlideUp 0.5s ease-out ${index * 0.1}s both;`;
                        badge.innerHTML = `
                            <span style="font-size: 18px;">${achievement.icon}</span>
                            <span>${achievement.name}</span>
                        `;
                        badgesContainer.appendChild(badge);
                    });

                    achievementsContainer.style.display = 'block';
                }

                const retryBtn = document.getElementById('retry-quiz-btn');
                if (retryBtn && deckId) {
                    let retryUrl = `/study/quiz/deck/${deckId}?fresh=true`;
                    if (wordLimit && wordLimit > 0) {
                        retryUrl += `&limit=${wordLimit}`;
                    }
                    retryBtn.href = retryUrl;
                } else if (retryBtn) {
                    retryBtn.href = '{{ url_for("study.quiz") }}?fresh=true';
                }

            } catch (error) {
                console.error('Error completing quiz:', error);
                window.location.href = '{{ url_for("study.index") }}';
            }
        }

        function showNoQuestionsMessage() {
            loadingSpinner.style.display = 'none';

            const messageDiv = document.createElement('div');
            messageDiv.className = 'alert alert-info text-center';
            messageDiv.innerHTML = `
                <h4>Нет доступных вопросов</h4>
                <p>Нет слов, соответствующих вашим критериям изучения.</p>
                <a href="{{ url_for('study.index') }}" class="btn btn-primary mt-2">
                    Вернуться к панели изучения
                </a>
            `;

            document.querySelector('#quiz-app').appendChild(messageDiv);
        }


        // Event listeners
        submitAnswerBtn.addEventListener('click', submitAnswer);
        nextBtn.addEventListener('click', nextQuestion);

        audioBtn.addEventListener('click', function() {
            wordAudio.play();
        });

        hintBtn.addEventListener('click', function() {
            hintText.style.display = hintText.style.display === 'block' ? 'none' : 'block';
        });

        endSessionBtn.addEventListener('click', function() {
            if (confirm("Вы уверены, что хотите завершить квиз?")) {
                completeQuiz();
            }
        });

        // Initialize the quiz
        initQuiz();
    });
</script>
{% endblock %}