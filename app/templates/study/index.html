{% extends "base.html" %}

{% block title %}–ò–∑—É—á–µ–Ω–∏–µ —Å–ª–æ–≤{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px;">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-4">
        <h1 class="h2 fw-bold mb-2">üìö –ò–∑—É—á–µ–Ω–∏–µ —Å–ª–æ–≤</h1>
        <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–¥—É –∏–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è</p>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç - –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è -->
    {% if due_items_count > 0 or total_items > 0 %}
    <div class="card mb-4 border-primary shadow-sm">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title mb-2">
                        <i class="fas fa-bolt text-warning"></i> –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç - –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
                    </h5>
                    <p class="text-muted mb-2">
                        {% if due_items_count > 0 %}
                        <strong class="text-primary">{{ due_items_count }}</strong> —Å–ª–æ–≤ –æ–∂–∏–¥–∞—é—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                        {% else %}
                        –í—Å–µ —Å–ª–æ–≤–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω—ã! –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∏–∑—É—á–µ–Ω–∏–µ.
                        {% endif %}
                    </p>
                    <small class="text-muted">
                        –í –∏–∑—É—á–µ–Ω–∏–∏: <strong>{{ total_items }}</strong> |
                        –í—ã—É—á–µ–Ω–æ: <strong>{{ mastered_count }}</strong>
                    </small>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{{ url_for('study.cards') }}" class="btn btn-primary btn-lg px-4">
                        <i class="fas fa-play me-2"></i>–ù–∞—á–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ú–æ–∏ –∫–æ–ª–æ–¥—ã -->
    {% if my_decks or True %}
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-0">
                <i class="fas fa-user-circle text-primary"></i> –ú–æ–∏ –∫–æ–ª–æ–¥—ã
                <span class="badge bg-primary" id="deck-count">{{ my_decks|length }}</span>
            </h4>
            <div class="d-flex gap-2">
                <div class="input-group" style="width: 300px;">
                    <span class="input-group-text bg-white">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control" id="deck-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–ª–æ–¥–∞–º...">
                    <button class="btn btn-outline-secondary" type="button" id="clear-search" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <a href="{{ url_for('study.create_deck') }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus me-1"></i>–°–æ–∑–¥–∞—Ç—å –∫–æ–ª–æ–¥—É
                </a>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 30%;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th class="text-center" style="width: 10%;">–í—Å–µ–≥–æ</th>
                            <th class="text-center" style="width: 10%;">
                                <span class="text-info" title="–ù–æ–≤—ã–µ —Å–ª–æ–≤–∞">
                                    <i class="fas fa-star"></i> –ù–æ–≤—ã–µ
                                </span>
                            </th>
                            <th class="text-center" style="width: 10%;">
                                <span class="text-warning" title="–ò–∑—É—á–∞–µ–º—ã–µ —Å–ª–æ–≤–∞">
                                    <i class="fas fa-graduation-cap"></i> –ò–∑—É—á–∞—é
                                </span>
                            </th>
                            <th class="text-center" style="width: 10%;">
                                <span class="text-danger" title="–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é">
                                    <i class="fas fa-redo"></i> –ü–æ–≤—Ç–æ—Ä
                                </span>
                            </th>
                            <th class="text-center" style="width: 10%;">
                                <span class="text-success" title="–í—ã—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞">
                                    <i class="fas fa-check-circle"></i> –í—ã—É—á–µ–Ω–æ
                                </span>
                            </th>
                            <th class="text-center" style="width: 10%;">–°—ã–≥—Ä–∞–Ω–æ</th>
                            <th class="text-center" style="width: 10%;">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for deck in my_decks %}
                        <tr>
                            <td>
                                <div class="fw-bold">{{ deck.title }}</div>
                                {% if deck.description %}
                                <small class="text-muted">{{ deck.description[:60] }}{% if deck.description|length > 60 %}...{% endif %}</small>
                                {% endif %}
                                {% if deck.word_count > 0 %}
                                <div class="progress mt-2" style="height: 6px;">
                                    {% set total = deck.word_count %}
                                    {% set mastered_pct = (deck.mastered_count / total * 100)|round(1) %}
                                    {% set learning_pct = (deck.learning_count / total * 100)|round(1) %}
                                    {% set review_pct = (deck.review_count / total * 100)|round(1) %}
                                    {% set new_pct = (deck.new_count / total * 100)|round(1) %}

                                    {% if mastered_pct > 0 %}
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ mastered_pct }}%"
                                         title="–í—ã—É—á–µ–Ω–æ: {{ deck.mastered_count }} ({{ mastered_pct }}%)"></div>
                                    {% endif %}
                                    {% if learning_pct > 0 %}
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ learning_pct }}%"
                                         title="–ò–∑—É—á–∞—é: {{ deck.learning_count }} ({{ learning_pct }}%)"></div>
                                    {% endif %}
                                    {% if review_pct > 0 %}
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: {{ review_pct }}%"
                                         title="–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é: {{ deck.review_count }} ({{ review_pct }}%)"></div>
                                    {% endif %}
                                    {% if new_pct > 0 %}
                                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ new_pct }}%"
                                         title="–ù–æ–≤—ã–µ: {{ deck.new_count }} ({{ new_pct }}%)"></div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <span class="badge bg-light text-dark">{{ deck.word_count }}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-info">{{ deck.new_count }}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-warning text-dark">{{ deck.learning_count }}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-danger">{{ deck.review_count }}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-success">{{ deck.mastered_count }}</span>
                            </td>
                            <td class="text-center">
                                <small class="text-muted">{{ deck.times_played }}</small>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('study.quiz_deck', deck_id=deck.id) }}" class="btn btn-primary" title="–ü—Ä–æ–π—Ç–∏ –∫–≤–∏–∑">
                                        <i class="fas fa-brain"></i> Quiz
                                    </a>
                                    <a href="{{ url_for('study.cards_deck', deck_id=deck.id) }}" class="btn btn-success" title="–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ">
                                        <i class="fas fa-layer-group"></i> –ö–∞—Ä—Ç–æ—á–∫–∏
                                    </a>
                                    <a href="{{ url_for('study.edit_deck', deck_id=deck.id) }}" class="btn btn-outline-secondary" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-danger" onclick="confirmDelete({{ deck.id }}, '{{ deck.title }}')" title="–£–¥–∞–ª–∏—Ç—å">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ü—É–±–ª–∏—á–Ω—ã–µ –∫–æ–ª–æ–¥—ã -->
    {% if public_decks %}
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-0">
                <i class="fas fa-globe text-success"></i> –ü—É–±–ª–∏—á–Ω—ã–µ –∫–æ–ª–æ–¥—ã
                <span class="badge bg-success">{{ public_decks|length }}</span>
            </h4>
            <a href="{{ url_for('study.quiz') }}" class="btn btn-sm btn-outline-success">
                <i class="fas fa-eye me-1"></i>–í—Å–µ –∫–æ–ª–æ–¥—ã
            </a>
        </div>
        <div class="row g-3">
            {% for deck in public_decks[:8] %}
            <div class="col-md-6 col-lg-4 col-xl-3">
                <div class="card h-100 shadow-sm hover-card" style="border-left: 3px solid var(--bs-success);">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title fw-bold mb-0 text-truncate flex-grow-1" title="{{ deck.title }}">
                                {{ deck.title }}
                            </h6>
                            <span class="badge bg-success ms-1" style="font-size: 0.6rem;">–ü—É–±–ª.</span>
                        </div>
                        {% if deck.description %}
                        <p class="card-text text-muted small mb-2" style="font-size: 0.8rem; height: 2.4em; overflow: hidden;">
                            {{ deck.description[:80] }}{% if deck.description|length > 80 %}...{% endif %}
                        </p>
                        {% else %}
                        <p class="card-text text-muted small mb-2" style="height: 2.4em;">&nbsp;</p>
                        {% endif %}
                        <div class="d-flex gap-1 mb-3 flex-wrap align-items-center">
                            <span class="badge bg-light text-dark" style="font-size: 0.7rem;">
                                <i class="fas fa-book"></i> {{ deck.word_count }} —Å–ª–æ–≤
                            </span>
                            {% if deck.times_played > 0 %}
                            <span class="badge bg-light text-dark" style="font-size: 0.7rem;">
                                <i class="fas fa-users"></i> {{ deck.times_played }}
                            </span>
                            {% endif %}
                        </div>
                        {% if deck.word_count > 0 %}
                        <div class="mb-2">
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 100%"
                                     title="{{ deck.word_count }} —Å–ª–æ–≤ –≤ –∫–æ–ª–æ–¥–µ"></div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="d-grid gap-1">
                            <a href="{{ url_for('study.quiz_deck', deck_id=deck.id) }}" class="btn btn-success btn-sm">
                                <i class="fas fa-play me-1"></i>–ö–≤–∏–∑
                            </a>
                            <form method="POST" action="{{ url_for('study.copy_deck', deck_id=deck.id) }}" style="margin: 0;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-outline-primary btn-sm w-100">
                                    <i class="fas fa-copy me-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}


    <!-- –î—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã –æ–±—É—á–µ–Ω–∏—è -->
    <div class="mb-4">
        <h4 class="fw-bold mb-3">
            <i class="fas fa-gamepad text-secondary"></i> –î—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã –æ–±—É—á–µ–Ω–∏—è
        </h4>
        <div class="row g-3">
            <div class="col-md-4">
                <a href="{{ url_for('study.cards') }}" class="card h-100 shadow-sm hover-card text-decoration-none">
                    <div class="card-body text-center p-3">
                        <div class="rounded-circle bg-primary bg-opacity-10 d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                            <i class="fas fa-layer-group text-primary fs-3"></i>
                        </div>
                        <h6 class="fw-bold text-dark mb-1">–ö–∞—Ä—Ç–æ—á–∫–∏</h6>
                        <p class="text-muted small mb-0">–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</p>
                    </div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="{{ url_for('study.quiz_auto') }}" class="card h-100 shadow-sm hover-card text-decoration-none">
                    <div class="card-body text-center p-3">
                        <div class="rounded-circle bg-success bg-opacity-10 d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                            <i class="fas fa-question-circle text-success fs-3"></i>
                        </div>
                        <h6 class="fw-bold text-dark mb-1">–ê–≤—Ç–æ–∫–≤–∏–∑</h6>
                        <p class="text-muted small mb-0">–°–ª—É—á–∞–π–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</p>
                    </div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="{{ url_for('study.matching') }}" class="card h-100 shadow-sm hover-card text-decoration-none">
                    <div class="card-body text-center p-3">
                        <div class="rounded-circle bg-warning bg-opacity-10 d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                            <i class="fas fa-puzzle-piece text-warning fs-3"></i>
                        </div>
                        <h6 class="fw-bold text-dark mb-1">–°–æ–≤–ø–∞–¥–µ–Ω–∏—è</h6>
                        <p class="text-muted small mb-0">–ò–≥—Ä–∞ –Ω–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ</p>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
    {% if not my_decks and not public_decks %}
    <div class="alert alert-info">
        <h5 class="alert-heading">
            <i class="fas fa-info-circle me-2"></i>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!
        </h5>
        <p class="mb-2">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–ª–æ–¥ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.</p>
        <hr>
        <p class="mb-0">
            {% if current_user.is_admin %}
            <a href="{{ url_for('admin.quiz_deck_create') }}" class="alert-link">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∫–æ–ª–æ–¥—É</a> –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.
            {% else %}
            –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–ª–æ–¥.
            {% endif %}
        </p>
        <p class="mt-2 mb-0">
            –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤ –∫ –∏–∑—É—á–µ–Ω–∏—é –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="{{ url_for('study.collections') }}" class="alert-link">–∫–æ–ª–ª–µ–∫—Ü–∏–∏</a>.
        </p>
    </div>
    {% endif %}
</div>

<style>
.hover-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.hover-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function confirmDelete(deckId, deckTitle) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–¥—É "${deckTitle}"?`)) {
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/study/my-decks/${deckId}/delete`;

        // Add CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.content;
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }
}

// Deck search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('deck-search');
    const clearButton = document.getElementById('clear-search');
    const deckTable = document.querySelector('.table tbody');
    const deckCountBadge = document.getElementById('deck-count');

    if (searchInput && deckTable) {
        const rows = Array.from(deckTable.querySelectorAll('tr'));
        const totalDecks = rows.length;

        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();

            // Show/hide clear button
            if (query) {
                clearButton.style.display = 'block';
            } else {
                clearButton.style.display = 'none';
            }

            let visibleCount = 0;

            rows.forEach(row => {
                // Get deck title and description
                const titleElement = row.querySelector('td:first-child .fw-bold');
                const descElement = row.querySelector('td:first-child .text-muted');

                const title = titleElement ? titleElement.textContent.toLowerCase() : '';
                const description = descElement ? descElement.textContent.toLowerCase() : '';

                // Check if query matches title or description
                if (title.includes(query) || description.includes(query)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Update counter
            if (query) {
                deckCountBadge.textContent = `${visibleCount} –∏–∑ ${totalDecks}`;
            } else {
                deckCountBadge.textContent = totalDecks;
            }

            // Show "no results" message if needed
            if (visibleCount === 0 && query) {
                if (!document.getElementById('no-results-message')) {
                    const noResultsRow = document.createElement('tr');
                    noResultsRow.id = 'no-results-message';
                    noResultsRow.innerHTML = `
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p class="mb-0">–ö–æ–ª–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É: "<strong>${query}</strong>"</p>
                        </td>
                    `;
                    deckTable.appendChild(noResultsRow);
                }
            } else {
                const noResultsMsg = document.getElementById('no-results-message');
                if (noResultsMsg) {
                    noResultsMsg.remove();
                }
            }
        });

        // Clear search
        clearButton.addEventListener('click', function() {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'));
            searchInput.focus();
        });

        // Allow ESC key to clear search
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                this.dispatchEvent(new Event('input'));
                this.blur();
            }
        });
    }
});
</script>
{% endblock %}
