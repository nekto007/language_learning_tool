{% extends "base.html" %}

{% block title %}–ö–∞—Ä—Ç–æ—á–∫–∏{% endblock %}

{% block content %}
<div class="container mt-4" id="flashcard-app">
    <!-- Progress bar and stats -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="h5 fw-bold mb-1">–ü—Ä–æ–≥—Ä–µ—Å—Å</h2>
                    <p class="text-secondary mb-0 small" id="card-counter">–ö–∞—Ä—Ç–æ—á–∫–∞ 1 –∏–∑ 20</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex gap-2">
                        <span class="badge bg-info" id="new-cards-counter" title="–ù–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–µ—â—ë –Ω–µ –æ—Ç–≤–µ—á–∞–ª–∏)">–ù–æ–≤—ã—Ö: 0</span>
                        <span class="badge bg-warning text-dark" id="studied-cards-counter" title="–ö–∞—Ä—Ç–æ—á–∫–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–∑—É—á–µ–Ω–∏—è">–í –∏–∑—É—á–µ–Ω–∏–∏: 0</span>
                        <span class="badge bg-danger" id="review-cards-counter" title="–ö–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–∏">–ù–∞ –ø–æ–≤—Ç–æ—Ä: 0</span>
                    </div>
                    <button id="end-session-btn" class="btn btn-outline-secondary btn-sm">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                </div>
            </div>
            <div class="progress progress-thin">
                <div class="progress-bar bg-success progress-animated" id="progress-fill" style="width: 0%;"></div>
            </div>
        </div>
    </div>

    <!-- Loading spinner -->
    <div id="loading-spinner" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫...</p>
    </div>

    <!-- Nothing to study message -->
    {% if nothing_to_study %}
    <div id="nothing-to-study" class="card shadow-sm text-center nothing-to-study-card" style="display: none;">
        <div class="card-body">
            {% if limit_reached %}
            <div class="celebration-icon">üìö</div>
            <h2 class="mb-3">–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!</h2>
            <p class="text-muted fs-5 mb-4">
                –í—ã —É–∂–µ –∏–∑—É—á–∏–ª–∏ <strong>{{ new_cards_today }}</strong> –Ω–æ–≤—ã—Ö —Å–ª–æ–≤ —Å–µ–≥–æ–¥–Ω—è.<br>
                –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç: <strong>{{ daily_limit }}</strong> —Å–ª–æ–≤.
            </p>
            <p class="text-secondary mb-4">
                –ú–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç –≤ <a href="{{ url_for('study.settings') }}">–Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö</a> –∏–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã –æ–±—É—á–µ–Ω–∏—è.
            </p>
            {% else %}
            <div class="celebration-icon">üéâ</div>
            <h2 class="mb-3">–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –∏–∑—É—á–µ–Ω–æ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è!</h2>
            <p class="text-muted fs-5 mb-4">
                {% if deck_title %}
                –í –∫–æ–ª–æ–¥–µ <strong>"{{ deck_title }}"</strong> —Å–µ–≥–æ–¥–Ω—è –Ω–µ—á–µ–≥–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å.
                {% else %}
                –£ –≤–∞—Å –Ω–µ—Ç —Å–ª–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.
                {% endif %}
            </p>
            <p class="text-secondary mb-4">
                –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞, —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∏–∑—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞, –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã –æ–±—É—á–µ–Ω–∏—è.
            </p>
            {% endif %}

            <div class="d-flex gap-3 justify-content-center flex-wrap mt-4">
                {% if deck_id %}
                <a href="{{ url_for('study.quiz_deck', deck_id=deck_id) }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-brain me-2"></i>–ü—Ä–æ–π—Ç–∏ Quiz
                </a>
                <a href="{{ url_for('study.edit_deck', deck_id=deck_id) }}" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-edit me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–æ–¥—É
                </a>
                {% else %}
                <a href="{{ url_for('study.quiz') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-brain me-2"></i>–ü—Ä–æ–π—Ç–∏ Quiz
                </a>
                <a href="{{ url_for('study.matching') }}" class="btn btn-outline-primary btn-lg">
                    <i class="fas fa-puzzle-piece me-2"></i>–ò–≥—Ä–∞ "–ü–æ–¥–±–µ—Ä–∏ –ø–∞—Ä—É"
                </a>
                {% endif %}
                <a href="{{ url_for('study.index') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-arrow-left me-2"></i>–ù–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Cards container -->
    <div id="flashcard-view" style="display: none;">
        <!-- Front side (question) -->
        <div id="card-front" class="card shadow-sm mb-4 text-center flashcard">
            <div class="card-body d-flex flex-column align-items-center justify-content-center">
                <!-- State badge -->
                <div id="front-state-badge" class="mb-2">
                    <span id="state-badge" class="badge"></span>
                    <span id="lapses-badge" class="badge bg-secondary ms-1" style="display: none;"></span>
                </div>
                <h1 id="front-word" class="display-3 mb-4 fw-medium"></h1>

                <button id="front-audio-btn" class="btn btn-outline-secondary mb-4">
                    <i class="fas fa-volume-up me-2"></i>–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ
                </button>

                <p id="hint-text" class="text-secondary my-4 hint-text hint-text-styles"></p>

                <!-- Leech hint - shows example sentences for stuck cards -->
                <div id="leech-hint" class="alert alert-warning mt-2" style="display: none; text-align: left; font-size: 0.9rem;">
                    <i class="fas fa-lightbulb me-2"></i><strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong>
                    <div id="leech-hint-text" class="mt-1" style="white-space: pre-line;"></div>
                </div>

                <button id="show-answer-btn" class="btn btn-primary btn-lg mt-auto">
                    –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
                </button>
            </div>
        </div>

        <!-- Back side (answer) -->
        <div id="card-back" class="card shadow-sm mb-4 text-center flashcard" style="display: none;">
            <div class="card-body">
                <h1 id="back-word" class="display-3 mb-4 fw-medium"></h1>

                <button id="back-audio-btn" class="btn btn-outline-secondary mb-4">
                    <i class="fas fa-volume-up me-2"></i>–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ
                </button>

                <hr class="my-4 divider-centered">

                <div class="mb-4">
                    <div class="text-secondary mb-2 fw-semibold">–ü–µ—Ä–µ–≤–æ–¥</div>
                    <div id="translation-text" class="fs-4 text-danger"></div>
                </div>

                <div id="examples-container" class="mb-4">
                    <div class="text-secondary mb-2 fw-semibold">–ü—Ä–∏–º–µ—Ä—ã</div>
                    <div id="example-text" class="mb-2"></div>
                    <div id="example-translation" class="text-secondary"></div>
                </div>

                <!-- Rating buttons -->
                <div class="d-flex justify-content-center gap-2 mt-4">
                    <button type="button" class="rating-btn rating-btn-compact btn-danger" data-rating="1">
                        <span class="rating-icon">üòï</span> –ù–µ –∑–Ω–∞—é
                    </button>
                    <button type="button" class="rating-btn rating-btn-compact btn-warning" data-rating="2">
                        <span class="rating-icon">ü§î</span> –°–æ–º–Ω–µ–≤–∞—é—Å—å
                    </button>
                    <button type="button" class="rating-btn rating-btn-compact btn-success" data-rating="3">
                        <span class="rating-icon">üòä</span> –ó–Ω–∞—é
                    </button>
                </div>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ -->
        <div id="daily-limit-message" class="card-container text-center" style="display: none;">
            <h2 class="mb-4 text-success">
                <i class="fas fa-check-circle text-success me-2"></i>
                –£—Ä–∞! –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å—ë!
            </h2>

            <div class="mb-4">–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∏–∑—É—á–µ–Ω–∏—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç. –ï—â—ë –µ—Å—Ç—å –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏, –Ω–æ –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω. –í—ã –º–æ–∂–µ—Ç–µ —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –Ω–æ –∏–º–µ–π—Ç–µ –≤ –≤–∏–¥—É, —á—Ç–æ —á–µ–º –±–æ–ª—å—à–µ –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –≤—ã –∏–∑—É—á–∏—Ç–µ, —Ç–µ–º –±–æ–ª—å—à–µ –ø—Ä–∏–¥—ë—Ç—Å—è –ø–æ–≤—Ç–æ—Ä—è—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</div>
            <div class="mt-4">
                <div class="d-flex justify-content-center gap-3 mb-4">
                    <div class="text-center">
                        <h4 id="new-cards-stats" class="mb-2">0 / 0</h4>
                        <p class="text-muted">–ù–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</p>
                    </div>
                    <div class="text-center">
                        <h4 id="reviews-stats" class="mb-2">0 / 0</h4>
                        <p class="text-muted">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</p>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <a href="{{ url_for('study.cards', word_source='new') }}?extra_study=true" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ
                </a>

                <a href="{{ url_for('study.index') }}" class="btn btn-outline-secondary ms-2">
                    –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </a>

                <a href="{{ url_for('study.settings') }}" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </a>
            </div>
        </div>

        <!-- No cards message -->
        <div id="no-cards-message" class="alert alert-info text-center" style="display: none;">
            <h4>–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</h4>
            <p>–ù–µ—Ç —Å–ª–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –æ–±—É—á–µ–Ω–∏—è.</p>
            <a href="{{ url_for('study.index') }}" class="btn btn-primary mt-2">
                –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—É—á–µ–Ω–∏—é
            </a>
        </div>

        <!-- No cards / Session complete message -->
        <div id="no-cards-in-source-message" class="session-done-screen" style="display: none;">
            <div class="session-done-content">
                <h1 class="session-done-title" id="no-cards-title">–£—Ä–∞! –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å—ë.</h1>

                <!-- Session stats -->
                <div class="session-done-stats" id="session-stats-block">
                    <p class="session-stats-label">–í —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ –∏–∑—É—á–µ–Ω–æ:</p>
                    <div class="session-stats-row">
                        <span class="stat-badge stat-new"><span id="session-new-count">0</span> –Ω–æ–≤—ã—Ö</span>
                        <span class="stat-badge stat-learning"><span id="session-learning-count">0</span> –≤ –∏–∑—É—á–µ–Ω–∏–∏</span>
                        <span class="stat-badge stat-review"><span id="session-review-count">0</span> –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</span>
                    </div>
                </div>

                <!-- Extra study offer -->
                <p class="session-done-extra" id="extra-study-text">
                    –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –≤–Ω–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, –Ω–∞—á–Ω–∏—Ç–µ
                    <a href="#" id="extra-study-link" class="extra-study-link">–¥–æ–ø–∑–∞–Ω—è—Ç–∏–µ</a>.
                </p>

                <a href="{{ url_for('study.index') }}" class="session-done-back">
                    <i class="fas fa-arrow-left me-2"></i>–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—É—á–µ–Ω–∏—é
                </a>
            </div>
        </div>

        <style>
            .session-done-screen {
                padding: 3rem 1.5rem;
                text-align: center;
            }

            .session-done-content {
                max-width: 400px;
                margin: 0 auto;
            }

            .session-done-title {
                font-size: 1.75rem;
                font-weight: 600;
                color: var(--text-primary, #1f2937);
                margin-bottom: 1.5rem;
            }

            .session-done-stats {
                background: var(--gray-50, #f9fafb);
                border-radius: 12px;
                padding: 1rem 1.25rem;
                margin-bottom: 1.5rem;
            }

            .session-stats-label {
                font-size: 0.875rem;
                color: var(--text-secondary, #6b7280);
                margin-bottom: 0.75rem;
            }

            .session-stats-row {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            .stat-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                padding: 0.375rem 0.75rem;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 500;
            }

            .stat-badge.stat-new {
                background: #dbeafe;
                color: #1d4ed8;
            }

            .stat-badge.stat-learning {
                background: #fef3c7;
                color: #b45309;
            }

            .stat-badge.stat-review {
                background: #dcfce7;
                color: #15803d;
            }

            .session-done-extra {
                font-size: 0.95rem;
                color: var(--text-secondary, #6b7280);
                margin-bottom: 2rem;
                line-height: 1.6;
            }

            .extra-study-link {
                color: var(--primary-600, #4f46e5);
                text-decoration: none;
                font-weight: 500;
            }

            .extra-study-link:hover {
                text-decoration: underline;
            }

            .session-done-back {
                display: inline-flex;
                align-items: center;
                color: var(--text-secondary, #6b7280);
                text-decoration: none;
                font-size: 0.9rem;
                transition: color 0.2s;
            }

            .session-done-back:hover {
                color: var(--text-primary, #1f2937);
            }
        </style>

        <!-- Session complete message - Celebration Screen -->
        <div id="session-complete" class="celebration-screen" style="display: none;">
            <!-- Confetti canvas -->
            <canvas id="confetti-canvas"></canvas>

            <div class="celebration-content">
                <!-- Trophy/Success icon -->
                <div class="celebration-icon-wrapper">
                    <div class="celebration-icon">
                        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="32" cy="32" r="28" fill="url(#celebGrad)" />
                            <path d="M20 32L28 40L44 24" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" class="checkmark-path"/>
                            <defs>
                                <linearGradient id="celebGrad" x1="4" y1="4" x2="60" y2="60" gradientUnits="userSpaceOnUse">
                                    <stop stop-color="#10b981"/>
                                    <stop offset="1" stop-color="#059669"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <div class="celebration-rings">
                        <div class="ring ring-1"></div>
                        <div class="ring ring-2"></div>
                        <div class="ring ring-3"></div>
                    </div>
                </div>

                <!-- Title -->
                <h1 class="celebration-title" id="celebration-title">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>

                <!-- Stats grid -->
                <div class="celebration-stats">
                    <div class="stat-card stat-cards-studied">
                        <div class="stat-value" id="stats-words">0</div>
                        <div class="stat-label">–∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑—É—á–µ–Ω–æ</div>
                    </div>

                    <div class="stat-card stat-accuracy">
                        <div class="accuracy-ring-wrapper">
                            <svg class="accuracy-ring" viewBox="0 0 80 80">
                                <circle cx="40" cy="40" r="34" fill="none" stroke="#e5e7eb" stroke-width="6"/>
                                <circle cx="40" cy="40" r="34" fill="none" stroke="url(#accuracyGrad)" stroke-width="6"
                                        stroke-linecap="round" stroke-dasharray="213.6" stroke-dashoffset="213.6"
                                        class="accuracy-progress" transform="rotate(-90 40 40)"/>
                                <defs>
                                    <linearGradient id="accuracyGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" stop-color="#f59e0b"/>
                                        <stop offset="100%" stop-color="#10b981"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="accuracy-value">
                                <span id="stats-score">0</span><small>%</small>
                            </div>
                        </div>
                        <div class="stat-label">—Ç–æ—á–Ω–æ—Å—Ç—å</div>
                    </div>

                    <div class="stat-card stat-correct">
                        <div class="stat-value" id="stats-correct">0</div>
                        <div class="stat-label">–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö</div>
                    </div>
                </div>

                <!-- XP earned with animation -->
                <div class="xp-reward">
                    <div class="xp-badge">
                        <span class="xp-lightning">‚ö°</span>
                        <span class="xp-amount">+<span id="xp-earned-amount">0</span></span>
                        <span class="xp-label">XP</span>
                    </div>
                    <div class="xp-level-info">
                        –£—Ä–æ–≤–µ–Ω—å <span id="current-level">1</span>
                    </div>
                </div>
                <span id="total-xp" style="display:none;">0</span>

                <!-- Action buttons -->
                <div class="celebration-actions">
                    <!-- Extra study button (shown conditionally) -->
                    <a href="#" id="session-extra-study-link" class="btn-extra-study" style="display: none;">
                        <span class="btn-icon">üî•</span>
                        –ï—â—ë –∫–∞—Ä—Ç–æ—á–∫–∏
                    </a>

                    <a href="{{ url_for('study.index') }}" class="btn-back-home">
                        <i class="fas fa-arrow-left"></i>
                        <span>–ö –æ–±—É—á–µ–Ω–∏—é</span>
                    </a>
                </div>

                <!-- Hidden element for extra study text state -->
                <span id="session-extra-study-text" style="display: none;"></span>
            </div>
        </div>

        <style>
            /* Font import */
            @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&display=swap');

            /* ============================================
               CELEBRATION SCREEN - Achievement Unlocked!
               ============================================ */

            .celebration-screen {
                position: relative;
                padding: 2rem 1rem 3rem;
                min-height: 70vh;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }

            #confetti-canvas {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 1;
            }

            .celebration-content {
                position: relative;
                z-index: 2;
                max-width: 380px;
                width: 100%;
                text-align: center;
            }

            /* Icon with animated rings */
            .celebration-icon-wrapper {
                position: relative;
                width: 100px;
                height: 100px;
                margin: 0 auto 1.5rem;
            }

            .celebration-icon {
                position: relative;
                z-index: 2;
                width: 80px;
                height: 80px;
                margin: 10px auto;
                animation: iconPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
                opacity: 0;
                transform: scale(0);
            }

            .celebration-icon svg {
                width: 100%;
                height: 100%;
                filter: drop-shadow(0 4px 12px rgba(16, 185, 129, 0.4));
            }

            .checkmark-path {
                stroke-dasharray: 40;
                stroke-dashoffset: 40;
                animation: drawCheck 0.5s ease-out 0.4s forwards;
            }

            .celebration-rings {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 100%;
                height: 100%;
            }

            .ring {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                border-radius: 50%;
                border: 2px solid rgba(16, 185, 129, 0.3);
                opacity: 0;
            }

            .ring-1 {
                width: 90px;
                height: 90px;
                animation: ringPulse 1.5s ease-out 0.2s infinite;
            }

            .ring-2 {
                width: 110px;
                height: 110px;
                animation: ringPulse 1.5s ease-out 0.5s infinite;
            }

            .ring-3 {
                width: 130px;
                height: 130px;
                animation: ringPulse 1.5s ease-out 0.8s infinite;
            }

            /* Title */
            .celebration-title {
                font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
                font-size: 1.625rem;
                font-weight: 800;
                color: #1f2937;
                margin: 0 0 1.75rem;
                animation: fadeSlideUp 0.5s ease-out 0.3s forwards;
                opacity: 0;
                transform: translateY(10px);
            }

            /* Stats grid */
            .celebration-stats {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 0.75rem;
                margin-bottom: 1.5rem;
                animation: fadeSlideUp 0.5s ease-out 0.5s forwards;
                opacity: 0;
                transform: translateY(10px);
            }

            .stat-card {
                background: #f9fafb;
                border-radius: 16px;
                padding: 1rem 0.5rem;
                transition: transform 0.2s, box-shadow 0.2s;
            }

            .stat-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }

            .stat-value {
                font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
                font-size: 1.75rem;
                font-weight: 800;
                color: #1f2937;
                line-height: 1;
            }

            .stat-cards-studied .stat-value {
                color: #4f46e5;
            }

            .stat-correct .stat-value {
                color: #10b981;
            }

            .stat-label {
                font-size: 0.75rem;
                color: #6b7280;
                margin-top: 0.375rem;
                font-weight: 500;
            }

            /* Accuracy ring */
            .stat-accuracy {
                position: relative;
            }

            .accuracy-ring-wrapper {
                position: relative;
                width: 70px;
                height: 70px;
                margin: -0.25rem auto 0;
            }

            .accuracy-ring {
                width: 100%;
                height: 100%;
            }

            .accuracy-progress {
                transition: stroke-dashoffset 1s ease-out;
            }

            .accuracy-value {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
                font-size: 1.125rem;
                font-weight: 800;
                color: #f59e0b;
            }

            .accuracy-value small {
                font-size: 0.625rem;
                font-weight: 600;
            }

            /* XP reward */
            .xp-reward {
                margin-bottom: 2rem;
                animation: fadeSlideUp 0.5s ease-out 0.7s forwards;
                opacity: 0;
                transform: translateY(10px);
            }

            .xp-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                padding: 0.625rem 1.25rem;
                border-radius: 50px;
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.25);
                animation: xpPulse 2s ease-in-out infinite;
            }

            .xp-lightning {
                font-size: 1.125rem;
                animation: lightningBounce 0.6s ease-out 1s;
            }

            .xp-amount {
                font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
                font-size: 1.375rem;
                font-weight: 800;
                color: #b45309;
            }

            .xp-label {
                font-size: 0.875rem;
                font-weight: 700;
                color: #d97706;
            }

            .xp-level-info {
                margin-top: 0.5rem;
                font-size: 0.8125rem;
                color: #6b7280;
                font-weight: 500;
            }

            /* Action buttons */
            .celebration-actions {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                align-items: center;
                animation: fadeSlideUp 0.5s ease-out 0.9s forwards;
                opacity: 0;
                transform: translateY(10px);
            }

            .btn-extra-study {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 0.875rem 1.75rem;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 700;
                text-decoration: none;
                box-shadow: 0 4px 14px rgba(16, 185, 129, 0.35);
                transition: transform 0.2s, box-shadow 0.2s;
            }

            .btn-extra-study:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(16, 185, 129, 0.45);
                color: white;
            }

            .btn-extra-study .btn-icon {
                font-size: 1.125rem;
            }

            .btn-back-home {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                color: #6b7280;
                padding: 0.75rem 1rem;
                font-size: 0.9375rem;
                font-weight: 500;
                text-decoration: none;
                transition: color 0.2s;
            }

            .btn-back-home:hover {
                color: #1f2937;
            }

            .btn-back-home i {
                font-size: 0.875rem;
            }

            /* ============================================
               ANIMATIONS
               ============================================ */

            @keyframes iconPop {
                0% {
                    opacity: 0;
                    transform: scale(0);
                }
                50% {
                    transform: scale(1.2);
                }
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            @keyframes drawCheck {
                to {
                    stroke-dashoffset: 0;
                }
            }

            @keyframes ringPulse {
                0% {
                    opacity: 0.6;
                    transform: translate(-50%, -50%) scale(0.8);
                }
                100% {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(1.3);
                }
            }

            @keyframes fadeSlideUp {
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes xpPulse {
                0%, 100% {
                    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.25);
                }
                50% {
                    box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4);
                }
            }

            @keyframes lightningBounce {
                0%, 100% {
                    transform: translateY(0);
                }
                25% {
                    transform: translateY(-4px);
                }
                50% {
                    transform: translateY(0);
                }
                75% {
                    transform: translateY(-2px);
                }
            }

            /* ============================================
               RESPONSIVE
               ============================================ */

            @media (max-width: 400px) {
                .celebration-stats {
                    grid-template-columns: 1fr;
                    gap: 0.625rem;
                }

                .stat-card {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 0.875rem 1rem;
                }

                .stat-accuracy {
                    flex-direction: row-reverse;
                }

                .accuracy-ring-wrapper {
                    width: 50px;
                    height: 50px;
                    margin: 0;
                }

                .stat-label {
                    margin-top: 0;
                }
            }
        </style>
    </div>
</div>

<!-- Audio element (hidden) -->
<audio id="word-audio" style="display: none;"></audio>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Config from server
        const sessionId = {{ session_id }};
        const wordSource = '{{ word_source }}';
        const deckId = {{ deck_id|default('null') }};
        const nothingToStudy = {{ 'true' if nothing_to_study else 'false' }};
        const showTranslations = {{ settings.include_translations|lower }};
        const showExamples = {{ settings.include_examples|lower }};
        const playAudio = {{ settings.include_audio|lower }};
        const hintTime = 7; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ - 5 —Å–µ–∫—É–Ω–¥

        // If nothing to study, hide UI and show message
        if (nothingToStudy) {
            document.getElementById('loading-spinner').style.display = 'none';
            document.querySelector('.card.shadow-sm.mb-4').style.display = 'none'; // Hide progress bar
            document.getElementById('nothing-to-study').style.display = 'block';
            return; // Don't initialize the rest of the app
        }

        // App state
        let originalCards = []; // Original cards from API
        let cards = [];         // Processed cards with both directions
        let currentCardIndex = 0;
        let sessionStartTime = Date.now();
        let sessionStats = {
            total: 0,
            correct: 0,
            incorrect: 0,
            new_cards: 0,
            learning_cards: 0,
            review_cards: 0
        };
        let hintTimeout = null;

        // Anti-repeat: track recently shown card IDs
        const recentCardIds = [];
        const RECENT_CARDS_LIMIT = 5;  // Keep last 5 card IDs to exclude

        // Track if more cards are available (for extra study option)
        let hasMoreNewCards = false;
        let hasMoreReviewCards = false;

        // Fun completion messages
        const completionMessages = [
            'Done ‚úÖ',
            '–ì–æ—Ç–æ–≤–æ.',
            '–ö—Ä–∞—Å–∞–≤–∞.',
            'Good job.',
            'Nice.',
            'Keep going.',
            '–ï–¥–µ–º –¥–∞–ª—å—à–µ.',
            'Mission complete ‚úÖ',
            'Brain gains üí™',
            'Vocabulary +1. –õ–µ–≥–µ–Ω–¥–∞.',
            '–ö–∞—Ä—Ç–æ—á–∫–∏? –†–∞–∑–æ–±—Ä–∞–ª(–∞).',
            '–¢—ã –¥–µ—Ä–∂–∏—à—å —Ç–µ–º–ø ‚Äî —ç—Ç–æ –∫—Ä—É—Ç–æ.',
            '–ú–∞–ª–µ–Ω—å–∫–∞—è –ø–æ–±–µ–¥–∞ –¥–Ω—è ‚úÖ',
            '–¢–≤–æ–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ä–∞—Å—Ç—ë—Ç üå±',
            'Flipped. Learned. Dominated.'
        ];

        function getRandomCompletionMessage() {
            return completionMessages[Math.floor(Math.random() * completionMessages.length)];
        }

        // State configuration for display
        const STATE_CONFIG = {
            'new': { label: '–ù–û–í–ê–Ø', class: 'bg-info', color: '#17a2b8' },
            'learning': { label: '–ò–ó–£–ß–ï–ù–ò–ï', class: 'bg-warning text-dark', color: '#ffc107' },
            'review': { label: '–ü–û–í–¢–û–†', class: 'bg-success', color: '#28a745' },
            'relearning': { label: '–ü–ï–†–ï–£–ß–ò–í–ê–ù–ò–ï', class: 'bg-danger', color: '#dc3545' }
        };

        // Update state badge based on card state
        function updateStateDisplay(card) {
            const state = card.state || 'new';
            const stepIndex = card.step_index || 0;
            const lapses = card.lapses || 0;

            // Update state badge
            if (stateBadge) {
                const config = STATE_CONFIG[state] || STATE_CONFIG['new'];
                stateBadge.textContent = config.label;
                stateBadge.className = 'badge ' + config.class;
            }

            // Update lapses badge (show only for relearning or if lapses > 0)
            if (lapsesBadge) {
                if (lapses > 0) {
                    lapsesBadge.textContent = `–ü—Ä–æ–≤–∞–ª–æ–≤: ${lapses}`;
                    lapsesBadge.style.display = 'inline-block';
                } else {
                    lapsesBadge.style.display = 'none';
                }
            }

        }

        // DOM elements
        const flashcardView = document.getElementById('flashcard-view');
        const cardFront = document.getElementById('card-front');
        const cardBack = document.getElementById('card-back');
        const frontWord = document.getElementById('front-word');
        const backWord = document.getElementById('back-word');
        const frontAudioBtn = document.getElementById('front-audio-btn');
        const backAudioBtn = document.getElementById('back-audio-btn');
        const translationText = document.getElementById('translation-text');
        const examplesContainer = document.getElementById('examples-container');
        const exampleText = document.getElementById('example-text');
        const exampleTranslation = document.getElementById('example-translation');
        const hintText = document.getElementById('hint-text');
        const leechHint = document.getElementById('leech-hint');
        const leechHintText = document.getElementById('leech-hint-text');
        const cardCounter = document.getElementById('card-counter');
        const correctCounter = document.getElementById('correct-counter');
        const incorrectCounter = document.getElementById('incorrect-counter');
        const newCardsCounter = document.getElementById('new-cards-counter');
        const studiedCardsCounter = document.getElementById('studied-cards-counter');
        const reviewCardsCounter = document.getElementById('review-cards-counter');
        const progressFill = document.getElementById('progress-fill');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noCardsMessage = document.getElementById('no-cards-message');
        const dailyLimitMessage = document.getElementById('daily-limit-message');
        const sessionComplete = document.getElementById('session-complete');
        const wordAudio = document.getElementById('word-audio');
        const endSessionBtn = document.getElementById('end-session-btn');
        const newCardsStats = document.getElementById('new-cards-stats');
        const reviewsStats = document.getElementById('reviews-stats');
        const stateBadge = document.getElementById('state-badge');
        const lapsesBadge = document.getElementById('lapses-badge');

        // Stats elements
        const statsWords = document.getElementById('stats-words');
        const statsCorrect = document.getElementById('stats-correct');
        const statsScore = document.getElementById('stats-score');

        // Fetch cards from the API
        async function fetchCards() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—Ä–æ—à–µ–Ω–æ –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ
                const extraStudy = new URLSearchParams(window.location.search).get('extra_study') === 'true';

                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ —ç—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ
                let url = `/study/api/get-study-items?source=${wordSource}${extraStudy ? '&extra_study=true' : ''}`;

                // –î–æ–±–∞–≤–ª—è–µ–º deck_id –µ—Å–ª–∏ –µ—Å—Ç—å
                if (deckId) {
                    url += `&deck_id=${deckId}`;
                }

                // Anti-repeat: –∏—Å–∫–ª—é—á–∞–µ–º –Ω–µ–¥–∞–≤–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                if (recentCardIds.length > 0) {
                    url += `&exclude_card_ids=${recentCardIds.join(',')}`;
                }

                const response = await fetch(url);


                if (!response.ok) {
                    throw new Error('Failed to fetch cards');
                }

                const data = await response.json();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (data.status === 'daily_limit_reached') {
                    showDailyLimitMessage(data.stats);
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ
                    window.noCardsMessageShown = true;
                    return [];
                }

                if (data.status === 'success' && (!data.items || data.items.length === 0)) {

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ –¥–æ—Å—Ç—É–ø–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è
                    const remainingNewCards = data.stats.new_cards_limit - data.stats.new_cards_today;
                    const remainingReviews = data.stats.reviews_limit - data.stats.reviews_today;

                    if (remainingNewCards > 0 || remainingReviews > 0) {
                        // –ï—Å–ª–∏ –µ—â–µ –µ—Å—Ç—å –ª–∏–º–∏—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º,
                        // —á—Ç–æ –≤ —ç—Ç–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫, –Ω–æ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
                        showNoCardsInSourceMessage(data.stats);
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ
                        window.noCardsMessageShown = true;
                    } else {
                        // –ï—Å–ª–∏ –ª–∏–º–∏—Ç—ã –∏—Å—á–µ—Ä–ø–∞–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
                        showNoCardsMessage();
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ
                        window.noCardsMessageShown = true;
                    }
                    return [];
                }

                // Store has_more flags for extra study option
                if (data.stats) {
                    hasMoreNewCards = data.stats.has_more_new || false;
                    hasMoreReviewCards = data.stats.has_more_reviews || false;
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∫ –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –∫–∞—Ä—Ç–æ—á–∫–∞–º
                const filteredData = data.items.filter(card => card.translation && card.translation.trim() !== '');

                return filteredData;
            } catch (error) {
                console.error('Error fetching cards:', error);
                showNoCardsMessage();
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ
                window.noCardsMessageShown = true;
                return [];
            }
        }

        function showNoCardsInSourceMessage(stats) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë –ª–∏—à–Ω–µ–µ
            loadingSpinner.style.display = 'none';
            if (cardFront) cardFront.style.display = 'none';
            if (cardBack) cardBack.style.display = 'none';
            if (noCardsMessage) noCardsMessage.style.display = 'none';
            if (sessionComplete) sessionComplete.style.display = 'none';
            if (dailyLimitMessage) dailyLimitMessage.style.display = 'none';

            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            const progressBar = document.querySelector('.card.shadow-sm.mb-4');
            if (progressBar) progressBar.style.display = 'none';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º flashcardView
            flashcardView.style.display = 'block';

            const noCardsInSourceMessage = document.getElementById('no-cards-in-source-message');
            if (!noCardsInSourceMessage) {
                window.noCardsMessageShown = true;
                return;
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            const hasMoreCards = stats.has_more_new || stats.has_more_reviews;

            // –†–∞–Ω–¥–æ–º–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const title = document.getElementById('no-cards-title');
            if (title) {
                title.textContent = getRandomCompletionMessage();
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ—Å—Å–∏–∏
            const sessionNewCount = document.getElementById('session-new-count');
            const sessionLearningCount = document.getElementById('session-learning-count');
            const sessionReviewCount = document.getElementById('session-review-count');

            if (sessionNewCount) sessionNewCount.textContent = stats.new_cards_today || 0;
            if (sessionLearningCount) sessionLearningCount.textContent = sessionStats.learning_cards || 0;
            if (sessionReviewCount) sessionReviewCount.textContent = stats.reviews_today || 0;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ø–∑–∞–Ω—è—Ç–∏—è
            const extraStudyText = document.getElementById('extra-study-text');
            const extraStudyLink = document.getElementById('extra-study-link');

            if (hasMoreCards && extraStudyText && extraStudyLink) {
                extraStudyText.style.display = 'block';
                // –°—Ç—Ä–æ–∏–º URL
                let extraUrl = deckId
                    ? `/study/cards/deck/${deckId}?extra_study=true`
                    : '{{ url_for("study.cards") }}?extra_study=true';
                extraStudyLink.href = extraUrl;
            } else if (extraStudyText) {
                extraStudyText.style.display = 'none';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
            noCardsInSourceMessage.style.display = 'block';

            window.noCardsMessageShown = true;
        }


        // Create alternating cards (eng-rus, rus-eng) from original cards
        // Shuffle only first N cards to preserve SRS priority for later cards
        const SHUFFLE_WINDOW = 30;  // Shuffle only first 30 cards

        function createAlternatingCards(originalCards) {
            if (!originalCards || originalCards.length === 0) {
                return [];
            }

            // API already returns cards with correct directions - just pass them through
            // Shuffle only first SHUFFLE_WINDOW cards to preserve SRS timeliness
            const cardsToShuffle = originalCards.slice(0, SHUFFLE_WINDOW);
            const remainingCards = originalCards.slice(SHUFFLE_WINDOW);

            return [...shuffleCards(cardsToShuffle), ...remainingCards];
        }

        // Shuffle cards while keeping same words apart from each other
        function shuffleCards(cards) {
            if (!cards || cards.length === 0) {
                return [];
            }

            // Group cards by word_id
            const cardsByWordId = {};
            for (const card of cards) {
                if (!cardsByWordId[card.word_id]) {
                    cardsByWordId[card.word_id] = [];
                }
                cardsByWordId[card.word_id].push(card);
            }

            // Create shuffled word_id array
            const wordIds = Object.keys(cardsByWordId);
            for (let i = wordIds.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [wordIds[i], wordIds[j]] = [wordIds[j], wordIds[i]];
            }

            // Rebuild cards array with randomized directions
            const shuffledCards = [];

            for (const wordId of wordIds) {
                const cardsForWord = cardsByWordId[wordId];

                // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞ (—Ä–∞–Ω–¥–æ–º–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π)
                const shuffledDirections = [...cardsForWord];
                for (let i = shuffledDirections.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledDirections[i], shuffledDirections[j]] = [shuffledDirections[j], shuffledDirections[i]];
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞
                shuffledCards.push(...shuffledDirections);
            }

            return shuffledCards;
        }

        // Format hint with first letter and underscores showing the length of the word
        function formatHint(word) {
            if (!word || word.length === 0) return '';

            // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π
            let targetWord = word;
            if (word.includes(',')) {
                targetWord = word.split(',')[0].trim();
            }

            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–ª–æ–≤ (1-2 –±—É–∫–≤—ã) - –æ–Ω–∞ –±—ã —Ä–∞—Å–∫—Ä—ã–ª–∞ –æ—Ç–≤–µ—Ç
            if (targetWord.length <= 2) {
                return '';
            }

            const firstChar = targetWord.charAt(0).toLowerCase();
            const underscores = '_'.repeat(Math.min(targetWord.length - 1, 8));
            const letterCount = targetWord.length;

            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
            let letterForm = '–±—É–∫–≤';
            const lastDigit = letterCount % 10;

            if (letterCount % 100 >= 11 && letterCount % 100 <= 19) {
                letterForm = '–±—É–∫–≤';
            } else if (lastDigit === 1) {
                letterForm = '–±—É–∫–≤–∞';
            } else if (lastDigit >= 2 && lastDigit <= 4) {
                letterForm = '–±—É–∫–≤—ã';
            }

            return `–ü–æ–¥—Å–∫–∞–∑–∫–∞: ${firstChar}${underscores} (${letterCount} ${letterForm})`;
        }

        // Show daily limit reached message
        function showDailyLimitMessage(stats) {
            loadingSpinner.style.display = 'none';
            flashcardView.style.display = 'block';
            cardFront.style.display = 'none';
            cardBack.style.display = 'none';
            noCardsMessage.style.display = 'none';
            sessionComplete.style.display = 'none';

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if (newCardsStats) {
                newCardsStats.textContent = `${stats.new_cards_today} / ${stats.new_cards_limit}`;
            }

            if (reviewsStats) {
                reviewsStats.textContent = `${stats.reviews_today} / ${stats.reviews_limit}`;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –¥–Ω–µ–≤–Ω–æ–º –ª–∏–º–∏—Ç–µ
            dailyLimitMessage.style.display = 'block';
        }

        // Initialize the flashcard app
        async function initApp() {

            try {
                // Fetch original cards
                originalCards = await fetchCards();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ - –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ, –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                if (window.noCardsMessageShown) {
                    return;
                }

                if (!originalCards || originalCards.length === 0) {
                    showNoCardsMessage();
                    return;
                }

                // Create alternating cards
                cards = createAlternatingCards(originalCards);

                if (!cards || cards.length === 0) {
                    showNoCardsMessage();
                    return;
                }

                // Count cards by state:
                // - –ù–æ–≤—ã—Ö = state === 'new' (never answered)
                // - –í –∏–∑—É—á–µ–Ω–∏–∏ = state === 'learning' OR 'relearning' (in learning mode)
                // - –ù–∞ –ø–æ–≤—Ç–æ—Ä = state === 'review' (scheduled interval review)
                let newCount = 0;
                let learningCount = 0;
                let reviewCount = 0;

                for (let card of cards) {
                    if (card.state === 'new') {
                        // Card never answered
                        newCount++;
                    } else if (card.state === 'learning' || card.state === 'relearning') {
                        // Card in learning/relearning mode
                        learningCount++;
                    } else if (card.state === 'review') {
                        // Card on interval review
                        reviewCount++;
                    }
                }

                sessionStats.new_cards = newCount;
                sessionStats.learning_cards = learningCount;
                sessionStats.review_cards = reviewCount;

                // Update counters
                if (newCardsCounter) {
                    newCardsCounter.textContent = `–ù–æ–≤—ã—Ö: ${newCount}`;
                }
                if (studiedCardsCounter) {
                    studiedCardsCounter.textContent = `–í –∏–∑—É—á–µ–Ω–∏–∏: ${learningCount}`;
                }
                if (reviewCardsCounter) {
                    reviewCardsCounter.textContent = `–ù–∞ –ø–æ–≤—Ç–æ—Ä: ${reviewCount}`;
                }

                // Update UI
                loadingSpinner.style.display = 'none';
                flashcardView.style.display = 'block';

                // Show first card
                showCard(0);
            } catch (error) {
                console.error('Error during initialization:', error);
                loadingSpinner.style.display = 'none';
                noCardsMessage.style.display = 'block';
            }
        }

        // Display a card
        function showCard(index) {

            if (!cards || cards.length === 0) {
                showNoCardsMessage();
                return;
            }

            if (index >= cards.length) {
                completeSession(hasMoreNewCards, hasMoreReviewCards);
                return;
            }

            const card = cards[index];
            currentCardIndex = index;

            // Update state badge and button hints
            updateStateDisplay(card);

            // Update progress
            const progress = ((index + 1) / cards.length) * 100;
            progressFill.style.width = `${progress}%`;
            cardCounter.textContent = `–ö–∞—Ä—Ç–æ—á–∫–∞ ${index + 1} –∏–∑ ${cards.length}`;

            // Reset card state
            cardFront.style.display = 'flex';
            cardBack.style.display = 'none';
            showAnswerBtn.style.display = 'block';
            hintText.classList.remove('visible');

            // Clear previous hint timeout
            if (hintTimeout) {
                clearTimeout(hintTimeout);
            }
            frontAudioBtn.hidden = true;  // –ø—Ä—è—á–µ–º ¬´–ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ¬ª —Å–ø–µ—Ä–µ–¥–∏
            backAudioBtn.hidden  = true;  // –∏ —Å–∑–∞–¥–∏, –ø–æ–∫–∞ –Ω–µ —Ä–µ—à–∏–º –∏–Ω–∞—á–µ

            // Configure audio buttons
            const hasAudio = card.audio_url !== null;

            const isEngToRu = card.direction === 'eng-rus';

            // Set card content based on direction
            frontWord.textContent = card.word;        // –≤—Å–µ–≥–¥–∞ word
            backWord.textContent  = card.word;        // —Ç–æ–∂–µ word
            translationText.textContent = card.translation;

            // –ø–æ–¥—Å–∫–∞–∑–∫–∞
            const hint = formatHint(card.translation);
            hintText.textContent = hint;
            // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –µ—Å–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø—É—Å—Ç–∞—è
            hintText.style.display = hint ? '' : 'none';

            // Leech hint - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è "–∑–∞–ª–∏–ø—à–∏—Ö" –∫–∞—Ä—Ç–æ—á–µ–∫ (6+ –ø—Ä–æ–≤–∞–ª–æ–≤)
            if (card.is_leech && card.leech_hint) {
                leechHint.style.display = 'block';
                leechHintText.textContent = card.leech_hint;
            } else {
                leechHint.style.display = 'none';
                leechHintText.textContent = '';
            }

            if (hasAudio && playAudio) {
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞—É–¥–∏–æ –∏—Å—Ç–æ—á–Ω–∏–∫
                if (card.audio_url) {
                    wordAudio.src = card.audio_url;
                }
                
                // –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–æ–∫ –∞—É–¥–∏–æ –∏ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                if (card.direction === 'eng-rus') {
                    // –î–ª—è eng-rus –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
                    frontAudioBtn.hidden = false;
                    backAudioBtn.hidden = false; // –¢–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
                    
                    // –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è eng-rus –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
                    setTimeout(() => {
                        wordAudio.play().catch(error => {
                        });
                    }, 300);
                } else {
                    // –î–ª—è rus-eng –∫–∞—Ä—Ç–æ—á–µ–∫ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
                    frontAudioBtn.hidden = true;
                    backAudioBtn.hidden = false; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
                    
                    // –ù–ï–¢ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ –¥–ª—è rus-eng
                }
            } else {
                frontAudioBtn.hidden = true;
                backAudioBtn.hidden = true;
            }

            // Show hint after specified time (only if hint exists)
            if (hint) {
                hintTimeout = setTimeout(() => {
                    hintText.classList.add('visible');
                }, hintTime * 1000);
            }

            // Set example if available
            if (showExamples && card.examples) {
                const example = extractExampleParts(card.examples);

                exampleText.textContent = example.en;
                exampleTranslation.textContent = example.ru;
                examplesContainer.style.display = 'block';
            } else {
                examplesContainer.style.display = 'none';
            }
        }

        // Extract English and Russian parts from examples
        function extractExampleParts(examples) {
            if (!examples) return { en: '', ru: '' };

            // Replace HTML tags with nothing
            // const cleanedExamples = examples.replace(/<[^>]*>/g, '');
            const withNewlines = examples.replace(/<br\s*\/?>/gi, '\n');
            const cleanedExamples = withNewlines.replace(/<[^>]*>/g, '');

            // Split by newlines first
            let lines = cleanedExamples.split('\n').filter(line => line.trim() !== '');

            if (lines.length >= 2) {
                return {
                    en: lines[0].trim(),
                    ru: lines[1].trim()
                };
            }

            // Check if there's a dash at the beginning of a line
            lines = cleanedExamples.split(/\n\s*-\s*/).filter(line => line.trim() !== '');
            if (lines.length >= 2) {
                return {
                    en: lines[0].trim(),
                    ru: lines[1].trim()
                };
            }

            // If no obvious separator found, try to detect if there's English and Russian text
            // This is a simplified approach - assumes English has Latin characters and Russian has Cyrillic
            const hasCyrillic = /[–ê-–Ø–∞-—è]/.test(cleanedExamples);
            const hasLatin = /[A-Za-z]/.test(cleanedExamples);

            if (hasCyrillic && hasLatin) {
                // Try to split by common punctuation that might separate examples
                const parts = cleanedExamples.split(/[;.]\s*/).filter(part => part.trim() !== '');

                // Find first part with Latin and first part with Cyrillic
                const enPart = parts.find(part => /[A-Za-z]/.test(part)) || '';
                const ruPart = parts.find(part => /[–ê-–Ø–∞-—è]/.test(part)) || '';

                return {
                    en: enPart.trim(),
                    ru: ruPart.trim()
                };
            }

            // If nothing else works, just return the whole text
            return {
                en: cleanedExamples.trim(),
                ru: ''
            };
        }

        // Flip card to show answer
        function flipCard() {
            cardFront.style.display = 'none';
            cardBack.style.display = 'flex';

            // Clear hint timeout
            if (hintTimeout) {
                clearTimeout(hintTimeout);
                hintTimeout = null;
            }

            // –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è rus-eng –∫–∞—Ä—Ç–æ—á–µ–∫
            const card = cards[currentCardIndex];
            if (card.audio_url && playAudio) {
                setTimeout(() => {
                    wordAudio.play().catch(error => {
                        console.log('Audio playback failed:', error);
                    });
                }, 300);
            }
        }

        // Session attempts tracking for requeue limit (max 3 shows per card)
        const sessionAttempts = {};  // card_key ‚Üí count
        const MAX_SESSION_ATTEMPTS = 3;

        // Rate a card and move to the next (Unified 1-2-3 scale)
        async function rateCard(rating) {
            if (!cards || currentCardIndex >= cards.length) {
                console.error('Cannot rate card - invalid card index');
                return;
            }
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            const csrfToken = csrfMeta && csrfMeta.content;
            const card = cards[currentCardIndex];

            // Track session attempts for this card+direction
            const cardKey = `${card.word_id}_${card.direction}`;
            sessionAttempts[cardKey] = (sessionAttempts[cardKey] || 0) + 1;

            try {
                // Send rating to server with direction (unified 1-2-3 scale)
                const response = await fetch('/study/api/update-study-item', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(csrfToken && { 'X-CSRFToken': csrfToken }),
                    },
                    body: JSON.stringify({
                        word_id: card.word_id,
                        direction: card.direction,
                        quality: rating,  // Unified 1-2-3 scale (backward compatible)
                        session_id: sessionId,
                        is_new: card.is_new,
                        deck_id: deckId,  // For per-deck limit checking
                        extra_study: new URLSearchParams(window.location.search).get('extra_study') === 'true'
                    }),
                });

                // Check if response is OK and JSON
                const contentType = response.headers.get('content-type');
                if (!response.ok || !contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Server error:', response.status, 'Content-Type:', contentType, 'Body:', text.substring(0, 500));
                    alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    window.location.reload();
                    return;
                }

                const data = await response.json();

                // Anti-repeat: –¥–æ–±–∞–≤–ª—è–µ–º card_id –≤ —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–∞–≤–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö
                if (data.card_id) {
                    recentCardIds.push(data.card_id);
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –º–∞—Å—Å–∏–≤–∞
                    while (recentCardIds.length > RECENT_CARDS_LIMIT) {
                        recentCardIds.shift();
                    }
                }

                // Check if daily limit was exceeded (race condition protection)
                if (!data.success && data.error === 'daily_limit_exceeded') {
                    alert('–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç. –≠—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –∑–∞—Å—á–∏—Ç–∞–Ω–∞.');
                    showCard(currentCardIndex + 1);
                    return;
                }

                // Handle buried cards - card won't be shown until burial expires
                if (data.is_buried) {
                    console.log(`Card ${data.card_id} buried after ${MAX_SESSION_ATTEMPTS} attempts`);
                }

                // Handle requeue based on rating and server response
                let shouldRequeue = false;
                let requeuePosition = null;

                // If card is buried, don't requeue (session limit reached on server)
                if (data.requeue_position !== null && data.requeue_position !== undefined && !data.is_buried) {
                    // Check session limit before requeuing (client-side tracking per session)
                    if (sessionAttempts[cardKey] < MAX_SESSION_ATTEMPTS) {
                        shouldRequeue = true;
                        requeuePosition = data.requeue_position;
                    }
                }
                // Removed fallback logic - server always provides requeue_position

                // Requeue the card if needed
                if (shouldRequeue && requeuePosition !== null) {
                    // Track state transition for counter update
                    const oldState = card.state;
                    const newState = data.state || card.state;

                    // Update card with new state from server
                    const cardCopy = {
                        ...card,
                        isRequeue: true,
                        state: newState,
                        step_index: data.step_index !== undefined ? data.step_index : card.step_index,
                        lapses: data.lapses !== undefined ? data.lapses : card.lapses
                    };
                    // Fixed: removed +1 that caused cards to appear sooner than intended
                    const insertAt = Math.min(currentCardIndex + requeuePosition, cards.length);
                    cards.splice(insertAt, 0, cardCopy);
                    console.log(`Card requeued at position +${requeuePosition}, state: ${newState} (session attempt ${sessionAttempts[cardKey]})`);

                    // Update counters when card transitions to learning/relearning state
                    if (oldState === 'new' && (newState === 'learning' || newState === 'relearning')) {
                        // New card started learning
                        sessionStats.learning_cards++;
                        if (studiedCardsCounter) {
                            studiedCardsCounter.textContent = `–í –∏–∑—É—á–µ–Ω–∏–∏: ${sessionStats.learning_cards}`;
                        }
                    } else if (oldState === 'review' && newState === 'relearning') {
                        // Review card failed, now relearning
                        sessionStats.learning_cards++;
                        if (studiedCardsCounter) {
                            studiedCardsCounter.textContent = `–í –∏–∑—É—á–µ–Ω–∏–∏: ${sessionStats.learning_cards}`;
                        }
                    }
                }

                // Update session stats
                sessionStats.total++;

                // Update counters (only for non-requeued cards)
                // Logic matches initialization: new / learning+relearning / review
                if (!card.isRequeue) {
                    if (card.state === 'new') {
                        // Card never answered before
                        sessionStats.new_cards--;
                        if (newCardsCounter) {
                            newCardsCounter.textContent = `–ù–æ–≤—ã—Ö: ${Math.max(0, sessionStats.new_cards)}`;
                        }
                    } else if (card.state === 'learning' || card.state === 'relearning') {
                        // Card in learning/relearning mode
                        sessionStats.learning_cards--;
                        if (studiedCardsCounter) {
                            studiedCardsCounter.textContent = `–í –∏–∑—É—á–µ–Ω–∏–∏: ${Math.max(0, sessionStats.learning_cards)}`;
                        }
                    } else if (card.state === 'review') {
                        // Card on interval review
                        sessionStats.review_cards--;
                        if (reviewCardsCounter) {
                            reviewCardsCounter.textContent = `–ù–∞ –ø–æ–≤—Ç–æ—Ä: ${Math.max(0, sessionStats.review_cards)}`;
                        }
                    }
                }

                // Move to next card
                showCard(currentCardIndex + 1);

            } catch (error) {
                console.error('Error rating card:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            }
        }

        // Complete the study session
        async function completeSession(hasMoreNew = false, hasMoreReviews = false) {
            try {
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                const csrfToken = csrfMeta && csrfMeta.content;

                const response = await fetch('/study/api/complete-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(csrfToken && { 'X-CSRFToken': csrfToken })
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    // Hide progress bar and cards
                    const progressBar = document.querySelector('.card.shadow-sm.mb-4');
                    if (progressBar) progressBar.style.display = 'none';
                    if (cardFront) cardFront.style.display = 'none';
                    if (cardBack) cardBack.style.display = 'none';
                    if (noCardsMessage) noCardsMessage.style.display = 'none';
                    if (dailyLimitMessage) dailyLimitMessage.style.display = 'none';
                    const noCardsInSource = document.getElementById('no-cards-in-source-message');
                    if (noCardsInSource) noCardsInSource.style.display = 'none';

                    // Show completion screen
                    flashcardView.style.display = 'block';
                    sessionComplete.style.display = 'flex';

                    // Set random completion message
                    const titleEl = document.getElementById('celebration-title');
                    if (titleEl) {
                        titleEl.textContent = getRandomCompletionMessage();
                    }

                    // Get stats values
                    const wordsStudied = data.stats.words_studied || 0;
                    const correct = data.stats.correct || 0;
                    const percentage = data.stats.percentage || 0;
                    const xpEarned = data.xp_earned || 0;

                    // Animate stats with counting effect
                    animateValue('stats-words', 0, wordsStudied, 800);
                    animateValue('stats-correct', 0, correct, 800);
                    animateValue('stats-score', 0, percentage, 1000);
                    animateValue('xp-earned-amount', 0, xpEarned, 1200);

                    // Animate accuracy ring
                    setTimeout(() => {
                        const accuracyRing = document.querySelector('.accuracy-progress');
                        if (accuracyRing) {
                            const circumference = 213.6; // 2 * PI * 34
                            const offset = circumference - (percentage / 100) * circumference;
                            accuracyRing.style.strokeDashoffset = offset;
                        }
                    }, 300);

                    // Update level
                    document.getElementById('current-level').textContent = data.level || 1;
                    document.getElementById('total-xp').textContent = data.total_xp || 0;

                    // Show extra study button if more cards available
                    if (hasMoreNew || hasMoreReviews) {
                        const extraLink = document.getElementById('session-extra-study-link');
                        if (extraLink) {
                            extraLink.style.display = 'inline-flex';
                            let extraUrl = deckId
                                ? `/study/cards/deck/${deckId}?extra_study=true`
                                : '{{ url_for("study.cards") }}?extra_study=true';
                            extraLink.href = extraUrl;
                        }
                    }

                    // Launch confetti!
                    launchConfetti();
                }

            } catch (error) {
                console.error('Error completing session:', error);
                window.location.href = '{{ url_for("study.index") }}';
            }
        }

        // Animate number counting
        function animateValue(elementId, start, end, duration) {
            const el = document.getElementById(elementId);
            if (!el) return;

            const range = end - start;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                // Ease out cubic
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.round(start + range * easeOut);
                el.textContent = current;

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        // Confetti animation
        function launchConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            const particles = [];
            const colors = ['#10b981', '#f59e0b', '#3b82f6', '#ec4899', '#8b5cf6', '#06b6d4'];

            // Create particles
            for (let i = 0; i < 80; i++) {
                particles.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15 - 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4,
                    rotation: Math.random() * 360,
                    rotationSpeed: (Math.random() - 0.5) * 10,
                    gravity: 0.2,
                    friction: 0.99,
                    opacity: 1
                });
            }

            let animationFrame;
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                let activeParticles = 0;
                particles.forEach(p => {
                    if (p.opacity <= 0) return;
                    activeParticles++;

                    p.vy += p.gravity;
                    p.vx *= p.friction;
                    p.vy *= p.friction;
                    p.x += p.vx;
                    p.y += p.vy;
                    p.rotation += p.rotationSpeed;

                    // Fade out when near bottom
                    if (p.y > canvas.height * 0.8) {
                        p.opacity -= 0.02;
                    }

                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.globalAlpha = p.opacity;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
                    ctx.restore();
                });

                if (activeParticles > 0) {
                    animationFrame = requestAnimationFrame(animate);
                } else {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }

            animate();
        }

        // Show "no cards" message
        function showNoCardsMessage() {
            loadingSpinner.style.display = 'none';
            noCardsMessage.style.display = 'block';
        }

        // Event Listeners
        showAnswerBtn.addEventListener('click', function() {
            flipCard();
        });

        // Audio button clicks
        frontAudioBtn.addEventListener('click', function(e) {
            wordAudio.play();
        });

        backAudioBtn.addEventListener('click', function(e) {
            wordAudio.play();
        });

        // Rating buttons
        document.querySelectorAll('.rating-btn').forEach(button => {
            button.addEventListener('click', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                rateCard(rating);
            });
        });

        // End session early
        endSessionBtn.addEventListener('click', function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é?')) {
                try {
                    completeSession(hasMoreNewCards, hasMoreReviewCards);
                } catch(e) {
                    console.error('Error in complete session:', e);
                    // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    window.location.href = '{{ url_for("study.index") }}';
                }
            }
        });

        // Keyboard shortcuts for rating cards (Unified 1-2-3 scale)
        document.addEventListener('keydown', function(e) {
            // Rating shortcuts when card back is visible
            if (cardBack.style.display === 'flex') {
                if (e.key === '1') {
                    e.preventDefault();
                    rateCard(1); // –ù–µ –∑–Ω–∞—é (show in 1-2 cards)
                } else if (e.key === '2') {
                    e.preventDefault();
                    rateCard(2); // –°–æ–º–Ω–µ–≤–∞—é—Å—å (show in 3-5 cards)
                } else if (e.key === '3') {
                    e.preventDefault();
                    rateCard(3); // –ó–Ω–∞—é (done)
                }
            }
            // Show answer when front card is visible and spacebar is pressed
            else if (cardFront.style.display === 'flex' && e.code === 'Space') {
                e.preventDefault();
                flipCard();
            }
            // Ctrl+Shift+X –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞
            else if (e.ctrlKey && e.shiftKey && e.key === 'X') {
                window.location.href = '{{ url_for("study.index") }}';
            }
        });

        // Initialize the app
        initApp();
    });
</script>
{% endblock %}