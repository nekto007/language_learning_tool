{% extends "base.html" %}

{% block title %}–ö–∞—Ä—Ç–æ—á–∫–∏{% endblock %}

{% block content %}
<div class="container mt-4" id="flashcard-app">
    <!-- Progress bar and stats -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="h5 fw-bold mb-1">–ü—Ä–æ–≥—Ä–µ—Å—Å</h2>
                    <p class="text-secondary mb-0 small" id="card-counter">–ö–∞—Ä—Ç–æ—á–∫–∞ 1 –∏–∑ 20</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex gap-2">
                        <span class="badge bg-info" id="new-cards-counter" title="–ù–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏">–ù–æ–≤—ã—Ö: 0</span>
                        <span class="badge bg-success" id="studied-cards-counter" title="–ò–∑—É—á–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏">–ò–∑—É—á–µ–Ω–æ: 0</span>
                        <span class="badge bg-warning" id="review-cards-counter" title="–ö–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å: 0</span>
                    </div>
                    <button id="end-session-btn" class="btn btn-outline-secondary btn-sm">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                </div>
            </div>
            <div class="progress progress-thin">
                <div class="progress-bar bg-success progress-animated" id="progress-fill" style="width: 0%;"></div>
            </div>
        </div>
    </div>

    <!-- Loading spinner -->
    <div id="loading-spinner" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫...</p>
    </div>

    <!-- Nothing to study message -->
    {% if nothing_to_study %}
    <div id="nothing-to-study" class="card shadow-sm text-center nothing-to-study-card" style="display: none;">
        <div class="card-body">
            {% if limit_reached %}
            <div class="celebration-icon">üìö</div>
            <h2 class="mb-3">–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!</h2>
            <p class="text-muted fs-5 mb-4">
                –í—ã —É–∂–µ –∏–∑—É—á–∏–ª–∏ <strong>{{ new_cards_today }}</strong> –Ω–æ–≤—ã—Ö —Å–ª–æ–≤ —Å–µ–≥–æ–¥–Ω—è.<br>
                –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç: <strong>{{ daily_limit }}</strong> —Å–ª–æ–≤.
            </p>
            <p class="text-secondary mb-4">
                –ú–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç –≤ <a href="{{ url_for('study.settings') }}">–Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö</a> –∏–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã –æ–±—É—á–µ–Ω–∏—è.
            </p>
            {% else %}
            <div class="celebration-icon">üéâ</div>
            <h2 class="mb-3">–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –∏–∑—É—á–µ–Ω–æ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è!</h2>
            <p class="text-muted fs-5 mb-4">
                {% if deck_title %}
                –í –∫–æ–ª–æ–¥–µ <strong>"{{ deck_title }}"</strong> —Å–µ–≥–æ–¥–Ω—è –Ω–µ—á–µ–≥–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å.
                {% else %}
                –£ –≤–∞—Å –Ω–µ—Ç —Å–ª–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.
                {% endif %}
            </p>
            <p class="text-secondary mb-4">
                –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞, —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∏–∑—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞, –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã –æ–±—É—á–µ–Ω–∏—è.
            </p>
            {% endif %}

            <div class="d-flex gap-3 justify-content-center flex-wrap mt-4">
                {% if deck_id %}
                <a href="{{ url_for('study.quiz_deck', deck_id=deck_id) }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-brain me-2"></i>–ü—Ä–æ–π—Ç–∏ Quiz
                </a>
                <a href="{{ url_for('study.edit_deck', deck_id=deck_id) }}" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-edit me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–æ–¥—É
                </a>
                {% else %}
                <a href="{{ url_for('study.quiz') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-brain me-2"></i>–ü—Ä–æ–π—Ç–∏ Quiz
                </a>
                <a href="{{ url_for('study.matching') }}" class="btn btn-outline-primary btn-lg">
                    <i class="fas fa-puzzle-piece me-2"></i>–ò–≥—Ä–∞ "–ü–æ–¥–±–µ—Ä–∏ –ø–∞—Ä—É"
                </a>
                {% endif %}
                <a href="{{ url_for('study.index') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-arrow-left me-2"></i>–ù–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Cards container -->
    <div id="flashcard-view" style="display: none;">
        <!-- Front side (question) -->
        <div id="card-front" class="card shadow-sm mb-4 text-center flashcard">
            <div class="card-body d-flex flex-column align-items-center justify-content-center">
                <!-- State badge -->
                <div id="front-state-badge" class="mb-2">
                    <span id="state-badge" class="badge"></span>
                    <span id="lapses-badge" class="badge bg-secondary ms-1" style="display: none;"></span>
                </div>
                <h1 id="front-word" class="display-3 mb-4 fw-medium"></h1>

                <button id="front-audio-btn" class="btn btn-outline-secondary mb-4">
                    <i class="fas fa-volume-up me-2"></i>–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ
                </button>

                <p id="hint-text" class="text-secondary my-4 hint-text hint-text-styles"></p>

                <button id="show-answer-btn" class="btn btn-primary btn-lg mt-auto">
                    –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
                </button>
            </div>
        </div>

        <!-- Back side (answer) -->
        <div id="card-back" class="card shadow-sm mb-4 text-center flashcard" style="display: none;">
            <div class="card-body">
                <h1 id="back-word" class="display-3 mb-4 fw-medium"></h1>

                <button id="back-audio-btn" class="btn btn-outline-secondary mb-4">
                    <i class="fas fa-volume-up me-2"></i>–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ
                </button>

                <hr class="my-4 divider-centered">

                <div class="mb-4">
                    <div class="text-secondary mb-2 fw-semibold">–ü–µ—Ä–µ–≤–æ–¥</div>
                    <div id="translation-text" class="fs-4 text-danger"></div>
                </div>

                <div id="examples-container" class="mb-4">
                    <div class="text-secondary mb-2 fw-semibold">–ü—Ä–∏–º–µ—Ä—ã</div>
                    <div id="example-text" class="mb-2"></div>
                    <div id="example-translation" class="text-secondary"></div>
                </div>

                <!-- Unified 1-2-3 rating scale -->
                <div class="d-flex justify-content-center gap-2 mt-4">
                    <button type="button" class="rating-btn btn-danger flex-fill rating-btn-sized" data-rating="1">
                        <span class="rating-icon">üòï</span>
                        –ù–µ –∑–Ω–∞—é
                        <small class="rating-hint">1-2 –∫–∞—Ä—Ç–æ—á–∫–∏</small>
                    </button>
                    <button type="button" class="rating-btn btn-warning flex-fill rating-btn-sized" data-rating="2">
                        <span class="rating-icon">ü§î</span>
                        –°–æ–º–Ω–µ–≤–∞—é—Å—å
                        <small class="rating-hint">3-5 –∫–∞—Ä—Ç–æ—á–µ–∫</small>
                    </button>
                    <button type="button" class="rating-btn btn-success flex-fill rating-btn-sized" data-rating="3">
                        <span class="rating-icon">üòä</span>
                        –ó–Ω–∞—é
                        <small class="rating-hint">–ì–æ—Ç–æ–≤–æ</small>
                    </button>
                </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ -->
        <div id="daily-limit-message" class="card-container text-center" style="display: none;">
            <h2 class="mb-4 text-success">
                <i class="fas fa-check-circle text-success me-2"></i>
                –£—Ä–∞! –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å—ë!
            </h2>

            <div class="mb-4">–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∏–∑—É—á–µ–Ω–∏—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç. –ï—â—ë –µ—Å—Ç—å –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏, –Ω–æ –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω. –í—ã –º–æ–∂–µ—Ç–µ —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –Ω–æ –∏–º–µ–π—Ç–µ –≤ –≤–∏–¥—É, —á—Ç–æ —á–µ–º –±–æ–ª—å—à–µ –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –≤—ã –∏–∑—É—á–∏—Ç–µ, —Ç–µ–º –±–æ–ª—å—à–µ –ø—Ä–∏–¥—ë—Ç—Å—è –ø–æ–≤—Ç–æ—Ä—è—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</div>
            <div class="mt-4">
                <div class="d-flex justify-content-center gap-3 mb-4">
                    <div class="text-center">
                        <h4 id="new-cards-stats" class="mb-2">0 / 0</h4>
                        <p class="text-muted">–ù–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</p>
                    </div>
                    <div class="text-center">
                        <h4 id="reviews-stats" class="mb-2">0 / 0</h4>
                        <p class="text-muted">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</p>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <a href="{{ url_for('study.cards', word_source='new') }}?extra_study=true" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ
                </a>

                <a href="{{ url_for('study.index') }}" class="btn btn-outline-secondary ms-2">
                    –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </a>

                <a href="{{ url_for('study.settings') }}" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </a>
            </div>
        </div>

        <!-- No cards message -->
        <div id="no-cards-message" class="alert alert-info text-center" style="display: none;">
            <h4>–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</h4>
            <p>–ù–µ—Ç —Å–ª–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –æ–±—É—á–µ–Ω–∏—è.</p>
            <a href="{{ url_for('study.index') }}" class="btn btn-primary mt-2">
                –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—É—á–µ–Ω–∏—é
            </a>
        </div>

        <!-- Session complete message -->
        <div id="session-complete" class="card-container text-center" style="display: none;">
            <h2 class="mb-4">
                <i class="fas fa-check-circle text-success me-2"></i>
                –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
            </h2>

            <!-- XP Earned Banner -->
            <div id="xp-earned-banner" class="mb-4 xp-banner">
                <div class="celebration-icon-sm">‚ö°</div>
                <div class="xp-banner-value">
                    +<span id="xp-earned-amount">0</span> XP
                </div>
                <div class="xp-banner-label">
                    –£—Ä–æ–≤–µ–Ω—å <span id="current-level">1</span> ‚Ä¢ <span id="total-xp">0</span> XP
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-4">
                    <h2 id="stats-words" class="text-primary">0</h2>
                    <p class="text-muted">–ö–∞—Ä—Ç–æ—á–µ–∫ –∏–∑—É—á–µ–Ω–æ</p>
                </div>
                <div class="col-md-4">
                    <h2 id="stats-correct" class="text-success">0</h2>
                    <p class="text-muted">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</p>
                </div>
                <div class="col-md-4">
                    <h2 id="stats-score" class="text-warning">0%</h2>
                    <p class="text-muted">–†–µ–∑—É–ª—å—Ç–∞—Ç</p>
                </div>
            </div>

            <div class="mt-5">
                <a href="{{ url_for('study.index') }}" class="btn btn-primary">
                    –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—É—á–µ–Ω–∏—é
                </a>
                <a href="{{ url_for('study.cards') }}" class="btn btn-outline-secondary ms-2">
                    –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Audio element (hidden) -->
<audio id="word-audio" style="display: none;"></audio>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Config from server
        const sessionId = {{ session_id }};
        const wordSource = '{{ word_source }}';
        const deckId = {{ deck_id|default('null') }};
        const nothingToStudy = {{ 'true' if nothing_to_study else 'false' }};
        const showTranslations = {{ settings.include_translations|lower }};
        const showExamples = {{ settings.include_examples|lower }};
        const playAudio = {{ settings.include_audio|lower }};
        const hintTime = 7; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ - 5 —Å–µ–∫—É–Ω–¥

        // If nothing to study, hide UI and show message
        if (nothingToStudy) {
            document.getElementById('loading-spinner').style.display = 'none';
            document.querySelector('.card.shadow-sm.mb-4').style.display = 'none'; // Hide progress bar
            document.getElementById('nothing-to-study').style.display = 'block';
            return; // Don't initialize the rest of the app
        }

        // App state
        let originalCards = []; // Original cards from API
        let cards = [];         // Processed cards with both directions
        let currentCardIndex = 0;
        let sessionStartTime = Date.now();
        let sessionStats = {
            total: 0,
            correct: 0,
            incorrect: 0,
            new_cards: 0,
            review_cards: 0
        };
        let hintTimeout = null;

        // Anti-repeat: track recently shown card IDs
        const recentCardIds = [];
        const RECENT_CARDS_LIMIT = 5;  // Keep last 5 card IDs to exclude

        // State configuration for display
        const STATE_CONFIG = {
            'new': { label: '–ù–û–í–ê–Ø', class: 'bg-info', color: '#17a2b8' },
            'learning': { label: '–ò–ó–£–ß–ï–ù–ò–ï', class: 'bg-warning text-dark', color: '#ffc107' },
            'review': { label: '–ü–û–í–¢–û–†', class: 'bg-success', color: '#28a745' },
            'relearning': { label: '–ü–ï–†–ï–£–ß–ò–í–ê–ù–ò–ï', class: 'bg-danger', color: '#dc3545' }
        };

        // Learning steps in minutes (must match backend constants.py)
        const LEARNING_STEPS = [1, 10];      // NEW/LEARNING: [1min, 10min]
        const RELEARNING_STEPS = [10];       // RELEARNING: [10min]
        const GRADUATING_INTERVAL = 1;       // LEARNING ‚Üí REVIEW: 1 day
        const EASY_INTERVAL = 4;             // NEW + "–ó–Ω–∞—é" ‚Üí skip to REVIEW: 4 days
        const LAPSE_MINIMUM_INTERVAL = 1;    // RELEARNING ‚Üí REVIEW: 1 day

        // Update state badge and button hints based on card state
        function updateStateDisplay(card) {
            const state = card.state || 'new';
            const stepIndex = card.step_index || 0;
            const lapses = card.lapses || 0;

            // Update state badge
            if (stateBadge) {
                const config = STATE_CONFIG[state] || STATE_CONFIG['new'];
                stateBadge.textContent = config.label;
                stateBadge.className = 'badge ' + config.class;
            }

            // Update lapses badge (show only for relearning or if lapses > 0)
            if (lapsesBadge) {
                if (lapses > 0) {
                    lapsesBadge.textContent = `–ü—Ä–æ–≤–∞–ª–æ–≤: ${lapses}`;
                    lapsesBadge.style.display = 'inline-block';
                } else {
                    lapsesBadge.style.display = 'none';
                }
            }

            // Update button hints based on state
            updateButtonHints(state, stepIndex);
        }

        // Update button hints dynamically based on card state
        function updateButtonHints(state, stepIndex) {
            const hints = getHintsForState(state, stepIndex);

            ratingButtons.forEach(btn => {
                const rating = parseInt(btn.getAttribute('data-rating'));
                const hintEl = btn.querySelector('.rating-hint');
                if (hintEl && hints[rating]) {
                    hintEl.textContent = hints[rating];
                }
            });
        }

        // Get button hints for each state - matches backend logic exactly
        function getHintsForState(state, stepIndex) {
            switch (state) {
                case 'new':
                    // NEW: –ø–µ—Ä–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–∞—Ä—Ç–æ—á–∫–æ–π
                    // 1 (–ù–µ –∑–Ω–∞—é): ‚Üí LEARNING step 0 (1 –º–∏–Ω)
                    // 2 (–°–æ–º–Ω–µ–≤–∞—é—Å—å): ‚Üí LEARNING step 1 (10 –º–∏–Ω)
                    // 3 (–ó–Ω–∞—é): ‚Üí REVIEW (4 –¥–Ω—è, –ø—Ä–æ–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è)
                    return {
                        1: `‚Üí –ò–∑—É—á–µ–Ω–∏–µ (${LEARNING_STEPS[0]}–º–∏–Ω)`,
                        2: `‚Üí –®–∞–≥ 2 (${LEARNING_STEPS[1]}–º–∏–Ω)`,
                        3: `‚Üí –ü–æ–≤—Ç–æ—Ä (${EASY_INTERVAL} –¥–Ω—è)`
                    };

                case 'learning':
                    // LEARNING: –ø—Ä–æ—Ö–æ–¥–∏–º —à–∞–≥–∏ –æ–±—É—á–µ–Ω–∏—è
                    // 1 (–ù–µ –∑–Ω–∞—é): ‚Üí reset to step 0 (1 –º–∏–Ω)
                    // 2 (–°–æ–º–Ω–µ–≤–∞—é—Å—å): ‚Üí repeat current step
                    // 3 (–ó–Ω–∞—é): ‚Üí advance step, if last step ‚Üí graduate to REVIEW (1 –¥–µ–Ω—å)
                    const currentStepTime = LEARNING_STEPS[stepIndex] || LEARNING_STEPS[0];
                    const isLastStep = stepIndex >= LEARNING_STEPS.length - 1;
                    const nextStepIndex = Math.min(stepIndex + 1, LEARNING_STEPS.length - 1);
                    const nextStepTime = LEARNING_STEPS[nextStepIndex];

                    return {
                        1: `‚Üí –®–∞–≥ 1 (${LEARNING_STEPS[0]}–º–∏–Ω)`,
                        2: `–®–∞–≥ ${stepIndex + 1} (${currentStepTime}–º–∏–Ω)`,
                        3: isLastStep
                            ? `‚Üí –ü–æ–≤—Ç–æ—Ä (${GRADUATING_INTERVAL} –¥–µ–Ω—å)`
                            : `‚Üí –®–∞–≥ ${nextStepIndex + 1} (${nextStepTime}–º–∏–Ω)`
                    };

                case 'review':
                    // REVIEW: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
                    // 1 (–ù–µ –∑–Ω–∞—é): ‚Üí RELEARNING, lapses++, ease -= 0.20
                    // 2 (–°–æ–º–Ω–µ–≤–∞—é—Å—å): –∏–Ω—Ç–µ—Ä–≤–∞–ª √ó 1.2, ease -= 0.05
                    // 3 (–ó–Ω–∞—é): –∏–Ω—Ç–µ—Ä–≤–∞–ª √ó ease √ó 1.3, ease += 0.15
                    return {
                        1: '‚Üí –ü–µ—Ä–µ—É—á–∏–≤–∞–Ω–∏–µ',
                        2: '–ò–Ω—Ç–µ—Ä–≤–∞–ª √ó1.2',
                        3: '–ò–Ω—Ç–µ—Ä–≤–∞–ª √óease√ó1.3'
                    };

                case 'relearning':
                    // RELEARNING: –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–∞–ª–∞
                    // 1 (–ù–µ –∑–Ω–∞—é): ‚Üí reset to step 0 (10 –º–∏–Ω)
                    // 2 (–°–æ–º–Ω–µ–≤–∞—é—Å—å): ‚Üí repeat current step (10 –º–∏–Ω)
                    // 3 (–ó–Ω–∞—é): ‚Üí REVIEW (1 –¥–µ–Ω—å)
                    const relearningStep = RELEARNING_STEPS[stepIndex] || RELEARNING_STEPS[0];
                    const isLastRelearningStep = stepIndex >= RELEARNING_STEPS.length - 1;

                    return {
                        1: `‚Üí –®–∞–≥ 1 (${RELEARNING_STEPS[0]}–º–∏–Ω)`,
                        2: `–®–∞–≥ ${stepIndex + 1} (${relearningStep}–º–∏–Ω)`,
                        3: `‚Üí –ü–æ–≤—Ç–æ—Ä (${LAPSE_MINIMUM_INTERVAL} –¥–µ–Ω—å)`
                    };

                default:
                    return {
                        1: '‚Üí –ò–∑—É—á–µ–Ω–∏–µ',
                        2: '‚Üí –®–∞–≥ 2',
                        3: '‚Üí –ü–æ–≤—Ç–æ—Ä'
                    };
            }
        }

        // DOM elements
        const flashcardView = document.getElementById('flashcard-view');
        const cardFront = document.getElementById('card-front');
        const cardBack = document.getElementById('card-back');
        const frontWord = document.getElementById('front-word');
        const backWord = document.getElementById('back-word');
        const frontAudioBtn = document.getElementById('front-audio-btn');
        const backAudioBtn = document.getElementById('back-audio-btn');
        const translationText = document.getElementById('translation-text');
        const examplesContainer = document.getElementById('examples-container');
        const exampleText = document.getElementById('example-text');
        const exampleTranslation = document.getElementById('example-translation');
        const hintText = document.getElementById('hint-text');
        const cardCounter = document.getElementById('card-counter');
        const correctCounter = document.getElementById('correct-counter');
        const incorrectCounter = document.getElementById('incorrect-counter');
        const newCardsCounter = document.getElementById('new-cards-counter');
        const studiedCardsCounter = document.getElementById('studied-cards-counter');
        const reviewCardsCounter = document.getElementById('review-cards-counter');
        const progressFill = document.getElementById('progress-fill');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noCardsMessage = document.getElementById('no-cards-message');
        const dailyLimitMessage = document.getElementById('daily-limit-message');
        const sessionComplete = document.getElementById('session-complete');
        const wordAudio = document.getElementById('word-audio');
        const endSessionBtn = document.getElementById('end-session-btn');
        const newCardsStats = document.getElementById('new-cards-stats');
        const reviewsStats = document.getElementById('reviews-stats');
        const stateBadge = document.getElementById('state-badge');
        const lapsesBadge = document.getElementById('lapses-badge');
        const ratingButtons = document.querySelectorAll('.rating-btn');

        // Stats elements
        const statsWords = document.getElementById('stats-words');
        const statsCorrect = document.getElementById('stats-correct');
        const statsScore = document.getElementById('stats-score');

        // Fetch cards from the API
        async function fetchCards() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—Ä–æ—à–µ–Ω–æ –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ
                const extraStudy = new URLSearchParams(window.location.search).get('extra_study') === 'true';

                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ —ç—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ
                let url = `/study/api/get-study-items?source=${wordSource}${extraStudy ? '&extra_study=true' : ''}`;

                // –î–æ–±–∞–≤–ª—è–µ–º deck_id –µ—Å–ª–∏ –µ—Å—Ç—å
                if (deckId) {
                    url += `&deck_id=${deckId}`;
                }

                // Anti-repeat: –∏—Å–∫–ª—é—á–∞–µ–º –Ω–µ–¥–∞–≤–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                if (recentCardIds.length > 0) {
                    url += `&exclude_card_ids=${recentCardIds.join(',')}`;
                }

                const response = await fetch(url);


                if (!response.ok) {
                    throw new Error('Failed to fetch cards');
                }

                const data = await response.json();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (data.status === 'daily_limit_reached') {
                    showDailyLimitMessage(data.stats);
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ
                    window.noCardsMessageShown = true;
                    return [];
                }

                if (data.status === 'success' && (!data.items || data.items.length === 0)) {

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ –¥–æ—Å—Ç—É–ø–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è
                    const remainingNewCards = data.stats.new_cards_limit - data.stats.new_cards_today;
                    const remainingReviews = data.stats.reviews_limit - data.stats.reviews_today;

                    if (remainingNewCards > 0 || remainingReviews > 0) {
                        // –ï—Å–ª–∏ –µ—â–µ –µ—Å—Ç—å –ª–∏–º–∏—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º,
                        // —á—Ç–æ –≤ —ç—Ç–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫, –Ω–æ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
                        showNoCardsInSourceMessage(data.stats);
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ
                        window.noCardsMessageShown = true;
                    } else {
                        // –ï—Å–ª–∏ –ª–∏–º–∏—Ç—ã –∏—Å—á–µ—Ä–ø–∞–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
                        showNoCardsMessage();
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ
                        window.noCardsMessageShown = true;
                    }
                    return [];
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∫ –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –∫–∞—Ä—Ç–æ—á–∫–∞–º
                const filteredData = data.items.filter(card => card.translation && card.translation.trim() !== '');

                return filteredData;
            } catch (error) {
                console.error('Error fetching cards:', error);
                showNoCardsMessage();
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ
                window.noCardsMessageShown = true;
                return [];
            }
        }

        function showNoCardsInSourceMessage(stats) {

            // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            loadingSpinner.style.display = 'none';
            if (cardFront) cardFront.style.display = 'none';
            if (cardBack) cardBack.style.display = 'none';
            if (noCardsMessage) noCardsMessage.style.display = 'none';
            if (sessionComplete) sessionComplete.style.display = 'none';
            if (dailyLimitMessage) dailyLimitMessage.style.display = 'none';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º flashcardView, —Ç–∞–∫ –∫–∞–∫ –≤ –Ω–µ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            flashcardView.style.display = 'block';

            // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            const noCardsInSourceMessage = document.getElementById('no-cards-in-source-message');

            if (noCardsInSourceMessage) {

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const availableNewCards = document.getElementById('available-new-cards');
                if (availableNewCards) {
                    const remaining = stats.new_cards_limit - stats.new_cards_today;
                    availableNewCards.textContent = `${remaining} / ${stats.new_cards_limit}`;
                }

                const availableReviews = document.getElementById('available-reviews');
                if (availableReviews) {
                    const remaining = stats.reviews_limit - stats.reviews_today;
                    availableReviews.textContent = `${remaining} / ${stats.reviews_limit}`;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º setTimeout –¥–ª—è –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                // —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª–µ–Ω
                setTimeout(() => {
                    noCardsInSourceMessage.style.display = 'block';

                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞: –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º —á–µ—Ä–µ–∑ 100–º—Å
                    setTimeout(() => {
                        if (noCardsInSourceMessage.style.display !== 'block') {
                            noCardsInSourceMessage.style.display = 'block';
                        }
                    }, 100);
                }, 50);
            } else {
                // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ noCardsMessage
                if (noCardsMessage) {
                    noCardsMessage.innerHTML = `
                        <h4>–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ</h4>
                        <p>–í –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ–≤ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è.</p>
                        <div class="alert alert-info my-3">
                            <p>–£ –≤–∞—Å –µ—â—ë –µ—Å—Ç—å –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –∏–∑—É—á–∞—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞.</p>
                        </div>
                        <div class="mt-4">
                            <a href="{{ url_for('study.cards', word_source='new') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i> –ò–∑—É—á–∏—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞
                            </a>
                            <a href="{{ url_for('study.cards', word_source='all') }}" class="btn btn-outline-primary ms-2">
                                <i class="fas fa-random me-2"></i> –°–º–µ—à–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
                            </a>
                            <a href="{{ url_for('study.index') }}" class="btn btn-outline-secondary ms-2">
                                –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—É—á–µ–Ω–∏—é
                            </a>
                        </div>
                    `;

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout –¥–ª—è –ø–æ–∫–∞–∑–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å –¥—Ä—É–≥–∏–º –∫–æ–¥–æ–º
                    setTimeout(() => {
                        noCardsMessage.style.display = 'block';
                    }, 5);
                }
            }

            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–∞—Ä—Ç–æ—á–µ–∫
            // –≠—Ç–æ –≤–∞–∂–Ω–æ! –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –º—ã —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
            window.noCardsMessageShown = true;
        }


        // Create alternating cards (eng-rus, rus-eng) from original cards
        function createAlternatingCards(originalCards) {
            if (!originalCards || originalCards.length === 0) {
                return [];
            }

            // API already returns cards with correct directions - just pass them through
            // No need to create additional directions, that would cause duplicates
            return shuffleCards([...originalCards]);
        }

        // Shuffle cards while keeping same words apart from each other
        function shuffleCards(cards) {
            if (!cards || cards.length === 0) {
                return [];
            }

            // Group cards by word_id
            const cardsByWordId = {};
            for (const card of cards) {
                if (!cardsByWordId[card.word_id]) {
                    cardsByWordId[card.word_id] = [];
                }
                cardsByWordId[card.word_id].push(card);
            }

            // Create shuffled word_id array
            const wordIds = Object.keys(cardsByWordId);
            for (let i = wordIds.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [wordIds[i], wordIds[j]] = [wordIds[j], wordIds[i]];
            }

            // Rebuild cards array with randomized directions
            const shuffledCards = [];

            for (const wordId of wordIds) {
                const cardsForWord = cardsByWordId[wordId];

                // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞ (—Ä–∞–Ω–¥–æ–º–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π)
                const shuffledDirections = [...cardsForWord];
                for (let i = shuffledDirections.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledDirections[i], shuffledDirections[j]] = [shuffledDirections[j], shuffledDirections[i]];
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞
                shuffledCards.push(...shuffledDirections);
            }

            return shuffledCards;
        }

        // Format hint with first letter and underscores showing the length of the word
        function formatHint(word) {
            if (!word || word.length === 0) return '';

            // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π
            let targetWord = word;
            if (word.includes(',')) {
                targetWord = word.split(',')[0].trim();
            }

            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–ª–æ–≤ (1-2 –±—É–∫–≤—ã) - –æ–Ω–∞ –±—ã —Ä–∞—Å–∫—Ä—ã–ª–∞ –æ—Ç–≤–µ—Ç
            if (targetWord.length <= 2) {
                return '';
            }

            const firstChar = targetWord.charAt(0).toLowerCase();
            const underscores = '_'.repeat(Math.min(targetWord.length - 1, 8));
            const letterCount = targetWord.length;

            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
            let letterForm = '–±—É–∫–≤';
            const lastDigit = letterCount % 10;

            if (letterCount % 100 >= 11 && letterCount % 100 <= 19) {
                letterForm = '–±—É–∫–≤';
            } else if (lastDigit === 1) {
                letterForm = '–±—É–∫–≤–∞';
            } else if (lastDigit >= 2 && lastDigit <= 4) {
                letterForm = '–±—É–∫–≤—ã';
            }

            return `–ü–æ–¥—Å–∫–∞–∑–∫–∞: ${firstChar}${underscores} (${letterCount} ${letterForm})`;
        }

        // Show daily limit reached message
        function showDailyLimitMessage(stats) {
            loadingSpinner.style.display = 'none';
            flashcardView.style.display = 'block';
            cardFront.style.display = 'none';
            cardBack.style.display = 'none';
            noCardsMessage.style.display = 'none';
            sessionComplete.style.display = 'none';

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if (newCardsStats) {
                newCardsStats.textContent = `${stats.new_cards_today} / ${stats.new_cards_limit}`;
            }

            if (reviewsStats) {
                reviewsStats.textContent = `${stats.reviews_today} / ${stats.reviews_limit}`;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –¥–Ω–µ–≤–Ω–æ–º –ª–∏–º–∏—Ç–µ
            dailyLimitMessage.style.display = 'block';
        }

        // Initialize the flashcard app
        async function initApp() {

            try {
                // Fetch original cards
                originalCards = await fetchCards();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ - –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ, –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                if (window.noCardsMessageShown) {
                    return;
                }

                if (!originalCards || originalCards.length === 0) {
                    return;
                }

                // Create alternating cards
                cards = createAlternatingCards(originalCards);

                if (!cards || cards.length === 0) {
                    return;
                }

                // Count new and review cards
                let newCount = 0;
                let reviewCount = 0;
                
                for (let card of cards) {
                    if (card.is_new) {
                        newCount++;
                    } else {
                        reviewCount++;
                    }
                }
                
                sessionStats.new_cards = newCount;
                sessionStats.review_cards = reviewCount;
                
                // Update counters
                if (newCardsCounter) {
                    newCardsCounter.textContent = `–ù–æ–≤—ã—Ö: ${newCount}`;
                }
                if (studiedCardsCounter) {
                    studiedCardsCounter.textContent = `–ò–∑—É—á–µ–Ω–æ: 0`;
                }
                if (reviewCardsCounter) {
                    reviewCardsCounter.textContent = `–ü–æ–≤—Ç–æ—Ä–∏—Ç—å: ${reviewCount}`;
                }

                // Update UI
                loadingSpinner.style.display = 'none';
                flashcardView.style.display = 'block';

                // Show first card
                showCard(0);
            } catch (error) {
                console.error('Error during initialization:', error);
                loadingSpinner.style.display = 'none';
                noCardsMessage.style.display = 'block';
            }
        }

        // Display a card
        function showCard(index) {

            if (!cards || cards.length === 0) {
                showNoCardsMessage();
                return;
            }

            if (index >= cards.length) {
                completeSession();
                return;
            }

            const card = cards[index];
            currentCardIndex = index;

            // Update state badge and button hints
            updateStateDisplay(card);

            // Update progress
            const progress = ((index + 1) / cards.length) * 100;
            progressFill.style.width = `${progress}%`;
            cardCounter.textContent = `–ö–∞—Ä—Ç–æ—á–∫–∞ ${index + 1} –∏–∑ ${cards.length}`;

            // Reset card state
            cardFront.style.display = 'flex';
            cardBack.style.display = 'none';
            showAnswerBtn.style.display = 'block';
            hintText.classList.remove('visible');

            // Clear previous hint timeout
            if (hintTimeout) {
                clearTimeout(hintTimeout);
            }
            frontAudioBtn.hidden = true;  // –ø—Ä—è—á–µ–º ¬´–ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ¬ª —Å–ø–µ—Ä–µ–¥–∏
            backAudioBtn.hidden  = true;  // –∏ —Å–∑–∞–¥–∏, –ø–æ–∫–∞ –Ω–µ —Ä–µ—à–∏–º –∏–Ω–∞—á–µ

            // Configure audio buttons
            const hasAudio = card.audio_url !== null;

            const isEngToRu = card.direction === 'eng-rus';

            // Set card content based on direction
            frontWord.textContent = card.word;        // –≤—Å–µ–≥–¥–∞ word
            backWord.textContent  = card.word;        // —Ç–æ–∂–µ word
            translationText.textContent = card.translation;

            // –ø–æ–¥—Å–∫–∞–∑–∫–∞
            const hint = formatHint(card.translation);
            hintText.textContent = hint;
            // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –µ—Å–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø—É—Å—Ç–∞—è
            hintText.style.display = hint ? '' : 'none';

            if (hasAudio && playAudio) {
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞—É–¥–∏–æ –∏—Å—Ç–æ—á–Ω–∏–∫
                if (card.audio_url) {
                    wordAudio.src = card.audio_url;
                }
                
                // –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–æ–∫ –∞—É–¥–∏–æ –∏ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                if (card.direction === 'eng-rus') {
                    // –î–ª—è eng-rus –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
                    frontAudioBtn.hidden = false;
                    backAudioBtn.hidden = false; // –¢–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
                    
                    // –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è eng-rus –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
                    setTimeout(() => {
                        wordAudio.play().catch(error => {
                        });
                    }, 300);
                } else {
                    // –î–ª—è rus-eng –∫–∞—Ä—Ç–æ—á–µ–∫ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
                    frontAudioBtn.hidden = true;
                    backAudioBtn.hidden = false; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
                    
                    // –ù–ï–¢ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ –¥–ª—è rus-eng
                }
            } else {
                frontAudioBtn.hidden = true;
                backAudioBtn.hidden = true;
            }

            // Show hint after specified time (only if hint exists)
            if (hint) {
                hintTimeout = setTimeout(() => {
                    hintText.classList.add('visible');
                }, hintTime * 1000);
            }

            // Set example if available
            if (showExamples && card.examples) {
                const example = extractExampleParts(card.examples);

                exampleText.textContent = example.en;
                exampleTranslation.textContent = example.ru;
                examplesContainer.style.display = 'block';
            } else {
                examplesContainer.style.display = 'none';
            }
        }

        // Extract English and Russian parts from examples
        function extractExampleParts(examples) {
            if (!examples) return { en: '', ru: '' };

            // Replace HTML tags with nothing
            // const cleanedExamples = examples.replace(/<[^>]*>/g, '');
            const withNewlines = examples.replace(/<br\s*\/?>/gi, '\n');
            const cleanedExamples = withNewlines.replace(/<[^>]*>/g, '');

            // Split by newlines first
            let lines = cleanedExamples.split('\n').filter(line => line.trim() !== '');

            if (lines.length >= 2) {
                return {
                    en: lines[0].trim(),
                    ru: lines[1].trim()
                };
            }

            // Check if there's a dash at the beginning of a line
            lines = cleanedExamples.split(/\n\s*-\s*/).filter(line => line.trim() !== '');
            if (lines.length >= 2) {
                return {
                    en: lines[0].trim(),
                    ru: lines[1].trim()
                };
            }

            // If no obvious separator found, try to detect if there's English and Russian text
            // This is a simplified approach - assumes English has Latin characters and Russian has Cyrillic
            const hasCyrillic = /[–ê-–Ø–∞-—è]/.test(cleanedExamples);
            const hasLatin = /[A-Za-z]/.test(cleanedExamples);

            if (hasCyrillic && hasLatin) {
                // Try to split by common punctuation that might separate examples
                const parts = cleanedExamples.split(/[;.]\s*/).filter(part => part.trim() !== '');

                // Find first part with Latin and first part with Cyrillic
                const enPart = parts.find(part => /[A-Za-z]/.test(part)) || '';
                const ruPart = parts.find(part => /[–ê-–Ø–∞-—è]/.test(part)) || '';

                return {
                    en: enPart.trim(),
                    ru: ruPart.trim()
                };
            }

            // If nothing else works, just return the whole text
            return {
                en: cleanedExamples.trim(),
                ru: ''
            };
        }

        // Flip card to show answer
        function flipCard() {
            cardFront.style.display = 'none';
            cardBack.style.display = 'flex';

            // Clear hint timeout
            if (hintTimeout) {
                clearTimeout(hintTimeout);
                hintTimeout = null;
            }

            // –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è rus-eng –∫–∞—Ä—Ç–æ—á–µ–∫
            const card = cards[currentCardIndex];
            if (card.direction === 'rus-eng' && card.audio_url && playAudio) {
                setTimeout(() => {
                }, 300);
            }
        }

        // Session attempts tracking for requeue limit (max 3 shows per card)
        const sessionAttempts = {};  // card_key ‚Üí count
        const MAX_SESSION_ATTEMPTS = 3;

        // Rate a card and move to the next (Unified 1-2-3 scale)
        async function rateCard(rating) {
            if (!cards || currentCardIndex >= cards.length) {
                console.error('Cannot rate card - invalid card index');
                return;
            }
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            const csrfToken = csrfMeta && csrfMeta.content;
            const card = cards[currentCardIndex];

            // Track session attempts for this card+direction
            const cardKey = `${card.word_id}_${card.direction}`;
            sessionAttempts[cardKey] = (sessionAttempts[cardKey] || 0) + 1;

            try {
                // Send rating to server with direction (unified 1-2-3 scale)
                const response = await fetch('/study/api/update-study-item', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(csrfToken && { 'X-CSRFToken': csrfToken }),
                    },
                    body: JSON.stringify({
                        word_id: card.word_id,
                        direction: card.direction,
                        quality: rating,  // Unified 1-2-3 scale (backward compatible)
                        session_id: sessionId,
                        is_new: card.is_new,
                        deck_id: deckId  // For per-deck limit checking
                    }),
                });

                const data = await response.json();

                // Anti-repeat: –¥–æ–±–∞–≤–ª—è–µ–º card_id –≤ —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–∞–≤–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö
                if (data.card_id) {
                    recentCardIds.push(data.card_id);
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –º–∞—Å—Å–∏–≤–∞
                    while (recentCardIds.length > RECENT_CARDS_LIMIT) {
                        recentCardIds.shift();
                    }
                }

                // Check if daily limit was exceeded (race condition protection)
                if (!data.success && data.error === 'daily_limit_exceeded') {
                    alert('–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç. –≠—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –∑–∞—Å—á–∏—Ç–∞–Ω–∞.');
                    showCard(currentCardIndex + 1);
                    return;
                }

                // Handle buried cards - card won't be shown until burial expires
                if (data.is_buried) {
                    console.log(`Card ${data.card_id} buried after ${MAX_SESSION_ATTEMPTS} attempts`);
                }

                // Handle requeue based on rating and server response
                let shouldRequeue = false;
                let requeuePosition = null;

                // If card is buried, don't requeue (session limit reached on server)
                if (data.requeue_position !== null && data.requeue_position !== undefined && !data.is_buried) {
                    // Check session limit before requeuing (client-side tracking per session)
                    if (sessionAttempts[cardKey] < MAX_SESSION_ATTEMPTS) {
                        shouldRequeue = true;
                        requeuePosition = data.requeue_position;
                    }
                }
                // Removed fallback logic - server always provides requeue_position

                // Requeue the card if needed
                if (shouldRequeue && requeuePosition !== null) {
                    // Update card with new state from server
                    const cardCopy = {
                        ...card,
                        isRequeue: true,
                        state: data.state || card.state,
                        step_index: data.step_index !== undefined ? data.step_index : card.step_index,
                        lapses: data.lapses !== undefined ? data.lapses : card.lapses
                    };
                    // Fixed: removed +1 that caused cards to appear sooner than intended
                    const insertAt = Math.min(currentCardIndex + requeuePosition, cards.length);
                    cards.splice(insertAt, 0, cardCopy);
                    console.log(`Card requeued at position +${requeuePosition}, state: ${data.state} (session attempt ${sessionAttempts[cardKey]})`);
                }

                // Update session stats
                sessionStats.total++;

                // Update simplified counters
                if (card.is_new && !card.isRequeue) {
                    sessionStats.new_cards--;
                    if (newCardsCounter) {
                        newCardsCounter.textContent = `–ù–æ–≤—ã—Ö: ${Math.max(0, sessionStats.new_cards)}`;
                    }
                } else if (!card.isRequeue) {
                    sessionStats.review_cards--;
                    if (reviewCardsCounter) {
                        reviewCardsCounter.textContent = `–ü–æ–≤—Ç–æ—Ä–∏—Ç—å: ${Math.max(0, sessionStats.review_cards)}`;
                    }
                }

                // Update studied cards counter
                if (studiedCardsCounter) {
                    studiedCardsCounter.textContent = `–ò–∑—É—á–µ–Ω–æ: ${sessionStats.total}`;
                }

                // Move to next card
                showCard(currentCardIndex + 1);

            } catch (error) {
                console.error('Error rating card:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            }
        }

        // Complete the study session
        async function completeSession() {
            try {
                const response = await fetch('/study/api/complete-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    // Hide flashcard and show completion screen
                    cardFront.style.display = 'none';
                    cardBack.style.display = 'none';
                    sessionComplete.style.display = 'flex';

                    // Update stats display
                    statsWords.textContent = data.stats.words_studied;
                    statsCorrect.textContent = data.stats.correct;
                    statsScore.textContent = data.stats.percentage + '%';

                    // Update XP display
                    if (data.xp_earned) {
                        document.getElementById('xp-earned-amount').textContent = data.xp_earned;
                        document.getElementById('current-level').textContent = data.level || 1;
                        document.getElementById('total-xp').textContent = data.total_xp || 0;
                    }
                }

            } catch (error) {
                console.error('Error completing session:', error);
                // –ù–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                window.location.href = '{{ url_for("study.index") }}';
            }
        }

        // Show "no cards" message
        function showNoCardsMessage() {
            loadingSpinner.style.display = 'none';
            noCardsMessage.style.display = 'block';
        }

        // Event Listeners
        showAnswerBtn.addEventListener('click', function() {
            flipCard();
        });

        // Audio button clicks
        frontAudioBtn.addEventListener('click', function(e) {
            wordAudio.play();
        });

        backAudioBtn.addEventListener('click', function(e) {
            wordAudio.play();
        });

        // Rating buttons
        document.querySelectorAll('.rating-btn').forEach(button => {
            button.addEventListener('click', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                rateCard(rating);
            });
        });

        // End session early
        endSessionBtn.addEventListener('click', function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é?')) {
                try {
                    completeSession();
                } catch(e) {
                    console.error('Error in complete session:', e);
                    // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    window.location.href = '{{ url_for("study.index") }}';
                }
            }
        });

        // Keyboard shortcuts for rating cards (Unified 1-2-3 scale)
        document.addEventListener('keydown', function(e) {
            // Rating shortcuts when card back is visible
            if (cardBack.style.display === 'flex') {
                if (e.key === '1') {
                    e.preventDefault();
                    rateCard(1); // –ù–µ –∑–Ω–∞—é (show in 1-2 cards)
                } else if (e.key === '2') {
                    e.preventDefault();
                    rateCard(2); // –°–æ–º–Ω–µ–≤–∞—é—Å—å (show in 3-5 cards)
                } else if (e.key === '3') {
                    e.preventDefault();
                    rateCard(3); // –ó–Ω–∞—é (done)
                }
            }
            // Show answer when front card is visible and spacebar is pressed
            else if (cardFront.style.display === 'flex' && e.code === 'Space') {
                e.preventDefault();
                flipCard();
            }
            // Ctrl+Shift+X –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞
            else if (e.ctrlKey && e.shiftKey && e.key === 'X') {
                window.location.href = '{{ url_for("study.index") }}';
            }
        });

        // Initialize the app
        initApp();
    });
</script>
{% endblock %}