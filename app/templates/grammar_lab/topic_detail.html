{% extends "base.html" %}

{% block title %}{{ topic.title }} - Grammar Lab{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/grammar-lab.css') }}?v={{ range(1000, 9999) | random }}">
{% endblock %}

{% block body_class %}grammar-lab-page{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav class="gl-breadcrumb" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('grammar_lab.index') }}">Grammar Lab</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('grammar_lab.topics', level=topic.level) }}">{{ topic.level }}</a></li>
            <li class="breadcrumb-item active">{{ topic.title }}</li>
        </ol>
    </nav>

    <!-- Hero Header -->
    <div class="gl-hero">
        <div class="gl-hero-content">
            <div class="gl-level-badge">
                <i class="fas fa-layer-group"></i>
                {{ topic.level }}
            </div>
            <h1>{{ topic.title }}</h1>
            <p class="gl-hero-subtitle">{{ topic.title_ru }}</p>

            {% if topic.progress %}
            <div class="gl-hero-progress">
                {% set progress_pct = (topic.progress.mastery_level / 5 * 100) %}
                <div class="gl-hero-progress-bar" style="width: {{ progress_pct }}%;"></div>
            </div>
            <div class="gl-hero-stats">
                <div class="gl-hero-stat">
                    <span class="gl-hero-stat-value">{{ topic.progress.mastery_level }}/5</span>
                    <span class="gl-hero-stat-label">Уровень</span>
                </div>
                <div class="gl-hero-stat">
                    <span class="gl-hero-stat-value">{{ topic.progress.correct_attempts }}</span>
                    <span class="gl-hero-stat-label">Верно</span>
                </div>
                <div class="gl-hero-stat">
                    <span class="gl-hero-stat-value">{{ topic.progress.total_attempts }}</span>
                    <span class="gl-hero-stat-label">Всего</span>
                </div>
            </div>
            {% endif %}
        </div>

        {% if topic.progress %}
        <div class="gl-xp-badge">
            <i class="fas fa-star"></i>
            <span>{{ topic.progress.xp_earned }} XP</span>
        </div>
        {% endif %}
    </div>

    <!-- Content Grid -->
    <div class="gl-content-grid">
        <!-- Main Content -->
        <div class="gl-main">
            <!-- Theory Card -->
            <div class="gl-card" id="theory">
                <div class="gl-card-header">
                    <h3>
                        <span class="gl-card-header-icon theory">
                            <i class="fas fa-book-open"></i>
                        </span>
                        Теория
                    </h3>
                    {% if topic.progress and topic.progress.theory_completed %}
                    <span class="gl-completed-badge">
                        <i class="fas fa-check"></i>
                        Изучено
                    </span>
                    {% endif %}
                </div>
                <div class="gl-card-body">
                    {% if topic.content %}
                        <!-- Introduction -->
                        {% if topic.content.introduction %}
                        <div class="gl-theory-intro">
                            {{ topic.content.introduction }}
                        </div>
                        {% endif %}

                        <!-- Sections -->
                        {% if topic.content.sections %}
                        {% for section in topic.content.sections %}
                        <div class="gl-theory-section">
                            <h5>{{ section.subtitle }}</h5>
                            {% if section.description %}
                            <p>{{ section.description }}</p>
                            {% endif %}

                            <!-- Table -->
                            {% if section.table %}
                            <table class="gl-grammar-table">
                                <tbody>
                                {% for row in section.table %}
                                <tr>
                                    {% if row.pronoun %}<td class="pronoun">{{ row.pronoun }}</td>{% endif %}
                                    {% if row.form %}<td><span class="form">{{ row.form }}</span></td>{% endif %}
                                    {% if row.example %}<td>{{ row.example }}</td>{% endif %}
                                    {% if row.translation %}<td class="translation">{{ row.translation }}</td>{% endif %}
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            {% endif %}

                            <!-- Rules -->
                            {% if section.rules %}
                            <ul class="gl-rules-list">
                                {% for rule in section.rules %}
                                <li class="gl-rule-item">
                                    <strong>{{ rule.rule }}</strong>
                                    {% if rule.examples %}
                                    <ul>
                                        {% for example in rule.examples %}
                                        <li>{{ example }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {% if rule.note %}
                                    <div class="gl-rule-note">{{ rule.note }}</div>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            <!-- Usage -->
                            {% if section.usage %}
                            <ul class="gl-rules-list">
                                {% for usage in section.usage %}
                                <li class="gl-rule-item">
                                    <strong>{{ usage.case }}</strong>
                                    {% if usage.examples %}
                                    <ul>
                                        {% for example in usage.examples %}
                                        <li>{{ example }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}

                        <!-- Important Notes -->
                        {% if topic.content.important_notes %}
                        <div class="gl-important">
                            <div class="gl-important-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                Важно
                            </div>
                            <ul>
                                {% for note in topic.content.important_notes %}
                                <li>{{ note }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Common Mistakes -->
                        {% if topic.content.common_mistakes %}
                        <div class="gl-mistakes">
                            <div class="gl-mistakes-header">
                                <i class="fas fa-times-circle"></i>
                                Типичные ошибки
                            </div>
                            {% for mistake in topic.content.common_mistakes %}
                            <div class="gl-mistake-item">
                                <span class="gl-mistake-wrong">{{ mistake.wrong }}</span>
                                <i class="fas fa-arrow-right gl-mistake-arrow"></i>
                                <span class="gl-mistake-correct">{{ mistake.correct }}</span>
                            </div>
                            {% if mistake.explanation %}
                            <span class="gl-mistake-explain">{{ mistake.explanation }}</span>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Summary Table -->
                        {% if topic.content.summary_table %}
                        <div class="gl-summary">
                            <div class="gl-summary-header">
                                <i class="fas fa-table"></i>
                                Сводная таблица
                            </div>
                            <table>
                                <tbody>
                                {% if topic.content.summary_table.affirmative %}
                                <tr><td>+</td><td>{{ topic.content.summary_table.affirmative }}</td></tr>
                                {% endif %}
                                {% if topic.content.summary_table.negative %}
                                <tr><td>-</td><td>{{ topic.content.summary_table.negative }}</td></tr>
                                {% endif %}
                                {% if topic.content.summary_table.question %}
                                <tr><td>?</td><td>{{ topic.content.summary_table.question }}</td></tr>
                                {% endif %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted text-center">Теоретический материал скоро будет добавлен.</p>
                    {% endif %}

                    {% if not topic.progress or not topic.progress.theory_completed %}
                    <div class="text-center mt-4">
                        <button type="button" class="gl-theory-complete-btn" id="complete-theory-btn">
                            <i class="fas fa-check"></i>
                            Теория изучена (+20 XP)
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Practice Card -->
            <div class="gl-card" id="practice">
                <div class="gl-card-header">
                    <h3>
                        <span class="gl-card-header-icon practice">
                            <i class="fas fa-dumbbell"></i>
                        </span>
                        Практика
                    </h3>
                    <span class="gl-exercise-count">{{ topic.exercise_count }} упражнений</span>
                </div>
                <div class="gl-card-body">
                    {% if topic.exercises %}
                    <div class="gl-practice-start">
                        <div class="gl-practice-icon">
                            <i class="fas fa-play"></i>
                        </div>
                        <h4>Готовы к практике?</h4>
                        <p>Проверьте свои знания в {{ topic.exercise_count }} упражнениях</p>
                        <button type="button" class="gl-start-btn" id="start-practice-btn">
                            <i class="fas fa-rocket"></i>
                            Начать практику
                        </button>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">Упражнения скоро будут добавлены.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="gl-sidebar">
            <!-- Progress Card -->
            {% if topic.progress %}
            <div class="gl-sidebar-card gl-progress-card">
                <div class="gl-card-header">
                    <h4>
                        <span class="gl-card-header-icon progress">
                            <i class="fas fa-chart-line"></i>
                        </span>
                        Ваш прогресс
                    </h4>
                </div>
                <div class="gl-card-body">
                    <div class="gl-mastery-section">
                        <div class="gl-mastery-label">
                            <span>Мастерство</span>
                            <strong>{{ topic.progress.mastery_level }}/5</strong>
                        </div>
                        <div class="gl-mastery-bar">
                            {% set mastery_pct = (topic.progress.mastery_level / 5 * 100) %}
                            <div class="gl-mastery-fill" style="width: {{ mastery_pct }}%;"></div>
                        </div>
                    </div>

                    <div class="gl-stats-grid">
                        <div class="gl-stat-box">
                            <span class="gl-stat-value success">{{ topic.progress.correct_attempts }}</span>
                            <span class="gl-stat-label">Верно</span>
                        </div>
                        <div class="gl-stat-box">
                            <span class="gl-stat-value primary">{{ topic.progress.total_attempts }}</span>
                            <span class="gl-stat-label">Всего</span>
                        </div>
                    </div>

                    {% if topic.progress.total_attempts > 0 %}
                    <div class="gl-accuracy">
                        {% set accuracy = (topic.progress.correct_attempts / topic.progress.total_attempts * 100)|round(1) %}
                        <div class="gl-accuracy-value {% if accuracy >= 80 %}high{% elif accuracy >= 60 %}medium{% else %}low{% endif %}">
                            {{ accuracy }}%
                        </div>
                        <span class="gl-accuracy-label">Точность</span>
                    </div>
                    {% endif %}

                    {% if topic.progress.next_review %}
                    <div class="gl-next-review">
                        <div class="gl-next-review-label">Следующее повторение</div>
                        <div class="gl-next-review-date">{{ topic.progress.next_review[:10] }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Topic Info Card -->
            <div class="gl-sidebar-card">
                <div class="gl-card-header">
                    <h4>
                        <span class="gl-card-header-icon info">
                            <i class="fas fa-info-circle"></i>
                        </span>
                        О теме
                    </h4>
                </div>
                <div class="gl-card-body">
                    <ul class="gl-info-list">
                        <li class="gl-info-item">
                            <span class="gl-info-icon level">
                                <i class="fas fa-layer-group"></i>
                            </span>
                            <div class="gl-info-text">
                                <span>Уровень</span>
                                <strong>{{ topic.level }}</strong>
                            </div>
                        </li>
                        {% if topic.estimated_time %}
                        <li class="gl-info-item">
                            <span class="gl-info-icon time">
                                <i class="fas fa-clock"></i>
                            </span>
                            <div class="gl-info-text">
                                <span>Время изучения</span>
                                <strong>{{ topic.estimated_time }} мин</strong>
                            </div>
                        </li>
                        {% endif %}
                        {% if topic.difficulty %}
                        <li class="gl-info-item">
                            <span class="gl-info-icon difficulty">
                                <i class="fas fa-signal"></i>
                            </span>
                            <div class="gl-info-text">
                                <span>Сложность</span>
                                <strong>{% for i in range(topic.difficulty) %}<i class="fas fa-star" style="color: #f59e0b;"></i>{% endfor %}{% for i in range(5 - topic.difficulty) %}<i class="far fa-star" style="color: #e2e8f0;"></i>{% endfor %}</strong>
                            </div>
                        </li>
                        {% endif %}
                        <li class="gl-info-item">
                            <span class="gl-info-icon exercises">
                                <i class="fas fa-dumbbell"></i>
                            </span>
                            <div class="gl-info-text">
                                <span>Упражнений</span>
                                <strong>{{ topic.exercise_count }}</strong>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exercise Modal -->
<div class="modal fade gl-modal" id="exerciseModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-pencil-alt me-2"></i>
                    Упражнение <span id="exercise-number">1</span> из <span id="exercise-total">{{ topic.exercise_count }}</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="exercise-content">
                <!-- Exercise content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <div id="exercise-feedback" class="w-100" style="display: none;"></div>
                <button type="button" class="gl-modal-btn secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="gl-modal-btn primary" id="submit-answer-btn">
                    <i class="fas fa-check"></i>
                    Проверить
                </button>
                <button type="button" class="gl-modal-btn success" id="next-exercise-btn" style="display: none;">
                    Далее
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const topicId = {{ topic.id }};
let exercises = {{ topic.exercises|tojson|safe }};
let currentExerciseIndex = 0;
let sessionId = null;

// Complete theory
document.getElementById('complete-theory-btn')?.addEventListener('click', async function() {
    try {
        const response = await fetch(`/grammar-lab/api/topic/${topicId}/complete-theory`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });
        const data = await response.json();

        if (data.xp_earned > 0) {
            this.innerHTML = '<i class="fas fa-check"></i> Изучено!';
            this.disabled = true;
            this.style.background = 'var(--gl-text-light)';

            // Show XP notification
            const notification = document.createElement('div');
            notification.className = 'gl-xp-notification';
            notification.innerHTML = `<i class="fas fa-star"></i><span>+${data.xp_earned} XP</span>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    } catch (error) {
        console.error('Error completing theory:', error);
    }
});

// Start practice
document.getElementById('start-practice-btn')?.addEventListener('click', async function() {
    try {
        const response = await fetch(`/grammar-lab/api/topic/${topicId}/start-practice`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });
        const data = await response.json();

        if (data.session_id) {
            sessionId = data.session_id;
            exercises = data.exercises || exercises;
            currentExerciseIndex = 0;
            showExercise(0);
            const modal = new bootstrap.Modal(document.getElementById('exerciseModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error starting practice:', error);
    }
});

function showExercise(index) {
    const exercise = exercises[index];
    if (!exercise) return;

    document.getElementById('exercise-number').textContent = index + 1;
    document.getElementById('exercise-total').textContent = exercises.length;

    const content = document.getElementById('exercise-content');
    let html = '';

    switch (exercise.exercise_type) {
        case 'fill_blank':
            html = renderFillBlank(exercise);
            break;
        case 'multiple_choice':
            html = renderMultipleChoice(exercise);
            break;
        case 'reorder':
            html = renderReorder(exercise);
            break;
        case 'true_false':
            html = renderTrueFalse(exercise);
            break;
        case 'translation':
            html = renderTranslation(exercise);
            break;
        case 'error_correction':
            html = renderErrorCorrection(exercise);
            break;
        case 'transformation':
            html = renderTransformation(exercise);
            break;
        case 'matching':
            html = renderMatching(exercise);
            break;
        default:
            html = `<p>Тип упражнения: ${exercise.exercise_type}</p>`;
    }

    content.innerHTML = html;

    // Reset buttons
    document.getElementById('submit-answer-btn').style.display = 'inline-flex';
    document.getElementById('next-exercise-btn').style.display = 'none';
    document.getElementById('exercise-feedback').style.display = 'none';
}

function renderFillBlank(exercise) {
    return `
        <div class="gl-exercise-question">${exercise.question || 'Заполните пропуск:'}</div>
        <input type="text" class="gl-input" id="user-answer" placeholder="Введите ответ" autocomplete="off">
    `;
}

function renderMultipleChoice(exercise) {
    let html = `<div class="gl-exercise-question">${exercise.question || 'Выберите правильный ответ:'}</div>`;
    html += '<div class="gl-options">';
    (exercise.options || []).forEach((option, i) => {
        html += `
            <label class="gl-option" onclick="selectOption(this, ${i})">
                <input type="radio" name="answer" value="${i}">
                <span class="gl-option-radio"></span>
                <span class="gl-option-text">${option}</span>
            </label>
        `;
    });
    html += '</div>';
    return html;
}

function selectOption(el, value) {
    document.querySelectorAll('.gl-option').forEach(opt => opt.classList.remove('selected'));
    el.classList.add('selected');
    el.querySelector('input').checked = true;
}

function renderReorder(exercise) {
    const words = exercise.words || [];
    let html = `<div class="gl-exercise-question">${exercise.instruction || 'Составьте предложение из слов:'}</div>`;
    html += '<div class="gl-word-bank" id="word-bank">';
    words.forEach((word, i) => {
        html += `<button type="button" class="gl-word-btn" data-index="${i}" data-word="${word}">${word}</button>`;
    });
    html += '</div>';
    html += '<div class="gl-answer-area empty" id="answer-area">Нажмите на слова выше</div>';
    html += '<input type="hidden" id="user-answer" value="">';

    setTimeout(() => {
        const wordBank = document.getElementById('word-bank');
        const answerArea = document.getElementById('answer-area');
        const hiddenInput = document.getElementById('user-answer');
        let selectedWords = [];

        wordBank.querySelectorAll('.gl-word-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.classList.contains('selected')) {
                    const idx = selectedWords.indexOf(this.dataset.word);
                    if (idx > -1) selectedWords.splice(idx, 1);
                    this.classList.remove('selected');
                } else {
                    selectedWords.push(this.dataset.word);
                    this.classList.add('selected');
                }
                if (selectedWords.length > 0) {
                    answerArea.textContent = selectedWords.join(' ');
                    answerArea.classList.remove('empty');
                } else {
                    answerArea.textContent = 'Нажмите на слова выше';
                    answerArea.classList.add('empty');
                }
                hiddenInput.value = selectedWords.join(' ');
            });
        });
    }, 100);

    return html;
}

function renderTrueFalse(exercise) {
    return `
        <div class="gl-exercise-question">${exercise.statement || exercise.question}</div>
        <div class="gl-tf-buttons">
            <button type="button" class="gl-tf-btn true-btn" onclick="selectTF(this, 'true')">
                <i class="fas fa-check"></i>
                <span>Верно</span>
            </button>
            <button type="button" class="gl-tf-btn false-btn" onclick="selectTF(this, 'false')">
                <i class="fas fa-times"></i>
                <span>Неверно</span>
            </button>
        </div>
        <input type="hidden" id="user-answer" value="">
    `;
}

function selectTF(el, value) {
    document.querySelectorAll('.gl-tf-btn').forEach(btn => btn.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('user-answer').value = value;
}

function renderTranslation(exercise) {
    let sentence = exercise.sentence || exercise.question || exercise.content?.sentence || exercise.content?.question || '';
    sentence = sentence.replace(/^Переведите на английский:\s*/i, '');
    return `
        <div class="gl-exercise-question">Переведите на английский:</div>
        <div class="gl-exercise-highlight">${sentence}</div>
        <input type="text" class="gl-input" id="user-answer" placeholder="Ваш перевод" autocomplete="off">
    `;
}

function renderErrorCorrection(exercise) {
    return `
        <div class="gl-exercise-question">Найдите и исправьте ошибку:</div>
        <div class="gl-exercise-highlight" style="background: linear-gradient(135deg, #fef2f2, #fee2e2); color: #991b1b;">${exercise.sentence}</div>
        <input type="text" class="gl-input" id="user-answer" placeholder="Исправленное слово/фраза" autocomplete="off">
    `;
}

function renderTransformation(exercise) {
    return `
        <div class="gl-exercise-question">${exercise.instruction || 'Преобразуйте предложение'}:</div>
        <div class="gl-exercise-highlight">${exercise.original}</div>
        <input type="text" class="gl-input" id="user-answer" placeholder="Введите преобразованное предложение" autocomplete="off">
    `;
}

function renderMatching(exercise) {
    const pairs = exercise.pairs || [];
    let html = `<div class="gl-exercise-question">${exercise.instruction || 'Соотнесите пары:'}</div>`;
    html += '<div class="gl-matching-grid">';
    // Simple implementation - can be enhanced
    pairs.forEach((pair, i) => {
        html += `<div class="gl-matching-item">${pair.english || pair.left} - ${pair.russian || pair.right}</div>`;
    });
    html += '</div>';
    html += '<input type="hidden" id="user-answer" value="matched">';
    return html;
}

// Submit answer
document.getElementById('submit-answer-btn').addEventListener('click', async function() {
    const exercise = exercises[currentExerciseIndex];
    let answer;

    if (exercise.exercise_type === 'multiple_choice') {
        const selected = document.querySelector('input[name="answer"]:checked');
        if (!selected) {
            alert('Выберите ответ');
            return;
        }
        answer = selected.value;
    } else {
        answer = document.getElementById('user-answer').value;
        if (!answer) {
            alert('Введите ответ');
            return;
        }
    }

    try {
        const response = await fetch(`/grammar-lab/api/exercise/${exercise.id}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                answer: answer,
                session_id: sessionId,
                source: 'topic_practice'
            })
        });
        const data = await response.json();

        // Show feedback
        const feedback = document.getElementById('exercise-feedback');
        if (data.is_correct) {
            feedback.className = 'gl-feedback success';
            feedback.innerHTML = `
                <div class="gl-feedback-header">
                    <i class="fas fa-check-circle"></i>
                    Правильно!${data.xp_earned ? ` <span>+${data.xp_earned} XP</span>` : ''}
                </div>
            `;
        } else {
            feedback.className = 'gl-feedback error';
            feedback.innerHTML = `
                <div class="gl-feedback-header">
                    <i class="fas fa-times-circle"></i>
                    Неверно
                </div>
                <div>Правильный ответ: <span class="gl-feedback-answer">${data.correct_answer}</span></div>
                ${data.explanation ? `<div class="gl-feedback-explain">${data.explanation}</div>` : ''}
            `;
        }
        feedback.style.display = 'block';

        // Toggle buttons
        this.style.display = 'none';
        document.getElementById('next-exercise-btn').style.display = 'inline-flex';

        // Disable inputs
        document.querySelectorAll('#exercise-content input, #exercise-content button').forEach(el => el.disabled = true);

    } catch (error) {
        console.error('Error submitting answer:', error);
    }
});

// Next exercise
document.getElementById('next-exercise-btn').addEventListener('click', function() {
    currentExerciseIndex++;
    if (currentExerciseIndex < exercises.length) {
        showExercise(currentExerciseIndex);
    } else {
        // Practice complete
        const modal = bootstrap.Modal.getInstance(document.getElementById('exerciseModal'));
        modal.hide();
        location.reload();
    }
});
</script>
{% endblock %}
