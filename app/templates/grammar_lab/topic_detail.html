{% extends "base.html" %}

{% block title %}{{ topic.title }} - Grammar Lab{% endblock %}

{% block content %}
<div class="container container-xl">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('grammar_lab.index') }}">Grammar Lab</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('grammar_lab.topics', level=topic.level) }}">{{ topic.level }}</a></li>
            <li class="breadcrumb-item active">{{ topic.title }}</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <span class="badge bg-{{ 'primary' if topic.level in ['A1', 'A2'] else 'success' if topic.level in ['B1', 'B2'] else 'warning' }} mb-2">{{ topic.level }}</span>
                    <h1 class="h2 fw-bold mb-1">{{ topic.title }}</h1>
                    <p class="text-muted mb-0">{{ topic.title_ru }}</p>
                </div>
                <div class="text-end">
                    {% if topic.progress %}
                        <div class="mb-2">
                            {% if topic.progress.mastery_level >= 5 %}
                                <span class="badge bg-success fs-6"><i class="fas fa-trophy"></i> Освоено</span>
                            {% else %}
                                <span class="badge bg-info fs-6">Уровень {{ topic.progress.mastery_level }}/5</span>
                            {% endif %}
                        </div>
                        <small class="text-muted d-block">{{ topic.progress.xp_earned }} XP</small>
                    {% endif %}
                </div>
            </div>

            {% if topic.progress %}
            <div class="progress mt-3" style="height: 8px;">
                {% set progress_pct = (topic.progress.mastery_level / 5 * 100) %}
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress_pct }}%;"></div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Theory Section -->
        <div class="col-lg-8">
            <div class="card mb-4 shadow-sm" id="theory">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-book-open text-primary me-2"></i>Теория
                    </h4>
                    {% if topic.progress and topic.progress.theory_completed %}
                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>Изучено</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if topic.content %}
                        <!-- Introduction -->
                        {% if topic.content.introduction %}
                        <div class="alert alert-info mb-4">
                            {{ topic.content.introduction }}
                        </div>
                        {% endif %}

                        <!-- Sections -->
                        {% if topic.content.sections %}
                        {% for section in topic.content.sections %}
                        <div class="mb-4">
                            <h5 class="fw-bold">{{ section.subtitle }}</h5>
                            {% if section.description %}
                            <p>{{ section.description }}</p>
                            {% endif %}

                            <!-- Table -->
                            {% if section.table %}
                            <div class="table-responsive mb-3">
                                <table class="table table-bordered table-striped">
                                    <tbody>
                                    {% for row in section.table %}
                                    <tr>
                                        {% if row.pronoun %}<td class="fw-bold">{{ row.pronoun }}</td>{% endif %}
                                        {% if row.form %}<td><code>{{ row.form }}</code></td>{% endif %}
                                        {% if row.example %}<td>{{ row.example }}</td>{% endif %}
                                        {% if row.translation %}<td class="text-muted">{{ row.translation }}</td>{% endif %}
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}

                            <!-- Rules -->
                            {% if section.rules %}
                            <ul class="list-group mb-3">
                                {% for rule in section.rules %}
                                <li class="list-group-item">
                                    <strong>{{ rule.rule }}</strong>
                                    {% if rule.examples %}
                                    <ul class="mt-2 mb-0">
                                        {% for example in rule.examples %}
                                        <li><em>{{ example }}</em></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {% if rule.note %}
                                    <small class="text-muted d-block mt-1">{{ rule.note }}</small>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            <!-- Usage -->
                            {% if section.usage %}
                            <div class="list-group">
                                {% for usage in section.usage %}
                                <div class="list-group-item">
                                    <h6 class="mb-1">{{ usage.case }}</h6>
                                    {% if usage.examples %}
                                    <ul class="mb-0 small">
                                        {% for example in usage.examples %}
                                        <li><em>{{ example }}</em></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}

                        <!-- Important Notes -->
                        {% if topic.content.important_notes %}
                        <div class="alert alert-warning">
                            <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-1"></i>Важно:</h6>
                            <ul class="mb-0">
                                {% for note in topic.content.important_notes %}
                                <li>{{ note }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Common Mistakes -->
                        {% if topic.content.common_mistakes %}
                        <div class="card bg-light mb-3">
                            <div class="card-header"><i class="fas fa-times-circle text-danger me-1"></i>Типичные ошибки</div>
                            <div class="card-body">
                                {% for mistake in topic.content.common_mistakes %}
                                <div class="mb-2">
                                    <span class="text-danger"><del>{{ mistake.wrong }}</del></span>
                                    <i class="fas fa-arrow-right mx-2"></i>
                                    <span class="text-success">{{ mistake.correct }}</span>
                                    {% if mistake.explanation %}
                                    <small class="text-muted d-block">{{ mistake.explanation }}</small>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Summary Table -->
                        {% if topic.content.summary_table %}
                        <div class="card bg-primary bg-opacity-10">
                            <div class="card-header bg-primary text-white"><i class="fas fa-table me-1"></i>Сводная таблица</div>
                            <div class="card-body">
                                <table class="table table-sm mb-0">
                                    <tbody>
                                    {% if topic.content.summary_table.affirmative %}
                                    <tr><td class="fw-bold">+</td><td>{{ topic.content.summary_table.affirmative }}</td></tr>
                                    {% endif %}
                                    {% if topic.content.summary_table.negative %}
                                    <tr><td class="fw-bold">-</td><td>{{ topic.content.summary_table.negative }}</td></tr>
                                    {% endif %}
                                    {% if topic.content.summary_table.question %}
                                    <tr><td class="fw-bold">?</td><td>{{ topic.content.summary_table.question }}</td></tr>
                                    {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">Теоретический материал скоро будет добавлен.</p>
                    {% endif %}

                    {% if not topic.progress or not topic.progress.theory_completed %}
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-success btn-lg" id="complete-theory-btn">
                            <i class="fas fa-check me-2"></i>Теория изучена (+20 XP)
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Practice Section -->
            <div class="card mb-4 shadow-sm" id="practice">
                <div class="card-header bg-white">
                    <h4 class="mb-0">
                        <i class="fas fa-dumbbell text-success me-2"></i>Практика
                        <span class="badge bg-secondary ms-2">{{ topic.exercise_count }} упражнений</span>
                    </h4>
                </div>
                <div class="card-body">
                    {% if topic.exercises %}
                    <div id="exercises-container">
                        <!-- Exercises will be loaded dynamically -->
                        <div class="text-center py-4">
                            <button type="button" class="btn btn-primary btn-lg" id="start-practice-btn">
                                <i class="fas fa-play me-2"></i>Начать практику
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">Упражнения скоро будут добавлены.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Progress Card -->
            {% if topic.progress %}
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line text-primary me-2"></i>Ваш прогресс</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Мастерство</span>
                            <strong>{{ topic.progress.mastery_level }}/5</strong>
                        </div>
                        <div class="progress" style="height: 10px;">
                            {% set mastery_pct = (topic.progress.mastery_level / 5 * 100) %}
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ mastery_pct }}%;"></div>
                        </div>
                    </div>

                    <div class="row text-center">
                        <div class="col-6">
                            <div class="h4 mb-0 text-success">{{ topic.progress.correct_attempts }}</div>
                            <small class="text-muted">Верно</small>
                        </div>
                        <div class="col-6">
                            <div class="h4 mb-0 text-primary">{{ topic.progress.total_attempts }}</div>
                            <small class="text-muted">Всего</small>
                        </div>
                    </div>

                    {% if topic.progress.total_attempts > 0 %}
                    <hr>
                    <div class="text-center">
                        {% set accuracy = (topic.progress.correct_attempts / topic.progress.total_attempts * 100)|round(1) %}
                        <div class="h3 mb-0 {% if accuracy >= 80 %}text-success{% elif accuracy >= 60 %}text-warning{% else %}text-danger{% endif %}">
                            {{ accuracy }}%
                        </div>
                        <small class="text-muted">Точность</small>
                    </div>
                    {% endif %}

                    {% if topic.progress.next_review %}
                    <hr>
                    <div class="text-center">
                        <small class="text-muted">Следующее повторение:</small>
                        <div>{{ topic.progress.next_review[:10] }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Topic Info -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle text-info me-2"></i>О теме</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-layer-group text-primary me-2"></i>
                            Уровень: <strong>{{ topic.level }}</strong>
                        </li>
                        {% if topic.estimated_time %}
                        <li class="mb-2">
                            <i class="fas fa-clock text-warning me-2"></i>
                            Время: <strong>{{ topic.estimated_time }} мин</strong>
                        </li>
                        {% endif %}
                        {% if topic.difficulty %}
                        <li class="mb-2">
                            <i class="fas fa-signal text-danger me-2"></i>
                            Сложность: <strong>{% for i in range(topic.difficulty) %}*{% endfor %}</strong>
                        </li>
                        {% endif %}
                        <li>
                            <i class="fas fa-dumbbell text-success me-2"></i>
                            Упражнений: <strong>{{ topic.exercise_count }}</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exercise Modal -->
<div class="modal fade" id="exerciseModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Упражнение <span id="exercise-number">1</span> из <span id="exercise-total">{{ topic.exercise_count }}</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="exercise-content">
                <!-- Exercise content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <div id="exercise-feedback" class="w-100 mb-3" style="display: none;"></div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="submit-answer-btn">Проверить</button>
                <button type="button" class="btn btn-success" id="next-exercise-btn" style="display: none;">Далее</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const topicId = {{ topic.id }};
let exercises = {{ topic.exercises|tojson|safe }};
let currentExerciseIndex = 0;
let sessionId = null;

// Complete theory
document.getElementById('complete-theory-btn')?.addEventListener('click', async function() {
    try {
        const response = await fetch(`/grammar-lab/api/topic/${topicId}/complete-theory`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });
        const data = await response.json();

        if (data.xp_earned > 0) {
            this.innerHTML = '<i class="fas fa-check me-2"></i>Изучено!';
            this.classList.remove('btn-success');
            this.classList.add('btn-secondary');
            this.disabled = true;

            // Show XP notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
            notification.innerHTML = `+${data.xp_earned} XP! <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    } catch (error) {
        console.error('Error completing theory:', error);
    }
});

// Start practice
document.getElementById('start-practice-btn')?.addEventListener('click', async function() {
    try {
        const response = await fetch(`/grammar-lab/api/topic/${topicId}/start-practice`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });
        const data = await response.json();

        if (data.session_id) {
            sessionId = data.session_id;
            exercises = data.exercises || exercises;
            currentExerciseIndex = 0;
            showExercise(0);
            const modal = new bootstrap.Modal(document.getElementById('exerciseModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error starting practice:', error);
    }
});

function showExercise(index) {
    const exercise = exercises[index];
    if (!exercise) return;

    document.getElementById('exercise-number').textContent = index + 1;
    document.getElementById('exercise-total').textContent = exercises.length;

    const content = document.getElementById('exercise-content');
    let html = '';

    switch (exercise.exercise_type) {
        case 'fill_blank':
            html = renderFillBlank(exercise);
            break;
        case 'multiple_choice':
            html = renderMultipleChoice(exercise);
            break;
        case 'reorder':
            html = renderReorder(exercise);
            break;
        case 'true_false':
            html = renderTrueFalse(exercise);
            break;
        case 'translation':
            html = renderTranslation(exercise);
            break;
        case 'error_correction':
            html = renderErrorCorrection(exercise);
            break;
        case 'transformation':
            html = renderTransformation(exercise);
            break;
        default:
            html = `<p>Тип упражнения: ${exercise.exercise_type}</p><pre>${JSON.stringify(exercise.content, null, 2)}</pre>`;
    }

    content.innerHTML = html;

    // Reset buttons
    document.getElementById('submit-answer-btn').style.display = 'inline-block';
    document.getElementById('next-exercise-btn').style.display = 'none';
    document.getElementById('exercise-feedback').style.display = 'none';
}

function renderFillBlank(exercise) {
    return `
        <div class="mb-3">
            <label class="form-label fs-5">${exercise.question || 'Заполните пропуск:'}</label>
            <input type="text" class="form-control form-control-lg" id="user-answer" placeholder="Введите ответ" autocomplete="off">
        </div>
    `;
}

function renderMultipleChoice(exercise) {
    let html = `<div class="mb-3"><p class="fs-5">${exercise.question || 'Выберите правильный ответ:'}</p>`;
    (exercise.options || []).forEach((option, i) => {
        html += `
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="answer" id="option-${i}" value="${i}">
                <label class="form-check-label fs-5" for="option-${i}">${option}</label>
            </div>
        `;
    });
    html += '</div>';
    return html;
}

function renderReorder(exercise) {
    const words = exercise.words || [];
    let html = `<p class="mb-3 fs-5">${exercise.instruction || 'Составьте предложение из слов:'}</p>`;
    html += '<div class="d-flex flex-wrap gap-2 mb-3" id="word-bank">';
    words.forEach((word, i) => {
        html += `<button type="button" class="btn btn-outline-primary word-btn" data-index="${i}" data-word="${word}">${word}</button>`;
    });
    html += '</div>';
    html += '<div class="border rounded p-3 min-height-50" id="answer-area"><span class="text-muted">Нажмите на слова выше</span></div>';
    html += '<input type="hidden" id="user-answer" value="">';

    setTimeout(() => {
        const wordBank = document.getElementById('word-bank');
        const answerArea = document.getElementById('answer-area');
        const hiddenInput = document.getElementById('user-answer');
        let selectedWords = [];

        wordBank.querySelectorAll('.word-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.classList.contains('btn-primary')) {
                    // Remove from answer
                    const idx = selectedWords.indexOf(this.dataset.word);
                    if (idx > -1) selectedWords.splice(idx, 1);
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-outline-primary');
                } else {
                    // Add to answer
                    selectedWords.push(this.dataset.word);
                    this.classList.add('btn-primary');
                    this.classList.remove('btn-outline-primary');
                }
                answerArea.innerHTML = selectedWords.length > 0 ? selectedWords.join(' ') : '<span class="text-muted">Нажмите на слова выше</span>';
                hiddenInput.value = selectedWords.join(' ');
            });
        });
    }, 100);

    return html;
}

function renderTrueFalse(exercise) {
    return `
        <div class="mb-3">
            <p class="fs-5">${exercise.statement || exercise.question}</p>
            <div class="d-flex gap-3">
                <button type="button" class="btn btn-outline-success btn-lg flex-grow-1 tf-btn" data-value="true">
                    <i class="fas fa-check me-2"></i>Верно
                </button>
                <button type="button" class="btn btn-outline-danger btn-lg flex-grow-1 tf-btn" data-value="false">
                    <i class="fas fa-times me-2"></i>Неверно
                </button>
            </div>
            <input type="hidden" id="user-answer" value="">
        </div>
    `;
}

function renderTranslation(exercise) {
    const sentence = exercise.content?.sentence || exercise.content?.question || exercise.sentence || '';
    return `
        <div class="mb-3">
            <label class="form-label">Переведите на английский:</label>
            <p class="fs-5 fw-bold">${sentence}</p>
            <input type="text" class="form-control form-control-lg" id="user-answer" placeholder="Ваш перевод" autocomplete="off">
        </div>
    `;
}

function renderErrorCorrection(exercise) {
    return `
        <div class="mb-3">
            <label class="form-label">Найдите и исправьте ошибку:</label>
            <p class="fs-5 text-danger">${exercise.sentence}</p>
            <input type="text" class="form-control form-control-lg" id="user-answer" placeholder="Исправленное слово/фраза" autocomplete="off">
        </div>
    `;
}

function renderTransformation(exercise) {
    return `
        <div class="mb-3">
            <label class="form-label">${exercise.instruction || 'Преобразуйте предложение'}:</label>
            <p class="fs-5 fw-bold">${exercise.original}</p>
            <input type="text" class="form-control form-control-lg" id="user-answer" placeholder="Введите преобразованное предложение" autocomplete="off">
        </div>
    `;
}

// Handle True/False buttons
document.getElementById('exercise-content').addEventListener('click', function(e) {
    if (e.target.classList.contains('tf-btn')) {
        document.querySelectorAll('.tf-btn').forEach(btn => {
            btn.classList.remove('btn-success', 'btn-danger');
            btn.classList.add('btn-outline-success', 'btn-outline-danger');
        });
        e.target.classList.remove('btn-outline-success', 'btn-outline-danger');
        e.target.classList.add(e.target.dataset.value === 'true' ? 'btn-success' : 'btn-danger');
        document.getElementById('user-answer').value = e.target.dataset.value;
    }
});

// Submit answer
document.getElementById('submit-answer-btn').addEventListener('click', async function() {
    const exercise = exercises[currentExerciseIndex];
    let answer;

    if (exercise.exercise_type === 'multiple_choice') {
        const selected = document.querySelector('input[name="answer"]:checked');
        if (!selected) {
            alert('Выберите ответ');
            return;
        }
        answer = selected.value;
    } else {
        answer = document.getElementById('user-answer').value;
        if (!answer) {
            alert('Введите ответ');
            return;
        }
    }

    try {
        const response = await fetch(`/grammar-lab/api/exercise/${exercise.id}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                answer: answer,
                session_id: sessionId,
                source: 'topic_practice'
            })
        });
        const data = await response.json();

        // Show feedback
        const feedback = document.getElementById('exercise-feedback');
        if (data.is_correct) {
            feedback.className = 'alert alert-success w-100 mb-3';
            feedback.innerHTML = `<i class="fas fa-check-circle me-2"></i>Правильно!${data.xp_earned ? ` +${data.xp_earned} XP` : ''}`;
        } else {
            feedback.className = 'alert alert-danger w-100 mb-3';
            feedback.innerHTML = `<i class="fas fa-times-circle me-2"></i>Неверно. Правильный ответ: <strong>${data.correct_answer}</strong>`;
            if (data.explanation) {
                feedback.innerHTML += `<br><small>${data.explanation}</small>`;
            }
        }
        feedback.style.display = 'block';

        // Toggle buttons
        this.style.display = 'none';
        document.getElementById('next-exercise-btn').style.display = 'inline-block';

        // Disable inputs
        document.querySelectorAll('#exercise-content input, #exercise-content button').forEach(el => el.disabled = true);

    } catch (error) {
        console.error('Error submitting answer:', error);
    }
});

// Next exercise
document.getElementById('next-exercise-btn').addEventListener('click', function() {
    currentExerciseIndex++;
    if (currentExerciseIndex < exercises.length) {
        showExercise(currentExerciseIndex);
    } else {
        // Practice complete
        const modal = bootstrap.Modal.getInstance(document.getElementById('exerciseModal'));
        modal.hide();
        location.reload(); // Reload to update progress
    }
});
</script>
{% endblock %}
