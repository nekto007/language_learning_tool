{% extends "base.html" %}

{% block title %}{{ topic.title }} - Grammar Lab{% endblock %}

{% block content %}
<div class="grammar-page">
  <!-- Breadcrumb -->
  <nav class="grammar-breadcrumb" aria-label="breadcrumb">
    <a href="{{ url_for('grammar_lab.index') }}">Grammar Lab</a>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M9 18l6-6-6-6"/>
    </svg>
    <a href="{{ url_for('grammar_lab.topics', level=topic.level) }}">{{ topic.level }}</a>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M9 18l6-6-6-6"/>
    </svg>
    <span>{{ topic.title }}</span>
  </nav>

  <!-- Hero -->
  <div class="topic-hero topic-hero--{{ topic.level[0]|lower }}">
    <div class="topic-hero__bg-shapes">
      <div class="shape shape--1"></div>
      <div class="shape shape--2"></div>
      <div class="shape shape--3"></div>
    </div>

    <div class="topic-hero__content">
      <div class="topic-hero__badge">{{ topic.level }}</div>
      <h1 class="topic-hero__title">{{ topic.title }}</h1>
      <p class="topic-hero__subtitle">{{ topic.title_ru }}</p>

      {% if topic.progress %}
      {% set topic_status = topic.progress.status|default('new') %}
      {% set status_pct = {'new': 0, 'theory_completed': 33, 'practicing': 66, 'mastered': 100} %}
      {% set status_labels = {'new': 'Новая', 'theory_completed': 'Теория изучена', 'practicing': 'Практикуется', 'mastered': 'Освоена'} %}
      <div class="topic-hero__progress">
        <div class="topic-hero__progress-bar">
          <div class="topic-hero__progress-fill" style="width: {{ status_pct.get(topic_status, 0) }}%;"></div>
        </div>
        <div class="topic-hero__stats">
          <div class="topic-hero__stat">
            <span class="topic-hero__stat-value">{{ status_labels.get(topic_status, 'Новая') }}</span>
            <span class="topic-hero__stat-label">Статус</span>
          </div>
          <div class="topic-hero__stat">
            <span class="topic-hero__stat-value">{{ topic.progress.correct_attempts }}</span>
            <span class="topic-hero__stat-label">Верно</span>
          </div>
          <div class="topic-hero__stat">
            <span class="topic-hero__stat-value">{{ topic.progress.total_attempts }}</span>
            <span class="topic-hero__stat-label">Всего</span>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    {% if topic.progress %}
    <div class="topic-hero__xp">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
      </svg>
      {{ topic.progress.xp_earned }} XP
    </div>
    {% endif %}
  </div>

  <!-- Content Grid -->
  <div class="topic-grid">
    <!-- Main Content -->
    <div class="topic-main">
      <!-- Theory Card -->
      <div class="topic-card" id="theory">
        <div class="topic-card__header">
          <div class="topic-card__header-left">
            <div class="topic-card__icon topic-card__icon--theory">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/>
              </svg>
            </div>
            <h2 class="topic-card__title">Теория</h2>
          </div>
          {% if topic.progress and topic.progress.theory_completed %}
          <span class="topic-card__badge topic-card__badge--success">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
            Изучено
          </span>
          {% endif %}
        </div>

        <div class="topic-card__body">
          {% if topic.content %}
            <!-- Introduction -->
            {% if topic.content.introduction %}
            <div class="theory-intro">
              {{ topic.content.introduction|unescape }}
            </div>
            {% endif %}

            <!-- Sections -->
            {% if topic.content.sections %}
            {% for section in topic.content.sections %}
            <div class="theory-section">
              <h3 class="theory-section__title">{{ section.subtitle|unescape }}</h3>
              {% if section.description %}
              <p class="theory-section__desc">{{ section.description|unescape }}</p>
              {% endif %}

              <!-- Table -->
              {% if section.table %}
              <div class="theory-table-wrapper">
                <table class="theory-table">
                  <tbody>
                  {% for row in section.table %}
                  <tr>
                    {% if row.pronoun %}<td class="theory-table__pronoun">{{ row.pronoun|unescape }}</td>{% endif %}
                    {% if row.form %}<td class="theory-table__form">{{ row.form|unescape }}</td>{% endif %}
                    {% if row.example %}<td>{{ row.example|unescape }}</td>{% endif %}
                    {% if row.translation %}<td class="theory-table__translation">{{ row.translation|unescape }}</td>{% endif %}
                  </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
              {% endif %}

              <!-- Rules -->
              {% if section.rules %}
              <ul class="theory-rules">
                {% for rule in section.rules %}
                <li class="theory-rule">
                  <strong>{{ rule.rule|unescape }}</strong>
                  {% if rule.examples %}
                  <ul class="theory-rule__examples">
                    {% for example in rule.examples %}
                    <li>{{ example|unescape }}</li>
                    {% endfor %}
                  </ul>
                  {% endif %}
                  {% if rule.note %}
                  <div class="theory-rule__note">{{ rule.note|unescape }}</div>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
              {% endif %}

              <!-- Usage -->
              {% if section.usage %}
              <ul class="theory-rules">
                {% for usage in section.usage %}
                <li class="theory-rule">
                  <strong>{{ usage.case|unescape }}</strong>
                  {% if usage.examples %}
                  <ul class="theory-rule__examples">
                    {% for example in usage.examples %}
                    <li>{{ example|unescape }}</li>
                    {% endfor %}
                  </ul>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
            {% endfor %}
            {% endif %}

            <!-- Important Notes -->
            {% if topic.content.important_notes %}
            <div class="theory-alert theory-alert--warning">
              <div class="theory-alert__header">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                Важно
              </div>
              <ul>
                {% for note in topic.content.important_notes %}
                <li>{{ note|unescape }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <!-- Common Mistakes -->
            {% if topic.content.common_mistakes %}
            <div class="theory-alert theory-alert--danger">
              <div class="theory-alert__header">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M15 9l-6 6M9 9l6 6"/>
                </svg>
                Типичные ошибки
              </div>
              {% for mistake in topic.content.common_mistakes %}
              <div class="theory-mistake">
                <span class="theory-mistake__wrong">{{ mistake.wrong|unescape }}</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
                <span class="theory-mistake__correct">{{ mistake.correct|unescape }}</span>
              </div>
              {% if mistake.explanation %}
              <p class="theory-mistake__explain">{{ mistake.explanation|unescape }}</p>
              {% endif %}
              {% endfor %}
            </div>
            {% endif %}

            <!-- Summary Table -->
            {% if topic.content.summary or topic.content.summary_table %}
            {% set summary = topic.content.summary or topic.content.summary_table %}
            <div class="theory-summary">
              <div class="theory-summary__header">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <path d="M3 9h18M9 21V9"/>
                </svg>
                {% if summary is mapping %}{{ summary.title or 'Сводная таблица' }}{% else %}Сводная таблица{% endif %}
              </div>
              {% if summary is mapping and summary.table %}
              {# DICT с table: стандартная или динамическая таблица #}
              {% set first_row = summary.table[0] %}
              {% set keys = first_row.keys()|list %}
              {% if 'affirmative' in keys %}
              <div class="theory-table-wrapper">
                <table class="theory-table theory-table--summary">
                  <thead>
                    <tr>
                      <th></th>
                      <th>+</th>
                      <th>-</th>
                      <th>?</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for row in summary.table %}
                  <tr>
                    <td class="theory-table__pronoun">{{ row.subject|unescape }}</td>
                    <td>{{ row.affirmative|unescape }}</td>
                    <td>{{ row.negative|unescape }}</td>
                    <td>{{ row.question|unescape }}</td>
                  </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <div class="theory-table-wrapper">
                <table class="theory-table theory-table--summary">
                  <thead>
                    <tr>
                      {% set col_names = {'usage': 'Использование', 'article': 'Артикль', 'examples': 'Примеры', 'form': 'Форма', 'example': 'Пример', 'pronoun': 'Местоимение', 'translation': 'Перевод', 'rule': 'Правило', 'case': 'Случай', 'signal_words': 'Слова-маркеры', 'structure': 'Структура', 'tense': 'Время', 'type': 'Тип', 'positive': 'Утверждение', 'negative': 'Отрицание', 'question': 'Вопрос', 'subject': 'Подлежащее', 'verb': 'Глагол', 'meaning': 'Значение', 'description': 'Описание', 'note': 'Примечание', 'word': 'Слово', 'phrase': 'Фраза', 'difference': 'Различие', 'correct': 'Правильно', 'incorrect': 'Неправильно', 'preposition': 'Предлог', 'conjunction': 'Союз', 'category': 'Категория', 'singular': 'Единственное', 'plural': 'Множественное', 'affirmative': 'Утверждение'} %}{% for key in keys %}<th>{{ col_names.get(key, key|replace('_', ' ')|capitalize) }}</th>{% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                  {% for row in summary.table %}
                  <tr>
                    {% for key in keys %}<td>{{ row[key]|unescape }}</td>{% endfor %}
                  </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
              {% endif %}
              {% elif summary is mapping and summary.rules %}
              {# DICT с rules: список правил #}
              <div class="theory-table-wrapper">
                <table class="theory-table">
                  <tbody>
                  {% for rule in summary.rules %}
                  <tr><td>{{ rule|unescape }}</td></tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
              {% elif summary is mapping %}
              {# DICT простой: affirmative/negative/question #}
              <div class="theory-table-wrapper">
                <table class="theory-table">
                  <tbody>
                  {% if summary.affirmative %}
                  <tr><td class="theory-table__pronoun">+</td><td>{{ summary.affirmative|unescape }}</td></tr>
                  {% endif %}
                  {% if summary.negative %}
                  <tr><td class="theory-table__pronoun">-</td><td>{{ summary.negative|unescape }}</td></tr>
                  {% endif %}
                  {% if summary.question %}
                  <tr><td class="theory-table__pronoun">?</td><td>{{ summary.question|unescape }}</td></tr>
                  {% endif %}
                  </tbody>
                </table>
              </div>
              {% else %}
              {# LIST: динамическая таблица из списка словарей #}
              {% set first_row = summary[0] %}
              {% set keys = first_row.keys()|list %}
              <div class="theory-table-wrapper">
                <table class="theory-table theory-table--summary">
                  <thead>
                    <tr>
                      {% set col_names = {'usage': 'Использование', 'article': 'Артикль', 'examples': 'Примеры', 'form': 'Форма', 'example': 'Пример', 'pronoun': 'Местоимение', 'translation': 'Перевод', 'rule': 'Правило', 'case': 'Случай', 'signal_words': 'Слова-маркеры', 'structure': 'Структура', 'tense': 'Время', 'type': 'Тип', 'positive': 'Утверждение', 'negative': 'Отрицание', 'question': 'Вопрос', 'subject': 'Подлежащее', 'verb': 'Глагол', 'meaning': 'Значение', 'description': 'Описание', 'note': 'Примечание', 'word': 'Слово', 'phrase': 'Фраза', 'difference': 'Различие', 'correct': 'Правильно', 'incorrect': 'Неправильно', 'preposition': 'Предлог', 'conjunction': 'Союз', 'category': 'Категория', 'singular': 'Единственное', 'plural': 'Множественное', 'affirmative': 'Утверждение'} %}{% for key in keys %}<th>{{ col_names.get(key, key|replace('_', ' ')|capitalize) }}</th>{% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                  {% for row in summary %}
                  <tr>
                    {% for key in keys %}<td>{{ row[key]|unescape }}</td>{% endfor %}
                  </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
              {% endif %}
            </div>
            {% endif %}
          {% else %}
            <p class="topic-card__empty">Теоретический материал скоро будет добавлен.</p>
          {% endif %}

          {% if not topic.progress or not topic.progress.theory_completed %}
          <div class="topic-card__action">
            <button type="button" class="topic-btn topic-btn--outline" id="complete-theory-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
              </svg>
              Теория изучена (+20 XP)
            </button>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Practice Card -->
      <div class="topic-card" id="practice">
        <div class="topic-card__header">
          <div class="topic-card__header-left">
            <div class="topic-card__icon topic-card__icon--practice">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
              </svg>
            </div>
            <h2 class="topic-card__title">Практика</h2>
          </div>
          <span class="topic-card__badge">{{ topic.exercise_count }} упражнений</span>
        </div>

        <div class="topic-card__body">
          {% if topic.exercises %}
          <div class="practice-start">
            <div class="practice-start__icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <polygon points="5 3 19 12 5 21 5 3"/>
              </svg>
            </div>
            <h3 class="practice-start__title">Готовы к практике?</h3>
            <p class="practice-start__desc">Сессия: <strong>10-12 упражнений</strong> из {{ topic.exercise_count }}</p>
            <p class="practice-start__note">Система подберёт задания на основе вашего прогресса</p>
            <a href="{{ url_for('grammar_lab.practice', topic_id=topic.id) }}" class="topic-btn topic-btn--primary topic-btn--large">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"/>
              </svg>
              Начать практику
            </a>
          </div>
          {% else %}
          <p class="topic-card__empty">Упражнения скоро будут добавлены.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="topic-sidebar">
      <!-- Progress Card -->
      {% if topic.progress %}
      <div class="sidebar-card">
        <div class="sidebar-card__header">
          <div class="sidebar-card__icon sidebar-card__icon--progress">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 20V10M12 20V4M6 20v-6"/>
            </svg>
          </div>
          <h3 class="sidebar-card__title">Ваш прогресс</h3>
        </div>

        <div class="sidebar-card__body">
          {% set sidebar_status = topic.progress.status|default('new') %}
          {% set sidebar_pct = {'new': 0, 'theory_completed': 33, 'practicing': 66, 'mastered': 100} %}
          {% set sidebar_labels = {'new': 'Новая', 'theory_completed': 'Теория изучена', 'practicing': 'Практикуется', 'mastered': 'Освоена'} %}
          <div class="progress-mastery">
            <div class="progress-mastery__header">
              <span>Статус</span>
              <strong>{{ sidebar_labels.get(sidebar_status, 'Новая') }}</strong>
            </div>
            <div class="progress-mastery__bar">
              <div class="progress-mastery__fill" style="width: {{ sidebar_pct.get(sidebar_status, 0) }}%;"></div>
            </div>
          </div>

          <div class="progress-stats">
            <div class="progress-stat progress-stat--success">
              <span class="progress-stat__value">{{ topic.progress.correct_attempts }}</span>
              <span class="progress-stat__label">Верно</span>
            </div>
            <div class="progress-stat progress-stat--primary">
              <span class="progress-stat__value">{{ topic.progress.total_attempts }}</span>
              <span class="progress-stat__label">Всего</span>
            </div>
          </div>

          {% if topic.progress.total_attempts > 0 %}
          <div class="progress-accuracy">
            {% set accuracy = (topic.progress.correct_attempts / topic.progress.total_attempts * 100)|round(1) %}
            <span class="progress-accuracy__value {% if accuracy >= 80 %}progress-accuracy__value--high{% elif accuracy >= 60 %}progress-accuracy__value--medium{% else %}progress-accuracy__value--low{% endif %}">
              {{ accuracy }}%
            </span>
            <span class="progress-accuracy__label">Точность</span>
          </div>
          {% endif %}

          {% if topic.progress.next_review %}
          <div class="progress-review">
            <span class="progress-review__label">Следующее повторение</span>
            <span class="progress-review__date">{{ topic.progress.next_review[:10] }}</span>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Topic Info Card -->
      <div class="sidebar-card">
        <div class="sidebar-card__header">
          <div class="sidebar-card__icon sidebar-card__icon--info">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4M12 8h.01"/>
            </svg>
          </div>
          <h3 class="sidebar-card__title">О теме</h3>
        </div>

        <div class="sidebar-card__body">
          <ul class="info-list">
            <li class="info-item">
              <div class="info-item__icon info-item__icon--level">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
              </div>
              <div class="info-item__content">
                <span class="info-item__label">Уровень</span>
                <strong class="info-item__value">{{ topic.level }}</strong>
              </div>
            </li>
            {% if topic.estimated_time %}
            <li class="info-item">
              <div class="info-item__icon info-item__icon--time">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
              </div>
              <div class="info-item__content">
                <span class="info-item__label">Время изучения</span>
                <strong class="info-item__value">{{ topic.estimated_time }} мин</strong>
              </div>
            </li>
            {% endif %}
            {# Difficulty based on CEFR level: A1=1, A2=2, B1=3, B2=4, C1/C2=5 #}
            {% set level_difficulty = {'A1': 1, 'A2': 2, 'B1': 3, 'B2': 4, 'C1': 5, 'C2': 5} %}
            {% set difficulty_stars = level_difficulty.get(topic.level, 3) %}
            <li class="info-item">
              <div class="info-item__icon info-item__icon--difficulty">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 17V7M12 17V3M18 17v-6"/>
                </svg>
              </div>
              <div class="info-item__content">
                <span class="info-item__label">Сложность</span>
                <strong class="info-item__value">
                  {% for i in range(difficulty_stars) %}<svg width="14" height="14" viewBox="0 0 24 24" fill="#f59e0b" stroke="#f59e0b" stroke-width="1"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>{% endfor %}{% for i in range(5 - difficulty_stars) %}<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="1"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>{% endfor %}
                </strong>
              </div>
            </li>
            <li class="info-item">
              <div class="info-item__icon info-item__icon--exercises">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
                </svg>
              </div>
              <div class="info-item__content">
                <span class="info-item__label">Упражнений</span>
                <strong class="info-item__value">{{ topic.exercise_count }}</strong>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<style>

.grammar-page {
  --grammar-font: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
  --grammar-primary: #8b5cf6;
  --grammar-primary-dark: #7c3aed;
  --grammar-success: #22c55e;
  --grammar-warning: #f59e0b;
  --grammar-danger: #ef4444;
  --grammar-surface: #ffffff;
  --grammar-surface-alt: #f8fafc;
  --grammar-text: #0f172a;
  --grammar-text-muted: #64748b;
  --grammar-border: #e2e8f0;
  --grammar-radius: 16px;
  --grammar-radius-sm: 10px;

  font-family: var(--grammar-font);
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 1rem 3rem;
}

/* Breadcrumb */
.grammar-breadcrumb {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
  color: var(--grammar-text-muted);
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.grammar-breadcrumb a {
  color: var(--grammar-primary);
  text-decoration: none;
  font-weight: 500;
}

.grammar-breadcrumb a:hover {
  text-decoration: underline;
}

.grammar-breadcrumb svg {
  opacity: 0.5;
  flex-shrink: 0;
}

/* Hero */
.topic-hero {
  position: relative;
  border-radius: var(--grammar-radius);
  padding: 2rem;
  margin-bottom: 1.5rem;
  overflow: hidden;
  color: white;
}

.topic-hero--a {
  background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
}

.topic-hero--b {
  background: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
}

.topic-hero--c {
  background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
}

.topic-hero__bg-shapes {
  position: absolute;
  inset: 0;
  overflow: hidden;
  pointer-events: none;
}

.topic-hero .shape {
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1);
}

.topic-hero .shape--1 {
  width: 200px;
  height: 200px;
  top: -80px;
  right: -40px;
  animation: float-1 18s ease-in-out infinite;
}

.topic-hero .shape--2 {
  width: 100px;
  height: 100px;
  bottom: -40px;
  left: 10%;
  animation: float-2 14s ease-in-out infinite;
}

.topic-hero .shape--3 {
  width: 60px;
  height: 60px;
  top: 30%;
  right: 20%;
  animation: float-3 20s ease-in-out infinite;
}

@keyframes float-1 {
  0%, 100% { transform: translate(0, 0) scale(1); }
  50% { transform: translate(-15px, 15px) scale(1.05); }
}

@keyframes float-2 {
  0%, 100% { transform: translate(0, 0) rotate(0deg); }
  50% { transform: translate(20px, -15px) rotate(8deg); }
}

@keyframes float-3 {
  0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.5; }
  50% { transform: translate(-25px, 10px) scale(1.1); opacity: 0.8; }
}

.topic-hero__content {
  position: relative;
  z-index: 1;
}

.topic-hero__badge {
  display: inline-block;
  padding: 0.375rem 0.75rem;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 700;
  backdrop-filter: blur(5px);
  margin-bottom: 0.75rem;
}

.topic-hero__title {
  font-size: 1.75rem;
  font-weight: 700;
  margin: 0 0 0.25rem;
  line-height: 1.2;
  letter-spacing: -0.02em;
}

.topic-hero__subtitle {
  font-size: 1rem;
  margin: 0;
  opacity: 0.9;
}

.topic-hero__progress {
  margin-top: 1.5rem;
}

.topic-hero__progress-bar {
  height: 8px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 1rem;
}

.topic-hero__progress-fill {
  height: 100%;
  background: white;
  border-radius: 4px;
  transition: width 0.5s ease;
}

.topic-hero__stats {
  display: flex;
  gap: 1.5rem;
}

.topic-hero__stat {
  display: flex;
  flex-direction: column;
}

.topic-hero__stat-value {
  font-size: 1.25rem;
  font-weight: 700;
  line-height: 1;
}

.topic-hero__stat-label {
  font-size: 0.75rem;
  opacity: 0.8;
  margin-top: 0.25rem;
}

.topic-hero__xp {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.5rem 0.875rem;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  font-size: 0.9375rem;
  font-weight: 700;
  backdrop-filter: blur(5px);
  z-index: 1;
}

.topic-hero__xp svg {
  color: #fbbf24;
}

/* Grid */
.topic-grid {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 1.5rem;
  align-items: start;
}

.topic-main {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

/* Topic Card */
.topic-card {
  background: var(--grammar-surface);
  border-radius: var(--grammar-radius);
  border: 1px solid var(--grammar-border);
  overflow: hidden;
}

.topic-card__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--grammar-border);
  background: var(--grammar-surface-alt);
}

.topic-card__header-left {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.topic-card__icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
}

.topic-card__icon--theory {
  background: linear-gradient(135deg, var(--grammar-primary) 0%, #a855f7 100%);
}

.topic-card__icon--practice {
  background: linear-gradient(135deg, var(--grammar-success) 0%, #16a34a 100%);
}

.topic-card__title {
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--grammar-text);
  margin: 0;
}

.topic-card__badge {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.375rem 0.625rem;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 600;
  background: var(--grammar-surface);
  color: var(--grammar-text-muted);
  border: 1px solid var(--grammar-border);
}

.topic-card__badge--success {
  background: rgba(34, 197, 94, 0.1);
  color: #16a34a;
  border-color: transparent;
}

.topic-card__body {
  padding: 1.5rem;
}

.topic-card__empty {
  text-align: center;
  color: var(--grammar-text-muted);
  margin: 0;
}

.topic-card__action {
  margin-top: 1.5rem;
  text-align: center;
}

/* Theory Styles */
.theory-intro {
  font-size: 1rem;
  line-height: 1.7;
  color: var(--grammar-text);
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%);
  border-radius: var(--grammar-radius-sm);
  border-left: 4px solid var(--grammar-primary);
}

.theory-section {
  margin-bottom: 2rem;
}

.theory-section:last-child {
  margin-bottom: 0;
}

.theory-section__title {
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--grammar-text);
  margin: 0 0 0.75rem;
}

.theory-section__desc {
  font-size: 0.9375rem;
  line-height: 1.6;
  color: var(--grammar-text-muted);
  margin: 0 0 1rem;
}

.theory-table-wrapper {
  overflow-x: auto;
  margin: 1rem 0;
}

.theory-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
}

.theory-table th,
.theory-table td {
  padding: 0.75rem 1rem;
  text-align: left;
  border-bottom: 1px solid var(--grammar-border);
}

.theory-table th {
  background: var(--grammar-surface-alt);
  font-weight: 600;
  color: var(--grammar-text);
}

.theory-table__pronoun {
  font-weight: 600;
  color: var(--grammar-primary);
  white-space: nowrap;
}

.theory-table__form {
  font-weight: 600;
  color: var(--grammar-text);
}

.theory-table__translation {
  color: var(--grammar-text-muted);
  font-style: italic;
}

.theory-table--summary th:first-child {
  width: 80px;
}

.theory-rules {
  list-style: none;
  padding: 0;
  margin: 1rem 0;
}

.theory-rule {
  padding: 1rem;
  background: var(--grammar-surface-alt);
  border-radius: var(--grammar-radius-sm);
  margin-bottom: 0.75rem;
}

.theory-rule:last-child {
  margin-bottom: 0;
}

.theory-rule strong {
  display: block;
  color: var(--grammar-text);
  margin-bottom: 0.5rem;
}

.theory-rule__examples {
  padding-left: 1.25rem;
  margin: 0.5rem 0 0;
  color: var(--grammar-text-muted);
}

.theory-rule__examples li {
  margin-bottom: 0.25rem;
}

.theory-rule__note {
  margin-top: 0.5rem;
  padding: 0.5rem 0.75rem;
  background: rgba(139, 92, 246, 0.1);
  border-radius: 6px;
  font-size: 0.8125rem;
  color: var(--grammar-primary-dark);
}

.theory-alert {
  padding: 1rem;
  border-radius: var(--grammar-radius-sm);
  margin: 1.5rem 0;
}

.theory-alert--warning {
  background: rgba(245, 158, 11, 0.1);
  border: 1px solid rgba(245, 158, 11, 0.2);
}

.theory-alert--danger {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.theory-alert__header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 700;
  margin-bottom: 0.75rem;
}

.theory-alert--warning .theory-alert__header {
  color: #d97706;
}

.theory-alert--danger .theory-alert__header {
  color: #dc2626;
}

.theory-alert ul {
  padding-left: 1.25rem;
  margin: 0;
}

.theory-alert li {
  margin-bottom: 0.375rem;
  color: var(--grammar-text);
}

.theory-mistake {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.5rem;
  flex-wrap: wrap;
}

.theory-mistake__wrong {
  padding: 0.375rem 0.75rem;
  background: rgba(239, 68, 68, 0.15);
  border-radius: 6px;
  color: #dc2626;
  text-decoration: line-through;
  font-weight: 500;
}

.theory-mistake__correct {
  padding: 0.375rem 0.75rem;
  background: rgba(34, 197, 94, 0.15);
  border-radius: 6px;
  color: #16a34a;
  font-weight: 500;
}

.theory-mistake__explain {
  font-size: 0.8125rem;
  color: var(--grammar-text-muted);
  margin: 0 0 1rem;
}

.theory-summary {
  margin-top: 1.5rem;
  padding: 1rem;
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 163, 127, 0.05) 100%);
  border-radius: var(--grammar-radius-sm);
  border: 1px solid rgba(34, 197, 94, 0.2);
}

.theory-summary__header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 700;
  color: #16a34a;
  margin-bottom: 1rem;
}

/* Practice Start */
.practice-start {
  text-align: center;
  padding: 2rem 1rem;
}

.practice-start__icon {
  width: 72px;
  height: 72px;
  margin: 0 auto 1.25rem;
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--grammar-success);
}

.practice-start__title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--grammar-text);
  margin: 0 0 0.5rem;
}

.practice-start__desc {
  font-size: 0.9375rem;
  color: var(--grammar-text);
  margin: 0 0 0.25rem;
}

.practice-start__note {
  font-size: 0.8125rem;
  color: var(--grammar-text-muted);
  margin: 0 0 1.5rem;
}

/* Sidebar */
.topic-sidebar {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.sidebar-card {
  background: var(--grammar-surface);
  border-radius: var(--grammar-radius);
  border: 1px solid var(--grammar-border);
  overflow: hidden;
}

.sidebar-card__header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  border-bottom: 1px solid var(--grammar-border);
  background: var(--grammar-surface-alt);
}

.sidebar-card__icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
}

.sidebar-card__icon--progress {
  background: linear-gradient(135deg, var(--grammar-primary) 0%, #a855f7 100%);
}

.sidebar-card__icon--info {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

.sidebar-card__title {
  font-size: 0.9375rem;
  font-weight: 700;
  color: var(--grammar-text);
  margin: 0;
}

.sidebar-card__body {
  padding: 1rem;
}

/* Progress */
.progress-mastery {
  margin-bottom: 1rem;
}

.progress-mastery__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
  color: var(--grammar-text);
}

.progress-mastery__bar {
  height: 8px;
  background: rgba(139, 92, 246, 0.15);
  border-radius: 4px;
  overflow: hidden;
}

.progress-mastery__fill {
  height: 100%;
  background: linear-gradient(90deg, var(--grammar-primary) 0%, #a855f7 100%);
  border-radius: 4px;
  transition: width 0.5s ease;
}

.progress-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.progress-stat {
  padding: 0.75rem;
  border-radius: var(--grammar-radius-sm);
  text-align: center;
}

.progress-stat--success {
  background: rgba(34, 197, 94, 0.1);
}

.progress-stat--primary {
  background: rgba(139, 92, 246, 0.1);
}

.progress-stat__value {
  display: block;
  font-size: 1.25rem;
  font-weight: 700;
  line-height: 1;
}

.progress-stat--success .progress-stat__value {
  color: var(--grammar-success);
}

.progress-stat--primary .progress-stat__value {
  color: var(--grammar-primary);
}

.progress-stat__label {
  display: block;
  font-size: 0.6875rem;
  color: var(--grammar-text-muted);
  margin-top: 0.25rem;
}

.progress-accuracy {
  text-align: center;
  padding: 0.75rem;
  background: var(--grammar-surface-alt);
  border-radius: var(--grammar-radius-sm);
  margin-bottom: 1rem;
}

.progress-accuracy__value {
  font-size: 1.5rem;
  font-weight: 700;
}

.progress-accuracy__value--high {
  color: var(--grammar-success);
}

.progress-accuracy__value--medium {
  color: var(--grammar-warning);
}

.progress-accuracy__value--low {
  color: var(--grammar-danger);
}

.progress-accuracy__label {
  display: block;
  font-size: 0.75rem;
  color: var(--grammar-text-muted);
  margin-top: 0.125rem;
}

.progress-review {
  padding: 0.75rem;
  background: rgba(59, 130, 246, 0.1);
  border-radius: var(--grammar-radius-sm);
  text-align: center;
}

.progress-review__label {
  display: block;
  font-size: 0.75rem;
  color: var(--grammar-text-muted);
  margin-bottom: 0.25rem;
}

.progress-review__date {
  font-size: 0.9375rem;
  font-weight: 600;
  color: #2563eb;
}

/* Info List */
.info-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 0;
  border-bottom: 1px solid var(--grammar-border);
}

.info-item:last-child {
  border-bottom: none;
}

.info-item__icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.info-item__icon--level {
  background: rgba(139, 92, 246, 0.1);
  color: var(--grammar-primary);
}

.info-item__icon--time {
  background: rgba(59, 130, 246, 0.1);
  color: #2563eb;
}

.info-item__icon--difficulty {
  background: rgba(245, 158, 11, 0.1);
  color: #d97706;
}

.info-item__icon--exercises {
  background: rgba(34, 197, 94, 0.1);
  color: #16a34a;
}

.info-item__content {
  flex: 1;
}

.info-item__label {
  display: block;
  font-size: 0.75rem;
  color: var(--grammar-text-muted);
}

.info-item__value {
  display: flex;
  align-items: center;
  gap: 0.125rem;
  font-size: 0.9375rem;
  color: var(--grammar-text);
}

/* Buttons */
.topic-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  font-family: var(--grammar-font);
  font-size: 0.9375rem;
  font-weight: 600;
  border: none;
  border-radius: var(--grammar-radius-sm);
  cursor: pointer;
  text-decoration: none;
  transition: all 0.2s ease;
}

.topic-btn--large {
  padding: 1rem 2rem;
  font-size: 1rem;
}

.topic-btn--primary {
  background: linear-gradient(135deg, var(--grammar-primary) 0%, #a855f7 100%);
  color: white;
}

.topic-btn--primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
  color: white;
}

.topic-btn--success {
  background: linear-gradient(135deg, var(--grammar-success) 0%, #16a34a 100%);
  color: white;
}

.topic-btn--success:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
  color: white;
}

.topic-btn--secondary {
  background: var(--grammar-surface-alt);
  color: var(--grammar-text);
  border: 1px solid var(--grammar-border);
}

.topic-btn--secondary:hover {
  background: var(--grammar-surface);
  color: var(--grammar-text);
}

.topic-btn--outline {
  background: transparent;
  color: var(--grammar-primary);
  border: 2px solid var(--grammar-primary);
}

.topic-btn--outline:hover {
  background: var(--grammar-primary);
  color: white;
}

/* XP Notification */
.xp-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  border-radius: 10px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
  animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
  z-index: 9999;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(100px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes fadeOut {
  to { opacity: 0; transform: translateY(-20px); }
}

/* Animations */
@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.topic-hero { animation: slideUp 0.4s ease-out; }
.topic-grid { animation: slideUp 0.4s ease-out 0.1s both; }

/* Responsive */
@media (max-width: 900px) {
  .topic-grid {
    grid-template-columns: 1fr;
  }

  .topic-sidebar {
    order: -1;
  }
}

@media (max-width: 640px) {
  .grammar-page {
    padding: 0 0.75rem 2rem;
  }

  .topic-hero {
    padding: 1.5rem;
  }

  .topic-hero__title {
    font-size: 1.375rem;
  }

  .topic-hero__xp {
    position: static;
    display: inline-flex;
    margin-top: 1rem;
  }

  .topic-hero__stats {
    flex-wrap: wrap;
    gap: 1rem;
  }

  .topic-card__header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }

  
}
</style>
{% endblock %}

{% block scripts %}
<script>
const topicId = {{ topic.id }};

// Get CSRF token safely
function getCSRFToken() {
  const meta = document.querySelector('meta[name="csrf-token"]');
  return meta ? meta.getAttribute('content') : '';
}

// Complete theory
document.getElementById('complete-theory-btn')?.addEventListener('click', async function() {
  try {
    const csrfToken = getCSRFToken();
    const response = await fetch(`/grammar-lab/api/topic/${topicId}/complete-theory`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    });
    const data = await response.json();

    if (data.xp_earned > 0) {
      this.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Изучено!';
      this.disabled = true;
      this.style.background = 'var(--grammar-surface-alt)';
      this.style.borderColor = 'var(--grammar-border)';
      this.style.color = 'var(--grammar-text-muted)';

      const notification = document.createElement('div');
      notification.className = 'xp-notification';
      notification.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg><span>+${data.xp_earned} XP</span>`;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }
  } catch (error) {
    console.error('Error completing theory:', error);
  }
});
</script>
{% endblock %}
