{% extends "base.html" %}

{% block title %}{{ topic.title }} - Grammar Lab{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/grammar-lab.css') }}?v={{ range(1000, 9999) | random }}">
{% endblock %}

{% block body_class %}grammar-lab-page{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav class="gl-breadcrumb" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('grammar_lab.index') }}">Grammar Lab</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('grammar_lab.topics', level=topic.level) }}">{{ topic.level }}</a></li>
            <li class="breadcrumb-item active">{{ topic.title }}</li>
        </ol>
    </nav>

    <!-- Hero Header -->
    <div class="gl-hero">
        <div class="gl-hero-content">
            <div class="gl-level-badge">
                <i class="fas fa-layer-group"></i>
                {{ topic.level }}
            </div>
            <h1>{{ topic.title }}</h1>
            <p class="gl-hero-subtitle">{{ topic.title_ru }}</p>

            {% if topic.progress %}
            <div class="gl-hero-progress">
                {% set progress_pct = (topic.progress.mastery_level / 5 * 100) %}
                <div class="gl-hero-progress-bar" style="width: {{ progress_pct }}%;"></div>
            </div>
            <div class="gl-hero-stats">
                <div class="gl-hero-stat">
                    <span class="gl-hero-stat-value">{{ topic.progress.mastery_level }}/5</span>
                    <span class="gl-hero-stat-label">–£—Ä–æ–≤–µ–Ω—å</span>
                </div>
                <div class="gl-hero-stat">
                    <span class="gl-hero-stat-value">{{ topic.progress.correct_attempts }}</span>
                    <span class="gl-hero-stat-label">–í–µ—Ä–Ω–æ</span>
                </div>
                <div class="gl-hero-stat">
                    <span class="gl-hero-stat-value">{{ topic.progress.total_attempts }}</span>
                    <span class="gl-hero-stat-label">–í—Å–µ–≥–æ</span>
                </div>
            </div>
            {% endif %}
        </div>

        {% if topic.progress %}
        <div class="gl-xp-badge">
            <i class="fas fa-star"></i>
            <span>{{ topic.progress.xp_earned }} XP</span>
        </div>
        {% endif %}
    </div>

    <!-- Content Grid -->
    <div class="gl-content-grid">
        <!-- Main Content -->
        <div class="gl-main">
            <!-- Theory Card -->
            <div class="gl-card" id="theory">
                <div class="gl-card-header">
                    <h3>
                        <span class="gl-card-header-icon theory">
                            <i class="fas fa-book-open"></i>
                        </span>
                        –¢–µ–æ—Ä–∏—è
                    </h3>
                    {% if topic.progress and topic.progress.theory_completed %}
                    <span class="gl-completed-badge">
                        <i class="fas fa-check"></i>
                        –ò–∑—É—á–µ–Ω–æ
                    </span>
                    {% endif %}
                </div>
                <div class="gl-card-body">
                    {% if topic.content %}
                        <!-- Introduction -->
                        {% if topic.content.introduction %}
                        <div class="gl-theory-intro">
                            {{ topic.content.introduction|unescape }}
                        </div>
                        {% endif %}

                        <!-- Sections -->
                        {% if topic.content.sections %}
                        {% for section in topic.content.sections %}
                        <div class="gl-theory-section">
                            <h5>{{ section.subtitle|unescape }}</h5>
                            {% if section.description %}
                            <p>{{ section.description|unescape }}</p>
                            {% endif %}

                            <!-- Table -->
                            {% if section.table %}
                            <table class="gl-grammar-table">
                                <tbody>
                                {% for row in section.table %}
                                <tr>
                                    {% if row.pronoun %}<td class="pronoun">{{ row.pronoun|unescape }}</td>{% endif %}
                                    {% if row.form %}<td><span class="form">{{ row.form|unescape }}</span></td>{% endif %}
                                    {% if row.example %}<td>{{ row.example|unescape }}</td>{% endif %}
                                    {% if row.translation %}<td class="translation">{{ row.translation|unescape }}</td>{% endif %}
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            {% endif %}

                            <!-- Rules -->
                            {% if section.rules %}
                            <ul class="gl-rules-list">
                                {% for rule in section.rules %}
                                <li class="gl-rule-item">
                                    <strong>{{ rule.rule|unescape }}</strong>
                                    {% if rule.examples %}
                                    <ul>
                                        {% for example in rule.examples %}
                                        <li>{{ example|unescape }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {% if rule.note %}
                                    <div class="gl-rule-note">{{ rule.note|unescape }}</div>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            <!-- Usage -->
                            {% if section.usage %}
                            <ul class="gl-rules-list">
                                {% for usage in section.usage %}
                                <li class="gl-rule-item">
                                    <strong>{{ usage.case|unescape }}</strong>
                                    {% if usage.examples %}
                                    <ul>
                                        {% for example in usage.examples %}
                                        <li>{{ example|unescape }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}

                        <!-- Important Notes -->
                        {% if topic.content.important_notes %}
                        <div class="gl-important">
                            <div class="gl-important-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                –í–∞–∂–Ω–æ
                            </div>
                            <ul>
                                {% for note in topic.content.important_notes %}
                                <li>{{ note|unescape }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Common Mistakes -->
                        {% if topic.content.common_mistakes %}
                        <div class="gl-mistakes">
                            <div class="gl-mistakes-header">
                                <i class="fas fa-times-circle"></i>
                                –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
                            </div>
                            {% for mistake in topic.content.common_mistakes %}
                            <div class="gl-mistake-item">
                                <span class="gl-mistake-wrong">{{ mistake.wrong|unescape }}</span>
                                <i class="fas fa-arrow-right gl-mistake-arrow"></i>
                                <span class="gl-mistake-correct">{{ mistake.correct|unescape }}</span>
                            </div>
                            {% if mistake.explanation %}
                            <span class="gl-mistake-explain">{{ mistake.explanation|unescape }}</span>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Summary Table -->
                        {% if topic.content.summary_table %}
                        <div class="gl-summary">
                            <div class="gl-summary-header">
                                <i class="fas fa-table"></i>
                                –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
                            </div>
                            <table>
                                <tbody>
                                {% if topic.content.summary_table.affirmative %}
                                <tr><td>+</td><td>{{ topic.content.summary_table.affirmative|unescape }}</td></tr>
                                {% endif %}
                                {% if topic.content.summary_table.negative %}
                                <tr><td>-</td><td>{{ topic.content.summary_table.negative|unescape }}</td></tr>
                                {% endif %}
                                {% if topic.content.summary_table.question %}
                                <tr><td>?</td><td>{{ topic.content.summary_table.question|unescape }}</td></tr>
                                {% endif %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted text-center">–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω.</p>
                    {% endif %}

                    {% if not topic.progress or not topic.progress.theory_completed %}
                    <div class="text-center mt-4">
                        <button type="button" class="gl-theory-complete-btn" id="complete-theory-btn">
                            <i class="fas fa-check"></i>
                            –¢–µ–æ—Ä–∏—è –∏–∑—É—á–µ–Ω–∞ (+20 XP)
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Practice Card -->
            <div class="gl-card" id="practice">
                <div class="gl-card-header">
                    <h3>
                        <span class="gl-card-header-icon practice">
                            <i class="fas fa-dumbbell"></i>
                        </span>
                        –ü—Ä–∞–∫—Ç–∏–∫–∞
                    </h3>
                    <span class="gl-exercise-count">{{ topic.exercise_count }} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</span>
                </div>
                <div class="gl-card-body">
                    {% if topic.exercises %}
                    <div class="gl-practice-start">
                        <div class="gl-practice-icon">
                            <i class="fas fa-play"></i>
                        </div>
                        <h4>–ì–æ—Ç–æ–≤—ã –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ?</h4>
                        <p>–°–µ—Å—Å–∏—è: <strong>10-12 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</strong> –∏–∑ {{ topic.exercise_count }}</p>
                        <p class="text-muted small mb-3">–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–±–µ—Ä—ë—Ç –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</p>
                        <button type="button" class="gl-start-btn" id="start-practice-btn">
                            <i class="fas fa-rocket"></i>
                            –ù–∞—á–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É
                        </button>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å–∫–æ—Ä–æ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="gl-sidebar">
            <!-- Progress Card -->
            {% if topic.progress %}
            <div class="gl-sidebar-card gl-progress-card">
                <div class="gl-card-header">
                    <h4>
                        <span class="gl-card-header-icon progress">
                            <i class="fas fa-chart-line"></i>
                        </span>
                        –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å
                    </h4>
                </div>
                <div class="gl-card-body">
                    <div class="gl-mastery-section">
                        <div class="gl-mastery-label">
                            <span>–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ</span>
                            <strong>{{ topic.progress.mastery_level }}/5</strong>
                        </div>
                        <div class="gl-mastery-bar">
                            {% set mastery_pct = (topic.progress.mastery_level / 5 * 100) %}
                            <div class="gl-mastery-fill" style="width: {{ mastery_pct }}%;"></div>
                        </div>
                    </div>

                    <div class="gl-stats-grid">
                        <div class="gl-stat-box">
                            <span class="gl-stat-value success">{{ topic.progress.correct_attempts }}</span>
                            <span class="gl-stat-label">–í–µ—Ä–Ω–æ</span>
                        </div>
                        <div class="gl-stat-box">
                            <span class="gl-stat-value primary">{{ topic.progress.total_attempts }}</span>
                            <span class="gl-stat-label">–í—Å–µ–≥–æ</span>
                        </div>
                    </div>

                    {% if topic.progress.total_attempts > 0 %}
                    <div class="gl-accuracy">
                        {% set accuracy = (topic.progress.correct_attempts / topic.progress.total_attempts * 100)|round(1) %}
                        <div class="gl-accuracy-value {% if accuracy >= 80 %}high{% elif accuracy >= 60 %}medium{% else %}low{% endif %}">
                            {{ accuracy }}%
                        </div>
                        <span class="gl-accuracy-label">–¢–æ—á–Ω–æ—Å—Ç—å</span>
                    </div>
                    {% endif %}

                    {% if topic.progress.next_review %}
                    <div class="gl-next-review">
                        <div class="gl-next-review-label">–°–ª–µ–¥—É—é—â–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</div>
                        <div class="gl-next-review-date">{{ topic.progress.next_review[:10] }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Topic Info Card -->
            <div class="gl-sidebar-card">
                <div class="gl-card-header">
                    <h4>
                        <span class="gl-card-header-icon info">
                            <i class="fas fa-info-circle"></i>
                        </span>
                        –û —Ç–µ–º–µ
                    </h4>
                </div>
                <div class="gl-card-body">
                    <ul class="gl-info-list">
                        <li class="gl-info-item">
                            <span class="gl-info-icon level">
                                <i class="fas fa-layer-group"></i>
                            </span>
                            <div class="gl-info-text">
                                <span>–£—Ä–æ–≤–µ–Ω—å</span>
                                <strong>{{ topic.level }}</strong>
                            </div>
                        </li>
                        {% if topic.estimated_time %}
                        <li class="gl-info-item">
                            <span class="gl-info-icon time">
                                <i class="fas fa-clock"></i>
                            </span>
                            <div class="gl-info-text">
                                <span>–í—Ä–µ–º—è –∏–∑—É—á–µ–Ω–∏—è</span>
                                <strong>{{ topic.estimated_time }} –º–∏–Ω</strong>
                            </div>
                        </li>
                        {% endif %}
                        {% if topic.difficulty %}
                        <li class="gl-info-item">
                            <span class="gl-info-icon difficulty">
                                <i class="fas fa-signal"></i>
                            </span>
                            <div class="gl-info-text">
                                <span>–°–ª–æ–∂–Ω–æ—Å—Ç—å</span>
                                <strong>{% for i in range(topic.difficulty) %}<i class="fas fa-star" style="color: #f59e0b;"></i>{% endfor %}{% for i in range(5 - topic.difficulty) %}<i class="far fa-star" style="color: #e2e8f0;"></i>{% endfor %}</strong>
                            </div>
                        </li>
                        {% endif %}
                        <li class="gl-info-item">
                            <span class="gl-info-icon exercises">
                                <i class="fas fa-dumbbell"></i>
                            </span>
                            <div class="gl-info-text">
                                <span>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</span>
                                <strong>{{ topic.exercise_count }}</strong>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exercise Modal -->
<div class="modal fade gl-modal" id="exerciseModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-pencil-alt me-2"></i>
                    –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ <span id="exercise-number">1</span> –∏–∑ <span id="exercise-total">{{ topic.exercise_count }}</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="exercise-content">
                <!-- Exercise content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <div id="exercise-feedback" class="w-100" style="display: none;"></div>
                <button type="button" class="gl-modal-btn secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="gl-modal-btn primary" id="submit-answer-btn">
                    <i class="fas fa-check"></i>
                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                </button>
                <button type="button" class="gl-modal-btn success" id="next-exercise-btn" style="display: none;">
                    –î–∞–ª–µ–µ
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const topicId = {{ topic.id }};
let exercises = {{ topic.exercises|tojson|safe }};
let currentExerciseIndex = 0;
let sessionId = null;
let correctCount = 0;
let wrongCount = 0;
let totalXP = 0;

// Complete theory
document.getElementById('complete-theory-btn')?.addEventListener('click', async function() {
    try {
        const response = await fetch(`/grammar-lab/api/topic/${topicId}/complete-theory`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });
        const data = await response.json();

        if (data.xp_earned > 0) {
            this.innerHTML = '<i class="fas fa-check"></i> –ò–∑—É—á–µ–Ω–æ!';
            this.disabled = true;
            this.style.background = 'var(--gl-text-light)';

            // Show XP notification
            const notification = document.createElement('div');
            notification.className = 'gl-xp-notification';
            notification.innerHTML = `<i class="fas fa-star"></i><span>+${data.xp_earned} XP</span>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    } catch (error) {
        console.error('Error completing theory:', error);
    }
});

// Start practice
document.getElementById('start-practice-btn')?.addEventListener('click', async function() {
    try {
        const response = await fetch(`/grammar-lab/api/topic/${topicId}/start-practice`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });
        const data = await response.json();

        if (data.session_id) {
            sessionId = data.session_id;
            exercises = data.exercises || exercises;
            currentExerciseIndex = 0;
            showExercise(0);
            const modal = new bootstrap.Modal(document.getElementById('exerciseModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error starting practice:', error);
    }
});

function showExercise(index) {
    const exercise = exercises[index];
    if (!exercise) return;

    document.getElementById('exercise-number').textContent = index + 1;
    document.getElementById('exercise-total').textContent = exercises.length;

    const content = document.getElementById('exercise-content');
    let html = '';

    switch (exercise.exercise_type) {
        case 'fill_blank':
            html = renderFillBlank(exercise);
            break;
        case 'multiple_choice':
            html = renderMultipleChoice(exercise);
            break;
        case 'reorder':
            html = renderReorder(exercise);
            break;
        case 'true_false':
            html = renderTrueFalse(exercise);
            break;
        case 'translation':
            html = renderTranslation(exercise);
            break;
        case 'error_correction':
            html = renderErrorCorrection(exercise);
            break;
        case 'transformation':
            html = renderTransformation(exercise);
            break;
        case 'matching':
            html = renderMatching(exercise);
            break;
        default:
            html = `<p>–¢–∏–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ${exercise.exercise_type}</p>`;
    }

    content.innerHTML = html;

    // Reset buttons
    document.getElementById('submit-answer-btn').style.display = 'inline-flex';
    document.getElementById('next-exercise-btn').style.display = 'none';
    document.getElementById('exercise-feedback').style.display = 'none';
}

function renderFillBlank(exercise) {
    return `
        <div class="gl-exercise-question">${exercise.question || '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–ø—É—Å–∫:'}</div>
        <input type="text" class="gl-input" id="user-answer" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç" autocomplete="off">
    `;
}

function renderMultipleChoice(exercise) {
    let html = `<div class="gl-exercise-question">${exercise.question || '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:'}</div>`;
    html += '<div class="gl-options">';
    (exercise.options || []).forEach((option, i) => {
        html += `
            <label class="gl-option" onclick="selectOption(this, ${i})">
                <input type="radio" name="answer" value="${i}">
                <span class="gl-option-radio"></span>
                <span class="gl-option-text">${option}</span>
            </label>
        `;
    });
    html += '</div>';
    return html;
}

function selectOption(el, value) {
    document.querySelectorAll('.gl-option').forEach(opt => opt.classList.remove('selected'));
    el.classList.add('selected');
    el.querySelector('input').checked = true;
}

function renderReorder(exercise) {
    const words = exercise.words || [];
    let html = `<div class="gl-exercise-question">${exercise.instruction || '–°–æ—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —Å–ª–æ–≤:'}</div>`;
    html += '<div class="gl-word-bank" id="word-bank">';
    words.forEach((word, i) => {
        html += `<button type="button" class="gl-word-btn" data-index="${i}" data-word="${word}">${word}</button>`;
    });
    html += '</div>';
    html += '<div class="gl-answer-area empty" id="answer-area">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–ª–æ–≤–∞ –≤—ã—à–µ</div>';
    html += '<input type="hidden" id="user-answer" value="">';

    setTimeout(() => {
        const wordBank = document.getElementById('word-bank');
        const answerArea = document.getElementById('answer-area');
        const hiddenInput = document.getElementById('user-answer');
        let selectedWords = [];

        wordBank.querySelectorAll('.gl-word-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.classList.contains('selected')) {
                    const idx = selectedWords.indexOf(this.dataset.word);
                    if (idx > -1) selectedWords.splice(idx, 1);
                    this.classList.remove('selected');
                } else {
                    selectedWords.push(this.dataset.word);
                    this.classList.add('selected');
                }
                if (selectedWords.length > 0) {
                    answerArea.textContent = selectedWords.join(' ');
                    answerArea.classList.remove('empty');
                } else {
                    answerArea.textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–ª–æ–≤–∞ –≤—ã—à–µ';
                    answerArea.classList.add('empty');
                }
                hiddenInput.value = selectedWords.join(' ');
            });
        });
    }, 100);

    return html;
}

function renderTrueFalse(exercise) {
    return `
        <div class="gl-exercise-question">${exercise.statement || exercise.question}</div>
        <div class="gl-tf-buttons">
            <button type="button" class="gl-tf-btn true-btn" onclick="selectTF(this, 'true')">
                <i class="fas fa-check"></i>
                <span>–í–µ—Ä–Ω–æ</span>
            </button>
            <button type="button" class="gl-tf-btn false-btn" onclick="selectTF(this, 'false')">
                <i class="fas fa-times"></i>
                <span>–ù–µ–≤–µ—Ä–Ω–æ</span>
            </button>
        </div>
        <input type="hidden" id="user-answer" value="">
    `;
}

function selectTF(el, value) {
    document.querySelectorAll('.gl-tf-btn').forEach(btn => btn.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('user-answer').value = value;
}

function renderTranslation(exercise) {
    let sentence = exercise.sentence || exercise.question || exercise.content?.sentence || exercise.content?.question || '';
    sentence = sentence.replace(/^–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π:\s*/i, '');
    return `
        <div class="gl-exercise-question">–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π:</div>
        <div class="gl-exercise-highlight">${sentence}</div>
        <input type="text" class="gl-input" id="user-answer" placeholder="–í–∞—à –ø–µ—Ä–µ–≤–æ–¥" autocomplete="off">
    `;
}

function renderErrorCorrection(exercise) {
    const sentence = exercise.sentence || exercise.content?.sentence || exercise.question || '';
    return `
        <div class="gl-exercise-question">–ù–∞–π–¥–∏—Ç–µ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫—É:</div>
        <div class="gl-exercise-highlight" style="background: linear-gradient(135deg, #fef2f2, #fee2e2); color: #991b1b;">${sentence}</div>
        <input type="text" class="gl-input" id="user-answer" placeholder="–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞" autocomplete="off">
    `;
}

function renderTransformation(exercise) {
    // Original sentence can be in: original, sentence, or question fields
    const original = exercise.original || exercise.sentence || exercise.question ||
                     exercise.content?.original || exercise.content?.sentence || exercise.content?.question || '';
    const instruction = exercise.instruction || exercise.content?.instruction || '–ü—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ';
    return `
        <div class="gl-exercise-question">${instruction}:</div>
        <div class="gl-exercise-highlight">${original}</div>
        <input type="text" class="gl-input" id="user-answer" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ" autocomplete="off">
    `;
}

function renderMatching(exercise) {
    const pairs = exercise.pairs || [];
    if (pairs.length === 0) {
        return `<div class="gl-exercise-question">–ù–µ—Ç –ø–∞—Ä –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è</div>`;
    }

    // Create shuffled right column
    const rightItems = pairs.map((pair, i) => ({
        text: pair.russian || pair.right,
        correctIndex: i
    }));
    // Shuffle right items
    for (let i = rightItems.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [rightItems[i], rightItems[j]] = [rightItems[j], rightItems[i]];
    }

    let html = `<div class="gl-exercise-question">${exercise.instruction || '–°–æ–æ—Ç–Ω–µ—Å–∏—Ç–µ –ø–∞—Ä—ã:'}</div>`;
    html += '<div class="gl-matching-container">';

    // Left column (source items)
    html += '<div class="gl-matching-column" id="matching-left">';
    html += '<div class="gl-matching-column-header">English</div>';
    pairs.forEach((pair, i) => {
        html += `<div class="gl-matching-item" data-index="${i}" data-side="left">${pair.english || pair.left}</div>`;
    });
    html += '</div>';

    // Right column (shuffled target items)
    html += '<div class="gl-matching-column" id="matching-right">';
    html += '<div class="gl-matching-column-header">–†—É—Å—Å–∫–∏–π</div>';
    rightItems.forEach((item, i) => {
        html += `<div class="gl-matching-item" data-index="${i}" data-correct="${item.correctIndex}" data-side="right">${item.text}</div>`;
    });
    html += '</div>';

    html += '</div>';

    // Progress indicator
    html += `<div class="gl-matching-progress">
        <span class="gl-matching-progress-text">–°–æ–≤–ø–∞–¥–µ–Ω–∏–π: <strong id="match-count">0</strong> –∏–∑ <strong>${pairs.length}</strong></span>
    </div>`;

    html += '<input type="hidden" id="user-answer" value="">';

    // Setup matching logic after render
    setTimeout(() => setupMatchingHandlers(pairs.length), 100);

    return html;
}

function setupMatchingHandlers(totalPairs) {
    let selectedLeft = null;
    let selectedRight = null;
    let matches = {};
    let matchCount = 0;

    const leftItems = document.querySelectorAll('#matching-left .gl-matching-item');
    const rightItems = document.querySelectorAll('#matching-right .gl-matching-item');

    function updateAnswer() {
        document.getElementById('user-answer').value = JSON.stringify(matches);
        document.getElementById('match-count').textContent = matchCount;

        // Auto-submit when all matched
        if (matchCount === totalPairs) {
            document.getElementById('user-answer').value = JSON.stringify(matches);
        }
    }

    function checkMatch() {
        if (selectedLeft !== null && selectedRight !== null) {
            const leftIdx = parseInt(selectedLeft.dataset.index);
            const rightCorrect = parseInt(selectedRight.dataset.correct);

            if (leftIdx === rightCorrect) {
                // Correct match
                selectedLeft.classList.remove('selected');
                selectedLeft.classList.add('matched');
                selectedRight.classList.remove('selected');
                selectedRight.classList.add('matched');

                matches[leftIdx] = leftIdx;
                matchCount++;
                updateAnswer();
            } else {
                // Wrong match - shake and reset
                selectedLeft.classList.add('wrong');
                selectedRight.classList.add('wrong');

                setTimeout(() => {
                    selectedLeft.classList.remove('selected', 'wrong');
                    selectedRight.classList.remove('selected', 'wrong');
                    selectedLeft = null;
                    selectedRight = null;
                }, 500);
                return;
            }

            selectedLeft = null;
            selectedRight = null;
        }
    }

    leftItems.forEach(item => {
        item.addEventListener('click', function() {
            if (this.classList.contains('matched')) return;

            leftItems.forEach(i => i.classList.remove('selected'));
            this.classList.add('selected');
            selectedLeft = this;
            checkMatch();
        });
    });

    rightItems.forEach(item => {
        item.addEventListener('click', function() {
            if (this.classList.contains('matched')) return;

            rightItems.forEach(i => i.classList.remove('selected'));
            this.classList.add('selected');
            selectedRight = this;
            checkMatch();
        });
    });
}

// Submit answer
document.getElementById('submit-answer-btn').addEventListener('click', async function() {
    const exercise = exercises[currentExerciseIndex];
    let answer;

    if (exercise.exercise_type === 'multiple_choice') {
        const selected = document.querySelector('input[name="answer"]:checked');
        if (!selected) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç');
            return;
        }
        answer = selected.value;
    } else if (exercise.exercise_type === 'matching') {
        const answerStr = document.getElementById('user-answer').value;
        if (!answerStr) {
            alert('–°–æ–æ—Ç–Ω–µ—Å–∏—Ç–µ –≤—Å–µ –ø–∞—Ä—ã');
            return;
        }
        try {
            const matches = JSON.parse(answerStr);
            const pairsCount = (exercise.pairs || []).length;
            if (Object.keys(matches).length < pairsCount) {
                alert(`–°–æ–æ—Ç–Ω–µ—Å–∏—Ç–µ –≤—Å–µ –ø–∞—Ä—ã (${Object.keys(matches).length}/${pairsCount})`);
                return;
            }
            answer = matches;
        } catch (e) {
            alert('–°–æ–æ—Ç–Ω–µ—Å–∏—Ç–µ –≤—Å–µ –ø–∞—Ä—ã');
            return;
        }
    } else {
        answer = document.getElementById('user-answer').value;
        if (!answer) {
            alert('–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç');
            return;
        }
    }

    try {
        const response = await fetch(`/grammar-lab/api/exercise/${exercise.id}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                answer: answer,
                session_id: sessionId,
                source: 'topic_practice'
            })
        });
        const data = await response.json();

        // Show feedback and track results
        const feedback = document.getElementById('exercise-feedback');
        if (data.is_correct) {
            correctCount++;
            totalXP += data.xp_earned || 0;
            feedback.className = 'gl-feedback success';
            feedback.innerHTML = `
                <div class="gl-feedback-header">
                    <i class="fas fa-check-circle"></i>
                    –ü—Ä–∞–≤–∏–ª—å–Ω–æ!${data.xp_earned ? ` <span>+${data.xp_earned} XP</span>` : ''}
                </div>
            `;
        } else {
            wrongCount++;
            feedback.className = 'gl-feedback error';
            feedback.innerHTML = `
                <div class="gl-feedback-header">
                    <i class="fas fa-times-circle"></i>
                    –ù–µ–≤–µ—Ä–Ω–æ
                </div>
                <div>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <span class="gl-feedback-answer">${data.correct_answer}</span></div>
                ${data.explanation ? `<div class="gl-feedback-explain">${data.explanation}</div>` : ''}
            `;
        }
        feedback.style.display = 'block';

        // Toggle buttons
        this.style.display = 'none';
        document.getElementById('next-exercise-btn').style.display = 'inline-flex';

        // Disable inputs
        document.querySelectorAll('#exercise-content input, #exercise-content button').forEach(el => el.disabled = true);

    } catch (error) {
        console.error('Error submitting answer:', error);
    }
});

// Next exercise
document.getElementById('next-exercise-btn').addEventListener('click', function() {
    currentExerciseIndex++;
    if (currentExerciseIndex < exercises.length) {
        showExercise(currentExerciseIndex);
    } else {
        // Practice complete - show completion screen
        showCompletionScreen();
    }
});

function showCompletionScreen() {
    const accuracy = exercises.length > 0 ? Math.round((correctCount / exercises.length) * 100) : 0;
    const emoji = accuracy >= 80 ? 'üéâ' : accuracy >= 60 ? 'üëç' : 'üí™';
    const message = accuracy >= 80 ? '–û—Ç–ª–∏—á–Ω–æ!' : accuracy >= 60 ? '–•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞!' : '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è!';

    document.getElementById('exercise-content').innerHTML = `
        <div class="gl-completion">
            <div class="gl-completion-emoji">${emoji}</div>
            <h3 class="gl-completion-title">${message}</h3>
            <p class="gl-completion-subtitle">–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ø—Ä–∞–∫—Ç–∏–∫—É –ø–æ —Ç–µ–º–µ</p>

            <div class="gl-completion-stats">
                <div class="gl-completion-stat correct">
                    <div class="gl-completion-stat-value">${correctCount}</div>
                    <div class="gl-completion-stat-label">–í–µ—Ä–Ω–æ</div>
                </div>
                <div class="gl-completion-stat wrong">
                    <div class="gl-completion-stat-value">${wrongCount}</div>
                    <div class="gl-completion-stat-label">–û—à–∏–±–æ–∫</div>
                </div>
                <div class="gl-completion-stat xp">
                    <div class="gl-completion-stat-value">${totalXP}</div>
                    <div class="gl-completion-stat-label">XP</div>
                </div>
            </div>

            <div class="gl-completion-accuracy">
                <div class="gl-completion-accuracy-bar">
                    <div class="gl-completion-accuracy-fill" style="width: ${accuracy}%;"></div>
                </div>
                <span class="gl-completion-accuracy-text">${accuracy}% —Ç–æ—á–Ω–æ—Å—Ç—å</span>
            </div>
        </div>
    `;

    // Update modal footer
    document.getElementById('exercise-feedback').style.display = 'none';
    document.getElementById('submit-answer-btn').style.display = 'none';
    document.getElementById('next-exercise-btn').style.display = 'none';

    // Change title
    document.querySelector('#exerciseModal .modal-title').innerHTML = '<i class="fas fa-trophy text-warning me-2"></i>–ü—Ä–∞–∫—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
}
</script>
{% endblock %}
