{% extends "base.html" %}

{% block styles %}
{{ super() }}
<style>
@import url('https://fonts.googleapis.com/css2?family=Onest:wght@400;500;600;700;800&display=swap');

/* ── Scoped Lesson Variables ── */
.lsn-page {
  --lsn-font: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
  --lsn-primary: #10b981;
  --lsn-primary-dark: #059669;
  --lsn-gradient: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
  --lsn-surface: #ffffff;
  --lsn-surface-alt: #f8fafc;
  --lsn-text: #0f172a;
  --lsn-text-muted: #64748b;
  --lsn-text-light: #94a3b8;
  --lsn-border: #e2e8f0;
  --lsn-radius: 16px;
  --lsn-radius-sm: 10px;
  --lsn-success: #10b981;
  --lsn-warning: #f59e0b;
  --lsn-danger: #ef4444;

  font-family: var(--lsn-font);
  max-width: 800px;
  margin: 0 auto;
  padding: 0 1rem 6rem;
}

/* ── Animations ── */
@keyframes lsnSlideUp {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes lsnFloat1 {
  0%, 100% { transform: translate(0, 0) scale(1); }
  50% { transform: translate(-12px, 12px) scale(1.05); }
}

@keyframes lsnFloat2 {
  0%, 100% { transform: translate(0, 0) rotate(0deg); }
  50% { transform: translate(14px, -10px) rotate(8deg); }
}

.lsn-page .lsn-header { animation: lsnSlideUp 0.4s ease-out; }
.lsn-page .lsn-body { animation: lsnSlideUp 0.4s ease-out 0.08s both; }
.lsn-page .lsn-footer { animation: lsnSlideUp 0.3s ease-out 0.12s both; }

/* ── Header ── */
.lsn-header {
  background: var(--lsn-gradient);
  border-radius: var(--lsn-radius);
  padding: 1.25rem 1.5rem;
  margin-bottom: 1.5rem;
  color: #fff;
  position: relative;
  overflow: hidden;
}

.lsn-header::before,
.lsn-header::after {
  content: '';
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.08);
  pointer-events: none;
}

.lsn-header::before {
  width: 120px;
  height: 120px;
  top: -40px;
  right: -30px;
  animation: lsnFloat1 18s ease-in-out infinite;
}

.lsn-header::after {
  width: 70px;
  height: 70px;
  bottom: -25px;
  left: 8%;
  animation: lsnFloat2 14s ease-in-out infinite;
}

.lsn-header__top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  position: relative;
  z-index: 1;
  margin-bottom: 0.75rem;
}

.lsn-header__left {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  min-width: 0;
}

.lsn-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.25rem 0.75rem;
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
  white-space: nowrap;
  backdrop-filter: blur(5px);
}

.lsn-badge__icon {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

.lsn-title {
  font-size: 1.125rem;
  font-weight: 700;
  margin: 0;
  letter-spacing: -0.01em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.lsn-header__counter {
  font-size: 0.8125rem;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
  white-space: nowrap;
}

/* Progress Bar */
.lsn-progress {
  position: relative;
  z-index: 1;
  height: 5px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
  overflow: hidden;
}

.lsn-progress__fill {
  height: 100%;
  background: #fff;
  border-radius: 3px;
  transition: width 0.4s ease;
}

/* ── Description ── */
.lsn-description {
  font-size: 0.875rem;
  color: var(--lsn-text-muted);
  margin: 0 0 1.25rem;
  line-height: 1.6;
}

/* ── Instruction Box ── */
.lsn-instruction {
  display: flex;
  align-items: flex-start;
  gap: 0.625rem;
  padding: 0.875rem 1rem;
  background: #ecfdf5;
  border: 1px solid #a7f3d0;
  border-radius: var(--lsn-radius-sm);
  font-size: 0.8125rem;
  color: #065f46;
  margin-bottom: 1.5rem;
  line-height: 1.5;
}

.lsn-instruction__icon {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  margin-top: 1px;
  color: var(--lsn-primary);
}

/* ── Content Area ── */
.lsn-body {
  margin-bottom: 2rem;
}

/* ── Footer ── */
.lsn-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--lsn-surface);
  border-top: 1px solid var(--lsn-border);
  padding: 0.75rem 1rem;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
}

.lsn-footer__inner {
  max-width: 800px;
  margin: 0 auto;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
}

.lsn-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.625rem 1.25rem;
  border-radius: var(--lsn-radius-sm);
  font-family: var(--lsn-font);
  font-size: 0.875rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.lsn-btn__icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.lsn-btn--primary {
  background: var(--lsn-gradient);
  color: #fff;
}

.lsn-btn--primary:hover {
  opacity: 0.92;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.lsn-btn--outline {
  background: var(--lsn-surface);
  color: var(--lsn-text-muted);
  border: 1.5px solid var(--lsn-border);
}

.lsn-btn--outline:hover {
  background: var(--lsn-surface-alt);
  color: var(--lsn-text);
  border-color: #cbd5e1;
}

/* ── Responsive ── */
@media (max-width: 640px) {
  .lsn-page {
    padding: 0 0.75rem 5.5rem;
  }

  .lsn-header {
    padding: 1rem 1.125rem;
    border-radius: 12px;
  }

  .lsn-title {
    font-size: 1rem;
  }

  .lsn-header__top {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .lsn-footer {
    padding: 0.625rem 0.75rem;
  }

  .lsn-btn {
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="lsn-page">

  <!-- Compact Header -->
  <div class="lsn-header">
    <div class="lsn-header__top">
      <div class="lsn-header__left">
        <span class="lsn-badge">
          {% if lesson.type == 'vocabulary' %}
            <svg class="lsn-badge__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 016.5 2H20v20H6.5a2.5 2.5 0 010-5H20"/></svg>
          {% elif lesson.type == 'grammar' %}
            <svg class="lsn-badge__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4z"/></svg>
          {% elif lesson.type == 'quiz' %}
            <svg class="lsn-badge__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          {% elif lesson.type == 'text' %}
            <svg class="lsn-badge__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          {% elif lesson.type in ['card', 'anki_cards'] %}
            <svg class="lsn-badge__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
          {% elif lesson.type == 'final_test' %}
            <svg class="lsn-badge__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 010-5H6"/><path d="M18 9h1.5a2.5 2.5 0 000-5H18"/><path d="M4 22h16"/><path d="M10 22V8a6 6 0 0112 0v14"/><path d="M2 8a6 6 0 0112 0"/></svg>
          {% elif lesson.type == 'matching' %}
            <svg class="lsn-badge__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          {% else %}
            <svg class="lsn-badge__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 6 3 6 3s3 0 6-3v-5"/></svg>
          {% endif %}
          {{ component_name|default(translate_lesson_type(lesson.type)) }}
        </span>
        <h1 class="lsn-title">{{ lesson.title }}</h1>
      </div>
      <span class="lsn-header__counter">{{ lesson.number }}/{{ total_lessons|default(12) }}</span>
    </div>
    <div class="lsn-progress">
      <div class="lsn-progress__fill" style="width: {{ ((lesson.number / total_lessons|default(7)) * 100)|round }}%"></div>
    </div>
  </div>

  {% if lesson.description or block_description %}
  <p class="lsn-description">{{ lesson.description or block_description|default('') }}</p>
  {% endif %}

  <!-- Instructions -->
  {% if instruction_text %}
  <div class="lsn-instruction">
    <svg class="lsn-instruction__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
    <span>{{ instruction_text }}</span>
  </div>
  {% endif %}

  <!-- Main Content -->
  <div class="lsn-body lesson-content">
    {% block lesson_content %}{% endblock %}
  </div>

  <!-- Navigation Footer -->
  <div class="lsn-footer" id="lesson-footer">
    <div class="lsn-footer__inner">
    {% block action_buttons %}
      <a href="{{ '/learn/' }}" class="lsn-btn lsn-btn--outline">
        <svg class="lsn-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        {{ _('К модулю') }}
      </a>

      <button type="button"
              class="lsn-btn lsn-btn--outline btn-lesson btn-outline"
              id="retry-button"
              style="display: none;"
              onclick="retryLesson()">
        <svg class="lsn-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
        {{ _('Заново') }}
      </button>

      {% if next_lesson %}
        <button type="button"
                class="lsn-btn lsn-btn--primary btn-lesson btn-primary"
                id="complete-exercise"
                style="display: none;"
                data-next-url="/learn/{{ next_lesson.id }}/"
                onclick="window.location.href=this.getAttribute('data-next-url')">
          {{ _('Следующий урок') }}
          <svg class="lsn-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
      {% else %}
        <button type="button"
                class="lsn-btn lsn-btn--primary btn-lesson btn-primary"
                id="complete-module"
                style="display: none;"
                onclick="window.location.href='{{ '/learn/' }}'">
          <svg class="lsn-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
          {{ _('Завершить') }}
        </button>
      {% endif %}
    {% endblock %}
      <div id="daily-plan-next-step"></div>
    </div>
  </div>

</div>

<!-- CSRF Token Meta -->
<meta name="csrf-token" content="{{ csrf_token() }}">
<script src="{{ url_for('static', filename='js/daily-plan-next.js') }}"></script>
<script>
// Dispatch daily plan event when lesson completion buttons become visible
(function() {
  var completeBtn = document.getElementById('complete-exercise') || document.getElementById('complete-module');
  if (!completeBtn) return;
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(m) {
      if (m.attributeName === 'style' && completeBtn.style.display !== 'none') {
        document.dispatchEvent(new Event('dailyPlanStepComplete'));
        observer.disconnect();
      }
    });
  });
  observer.observe(completeBtn, { attributes: true, attributeFilter: ['style'] });
})();
</script>
{% endblock %}
