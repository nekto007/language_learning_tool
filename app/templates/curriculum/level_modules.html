{% extends "base.html" %}

{% block title %}{{ level.code }} - {{ level.name }}{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Hero Section -->
  <div class="hero-section mb-4">
    <div class="hero-content">
      <div class="hero-header">
        <a href="/learn/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å–∞–º</a>
        <div class="hero-title-group">
          <div class="level-badge-large level-{{ level.code[0]|lower }}">{{ level.code }}</div>
          <div>
            <h1>{{ level.name }}</h1>
            <p class="hero-subtitle">{{ level.description }}</p>
          </div>
        </div>
      </div>

      {% if next_lesson_info %}
        <div class="hero-cta">
          <a href="{{ get_lesson_url(next_lesson_info['lesson']) }}"
             class="btn-hero">
            <span class="btn-hero-text">
              <strong>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ</strong>
              <small>{{ next_lesson_info['lesson'].title }}</small>
            </span>
            <span class="btn-hero-icon">‚Üí</span>
          </a>
        </div>
      {% endif %}
    </div>

    <!-- Level Stats -->
    {% if level_stats %}
      <div class="level-stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-value">{{ level_stats.completed_lessons }}/{{ level_stats.total_lessons }}</div>
          <div class="stat-label">—É—Ä–æ–∫–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üéØ</div>
          <div class="stat-value">{{ level_stats.progress_percent }}%</div>
          <div class="stat-label">–ø—Ä–æ–≥—Ä–µ—Å—Å</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üìö</div>
          <div class="stat-value">{{ level_stats.completed_modules }}/{{ level_stats.total_modules }}</div>
          <div class="stat-label">–º–æ–¥—É–ª–µ–π</div>
        </div>

        {% if level_stats.estimated_hours > 0 %}
          <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-value">~{{ level_stats.estimated_hours }} —á</div>
            <div class="stat-label">–æ—Å—Ç–∞–ª–æ—Å—å</div>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- Modules List -->
  <div class="section-card">
    <div class="section-header">
      <h2>üìñ –ú–æ–¥—É–ª–∏ –∫—É—Ä—Å–∞</h2>
      <p class="section-subtitle">–ò–∑—É—á–∞–π—Ç–µ –º–æ–¥—É–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</p>
    </div>
    <div class="section-content">
      {% if modules %}
        <div class="modules-list">
          {% for module in modules|sort(attribute='number') %}
            {% set progress = user_module_progress.get(module.id, {}) %}
            {% set is_accessible = progress.get('is_accessible', False) %}
            {% set is_completed = progress.get('is_completed', False) %}
            {% set is_locked = progress.get('is_locked', True) %}
            {% set percentage = progress.get('percentage', 0) %}

            <div class="module-card {{ 'current' if progress.get('is_current') else 'completed' if is_completed else 'locked' if is_locked else '' }}">
              <div class="module-header">
                <div class="module-number">
                  <span class="number-badge">{{ module.number }}</span>
                  {% if is_completed %}
                    <span class="status-icon completed">‚úì</span>
                  {% elif is_locked %}
                    <span class="status-icon locked">üîí</span>
                  {% elif percentage > 0 %}
                    <div class="progress-ring">
                      <svg width="24" height="24">
                        <circle cx="12" cy="12" r="10" fill="none" stroke="#e9ecef" stroke-width="3"></circle>
                        <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="3"
                                stroke-dasharray="{{ (percentage / 100 * 62.8)|round }} 62.8"
                                stroke-dashoffset="0"
                                transform="rotate(-90 12 12)"></circle>
                      </svg>
                    </div>
                  {% endif %}
                </div>

                <div class="module-info">
                  <h3>{{ module.title }}</h3>
                  <p class="module-desc">
                    {% if is_locked %}
                      –ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥—É–ª—å, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                    {% else %}
                      {{ module.description or '–ò–∑—É—á–∏—Ç–µ –æ—Å–Ω–æ–≤—ã –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏ –∏ –ª–µ–∫—Å–∏–∫–∏' }}
                    {% endif %}
                  </p>
                </div>

                {% if is_completed %}
                  <div class="completion-badge">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω</div>
                {% elif progress.get('is_current') %}
                  <div class="current-badge">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                {% endif %}
              </div>

              {% if is_accessible %}
                <div class="module-body">
                  <div class="module-stats-row">
                    <div class="module-stat">
                      <span class="stat-icon">üìù</span>
                      <span class="stat-text">{{ progress.get('completed_lessons', 0) }}/{{ progress.get('total_lessons', 0) }} —É—Ä–æ–∫–æ–≤</span>
                    </div>

                    {% if progress.get('estimated_hours', 0) > 0 %}
                      <div class="module-stat">
                        <span class="stat-icon">‚è±Ô∏è</span>
                        <span class="stat-text">~{{ progress.get('estimated_hours') }} —á</span>
                      </div>
                    {% endif %}

                    {% if percentage > 0 %}
                      <div class="module-stat">
                        <span class="stat-icon">üéØ</span>
                        <span class="stat-text">{{ percentage }}%</span>
                      </div>
                    {% endif %}
                  </div>

                  {% if percentage > 0 and percentage < 100 %}
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: {{ percentage }}%"></div>
                    </div>
                  {% endif %}

                  <div class="module-actions">
                    <a href="/learn/{{ level.code|lower }}/module-{{ module.number }}/"
                       class="btn-module {{ 'btn-primary' if progress.get('is_current') else 'btn-secondary' }}">
                      {% if is_completed %}
                        –ü–æ–≤—Ç–æ—Ä–∏—Ç—å ‚Üí
                      {% elif percentage > 0 %}
                        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí
                      {% else %}
                        –ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ ‚Üí
                      {% endif %}
                    </a>
                  </div>
                </div>
              {% else %}
                <div class="module-body locked">
                  <p class="locked-message">
                    <span class="locked-icon">üîí</span>
                    –ó–∞–≤–µ—Ä—à–∏—Ç–µ {{ module.number - 1 }} –º–æ–¥—É–ª—å, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                  </p>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">üìö</div>
          <h4>–í —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ –ø–æ–∫–∞ –Ω–µ—Ç –º–æ–¥—É–ª–µ–π</h4>
          <p>–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —É—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
