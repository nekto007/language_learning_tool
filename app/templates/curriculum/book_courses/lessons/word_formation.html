{% extends "curriculum/book_courses/lessons/_lesson_base.html" %}

{% block lesson_type %}üî§ –°–ª–æ–≤–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ{% endblock %}

{% block lesson_content %}
<div class="lesson-intro">
  <h1>–°–ª–æ–≤–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</h1>
  <p>–ü—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ —Å–ª–æ–≤–∞ –≤ —Å–∫–æ–±–∫–∞—Ö –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–æ—Ä–º—É</p>
</div>

<div class="lesson-instructions">
  <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Å–ª–æ–≤–∞ –≤ —Å–∫–æ–±–∫–∞—Ö —Ç–∞–∫,
  —á—Ç–æ–±—ã –æ–Ω–æ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –ª–µ–∫—Å–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ö–æ–¥–∏–ª–æ –∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é.
</div>

<div class="word-formation-container" id="wf-container">
  <!-- Will be populated -->
</div>

<div class="wf-summary" id="summary" style="display: none;">
  <div class="summary-score">
    <span id="correct-count">0</span> / <span id="total-count">8</span> –ø—Ä–∞–≤–∏–ª—å–Ω–æ
  </div>
</div>
{% endblock %}

{% block lesson_footer %}
<div class="lesson-footer-actions">
  <a href="{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}" class="btn-footer btn-secondary">
    <i class="fas fa-arrow-left"></i> –ö —É—Ä–æ–∫–∞–º
  </a>
  <button id="check-btn" class="btn-footer btn-primary" onclick="checkAnswers()">
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
  </button>
  <button id="complete-btn" class="btn-footer btn-primary" onclick="finishLesson()" style="display: none;">
    {% if has_next_lesson %}–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i>{% else %}–ó–∞–≤–µ—Ä—à–∏—Ç—å <i class="fas fa-check"></i>{% endif %}
  </button>
</div>
{% endblock %}

{% block lesson_scripts %}
<script>
// Word formation data
const wordFormationData = [
  {
    id: 1,
    sentence: "The ______ of the new shopping center has created many jobs.",
    baseWord: "DEVELOP",
    answer: "development",
    hint: "—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ"
  },
  {
    id: 2,
    sentence: "She gave a very ______ performance in the school play.",
    baseWord: "IMPRESS",
    answer: "impressive",
    hint: "–ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ"
  },
  {
    id: 3,
    sentence: "The weather forecast was quite ______ as it didn't rain at all.",
    baseWord: "ACCURATE",
    answer: "inaccurate",
    hint: "–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ"
  },
  {
    id: 4,
    sentence: "His ______ to the project was invaluable.",
    baseWord: "CONTRIBUTE",
    answer: "contribution",
    hint: "—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ"
  },
  {
    id: 5,
    sentence: "The children behaved ______ during the ceremony.",
    baseWord: "BEAUTY",
    answer: "beautifully",
    hint: "–Ω–∞—Ä–µ—á–∏–µ"
  },
  {
    id: 6,
    sentence: "There has been a significant ______ in air quality.",
    baseWord: "IMPROVE",
    answer: "improvement",
    hint: "—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ"
  },
  {
    id: 7,
    sentence: "It's ______ to think that money can buy happiness.",
    baseWord: "FOOL",
    answer: "foolish",
    hint: "–ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ"
  },
  {
    id: 8,
    sentence: "The ______ of the internet has changed our lives dramatically.",
    baseWord: "INVENT",
    answer: "invention",
    hint: "—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ"
  }
];

let userAnswers = {};
let isChecked = false;

// localStorage key –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
const lessonId = {{ daily_lesson.id if daily_lesson else 0 }};
const storageKey = `wf_progress_${lessonId}`;

function init() {
  loadProgress();
  renderItems();
}

function saveProgress() {
  if (lessonId && !isChecked) {
    localStorage.setItem(storageKey, JSON.stringify({
      userAnswers: userAnswers,
      timestamp: Date.now()
    }));
  }
}

function loadProgress() {
  if (!lessonId) return;

  try {
    const saved = localStorage.getItem(storageKey);
    if (saved) {
      const data = JSON.parse(saved);
      if (data.timestamp && (Date.now() - data.timestamp) < 24 * 60 * 60 * 1000) {
        userAnswers = data.userAnswers || {};
      } else {
        clearProgress();
      }
    }
  } catch (e) {
    console.error('Error loading progress:', e);
  }
}

function clearProgress() {
  localStorage.removeItem(storageKey);
}

function renderItems() {
  const container = document.getElementById('wf-container');
  container.innerHTML = wordFormationData.map(item => {
    const parts = item.sentence.split('______');
    return `
      <div class="wf-item" id="item-${item.id}">
        <div class="item-number">${item.id}</div>
        <div class="item-content">
          <div class="sentence">
            ${parts[0]}<input type="text"
                              class="wf-input"
                              id="input-${item.id}"
                              data-id="${item.id}"
                              oninput="onInputChange(${item.id})"
                              autocomplete="off">${parts[1]}
          </div>
          <div class="base-word">(${item.baseWord})</div>
        </div>
      </div>
    `;
  }).join('');

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
  Object.keys(userAnswers).forEach(itemId => {
    const input = document.getElementById(`input-${itemId}`);
    if (input && userAnswers[itemId]) {
      input.value = userAnswers[itemId];
    }
  });
}

function onInputChange(itemId) {
  const input = document.getElementById(`input-${itemId}`);
  userAnswers[itemId] = input.value.trim().toLowerCase();
  saveProgress();
}

function checkAnswers() {
  if (isChecked) return;
  isChecked = true;

  let correctCount = 0;

  wordFormationData.forEach(item => {
    const input = document.getElementById(`input-${item.id}`);
    const userAnswer = (userAnswers[item.id] || '').toLowerCase();
    const correctAnswer = item.answer.toLowerCase();
    const isCorrect = userAnswer === correctAnswer;

    input.disabled = true;
    input.classList.add(isCorrect ? 'correct' : 'incorrect');

    if (isCorrect) {
      correctCount++;
    } else {
      // Show correct answer
      const itemEl = document.getElementById(`item-${item.id}`);
      const correction = document.createElement('div');
      correction.className = 'correction';
      correction.innerHTML = `<span class="correction-label">–ü—Ä–∞–≤–∏–ª—å–Ω–æ:</span> ${item.answer}`;
      itemEl.querySelector('.item-content').appendChild(correction);
    }
  });

  // Show summary
  document.getElementById('correct-count').textContent = correctCount;
  document.getElementById('total-count').textContent = wordFormationData.length;
  document.getElementById('summary').style.display = 'block';

  // Calculate score
  window.finalScore = Math.round((correctCount / wordFormationData.length) * 100);

  // Show complete button
  document.getElementById('check-btn').style.display = 'none';
  document.getElementById('complete-btn').style.display = 'inline-block';
}

const nextLessonUrl = {{ next_lesson_url | tojson | safe if next_lesson_url else 'null' }};
const hasNextLesson = {{ 'true' if has_next_lesson else 'false' }};
const moduleUrl = "{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}";

async function finishLesson() {
  const btn = document.getElementById('complete-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω—è–µ–º...';

  try {
    {% if daily_lesson %}
    const response = await fetch(`/curriculum/api/v1/lesson/{{ daily_lesson.id }}/complete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    if (response.status === 201 || response.ok) {
      clearProgress();
      if (hasNextLesson && nextLessonUrl) {
        window.location.href = nextLessonUrl;
      } else {
        window.location.href = moduleUrl;
      }
    } else {
      throw new Error('Failed to save');
    }
    {% else %}
    clearProgress();
    if (hasNextLesson && nextLessonUrl) {
      window.location.href = nextLessonUrl;
    } else {
      window.location.href = moduleUrl;
    }
    {% endif %}
  } catch (error) {
    console.error('Error:', error);
    btn.disabled = false;
    btn.innerHTML = hasNextLesson ? '–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i>' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å <i class="fas fa-check"></i>';
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
  }
}

document.addEventListener('DOMContentLoaded', function() {
  init();
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.target.classList.contains('wf-input') && !isChecked) {
      e.preventDefault();
      checkAnswers();
    }
  });
});
</script>

<style>
/* Word Formation Specific Styles */
.word-formation-container {
  max-width: 800px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.wf-item {
  display: flex;
  gap: 1rem;
  padding: 1.25rem;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
}

.item-number {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border-radius: 50%;
  font-weight: 600;
  flex-shrink: 0;
}

.item-content {
  flex: 1;
}

.sentence {
  font-size: 1.0625rem;
  line-height: 1.6;
  margin-bottom: 0.5rem;
}

.wf-input {
  width: 150px;
  padding: 0.25rem 0.5rem;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 1rem;
  background: var(--bg-primary);
  margin: 0 0.25rem;
}

.wf-input:focus {
  outline: none;
  border-color: var(--accent-color);
}

.wf-input.correct {
  border-color: #4caf50;
  background: rgba(76, 175, 80, 0.1);
}

.wf-input.incorrect {
  border-color: #f44336;
  background: rgba(244, 67, 54, 0.1);
}

.base-word {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  background: var(--accent-color);
  color: white;
  border-radius: var(--radius-full);
  font-size: 0.875rem;
  font-weight: 600;
}

.correction {
  margin-top: 0.75rem;
  padding: 0.5rem 0.75rem;
  background: #e8f5e9;
  border-radius: var(--radius-sm);
  font-size: 0.875rem;
}

.correction-label {
  color: #2e7d32;
  font-weight: 500;
  margin-right: 0.5rem;
}

.wf-summary {
  margin-top: 2rem;
  text-align: center;
}

.summary-score {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--accent-color);
}

/* Responsive */
@media (max-width: 768px) {
  .wf-item {
    flex-direction: column;
    gap: 0.75rem;
  }

  .item-number {
    align-self: flex-start;
  }

  .wf-input {
    width: 120px;
  }
}
</style>
{% endblock %}
