{% extends "curriculum/book_courses/lessons/_lesson_base.html" %}

{% block lesson_type %}‚ùì –¢–µ—Å—Ç –Ω–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ{% endblock %}

{% block lesson_content %}
<div class="lesson-intro">
  <h1>–¢–µ—Å—Ç –Ω–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</h1>
  <p>–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ç–µ–∫—Å—Ç—É. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å/—Å–≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ.</p>
</div>

<!-- Passage Text (collapsible) -->
{% if daily_lesson and daily_lesson.slice_text %}
<div class="passage-container">
  <div class="passage-header" onclick="togglePassage()">
    <span class="passage-title">üìñ –¢–µ–∫—Å—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è</span>
    <span class="passage-toggle" id="passage-toggle">‚ñº –ü–æ–∫–∞–∑–∞—Ç—å</span>
  </div>
  <div class="passage-content" id="passage-content" style="display: none;">
    <div class="passage-text">{{ daily_lesson.slice_text }}</div>
  </div>
</div>
{% endif %}

<div class="quiz-container">
  <!-- Progress -->
  <div class="quiz-progress">
    <div class="progress-bar">
      <div class="progress-fill" id="quiz-progress" style="width: 10%"></div>
    </div>
    <span class="progress-text">–í–æ–ø—Ä–æ—Å <span id="current-q">1</span> –∏–∑ 10</span>
  </div>

  <!-- Question Card -->
  <div class="question-card" id="question-card">
    <div class="question-number">–í–æ–ø—Ä–æ—Å <span id="q-number">1</span></div>
    <div class="question-text" id="question-text"></div>

    <div class="options-list" id="options-list">
      <!-- Options will be rendered here -->
    </div>

    <div class="question-feedback" id="feedback" style="display: none;">
      <div class="feedback-icon" id="feedback-icon"></div>
      <div class="feedback-text" id="feedback-text"></div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="quiz-nav">
    <button class="nav-btn primary" id="next-btn" onclick="nextQuestion()" disabled>–î–∞–ª–µ–µ ‚Üí</button>
  </div>
</div>

<!-- Results (hidden initially) -->
<div class="quiz-results" id="results" style="display: none;">
  <div class="results-card">
    <div class="results-icon" id="results-icon">üéØ</div>
    <div class="results-score" id="results-score">0%</div>
    <div class="results-correct" id="results-correct">0 –∏–∑ 10 –ø—Ä–∞–≤–∏–ª—å–Ω–æ</div>
    <div class="results-message" id="results-message"></div>
  </div>
</div>
{% endblock %}

{% block lesson_footer %}
<div class="lesson-footer-actions" id="footer-buttons">
  <a href="{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}" class="btn-footer btn-secondary">
    <i class="fas fa-arrow-left"></i> –ö —É—Ä–æ–∫–∞–º
  </a>
  <button id="complete-btn" class="btn-footer btn-primary" onclick="finishQuiz()" style="display: none;">
    {% if has_next_lesson %}
    –î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i>
    {% else %}
    –ó–∞–≤–µ—Ä—à–∏—Ç—å <i class="fas fa-check"></i>
    {% endif %}
  </button>
</div>
{% endblock %}

{% block lesson_scripts %}
<!-- Server data -->
<script>
const serverQuestionData = {{ mcq_data | tojson | safe if mcq_data else 'null' }};
</script>

<script>
// Quiz data - load from server or use fallback
let questions = [];
let currentQuestion = 0;
let answers = {};
let score = 0;

// localStorage for progress persistence
const lessonId = {{ daily_lesson.id if daily_lesson else 0 }};
const storageKey = `quiz_progress_${lessonId}`;

function saveProgress() {
  localStorage.setItem(storageKey, JSON.stringify({
    currentQuestion,
    answers,
    timestamp: Date.now()
  }));
}

function loadProgress() {
  try {
    const saved = localStorage.getItem(storageKey);
    if (saved) {
      const data = JSON.parse(saved);
      // Only restore if less than 1 hour old
      if (Date.now() - data.timestamp < 3600000) {
        currentQuestion = data.currentQuestion || 0;
        answers = data.answers || {};
        return true;
      }
    }
  } catch (e) {}
  return false;
}

function clearProgress() {
  localStorage.removeItem(storageKey);
}

function loadQuestions() {
  // Try to load from server data first
  if (serverQuestionData && serverQuestionData.questions && serverQuestionData.questions.length > 0) {
    questions = serverQuestionData.questions.map(q => ({
      text: q.question || q.text,
      options: q.options || [],
      correct: q.correct || 0,
      explanation: q.explanation || ''
    }));
  } else {
    // Use placeholder questions as fallback
    questions = generatePlaceholderQuestions();
  }

  // Update total count
  document.querySelectorAll('#total-q, .progress-text').forEach(el => {
    if (el.textContent.includes('10')) {
      el.textContent = el.textContent.replace('10', questions.length);
    }
  });

  // Restore progress if available
  loadProgress();
  showQuestion(currentQuestion);
}

function generatePlaceholderQuestions() {
  // Placeholder questions for testing
  return [
    {
      text: 'What is the main topic of the passage?',
      options: ['Character development', 'Setting description', 'Plot advancement', 'Theme introduction'],
      correct: 0,
      explanation: 'The passage mainly focuses on character development.'
    },
    {
      text: 'According to the text, what happens first?',
      options: ['The protagonist makes a decision', 'A conflict arises', 'A new character appears', 'The setting changes'],
      correct: 1,
      explanation: 'The text describes a conflict arising as the first major event.'
    },
    {
      text: 'What can we infer about the main character?',
      options: ['They are cautious', 'They are impulsive', 'They are indifferent', 'They are experienced'],
      correct: 0,
      explanation: 'Based on the character\'s actions, we can infer they are cautious.'
    },
    {
      text: 'Which word best describes the tone of the passage?',
      options: ['Hopeful', 'Tense', 'Humorous', 'Melancholic'],
      correct: 1,
      explanation: 'The language and descriptions create a tense atmosphere.'
    },
    {
      text: 'What is the purpose of the highlighted vocabulary in context?',
      options: ['To describe emotions', 'To advance the plot', 'To create imagery', 'To introduce conflict'],
      correct: 2,
      explanation: 'The vocabulary words help create vivid imagery in the passage.'
    },
    {
      text: 'Based on the passage, which statement is true?',
      options: ['The events occur in the past', 'The narrator is omniscient', 'The story is autobiographical', 'The setting is fictional'],
      correct: 1,
      explanation: 'The narrative style suggests an omniscient narrator.'
    },
    {
      text: 'What does the author imply about the situation?',
      options: ['It will resolve quickly', 'It has deeper consequences', 'It is insignificant', 'It is unexpected'],
      correct: 1,
      explanation: 'The author\'s word choices imply deeper consequences.'
    },
    {
      text: 'Which literary device is primarily used in this section?',
      options: ['Metaphor', 'Foreshadowing', 'Irony', 'Personification'],
      correct: 1,
      explanation: 'The passage contains elements of foreshadowing about future events.'
    },
    {
      text: 'What is the significance of the mentioned detail?',
      options: ['It reveals character motivation', 'It establishes the time period', 'It creates suspense', 'It provides comic relief'],
      correct: 0,
      explanation: 'This detail helps reveal the character\'s underlying motivation.'
    },
    {
      text: 'How does this passage connect to the overall narrative?',
      options: ['It introduces the climax', 'It develops the rising action', 'It provides exposition', 'It signals the resolution'],
      correct: 1,
      explanation: 'This passage contributes to the rising action of the story.'
    }
  ];
}

function showQuestion(index) {
  if (!questions || questions.length === 0) {
    console.error('No questions loaded');
    return;
  }

  const q = questions[index];
  if (!q) {
    console.error('Question not found at index', index);
    return;
  }

  currentQuestion = index;

  const qNumber = document.getElementById('q-number');
  const currentQ = document.getElementById('current-q');
  const questionText = document.getElementById('question-text');

  if (qNumber) qNumber.textContent = index + 1;
  if (currentQ) currentQ.textContent = index + 1;
  if (questionText) questionText.textContent = q.text;

  // Update progress
  const progressBar = document.getElementById('quiz-progress');
  if (progressBar) progressBar.style.width = ((index + 1) / questions.length * 100) + '%';

  // Render options
  const optionsList = document.getElementById('options-list');
  if (optionsList) {
    optionsList.innerHTML = q.options.map((opt, i) => `
      <div class="option ${answers[index] === i ? 'selected' : ''}" onclick="selectOption(${i})">
        <span class="option-letter">${String.fromCharCode(65 + i)}</span>
        <span class="option-text">${opt}</span>
      </div>
    `).join('');
  }

  // Update nav button
  const nextBtn = document.getElementById('next-btn');
  if (nextBtn) {
    nextBtn.disabled = answers[index] === undefined;
    nextBtn.textContent = index === questions.length - 1 ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å ‚úì' : '–î–∞–ª–µ–µ ‚Üí';
  }

  // Hide feedback
  const feedback = document.getElementById('feedback');
  if (feedback) feedback.style.display = 'none';
}

function selectOption(optionIndex) {
  const q = questions[currentQuestion];
  answers[currentQuestion] = optionIndex;

  // Update UI
  const options = document.querySelectorAll('.option');
  options.forEach((opt, i) => {
    opt.classList.remove('selected', 'correct', 'incorrect');
    if (i === optionIndex) {
      opt.classList.add('selected');
    }
  });

  // Show feedback
  const isCorrect = optionIndex === q.correct;
  const feedback = document.getElementById('feedback');
  document.getElementById('feedback-icon').textContent = isCorrect ? '‚úì' : '‚úó';
  document.getElementById('feedback-icon').className = 'feedback-icon ' + (isCorrect ? 'correct' : 'incorrect');
  document.getElementById('feedback-text').textContent = q.explanation || (isCorrect ? '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!' : '–ù–µ–≤–µ—Ä–Ω–æ');
  feedback.style.display = 'block';

  // Highlight correct/incorrect
  options.forEach((opt, i) => {
    if (i === q.correct) {
      opt.classList.add('correct');
    } else if (i === optionIndex && !isCorrect) {
      opt.classList.add('incorrect');
    }
  });

  // Enable next
  document.getElementById('next-btn').disabled = false;

  // Save progress
  saveProgress();
}

function nextQuestion() {
  if (currentQuestion < questions.length - 1) {
    currentQuestion++;
    showQuestion(currentQuestion);
    saveProgress();
  } else {
    showResults();
  }
}

function showResults() {
  // Calculate score
  let correct = 0;
  questions.forEach((q, i) => {
    if (answers[i] === q.correct) correct++;
  });
  score = Math.round((correct / questions.length) * 100);

  // Hide quiz, show results
  document.querySelector('.quiz-container').style.display = 'none';
  const results = document.getElementById('results');
  results.style.display = 'block';

  // Update results display
  document.getElementById('results-score').textContent = score + '%';
  document.getElementById('results-correct').textContent = `${correct} –∏–∑ ${questions.length} –ø—Ä–∞–≤–∏–ª—å–Ω–æ`;

  const icon = score >= 70 ? 'üéâ' : score >= 50 ? 'üëç' : 'üí™';
  const message = score >= 70 ? '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!' : score >= 50 ? '–•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞!' : '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç';

  document.getElementById('results-icon').textContent = icon;
  document.getElementById('results-message').textContent = message;

  // Show complete button
  document.getElementById('complete-btn').style.display = 'inline-block';
}

const nextLessonUrl = {{ next_lesson_url | tojson | safe if next_lesson_url else 'null' }};
const hasNextLesson = {{ 'true' if has_next_lesson else 'false' }};
const moduleUrl = "{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}";

async function finishQuiz() {
  const btn = document.getElementById('complete-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω—è–µ–º...';

  try {
    {% if daily_lesson %}
    const response = await fetch(`/curriculum/api/v1/lesson/{{ daily_lesson.id }}/complete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    if (response.status === 201 || response.ok) {
      clearProgress();
      // Redirect immediately
      if (hasNextLesson && nextLessonUrl) {
        window.location.href = nextLessonUrl;
      } else {
        window.location.href = moduleUrl;
      }
    } else {
      throw new Error('Failed to save');
    }
    {% else %}
    if (hasNextLesson && nextLessonUrl) {
      window.location.href = nextLessonUrl;
    } else {
      window.location.href = moduleUrl;
    }
    {% endif %}
  } catch (error) {
    console.error('Error:', error);
    btn.disabled = false;
    btn.innerHTML = hasNextLesson ? '–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i>' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å <i class="fas fa-check"></i>';
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
  }
}

// Toggle passage visibility
function togglePassage() {
  const content = document.getElementById('passage-content');
  const toggle = document.getElementById('passage-toggle');

  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '‚ñ≤ –°–∫—Ä—ã—Ç—å';
  } else {
    content.style.display = 'none';
    toggle.textContent = '‚ñº –ü–æ–∫–∞–∑–∞—Ç—å';
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', loadQuestions);
</script>

<style>
/* Passage Container */
.passage-container {
  max-width: 700px;
  margin: 0 auto 1.5rem;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.passage-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  background: var(--bg-secondary);
  cursor: pointer;
  transition: background 0.2s;
}

.passage-header:hover {
  background: var(--bg-tertiary);
}

.passage-title {
  font-weight: 600;
  color: var(--text-primary);
}

.passage-toggle {
  font-size: 0.875rem;
  color: var(--accent-color);
}

.passage-content {
  padding: 1.5rem;
  border-top: 1px solid var(--border-color);
}

.passage-text {
  font-size: 1rem;
  line-height: 1.8;
  color: var(--text-primary);
  white-space: pre-wrap;
}

/* Quiz Specific Styles */
.quiz-container {
  max-width: 700px;
  margin: 0 auto;
}

.quiz-progress {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 2rem;
}

.quiz-progress .progress-bar {
  flex: 1;
  height: 6px;
  background: var(--bg-secondary);
  border-radius: var(--radius-full);
  overflow: hidden;
}

.quiz-progress .progress-fill {
  height: 100%;
  background: var(--accent-color);
  transition: width 0.3s ease;
}

.quiz-progress .progress-text {
  font-size: 0.875rem;
  color: var(--text-secondary);
  white-space: nowrap;
}

/* Question Card */
.question-card {
  background: var(--card-bg);
  padding: 2rem;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
  margin-bottom: 1.5rem;
}

.question-number {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}

.question-text {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 1.5rem;
  line-height: 1.4;
}

/* Options */
.options-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.option {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-primary);
  border: 2px solid var(--border-color);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s;
}

.option:hover {
  border-color: var(--accent-color);
}

.option.selected {
  border-color: var(--accent-color);
  background: rgba(var(--accent-rgb), 0.1);
}

.option.correct {
  border-color: #4caf50;
  background: rgba(76, 175, 80, 0.1);
}

.option.incorrect {
  border-color: #f44336;
  background: rgba(244, 67, 54, 0.1);
}

.option-letter {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border-radius: 50%;
  font-weight: 600;
  font-size: 0.875rem;
  flex-shrink: 0;
}

.option.correct .option-letter {
  background: #4caf50;
  color: white;
}

.option.incorrect .option-letter {
  background: #f44336;
  color: white;
}

.option-text {
  flex: 1;
  line-height: 1.4;
}

/* Feedback */
.question-feedback {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  margin-top: 1.5rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
}

.feedback-icon {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-weight: 700;
}

.feedback-icon.correct {
  background: #4caf50;
  color: white;
}

.feedback-icon.incorrect {
  background: #f44336;
  color: white;
}

.feedback-text {
  flex: 1;
  font-size: 0.875rem;
  color: var(--text-secondary);
  line-height: 1.4;
}

/* Navigation */
.quiz-nav {
  display: flex;
  justify-content: flex-end;
  margin-top: 1rem;
}

.nav-btn {
  padding: 1rem 2.5rem;
  background: var(--bg-secondary);
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1.1rem;
  transition: all 0.2s;
}

.nav-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.nav-btn.primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.nav-btn.primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
  background: linear-gradient(135deg, #5a6fd6, #6a42a0);
}

/* Results */
.quiz-results {
  max-width: 500px;
  margin: 0 auto;
}

.results-card {
  background: var(--card-bg);
  padding: 3rem;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
  text-align: center;
}

.results-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.results-score {
  font-size: 3rem;
  font-weight: 700;
  color: var(--accent-color);
  margin-bottom: 0.5rem;
}

.results-correct {
  font-size: 1.125rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}

.results-message {
  font-size: 1rem;
  color: var(--text-primary);
}

/* Footer Actions */
.lesson-footer-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.btn-footer {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.875rem 1.5rem;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.2s;
}

.btn-footer.btn-secondary {
  background: #f3f4f6;
  color: #374151;
}

.btn-footer.btn-secondary:hover {
  background: #e5e7eb;
  color: #1f2937;
}

.btn-footer.btn-primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-footer.btn-primary:disabled {
  background: #d1d5db;
  box-shadow: none;
  cursor: not-allowed;
  color: #9ca3af;
}

.btn-footer.btn-primary:not(:disabled):hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  background: linear-gradient(135deg, #5a6fd6, #6a42a0);
  color: white;
}

@media (max-width: 768px) {
  .lesson-footer-actions {
    flex-direction: column;
    gap: 0.75rem;
  }
  .btn-footer {
    width: 100%;
    justify-content: center;
  }
}
</style>
{% endblock %}
