{% extends "base.html" %}

{% block title %}{{ lesson.title or '–£—Ä–æ–∫' }} - {{ course.title }}{% endblock %}

{% block content %}
<div class="lesson-container">
  <!-- Lesson Header -->
  <div class="lesson-header-bar">
    <div class="lesson-nav">
      <a href="{% if course.slug %}{{ url_for('book_courses.view_module_by_slug', course_slug=course.slug, module_number=module.module_number) }}{% else %}{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}{% endif %}" class="back-btn">
        ‚Üê –ö –º–æ–¥—É–ª—é
      </a>
    </div>
    <div class="lesson-info">
      <span class="lesson-type">{% block lesson_type %}–£—Ä–æ–∫{% endblock %}</span>
      <span class="lesson-title">{{ lesson.title or ('–£—Ä–æ–∫ ' ~ lesson_number) }}</span>
    </div>
  </div>

  <!-- SRS Review Section (if there are due cards) -->
  {% if review_cards and review_cards|length > 0 %}
  <div class="srs-review-section" id="srs-review-section">
    <div class="review-header">
      <div class="review-info">
        <span class="review-icon">üîÑ</span>
        <span class="review-title">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —Å–ª–æ–≤</span>
        <span class="review-count">{{ review_cards|length }} —Å–ª–æ–≤</span>
      </div>
      <button class="review-toggle-btn" onclick="toggleReviewSection()">
        <span id="review-toggle-text">–ù–∞—á–∞—Ç—å</span>
      </button>
    </div>

    <div class="review-content" id="review-content" style="display: none;">
      <div class="review-card-container">
        <div class="review-card" id="review-card" onclick="flipReviewCard()">
          <div class="review-card-front">
            <div class="review-word" id="review-front"></div>
            <div class="review-hint">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</div>
          </div>
          <div class="review-card-back">
            <div class="review-word" id="review-back"></div>
          </div>
        </div>
      </div>

      <div class="review-controls">
        <div class="review-progress">
          <span id="review-current">1</span> / <span id="review-total">{{ review_cards|length }}</span>
        </div>
        <!-- Unified 1-2-3 rating scale -->
        <div class="review-buttons" id="review-buttons" style="display: none;">
          <button class="review-btn hard" onclick="rateReviewCard(1)">–ù–µ –∑–Ω–∞—é</button>
          <button class="review-btn good" onclick="rateReviewCard(2)">–°–æ–º–Ω–µ–≤–∞—é—Å—å</button>
          <button class="review-btn easy" onclick="rateReviewCard(3)">–ó–Ω–∞—é</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Lesson Content -->
  <div class="lesson-content">
    {% block lesson_content %}{% endblock %}
  </div>

  <!-- Lesson Footer -->
  <div class="lesson-footer">
    {% block lesson_footer %}
    <button id="complete-btn" class="btn btn-primary btn-lg" onclick="completeLesson()" disabled>
      –ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫
    </button>
    {% endblock %}
  </div>
</div>

<style>
/* Base Lesson Styles */
.lesson-container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
}

.lesson-header-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 2rem;
  background: var(--card-bg);
  border-bottom: 1px solid var(--border-color);
}

.back-btn {
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 0.875rem;
}

.back-btn:hover {
  color: var(--accent-color);
}

.lesson-info {
  text-align: center;
}

.lesson-type {
  display: block;
  font-size: 0.75rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.lesson-title {
  font-weight: 600;
}

.lesson-content {
  flex: 1;
  padding: 2rem;
  max-width: 900px;
  margin: 0 auto;
  width: 100%;
}

.lesson-footer {
  padding: 1.5rem 2rem;
  background: var(--card-bg);
  border-top: 1px solid var(--border-color);
  text-align: center;
}

/* Common Lesson Elements */
.lesson-intro {
  text-align: center;
  margin-bottom: 2rem;
}

.lesson-intro h1 {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}

.lesson-intro p {
  color: var(--text-secondary);
}

.lesson-instructions {
  background: var(--bg-secondary);
  padding: 1rem;
  border-radius: var(--radius-md);
  margin-bottom: 2rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

/* Buttons */
.btn {
  display: inline-block;
  padding: 0.75rem 1.5rem;
  border-radius: var(--radius-md);
  font-weight: 500;
  text-decoration: none;
  text-align: center;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-lg {
  padding: 1rem 2rem;
  font-size: 1.125rem;
}

.btn-primary {
  background: var(--accent-color);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: var(--accent-hover);
}

.btn-secondary {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.btn-secondary:hover:not(:disabled) {
  background: var(--bg-tertiary);
}

/* Results */
.lesson-results {
  text-align: center;
  padding: 2rem;
  background: var(--card-bg);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
}

.results-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.results-score {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--accent-color);
  margin-bottom: 0.5rem;
}

.results-message {
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
}

.results-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
}

/* Responsive */
@media (max-width: 768px) {
  .lesson-header-bar {
    padding: 1rem;
  }

  .lesson-content {
    padding: 1rem;
  }

  .lesson-footer {
    padding: 1rem;
  }
}

/* SRS Review Section */
.srs-review-section {
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  border-radius: var(--radius-lg);
  padding: 1rem 1.5rem;
  margin: 0 2rem 1rem;
  border: 1px solid #ffcc80;
}

.review-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.review-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.review-icon {
  font-size: 1.25rem;
}

.review-title {
  font-weight: 600;
  color: #e65100;
}

.review-count {
  background: #ff9800;
  color: white;
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 500;
}

.review-toggle-btn {
  background: #ff9800;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s;
}

.review-toggle-btn:hover {
  background: #f57c00;
}

.review-content {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(230, 81, 0, 0.2);
}

.review-card-container {
  perspective: 1000px;
  margin-bottom: 1rem;
}

.review-card {
  width: 100%;
  height: 150px;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.5s;
  cursor: pointer;
}

.review-card.flipped {
  transform: rotateY(180deg);
}

.review-card-front,
.review-card-back {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  background: white;
  border-radius: var(--radius-md);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.review-card-back {
  transform: rotateY(180deg);
  background: #fff8e1;
}

.review-word {
  font-size: 1.5rem;
  font-weight: 600;
  color: #333;
}

.review-hint {
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-top: 0.5rem;
}

.review-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.review-progress {
  font-size: 0.875rem;
  color: #e65100;
  font-weight: 500;
}

.review-buttons {
  display: flex;
  gap: 0.5rem;
}

.review-btn {
  padding: 0.4rem 1rem;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 500;
  transition: all 0.2s;
}

.review-btn.hard {
  background: #ffebee;
  color: #c62828;
}

.review-btn.hard:hover {
  background: #ffcdd2;
}

.review-btn.good {
  background: #e8f5e9;
  color: #2e7d32;
}

.review-btn.good:hover {
  background: #c8e6c9;
}

.review-btn.easy {
  background: #e3f2fd;
  color: #1565c0;
}

.review-btn.easy:hover {
  background: #bbdefb;
}

.review-complete {
  text-align: center;
  padding: 1rem;
  color: #2e7d32;
  font-weight: 500;
}

/* Common Footer Button Styles */
.lesson-footer-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.btn-footer {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.875rem 1.5rem;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.2s;
}

.btn-footer.btn-secondary {
  background: #f3f4f6;
  color: #374151;
}

.btn-footer.btn-secondary:hover {
  background: #e5e7eb;
  color: #1f2937;
}

.btn-footer.btn-primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-footer.btn-primary:disabled {
  background: #d1d5db;
  box-shadow: none;
  cursor: not-allowed;
  color: #9ca3af;
}

.btn-footer.btn-primary:not(:disabled):hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  background: linear-gradient(135deg, #5a6fd6, #6a42a0);
  color: white;
}

@media (max-width: 768px) {
  .lesson-footer-actions {
    flex-direction: column;
    gap: 0.75rem;
  }
  .btn-footer {
    width: 100%;
    justify-content: center;
  }
}
</style>

<script>
const courseId = {{ course.id }};
const moduleId = {{ module.id }};
const lessonNumber = {{ lesson_number }};
const dailyLessonId = {{ lesson.daily_lesson_id or 'null' }};

function enableCompleteButton() {
  const btn = document.getElementById('complete-btn');
  if (btn) btn.disabled = false;
}

function completeLesson(score = 100) {
  const btn = document.getElementById('complete-btn');
  btn.disabled = true;
  btn.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';

  // Use new API if daily_lesson_id exists
  const endpoint = dailyLessonId
    ? `/curriculum/api/v1/lesson/${dailyLessonId}/complete`
    : `/curriculum/api/book-courses/${courseId}/modules/${moduleId}/complete-lesson`;

  const body = dailyLessonId
    ? {}
    : { lesson_number: lessonNumber, score: score };

  fetch(endpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(body)
  })
  .then(response => {
    if (response.status === 201 || response.ok) {
      // Handle empty or JSON responses
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        return response.json();
      }
      return { success: true };
    }
    throw new Error('Failed to complete lesson');
  })
  .then(data => {
    console.log('Lesson completed:', data);
    // Show success and redirect
    showResults(score);
  })
  .catch(error => {
    console.error('Error:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞');
    btn.disabled = false;
    btn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫';
  });
}

function showResults(score) {
  const content = document.querySelector('.lesson-content');
  const footer = document.querySelector('.lesson-footer');

  const emoji = score >= 90 ? 'üéâ' : score >= 70 ? 'üëç' : 'üí™';
  const message = score >= 90 ? '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!'
    : score >= 70 ? '–•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞!'
    : '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è!';

  content.innerHTML = `
    <div class="lesson-results">
      <div class="results-icon">${emoji}</div>
      <div class="results-score">${score}%</div>
      <div class="results-message">${message}</div>
      <div class="results-actions">
        <a href="${document.referrer || '{% if course.slug %}{{ url_for("book_courses.view_module_by_slug", course_slug=course.slug, module_number=module.module_number) }}{% else %}{{ url_for("book_courses.view_module", course_id=course.id, module_id=module.id) }}{% endif %}'}" class="btn btn-primary">
          –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </a>
      </div>
    </div>
  `;

  footer.style.display = 'none';
}

// SRS Review Section Functions
{% if review_cards and review_cards|length > 0 %}
const reviewCards = {{ review_cards | tojson | safe }};
let reviewIndex = 0;
let reviewFlipped = false;

function toggleReviewSection() {
  const content = document.getElementById('review-content');
  const toggleText = document.getElementById('review-toggle-text');

  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggleText.textContent = '–°–∫—Ä—ã—Ç—å';
    showReviewCard(0);
  } else {
    content.style.display = 'none';
    toggleText.textContent = '–ù–∞—á–∞—Ç—å';
  }
}

function showReviewCard(index) {
  if (index >= reviewCards.length) {
    // All cards reviewed
    document.getElementById('review-content').innerHTML = `
      <div class="review-complete">
        ‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í—Å–µ —Å–ª–æ–≤–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω—ã.
      </div>
    `;
    return;
  }

  const card = reviewCards[index];
  reviewIndex = index;
  reviewFlipped = false;

  document.getElementById('review-front').textContent = card.front;
  document.getElementById('review-back').textContent = card.back;
  document.getElementById('review-card').classList.remove('flipped');
  document.getElementById('review-buttons').style.display = 'none';
  document.getElementById('review-current').textContent = index + 1;
}

function flipReviewCard() {
  reviewFlipped = !reviewFlipped;
  document.getElementById('review-card').classList.toggle('flipped');

  if (reviewFlipped) {
    document.getElementById('review-buttons').style.display = 'flex';
  } else {
    document.getElementById('review-buttons').style.display = 'none';
  }
}

function rateReviewCard(rating) {
  const card = reviewCards[reviewIndex];

  // Send rating to server (unified 1-2-3 scale)
  fetch('/curriculum/api/v1/srs/grade', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      card_id: card.card_id,
      rating: rating,  // Unified 1-2-3 scale
      session_key: 'lesson_review'
    })
  })
  .then(response => response.json())
  .then(result => {
    console.log('SRS grade result:', result);
    // Handle requeue if needed (rating 1 or 2)
    if (result.requeue_position !== null && result.requeue_position !== undefined) {
      const cardCopy = { ...card, isRequeue: true };
      const insertAt = Math.min(reviewIndex + result.requeue_position + 1, reviewCards.length);
      reviewCards.splice(insertAt, 0, cardCopy);
      document.getElementById('review-total').textContent = reviewCards.length;
      console.log(`Card requeued at position +${result.requeue_position}`);
    }
  })
  .catch(e => console.log('Grade API not available:', e));

  // Move to next card
  setTimeout(() => showReviewCard(reviewIndex + 1), 200);
}
{% endif %}
</script>

{% block lesson_scripts %}{% endblock %}
{% endblock %}
