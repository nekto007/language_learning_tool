{% extends "base.html" %}

{% block title %}{{ lesson.title or '–£—Ä–æ–∫' }} - {{ course.title }}{% endblock %}

{% block styles %}
{{ super() }}
<style>

/* ‚îÄ‚îÄ Scoped Book Lesson Variables ‚îÄ‚îÄ */
.bls-page {
  --bls-font: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
  --bls-primary: #10b981;
  --bls-primary-dark: #059669;
  --bls-gradient: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
  --bls-surface: #ffffff;
  --bls-surface-alt: #f8fafc;
  --bls-text: #0f172a;
  --bls-text-muted: #64748b;
  --bls-text-light: #94a3b8;
  --bls-border: #e2e8f0;
  --bls-radius: 16px;
  --bls-radius-sm: 10px;
  --bls-success: #10b981;
  --bls-warning: #f59e0b;
  --bls-danger: #ef4444;

  font-family: var(--bls-font);
  max-width: 800px;
  margin: 0 auto;
  padding: 0 1rem 6rem;
}

/* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
@keyframes blsSlideUp {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes blsFloat1 {
  0%, 100% { transform: translate(0, 0) scale(1); }
  50% { transform: translate(-12px, 12px) scale(1.05); }
}

@keyframes blsFloat2 {
  0%, 100% { transform: translate(0, 0) rotate(0deg); }
  50% { transform: translate(14px, -10px) rotate(8deg); }
}

.bls-page .bls-header { animation: blsSlideUp 0.4s ease-out; }
.bls-page .bls-body { animation: blsSlideUp 0.4s ease-out 0.08s both; }
.bls-page .bls-footer { animation: blsSlideUp 0.3s ease-out 0.12s both; }

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.bls-header {
  background: var(--bls-gradient);
  border-radius: var(--bls-radius);
  padding: 1.25rem 1.5rem;
  margin-bottom: 1.5rem;
  color: #fff;
  position: relative;
  overflow: hidden;
}

.bls-header::before,
.bls-header::after {
  content: '';
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.08);
  pointer-events: none;
}

.bls-header::before {
  width: 120px;
  height: 120px;
  top: -40px;
  right: -30px;
  animation: blsFloat1 18s ease-in-out infinite;
}

.bls-header::after {
  width: 70px;
  height: 70px;
  bottom: -25px;
  left: 8%;
  animation: blsFloat2 14s ease-in-out infinite;
}

.bls-header__top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  position: relative;
  z-index: 1;
  margin-bottom: 0.75rem;
}

.bls-header__left {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  min-width: 0;
}

.bls-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.25rem 0.75rem;
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
  white-space: nowrap;
  backdrop-filter: blur(5px);
}

.bls-badge__icon {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

.bls-title {
  font-size: 1.125rem;
  font-weight: 700;
  margin: 0;
  letter-spacing: -0.01em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.bls-header__counter {
  font-size: 0.8125rem;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
  white-space: nowrap;
}

/* ‚îÄ‚îÄ Content Area ‚îÄ‚îÄ */
.bls-body {
  margin-bottom: 2rem;
}

/* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
.bls-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bls-surface);
  border-top: 1px solid var(--bls-border);
  padding: 0.75rem 1rem;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
}

.bls-footer__inner {
  max-width: 800px;
  margin: 0 auto;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
}

.bls-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.625rem 1.25rem;
  border-radius: var(--bls-radius-sm);
  font-family: var(--bls-font);
  font-size: 0.875rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.bls-btn__icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.bls-btn--primary {
  background: var(--bls-gradient);
  color: #fff;
}

.bls-btn--primary:hover {
  opacity: 0.92;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.bls-btn--primary:disabled {
  background: #d1d5db;
  box-shadow: none;
  cursor: not-allowed;
  color: #9ca3af;
  opacity: 1;
  transform: none;
}

.bls-btn--outline {
  background: var(--bls-surface);
  color: var(--bls-text-muted);
  border: 1.5px solid var(--bls-border);
}

.bls-btn--outline:hover {
  background: var(--bls-surface-alt);
  color: var(--bls-text);
  border-color: #cbd5e1;
}

/* ‚îÄ‚îÄ SRS Review Section ‚îÄ‚îÄ */
.bls-review {
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  border-radius: var(--bls-radius-sm);
  padding: 1rem 1.25rem;
  margin-bottom: 1.5rem;
  border: 1px solid #ffcc80;
}

.bls-review__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.bls-review__info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.bls-review__icon {
  font-size: 1.25rem;
}

.bls-review__title {
  font-weight: 600;
  color: #e65100;
}

.bls-review__count {
  background: #ff9800;
  color: white;
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 500;
}

.bls-review__toggle {
  background: #ff9800;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: var(--bls-radius-sm);
  cursor: pointer;
  font-family: var(--bls-font);
  font-weight: 500;
  transition: all 0.2s;
}

.bls-review__toggle:hover {
  background: #f57c00;
}

.bls-review__content {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(230, 81, 0, 0.2);
}

.bls-review__card-wrap {
  perspective: 1000px;
  margin-bottom: 1rem;
}

.bls-review__card {
  width: 100%;
  height: 150px;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.5s;
  cursor: pointer;
}

.bls-review__card.flipped {
  transform: rotateY(180deg);
}

.bls-review__card-face {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  backface-visibility: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  background: white;
  border-radius: var(--bls-radius-sm);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.bls-review__card-face--back {
  transform: rotateY(180deg);
  background: #fff8e1;
}

.bls-review__word {
  font-size: 1.5rem;
  font-weight: 600;
  color: #333;
}

.bls-review__hint {
  font-size: 0.75rem;
  color: var(--bls-text-muted);
  margin-top: 0.5rem;
}

.bls-review__controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.bls-review__progress {
  font-size: 0.875rem;
  color: #e65100;
  font-weight: 500;
}

.bls-review__buttons {
  display: flex;
  gap: 0.5rem;
}

.bls-review__rate {
  padding: 0.4rem 1rem;
  border: none;
  border-radius: var(--bls-radius-sm);
  cursor: pointer;
  font-family: var(--bls-font);
  font-size: 0.8rem;
  font-weight: 500;
  transition: all 0.2s;
}

.bls-review__rate--hard { background: #ffebee; color: #c62828; }
.bls-review__rate--hard:hover { background: #ffcdd2; }
.bls-review__rate--good { background: #e8f5e9; color: #2e7d32; }
.bls-review__rate--good:hover { background: #c8e6c9; }
.bls-review__rate--easy { background: #e3f2fd; color: #1565c0; }
.bls-review__rate--easy:hover { background: #bbdefb; }

.bls-review__complete {
  text-align: center;
  padding: 1rem;
  color: #2e7d32;
  font-weight: 500;
}

/* ‚îÄ‚îÄ Lesson Results ‚îÄ‚îÄ */
.bls-results {
  text-align: center;
  padding: 2rem;
  background: var(--bls-surface);
  border-radius: var(--bls-radius);
  border: 1px solid var(--bls-border);
}

.bls-results__icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.bls-results__score {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--bls-primary);
  margin-bottom: 0.5rem;
}

.bls-results__message {
  color: var(--bls-text-muted);
  margin-bottom: 1.5rem;
}

.bls-results__actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
}

/* ‚îÄ‚îÄ Legacy class support ‚îÄ‚îÄ */
.lesson-content {
  flex: 1;
}

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media (max-width: 640px) {
  .bls-page {
    padding: 0 0.75rem 5.5rem;
  }

  .bls-header {
    padding: 1rem 1.125rem;
    border-radius: 12px;
  }

  .bls-title {
    font-size: 1rem;
  }

  .bls-header__top {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .bls-footer {
    padding: 0.625rem 0.75rem;
  }

  .bls-btn {
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="bls-page">

  <!-- Breadcrumb -->
  <nav class="breadcrumb-nav" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
    <a href="{{ url_for('book_courses.list_book_courses') }}">–ö—É—Ä—Å—ã</a>
    <span class="breadcrumb-nav__separator"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span>
    <a href="{{ url_for('book_courses.view_course', course_id=course.id) }}">{{ course.title }}</a>
    <span class="breadcrumb-nav__separator"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span>
    <a href="{% if course.slug %}{{ url_for('book_courses.view_module_by_slug', course_slug=course.slug, module_number=module.module_number) }}{% else %}{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}{% endif %}">–ú–æ–¥—É–ª—å {{ module.module_number }}</a>
    <span class="breadcrumb-nav__separator"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span>
    <span class="breadcrumb-nav__current">{{ lesson.title or ('–£—Ä–æ–∫ ' ~ lesson_number) }}</span>
  </nav>

  <!-- Compact Header -->
  <div class="bls-header">
    <div class="bls-header__top">
      <div class="bls-header__left">
        <span class="bls-badge">
          <svg class="bls-badge__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 6 3 6 3s3 0 6-3v-5"/></svg>
          {% block lesson_type %}–£—Ä–æ–∫{% endblock %}
        </span>
        <h1 class="bls-title">{{ lesson.title or ('–£—Ä–æ–∫ ' ~ lesson_number) }}</h1>
      </div>
      <span class="bls-header__counter">{{ course.title }}</span>
    </div>
  </div>

  <!-- SRS Review Section (if there are due cards) -->
  {% if review_cards and review_cards|length > 0 %}
  <div class="bls-review" id="srs-review-section">
    <div class="bls-review__header">
      <div class="bls-review__info">
        <span class="bls-review__icon">üîÑ</span>
        <span class="bls-review__title">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —Å–ª–æ–≤</span>
        <span class="bls-review__count">{{ review_cards|length }} —Å–ª–æ–≤</span>
      </div>
      <button class="bls-review__toggle" onclick="toggleReviewSection()">
        <span id="review-toggle-text">–ù–∞—á–∞—Ç—å</span>
      </button>
    </div>

    <div class="bls-review__content" id="review-content" style="display: none;">
      <div class="bls-review__card-wrap">
        <div class="bls-review__card" id="review-card" onclick="flipReviewCard()">
          <div class="bls-review__card-face">
            <div class="bls-review__word" id="review-front"></div>
            <div class="bls-review__hint">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</div>
          </div>
          <div class="bls-review__card-face bls-review__card-face--back">
            <div class="bls-review__word" id="review-back"></div>
          </div>
        </div>
      </div>

      <div class="bls-review__controls">
        <div class="bls-review__progress">
          <span id="review-current">1</span> / <span id="review-total">{{ review_cards|length }}</span>
        </div>
        <div class="bls-review__buttons" id="review-buttons" style="display: none;">
          <button class="bls-review__rate bls-review__rate--hard" onclick="rateReviewCard(1)">–ù–µ –∑–Ω–∞—é</button>
          <button class="bls-review__rate bls-review__rate--good" onclick="rateReviewCard(2)">–°–æ–º–Ω–µ–≤–∞—é—Å—å</button>
          <button class="bls-review__rate bls-review__rate--easy" onclick="rateReviewCard(3)">–ó–Ω–∞—é</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Main Content -->
  <div class="bls-body lesson-content">
    {% block lesson_content %}{% endblock %}
  </div>

  <!-- Navigation Footer -->
  <div class="bls-footer" id="lesson-footer">
    <div class="bls-footer__inner">
    {% block lesson_footer %}
      <a href="{% if course.slug %}{{ url_for('book_courses.view_module_by_slug', course_slug=course.slug, module_number=module.module_number) }}{% else %}{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}{% endif %}" class="bls-btn bls-btn--outline">
        <svg class="bls-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        –ö –º–æ–¥—É–ª—é
      </a>

      <button id="complete-btn" class="bls-btn bls-btn--primary btn-footer btn-primary" onclick="completeLesson()" disabled>
        <svg class="bls-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        –ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫
      </button>
    {% endblock %}
    </div>
  </div>

</div>

<!-- CSRF Token Meta -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<script>
const courseId = {{ course.id }};
const moduleId = {{ module.id }};
const lessonNumber = {{ lesson_number }};
const dailyLessonId = {{ lesson.daily_lesson_id or 'null' }};

function enableCompleteButton() {
  const btn = document.getElementById('complete-btn');
  if (btn) btn.disabled = false;
}

function completeLesson(score = 100) {
  const btn = document.getElementById('complete-btn');
  btn.disabled = true;
  btn.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';

  // Use new API if daily_lesson_id exists
  const endpoint = dailyLessonId
    ? `/curriculum/api/v1/lesson/${dailyLessonId}/complete`
    : `/curriculum/api/book-courses/${courseId}/modules/${moduleId}/complete-lesson`;

  const body = dailyLessonId
    ? {}
    : { lesson_number: lessonNumber, score: score };

  const csrfMeta = document.querySelector('meta[name="csrf-token"]');
  const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

  fetch(endpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify(body)
  })
  .then(response => {
    if (response.status === 201 || response.ok) {
      // Handle empty or JSON responses
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        return response.json();
      }
      return { success: true };
    }
    throw new Error('Failed to complete lesson');
  })
  .then(data => {
    console.log('Lesson completed:', data);
    // Show success and redirect
    showResults(score);
  })
  .catch(error => {
    console.error('Error:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞');
    btn.disabled = false;
    btn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫';
  });
}

function showResults(score) {
  const content = document.querySelector('.lesson-content');
  const footer = document.querySelector('#lesson-footer');

  const emoji = score >= 90 ? 'üéâ' : score >= 70 ? 'üëç' : 'üí™';
  const message = score >= 90 ? '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!'
    : score >= 70 ? '–•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞!'
    : '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è!';

  content.innerHTML = `
    <div class="bls-results">
      <div class="bls-results__icon">${emoji}</div>
      <div class="bls-results__score">${score}%</div>
      <div class="bls-results__message">${message}</div>
      <div class="bls-results__actions">
        <a href="${document.referrer || '{% if course.slug %}{{ url_for("book_courses.view_module_by_slug", course_slug=course.slug, module_number=module.module_number) }}{% else %}{{ url_for("book_courses.view_module", course_id=course.id, module_id=module.id) }}{% endif %}'}" class="bls-btn bls-btn--primary">
          –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </a>
      </div>
    </div>
  `;

  if (footer) footer.style.display = 'none';
}

// SRS Review Section Functions
{% if review_cards and review_cards|length > 0 %}
const reviewCards = {{ review_cards | tojson | safe }};
let reviewIndex = 0;
let reviewFlipped = false;

function toggleReviewSection() {
  const content = document.getElementById('review-content');
  const toggleText = document.getElementById('review-toggle-text');

  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggleText.textContent = '–°–∫—Ä—ã—Ç—å';
    showReviewCard(0);
  } else {
    content.style.display = 'none';
    toggleText.textContent = '–ù–∞—á–∞—Ç—å';
  }
}

function showReviewCard(index) {
  if (index >= reviewCards.length) {
    // All cards reviewed
    document.getElementById('review-content').innerHTML = `
      <div class="bls-review__complete">
        ‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í—Å–µ —Å–ª–æ–≤–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω—ã.
      </div>
    `;
    return;
  }

  const card = reviewCards[index];
  reviewIndex = index;
  reviewFlipped = false;

  document.getElementById('review-front').textContent = card.front;
  document.getElementById('review-back').textContent = card.back;
  document.getElementById('review-card').classList.remove('flipped');
  document.getElementById('review-buttons').style.display = 'none';
  document.getElementById('review-current').textContent = index + 1;
}

function flipReviewCard() {
  reviewFlipped = !reviewFlipped;
  document.getElementById('review-card').classList.toggle('flipped');

  if (reviewFlipped) {
    document.getElementById('review-buttons').style.display = 'flex';
  } else {
    document.getElementById('review-buttons').style.display = 'none';
  }
}

function rateReviewCard(rating) {
  const card = reviewCards[reviewIndex];

  // Send rating to server (unified 1-2-3 scale)
  fetch('/curriculum/api/v1/srs/grade', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      card_id: card.card_id,
      rating: rating,  // Unified 1-2-3 scale
      session_key: 'lesson_review'
    })
  })
  .then(response => response.json())
  .then(result => {
    console.log('SRS grade result:', result);
    // Handle requeue if needed (rating 1 or 2)
    if (result.requeue_position !== null && result.requeue_position !== undefined) {
      const cardCopy = { ...card, isRequeue: true };
      const insertAt = Math.min(reviewIndex + result.requeue_position + 1, reviewCards.length);
      reviewCards.splice(insertAt, 0, cardCopy);
      document.getElementById('review-total').textContent = reviewCards.length;
      console.log(`Card requeued at position +${result.requeue_position}`);
    }
  })
  .catch(e => console.log('Grade API not available:', e));

  // Move to next card
  setTimeout(() => showReviewCard(reviewIndex + 1), 200);
}
{% endif %}
</script>

{% block lesson_scripts %}{% endblock %}
{% endblock %}
