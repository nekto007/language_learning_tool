{% extends "curriculum/book_courses/lessons/_lesson_base.html" %}

{% block lesson_type %}üìñ –ß—Ç–µ–Ω–∏–µ{% endblock %}

{% block lesson_content %}
<div class="lesson-intro">
  <h1>–ß—Ç–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º</h1>
  <p>–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ —Ç–µ–∫—Å—Ç. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞.</p>
</div>

<div class="reading-wrapper">
  <!-- Reading Stats -->
  <div class="reading-stats">
    <span class="stat">üìñ <span id="word-count">{{ lesson.word_count or '~200' }}</span> —Å–ª–æ–≤</span>
    <span class="stat">‚è±Ô∏è ~<span id="read-time">2</span> –º–∏–Ω.</span>
  </div>

  <!-- Scrollable Reading Content -->
  <div class="reading-scroll-container" id="reading-scroll-container">
    <div class="reading-content" id="reading-content">
      {% if use_api %}
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–∞...</p>
        </div>
      {% else %}
        <div class="passage-text">
          {{ lesson.slice_text | safe }}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Reading Progress -->
  <div class="reading-progress-section">
    <span class="progress-label">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ: <span id="progress-percent">0</span>%</span>
    <div class="reading-progress-bar">
      <div class="progress-fill" id="reading-progress" style="width: 0%"></div>
    </div>
  </div>
</div>

<!-- Word Popup Modal -->
<div class="word-popup-overlay" id="word-popup-overlay">
  <div class="word-popup" id="word-popup">
    <div class="popup-word" id="popup-word">word</div>
    <div class="popup-translation" id="popup-translation">–ø–µ—Ä–µ–≤–æ–¥</div>
    <div class="popup-example" id="popup-example"></div>

    <div class="popup-actions">
      <button class="popup-btn" id="popup-audio-btn" onclick="playAudio()" title="–û–∑–≤—É—á–∏—Ç—å">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
          <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
      </button>
      <button class="popup-btn popup-btn-primary" id="popup-add-btn" onclick="addToFlashcards()" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞—Ä—Ç–æ—á–∫–∏">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
    </div>

    <div class="popup-status" id="popup-status"></div>
  </div>
</div>

<!-- Hidden Audio Element -->
<audio id="word-audio" preload="none"></audio>
{% endblock %}

{% block lesson_footer %}
<div class="lesson-footer-buttons" id="footer-buttons">
  <button id="complete-btn" class="btn btn-primary btn-lg" onclick="completeReadingLesson()" disabled>
    –ó–∞–≤–µ—Ä—à–∏—Ç—å —á—Ç–µ–Ω–∏–µ
  </button>
</div>
{% endblock %}

{% block lesson_scripts %}
<script>
let currentWord = null;
let currentWordId = null;

function getCSRFToken() {
  const meta = document.querySelector('meta[name="csrf-token"]');
  return meta ? meta.getAttribute('content') : '';
}

{% if use_api %}
async function loadContent() {
  try {
    const response = await fetch(`/curriculum/api/v1/lesson/{{ daily_lesson.id }}`);
    const data = await response.json();

    if (data.html) {
      document.getElementById('reading-content').innerHTML = `<div class="passage-text">${data.html}</div>`;

      if (data.word_count) {
        document.getElementById('word-count').textContent = data.word_count;
        document.getElementById('read-time').textContent = Math.ceil(data.word_count / 150);
      }

      makeWordsClickable();
      initReadingProgress();
    } else if (data.error) {
      document.getElementById('reading-content').innerHTML = `<div class="error-state"><p>–û—à–∏–±–∫–∞: ${data.error}</p></div>`;
    }
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('reading-content').innerHTML = `<div class="error-state"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>`;
  }
}
document.addEventListener('DOMContentLoaded', loadContent);
{% else %}
document.addEventListener('DOMContentLoaded', () => {
  makeWordsClickable();
  initReadingProgress();
});
{% endif %}

function makeWordsClickable() {
  const content = document.querySelector('.passage-text');
  if (!content) return;

  const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT, null, false);
  const textNodes = [];
  while (walker.nextNode()) textNodes.push(walker.currentNode);

  textNodes.forEach(textNode => {
    const text = textNode.textContent;
    const parts = text.split(/(\s+|[.,!?;:'"()\[\]{}‚Äî‚Äì-]+)/);
    const fragment = document.createDocumentFragment();

    parts.forEach(part => {
      if (part.trim() && /[a-zA-Z]/.test(part)) {
        const span = document.createElement('span');
        span.className = 'clickable-word';
        span.textContent = part;
        span.onclick = (e) => handleWordClick(e, part);
        fragment.appendChild(span);
      } else {
        fragment.appendChild(document.createTextNode(part));
      }
    });

    if (textNode.parentNode) {
      textNode.parentNode.replaceChild(fragment, textNode);
    }
  });
}

async function handleWordClick(event, word) {
  event.stopPropagation();
  const cleanWord = word.replace(/[^\w'-]/g, '').toLowerCase();
  if (!cleanWord) return;

  currentWord = cleanWord;
  currentWordId = null;

  // Show popup
  document.getElementById('popup-word').textContent = cleanWord;
  document.getElementById('popup-translation').textContent = '...';
  document.getElementById('popup-example').textContent = '';
  document.getElementById('popup-example').style.display = 'none';
  document.getElementById('popup-status').textContent = '';
  document.getElementById('popup-status').className = 'popup-status';
  resetAddButton();
  document.getElementById('word-popup-overlay').classList.add('active');

  try {
    const response = await fetch('/api/translate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify({ word: cleanWord })
    });
    const data = await response.json();

    if (data.success) {
      document.getElementById('popup-translation').textContent = data.translation || '–ù–µ –Ω–∞–π–¥–µ–Ω–æ';
      if (data.word_id) currentWordId = data.word_id;
      if (data.sentences) {
        // Replace <br> with newlines and render
        const example = data.sentences.replace(/<br\s*\/?>/gi, '\n');
        document.getElementById('popup-example').textContent = example;
        document.getElementById('popup-example').style.display = 'block';
      }
    } else {
      document.getElementById('popup-translation').textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ';
    }
  } catch (error) {
    document.getElementById('popup-translation').textContent = '–û—à–∏–±–∫–∞';
  }
}

// Close popup on overlay click
document.getElementById('word-popup-overlay').addEventListener('click', (e) => {
  if (e.target.id === 'word-popup-overlay') {
    document.getElementById('word-popup-overlay').classList.remove('active');
    currentWord = null;
    currentWordId = null;
  }
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.getElementById('word-popup-overlay').classList.remove('active');
  }
});

function playAudio() {
  if (!currentWord) return;
  const audio = document.getElementById('word-audio');
  audio.src = `/static/audio/pronunciation_en_${currentWord}.mp3`;
  audio.play().catch(() => showStatus('–ù–µ—Ç –∞—É–¥–∏–æ', 'error'));
}

async function addToFlashcards() {
  if (!currentWord) return;
  const btn = document.getElementById('popup-add-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';

  try {
    if (!currentWordId) {
      const searchResp = await fetch(`/api/words/search?term=${encodeURIComponent(currentWord)}`);
      const searchData = await searchResp.json();
      if (searchData.length > 0) {
        const exact = searchData.find(w => w.english_word.toLowerCase() === currentWord);
        currentWordId = exact ? exact.id : searchData[0].id;
      }
    }

    if (!currentWordId) {
      showStatus('–°–ª–æ–≤–æ –Ω–µ –≤ —Å–ª–æ–≤–∞—Ä–µ', 'error');
      resetAddButton();
      return;
    }

    const resp = await fetch('/curriculum/api/srs/add-card', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify({ word_id: currentWordId, source: 'book_reading' })
    });
    const data = await resp.json();

    if (data.success) {
      showStatus('‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ!', 'success');
      btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg>';
    } else {
      showStatus(data.error || '–û—à–∏–±–∫–∞', 'error');
      resetAddButton();
    }
  } catch (error) {
    showStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    resetAddButton();
  }
}

function resetAddButton() {
  const btn = document.getElementById('popup-add-btn');
  btn.disabled = false;
  btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
}

function showStatus(msg, type) {
  const el = document.getElementById('popup-status');
  el.textContent = msg;
  el.className = 'popup-status ' + type;
}

function initReadingProgress() {
  const container = document.getElementById('reading-scroll-container');
  const progressBar = document.getElementById('reading-progress');
  const progressPercent = document.getElementById('progress-percent');
  const completeBtn = document.getElementById('complete-btn');
  let maxScroll = 0;

  function updateProgress(percent) {
    const rounded = Math.round(percent);
    progressBar.style.width = percent + '%';
    progressPercent.textContent = rounded;
    if (percent >= 80 && completeBtn) {
      completeBtn.disabled = false;
    }
  }

  container.addEventListener('scroll', () => {
    const scrollTop = container.scrollTop;
    const scrollHeight = container.scrollHeight - container.clientHeight;
    if (scrollHeight <= 0) return;

    const percent = Math.min((scrollTop / scrollHeight) * 100, 100);
    if (percent > maxScroll) {
      maxScroll = percent;
      updateProgress(maxScroll);
    }
  });

  // For short content
  setTimeout(() => {
    if (container.scrollHeight <= container.clientHeight * 1.1) {
      updateProgress(100);
    }
  }, 500);
}

const nextLessonUrl = {{ next_lesson_url | tojson | safe if next_lesson_url else 'null' }};
const hasNextLesson = {{ 'true' if has_next_lesson else 'false' }};
const moduleUrl = "{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}";

async function completeReadingLesson() {
  const btn = document.getElementById('complete-btn');
  btn.disabled = true;
  btn.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';

  try {
    {% if daily_lesson %}
    const response = await fetch(`/curriculum/api/v1/lesson/{{ daily_lesson.id }}/complete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() }
    });

    if (response.status === 201 || response.ok) {
      showCompletionSuccess();
    } else {
      throw new Error('Failed to save');
    }
    {% else %}
    showCompletionSuccess();
    {% endif %}
  } catch (error) {
    console.error('Error:', error);
    btn.disabled = false;
    btn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å —á—Ç–µ–Ω–∏–µ';
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
  }
}

function showCompletionSuccess() {
  const footerButtons = document.getElementById('footer-buttons');

  if (hasNextLesson && nextLessonUrl) {
    footerButtons.innerHTML = `
      <a href="${nextLessonUrl}" class="btn btn-primary btn-lg next-lesson-btn">
        –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫ ‚Üí
      </a>
    `;
  } else {
    footerButtons.innerHTML = `
      <span class="completion-message">‚úì –ß—Ç–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</span>
      <a href="${moduleUrl}" class="btn btn-primary btn-lg">
        –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–æ–¥—É–ª—é
      </a>
    `;
  }
}
</script>

<style>
.reading-wrapper {
  max-width: 750px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  max-height: calc(100vh - 350px);
  min-height: 300px;
}

/* Ensure footer is always visible */
.lesson-footer {
  position: fixed !important;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card-bg, #fff) !important;
  z-index: 100;
  display: block !important;
}

.lesson-content {
  padding-bottom: 100px; /* Space for fixed footer */
}

.reading-stats {
  display: flex;
  gap: 1.5rem;
  padding: 0.75rem 1rem;
  background: #f8f9fa;
  border-radius: 10px;
  margin-bottom: 1rem;
  flex-shrink: 0;
}

.reading-stats .stat {
  font-size: 0.875rem;
  color: #666;
}

.reading-scroll-container {
  flex: 1;
  overflow-y: auto;
  background: #fff;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.reading-content {
  padding: 2rem;
}

.passage-text {
  font-size: 1.125rem;
  line-height: 1.85;
  color: #1f2937;
  font-family: Georgia, 'Times New Roman', serif;
}

.passage-text p {
  margin-bottom: 1.25rem;
  text-indent: 1.5em;
}

.passage-text p:first-child { text-indent: 0; }
.passage-text p:last-child { margin-bottom: 0; }

.clickable-word {
  cursor: pointer;
  border-radius: 3px;
  transition: background 0.15s, color 0.15s;
}

.clickable-word:hover {
  background: rgba(99, 102, 241, 0.15);
  color: #4f46e5;
}

.reading-progress-section {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-top: 1rem;
  flex-shrink: 0;
}

.progress-label {
  font-size: 0.875rem;
  color: #6b7280;
  white-space: nowrap;
  min-width: 100px;
}

.reading-progress-bar {
  flex: 1;
  height: 6px;
  background: #e5e7eb;
  border-radius: 10px;
  overflow: hidden;
}

.reading-progress-bar .progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #6366f1, #8b5cf6);
  transition: width 0.3s;
}

/* Popup */
.word-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s;
}

.word-popup-overlay.active {
  opacity: 1;
  visibility: visible;
}

.word-popup {
  background: #fff;
  border-radius: 16px;
  padding: 1.5rem;
  width: 280px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.25);
  transform: scale(0.9);
  transition: transform 0.2s;
  text-align: center;
}

.word-popup-overlay.active .word-popup {
  transform: scale(1);
}

.popup-word {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1f2937;
  margin-bottom: 0.5rem;
}

.popup-translation {
  font-size: 1.125rem;
  font-weight: 600;
  color: #4f46e5;
  margin-bottom: 0.75rem;
}

.popup-example {
  font-size: 0.875rem;
  color: #6b7280;
  font-style: italic;
  margin-bottom: 1rem;
  line-height: 1.5;
  white-space: pre-wrap;
  display: none;
}

.popup-actions {
  display: flex;
  justify-content: center;
  gap: 1rem;
}

.popup-btn {
  width: 48px;
  height: 48px;
  border: none;
  border-radius: 50%;
  background: #f3f4f6;
  color: #374151;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.popup-btn:hover {
  background: #e5e7eb;
  transform: scale(1.05);
}

.popup-btn-primary {
  background: #6366f1;
  color: #fff;
}

.popup-btn-primary:hover {
  background: #4f46e5;
}

.popup-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.popup-status {
  font-size: 0.8rem;
  margin-top: 0.75rem;
  min-height: 1rem;
}

.popup-status.success { color: #10b981; }
.popup-status.error { color: #ef4444; }

.spinner {
  width: 18px;
  height: 18px;
  border: 2px solid #fff;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading {
  text-align: center;
  padding: 3rem;
  color: #6b7280;
}

.loading-spinner {
  width: 36px;
  height: 36px;
  border: 3px solid #e5e7eb;
  border-top-color: #6366f1;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 1rem;
}

.error-state {
  text-align: center;
  padding: 2rem;
  color: #ef4444;
}

.lesson-footer-buttons {
  display: flex;
  justify-content: center;
  gap: 1rem;
}

.lesson-footer-buttons .btn {
  min-width: 200px;
}

/* Explicit button styling */
#complete-btn {
  background: #6366f1 !important;
  color: #fff !important;
  border: none !important;
  padding: 1rem 2rem;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

#complete-btn:disabled {
  background: #9ca3af !important;
  cursor: not-allowed;
  opacity: 0.7;
}

#complete-btn:not(:disabled):hover {
  background: #4f46e5 !important;
  transform: translateY(-1px);
}

.lesson-footer-buttons .btn-primary {
  background: #6366f1 !important;
  color: #fff !important;
}

.completion-message {
  display: block;
  font-size: 1.25rem;
  font-weight: 600;
  color: #10b981;
  margin-bottom: 1rem;
}

.next-lesson-btn {
  background: #10b981 !important;
}

.next-lesson-btn:hover {
  background: #059669 !important;
}

@media (max-width: 768px) {
  .reading-wrapper {
    height: calc(100vh - 200px);
  }
  .reading-content {
    padding: 1.25rem;
  }
  .passage-text {
    font-size: 1rem;
  }
}
</style>
{% endblock %}
