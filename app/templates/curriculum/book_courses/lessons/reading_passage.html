{% extends "curriculum/book_courses/lessons/_lesson_base.html" %}

{% block lesson_type %}üìñ –ß—Ç–µ–Ω–∏–µ{% endblock %}

{% block lesson_content %}
<div class="lesson-intro">
  <h1>–ß—Ç–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º</h1>
  <p>–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ —Ç–µ–∫—Å—Ç. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞.</p>
</div>

<div class="reading-wrapper">
  <!-- Reading Stats -->
  <div class="reading-stats">
    <span class="stat">üìñ <span id="word-count">{{ lesson.word_count or '~200' }}</span> —Å–ª–æ–≤</span>
    <span class="stat">‚è±Ô∏è ~<span id="read-time">2</span> –º–∏–Ω.</span>
  </div>

  <!-- Audio Player Section -->
  <div class="audio-player-section" id="audio-player-section" style="display: none;">
    <div class="audio-player-container">
      <div class="audio-player-header">
        <span class="audio-icon">üéß</span>
        <span class="audio-title">–ê—É–¥–∏–æ–∫–Ω–∏–≥–∞</span>
      </div>

      <audio id="lesson-audio-player" controls preload="metadata" class="audio-player">
        <source id="audio-source" src="" type="audio/mpeg">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
      </audio>

      <div class="audio-controls">
        <button id="audio-rewind" class="audio-btn" title="–ù–∞–∑–∞–¥ 10—Å">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 4v6h6M23 20v-6h-6"/>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
          </svg>
          <span class="rewind-text">-10s</span>
        </button>

        <button id="audio-speed" class="audio-btn audio-speed-btn" title="–°–∫–æ—Ä–æ—Å—Ç—å">
          <span class="speed-text">1x</span>
        </button>

        <button id="audio-forward" class="audio-btn" title="–í–ø–µ—Ä–µ–¥ 10—Å">
          <span class="forward-text">+10s</span>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6M1 20v-6h6"/>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
          </svg>
        </button>
      </div>

      <div class="audio-progress-bar" id="audio-progress-bar">
        <div class="audio-progress-fill" id="audio-progress-fill"></div>
        <div class="audio-progress-handle" id="audio-progress-handle"></div>
      </div>

      <div class="audio-time-display">
        <span id="audio-current-time">0:00</span>
        <span class="audio-time-separator">/</span>
        <span id="audio-duration">0:00</span>
      </div>
    </div>
  </div>

  <!-- Scrollable Reading Content -->
  <div class="reading-scroll-container" id="reading-scroll-container">
    <div class="reading-content" id="reading-content">
      {% if use_api %}
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–∞...</p>
        </div>
      {% else %}
        <div class="passage-text">
          {{ lesson.slice_text | safe }}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Comprehension Questions (if available) -->
  {% if comprehension_questions and comprehension_questions|length > 0 %}
  <div class="comprehension-section" id="comprehension-section" style="display: none;">
    <h3 class="comprehension-title">üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–Ω–∏–º–∞–Ω–∏—è</h3>
    <div class="comprehension-questions">
      {% for q in comprehension_questions %}
      <div class="question-item" data-question-id="{{ loop.index }}">
        <p class="question-text">{{ loop.index }}. {{ q.question }}</p>
        <div class="question-options">
          {% for opt in q.options %}
          <label class="option-label">
            <input type="radio" name="q{{ loop.index }}" value="{{ opt }}"
                   data-correct="{{ 'true' if opt == q.correct_answer else 'false' }}">
            <span class="option-text">{{ opt }}</span>
          </label>
          {% endfor %}
        </div>
        <div class="question-feedback" id="feedback-{{ loop.index }}"></div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Reading Progress -->
  <div class="reading-progress-section">
    <span class="progress-label">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ: <span id="progress-percent">0</span>%</span>
    <div class="reading-progress-bar">
      <div class="progress-fill" id="reading-progress" style="width: 0%"></div>
    </div>
  </div>
</div>

<!-- Word Popup Modal -->
<div class="word-popup-overlay" id="word-popup-overlay">
  <div class="word-popup" id="word-popup">
    <div class="popup-word" id="popup-word">word</div>
    <div class="popup-translation" id="popup-translation">–ø–µ—Ä–µ–≤–æ–¥</div>
    <div class="popup-example" id="popup-example"></div>

    <div class="popup-actions">
      <button class="popup-btn" id="popup-audio-btn" onclick="playAudio()" title="–û–∑–≤—É—á–∏—Ç—å">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
          <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
      </button>
      <button class="popup-btn popup-btn-primary" id="popup-add-btn" onclick="addToFlashcards()" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞—Ä—Ç–æ—á–∫–∏">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
    </div>

    <div class="popup-status" id="popup-status"></div>
  </div>
</div>

<!-- Hidden Audio Element -->
<audio id="word-audio" preload="none"></audio>
{% endblock %}

{% block lesson_footer %}
<div class="lesson-footer-buttons" id="footer-buttons">
  <button id="complete-btn" class="btn btn-primary btn-lg" onclick="completeReadingLesson()" disabled>
    –ó–∞–≤–µ—Ä—à–∏—Ç—å —á—Ç–µ–Ω–∏–µ
  </button>
</div>
{% endblock %}

{% block lesson_scripts %}
<script>
let currentWord = null;
let currentWordId = null;
// courseId already defined in _lesson_base.html

function getCSRFToken() {
  const meta = document.querySelector('meta[name="csrf-token"]');
  return meta ? meta.getAttribute('content') : '';
}

{% if use_api %}
async function loadContent() {
  try {
    const response = await fetch(`/curriculum/api/v1/lesson/{{ daily_lesson.id }}`);
    const data = await response.json();

    if (data.html) {
      document.getElementById('reading-content').innerHTML = `<div class="passage-text">${data.html}</div>`;

      if (data.word_count) {
        document.getElementById('word-count').textContent = data.word_count;
        document.getElementById('read-time').textContent = Math.ceil(data.word_count / 150);
      }

      // Initialize audio player if audio available
      if (data.audio_url) {
        initAudioPlayer(data.audio_url);
      }

      makeWordsClickable();
      initReadingProgress();
    } else if (data.error) {
      document.getElementById('reading-content').innerHTML = `<div class="error-state"><p>–û—à–∏–±–∫–∞: ${data.error}</p></div>`;
    }
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('reading-content').innerHTML = `<div class="error-state"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>`;
  }
}
document.addEventListener('DOMContentLoaded', loadContent);
{% else %}
document.addEventListener('DOMContentLoaded', () => {
  makeWordsClickable();
  initReadingProgress();
});
{% endif %}

function makeWordsClickable() {
  const content = document.querySelector('.passage-text');
  if (!content) return;

  const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT, null, false);
  const textNodes = [];
  while (walker.nextNode()) textNodes.push(walker.currentNode);

  textNodes.forEach(textNode => {
    const text = textNode.textContent;
    const parts = text.split(/(\s+|[.,!?;:'"()\[\]{}‚Äî‚Äì-]+)/);
    const fragment = document.createDocumentFragment();

    parts.forEach(part => {
      if (part.trim() && /[a-zA-Z]/.test(part)) {
        const span = document.createElement('span');
        span.className = 'clickable-word';
        span.textContent = part;
        span.onclick = (e) => handleWordClick(e, part);
        fragment.appendChild(span);
      } else {
        fragment.appendChild(document.createTextNode(part));
      }
    });

    if (textNode.parentNode) {
      textNode.parentNode.replaceChild(fragment, textNode);
    }
  });
}

async function handleWordClick(event, word) {
  event.stopPropagation();
  const cleanWord = word.replace(/[^\w'-]/g, '').toLowerCase();
  if (!cleanWord) return;

  currentWord = cleanWord;
  currentWordId = null;

  // Show popup
  document.getElementById('popup-word').textContent = cleanWord;
  document.getElementById('popup-translation').textContent = '...';
  document.getElementById('popup-example').textContent = '';
  document.getElementById('popup-example').style.display = 'none';
  document.getElementById('popup-status').textContent = '';
  document.getElementById('popup-status').className = 'popup-status';
  resetAddButton();
  document.getElementById('word-popup-overlay').classList.add('active');

  try {
    const response = await fetch('/api/translate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify({ word: cleanWord })
    });
    const data = await response.json();

    if (data.success) {
      document.getElementById('popup-translation').textContent = data.translation || '–ù–µ –Ω–∞–π–¥–µ–Ω–æ';
      if (data.word_id) currentWordId = data.word_id;
      if (data.sentences) {
        // Replace <br> with newlines and render
        const example = data.sentences.replace(/<br\s*\/?>/gi, '\n');
        document.getElementById('popup-example').textContent = example;
        document.getElementById('popup-example').style.display = 'block';
      }
    } else {
      document.getElementById('popup-translation').textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ';
    }
  } catch (error) {
    document.getElementById('popup-translation').textContent = '–û—à–∏–±–∫–∞';
  }
}

// Close popup on overlay click
document.getElementById('word-popup-overlay').addEventListener('click', (e) => {
  if (e.target.id === 'word-popup-overlay') {
    document.getElementById('word-popup-overlay').classList.remove('active');
    currentWord = null;
    currentWordId = null;
  }
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.getElementById('word-popup-overlay').classList.remove('active');
  }
});

function playAudio() {
  if (!currentWord) return;
  const audio = document.getElementById('word-audio');
  audio.src = `/static/audio/pronunciation_en_${currentWord}.mp3`;
  audio.play().catch(() => showStatus('–ù–µ—Ç –∞—É–¥–∏–æ', 'error'));
}

async function addToFlashcards() {
  if (!currentWord) return;
  const btn = document.getElementById('popup-add-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';

  try {
    if (!currentWordId) {
      const searchResp = await fetch(`/api/words/search?term=${encodeURIComponent(currentWord)}`);
      const searchData = await searchResp.json();
      if (searchData.length > 0) {
        const exact = searchData.find(w => w.english_word.toLowerCase() === currentWord);
        currentWordId = exact ? exact.id : searchData[0].id;
      }
    }

    if (!currentWordId) {
      showStatus('–°–ª–æ–≤–æ –Ω–µ –≤ —Å–ª–æ–≤–∞—Ä–µ', 'error');
      resetAddButton();
      return;
    }

    const resp = await fetch('/curriculum/api/srs/add-card', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify({
        word_id: currentWordId,
        source: 'book_reading',
        course_id: courseId
      })
    });
    const data = await resp.json();

    // Handle word_status from response
    if (data.word_status === 'learned') {
      showStatus('‚úì –£–∂–µ –≤—ã—É—á–µ–Ω–æ', 'success');
      btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg>';
      btn.classList.add('learned');
    } else if (data.word_status === 'in_learning') {
      showStatus('üìö –í –æ–±—É—á–µ–Ω–∏–∏', 'success');
      btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg>';
    } else if (data.success) {
      showStatus('‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ!', 'success');
      btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg>';
    } else {
      showStatus(data.error || '–û—à–∏–±–∫–∞', 'error');
      resetAddButton();
    }
  } catch (error) {
    showStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    resetAddButton();
  }
}

function resetAddButton() {
  const btn = document.getElementById('popup-add-btn');
  btn.disabled = false;
  btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
}

function showStatus(msg, type) {
  const el = document.getElementById('popup-status');
  el.textContent = msg;
  el.className = 'popup-status ' + type;
}

function initReadingProgress() {
  const container = document.getElementById('reading-scroll-container');
  const progressBar = document.getElementById('reading-progress');
  const progressPercent = document.getElementById('progress-percent');
  const completeBtn = document.getElementById('complete-btn');
  const comprehensionSection = document.getElementById('comprehension-section');
  let maxScroll = 0;
  let comprehensionShown = false;

  function updateProgress(percent) {
    const rounded = Math.round(percent);
    progressBar.style.width = percent + '%';
    progressPercent.textContent = rounded;

    // Show comprehension questions at 80%
    if (percent >= 80 && comprehensionSection && !comprehensionShown) {
      comprehensionSection.style.display = 'block';
      comprehensionShown = true;
      initComprehensionQuestions();
    }

    // Enable complete button at 80%
    if (percent >= 80 && completeBtn) {
      completeBtn.disabled = false;
    }
  }

  container.addEventListener('scroll', () => {
    const scrollTop = container.scrollTop;
    const scrollHeight = container.scrollHeight - container.clientHeight;
    if (scrollHeight <= 0) return;

    const percent = Math.min((scrollTop / scrollHeight) * 100, 100);
    if (percent > maxScroll) {
      maxScroll = percent;
      updateProgress(maxScroll);
    }
  });

  // For short content
  setTimeout(() => {
    if (container.scrollHeight <= container.clientHeight * 1.1) {
      updateProgress(100);
    }
  }, 500);
}

function initComprehensionQuestions() {
  const options = document.querySelectorAll('.option-label input');
  options.forEach(input => {
    input.addEventListener('change', function() {
      const questionItem = this.closest('.question-item');
      const questionId = questionItem.dataset.questionId;
      const allOptions = questionItem.querySelectorAll('.option-label');
      const feedback = document.getElementById('feedback-' + questionId);
      const isCorrect = this.dataset.correct === 'true';

      // Reset all options
      allOptions.forEach(opt => {
        opt.classList.remove('correct', 'incorrect');
      });

      // Mark selected
      const selectedLabel = this.closest('.option-label');
      if (isCorrect) {
        selectedLabel.classList.add('correct');
        feedback.textContent = '‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
        feedback.className = 'question-feedback correct';
      } else {
        selectedLabel.classList.add('incorrect');
        feedback.textContent = '‚úó –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑';
        feedback.className = 'question-feedback incorrect';
        // Show correct answer after delay
        setTimeout(() => {
          allOptions.forEach(opt => {
            if (opt.querySelector('input').dataset.correct === 'true') {
              opt.classList.add('correct');
            }
          });
        }, 1000);
      }
    });
  });
}

const nextLessonUrl = {{ next_lesson_url | tojson | safe if next_lesson_url else 'null' }};
const hasNextLesson = {{ 'true' if has_next_lesson else 'false' }};
const moduleUrl = "{% if course.slug %}{{ url_for('book_courses.view_module_by_slug', course_slug=course.slug, module_number=module.module_number) }}{% else %}{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}{% endif %}";

async function completeReadingLesson() {
  const btn = document.getElementById('complete-btn');
  btn.disabled = true;
  btn.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';

  try {
    {% if daily_lesson %}
    const response = await fetch(`/curriculum/api/v1/lesson/{{ daily_lesson.id }}/complete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() }
    });

    if (response.status === 201 || response.ok) {
      showCompletionSuccess();
    } else {
      throw new Error('Failed to save');
    }
    {% else %}
    showCompletionSuccess();
    {% endif %}
  } catch (error) {
    console.error('Error:', error);
    btn.disabled = false;
    btn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å —á—Ç–µ–Ω–∏–µ';
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
  }
}

function showCompletionSuccess() {
  const footerButtons = document.getElementById('footer-buttons');

  if (hasNextLesson && nextLessonUrl) {
    footerButtons.innerHTML = `
      <a href="${nextLessonUrl}" class="btn btn-primary btn-lg next-lesson-btn">
        –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫ ‚Üí
      </a>
    `;
  } else {
    footerButtons.innerHTML = `
      <span class="completion-message">‚úì –ß—Ç–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</span>
      <a href="${moduleUrl}" class="btn btn-primary btn-lg">
        –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–æ–¥—É–ª—é
      </a>
    `;
  }
}

// ==================== Audio Player ====================

let currentSpeed = 1.0;
const speeds = [0.75, 1.0, 1.25, 1.5, 1.75, 2.0];
let speedIndex = 1;

function initAudioPlayer(audioUrl) {
  const audioSection = document.getElementById('audio-player-section');
  const audioPlayer = document.getElementById('lesson-audio-player');
  const audioSource = document.getElementById('audio-source');

  if (!audioUrl || !audioPlayer) return;

  // Prepend /static/ if not already present
  const fullAudioUrl = audioUrl.startsWith('/') ? audioUrl : '/static/' + audioUrl;
  audioSource.src = fullAudioUrl;
  audioPlayer.load();
  audioSection.style.display = 'block';

  audioPlayer.addEventListener('loadedmetadata', updateAudioDuration);
  audioPlayer.addEventListener('timeupdate', updateAudioProgress);

  document.getElementById('audio-rewind').addEventListener('click', () => rewindAudio(10));
  document.getElementById('audio-forward').addEventListener('click', () => forwardAudio(10));
  document.getElementById('audio-speed').addEventListener('click', cycleSpeed);
  document.getElementById('audio-progress-bar').addEventListener('click', seekAudio);
}

function updateAudioDuration() {
  const player = document.getElementById('lesson-audio-player');
  const durationEl = document.getElementById('audio-duration');
  if (player && player.duration) {
    durationEl.textContent = formatTime(player.duration);
  }
}

function updateAudioProgress() {
  const player = document.getElementById('lesson-audio-player');
  const currentTimeEl = document.getElementById('audio-current-time');
  const progressFill = document.getElementById('audio-progress-fill');
  const progressHandle = document.getElementById('audio-progress-handle');

  if (!player || !player.duration) return;

  const percent = (player.currentTime / player.duration) * 100;
  currentTimeEl.textContent = formatTime(player.currentTime);
  progressFill.style.width = percent + '%';
  progressHandle.style.left = percent + '%';
}

function rewindAudio(seconds) {
  const player = document.getElementById('lesson-audio-player');
  if (player) player.currentTime = Math.max(0, player.currentTime - seconds);
}

function forwardAudio(seconds) {
  const player = document.getElementById('lesson-audio-player');
  if (player && player.duration) {
    player.currentTime = Math.min(player.duration, player.currentTime + seconds);
  }
}

function cycleSpeed() {
  const player = document.getElementById('lesson-audio-player');
  const speedText = document.querySelector('.speed-text');

  speedIndex = (speedIndex + 1) % speeds.length;
  currentSpeed = speeds[speedIndex];

  if (player) player.playbackRate = currentSpeed;
  speedText.textContent = currentSpeed + 'x';
}

function seekAudio(e) {
  const progressBar = document.getElementById('audio-progress-bar');
  const player = document.getElementById('lesson-audio-player');

  if (!player || !player.duration) return;

  const rect = progressBar.getBoundingClientRect();
  const percent = (e.clientX - rect.left) / rect.width;
  player.currentTime = percent * player.duration;
}

function formatTime(seconds) {
  if (!seconds || isNaN(seconds)) return '0:00';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}
</script>

<style>
.reading-wrapper {
  max-width: 750px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  height: calc(100vh - 200px);
  min-height: 400px;
}


.reading-stats {
  display: flex;
  gap: 1.5rem;
  padding: 0.75rem 1rem;
  background: var(--bg-secondary);
  border-radius: 10px;
  margin-bottom: 1rem;
}

.reading-stats .stat {
  font-size: 0.875rem;
  color: #666;
}

.reading-scroll-container {
  flex: 1;
  overflow-y: auto;
  background: var(--bg-primary);
  border-radius: 16px;
  border: 1px solid var(--border-light);
  box-shadow: var(--shadow-sm);
}

.reading-content {
  padding: 2rem;
}

.passage-text {
  font-size: 1.125rem;
  line-height: 1.85;
  color: var(--text-primary);
  font-family: Georgia, 'Times New Roman', serif;
}

.passage-text p {
  margin-bottom: 1.25rem;
  text-indent: 1.5em;
}

.passage-text p:first-child { text-indent: 0; }
.passage-text p:last-child { margin-bottom: 0; }

.clickable-word {
  cursor: pointer;
  border-radius: 3px;
  transition: background 0.15s, color 0.15s;
}

.clickable-word:hover {
  background: rgba(99, 102, 241, 0.15);
  color: var(--primary-600);
}

.reading-progress-section {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-top: 1rem;
  margin-bottom: 1rem;
}

.progress-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  white-space: nowrap;
  min-width: 100px;
}

.reading-progress-bar {
  flex: 1;
  height: 6px;
  background: var(--gray-200);
  border-radius: 10px;
  overflow: hidden;
}

.reading-progress-bar .progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-500), var(--primary-400));
  transition: width 0.3s;
}

/* Popup */
.word-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s;
}

.word-popup-overlay.active {
  opacity: 1;
  visibility: visible;
}

.word-popup {
  background: var(--bg-primary);
  border-radius: 16px;
  padding: 1.5rem;
  width: 280px;
  box-shadow: var(--shadow-2xl);
  transform: scale(0.9);
  transition: transform 0.2s;
  text-align: center;
}

.word-popup-overlay.active .word-popup {
  transform: scale(1);
}

.popup-word {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
}

.popup-translation {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--primary-600);
  margin-bottom: 0.75rem;
}

.popup-example {
  font-size: 0.875rem;
  color: var(--text-secondary);
  font-style: italic;
  margin-bottom: 1rem;
  line-height: 1.5;
  white-space: pre-wrap;
  display: none;
}

.popup-actions {
  display: flex;
  justify-content: center;
  gap: 1rem;
}

.popup-btn {
  width: 48px;
  height: 48px;
  border: none;
  border-radius: 50%;
  background: var(--gray-100);
  color: var(--gray-700);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.popup-btn:hover {
  background: var(--gray-200);
  transform: scale(1.05);
}

.popup-btn-primary {
  background: var(--primary-500);
  color: var(--text-inverse);
}

.popup-btn-primary:hover {
  background: var(--primary-600);
}

.popup-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.popup-btn.learned {
  background: var(--success-500);
  color: var(--text-inverse);
}

.popup-status {
  font-size: 0.8rem;
  margin-top: 0.75rem;
  min-height: 1rem;
}

.popup-status.success { color: var(--success-500); }
.popup-status.error { color: var(--danger-500); }

.spinner {
  width: 18px;
  height: 18px;
  border: 2px solid #fff;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}

/* spin animation moved to design-system.css */

.loading {
  text-align: center;
  padding: 3rem;
  color: var(--text-secondary);
}

.loading-spinner {
  width: 36px;
  height: 36px;
  border: 3px solid var(--gray-200);
  border-top-color: var(--primary-500);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 1rem;
}

.error-state {
  text-align: center;
  padding: 2rem;
  color: var(--danger-500);
}

.lesson-footer-buttons {
  display: flex;
  justify-content: center;
  gap: 1rem;
}

.lesson-footer-buttons .btn {
  min-width: 200px;
}

/* Explicit button styling */
#complete-btn {
  background: var(--primary-500);
  color: var(--text-inverse);
  border: none;
  padding: 1rem 2rem;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

#complete-btn:disabled {
  background: var(--gray-400);
  cursor: not-allowed;
  opacity: 0.7;
}

#complete-btn:not(:disabled):hover {
  background: var(--primary-600);
  transform: translateY(-1px);
}

.lesson-footer-buttons .btn-primary {
  background: var(--primary-500);
  color: var(--text-inverse);
}

.completion-message {
  display: block;
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--success-500);
  margin-bottom: 1rem;
}

.next-lesson-btn {
  background: var(--success-500);
}

.next-lesson-btn:hover {
  background: var(--success-600);
}

/* Comprehension Section */
.comprehension-section {
  margin-top: 2rem;
  padding: 1.5rem;
  background: var(--bg-secondary);
  border-radius: 16px;
  border: 1px solid var(--border-light);
}

.comprehension-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 1.25rem;
}

.question-item {
  padding: 1rem;
  background: #fff;
  border-radius: 12px;
  margin-bottom: 1rem;
  border: 1px solid #e5e7eb;
}

.question-item:last-child {
  margin-bottom: 0;
}

.question-text {
  font-weight: 500;
  color: #374151;
  margin-bottom: 0.75rem;
}

.question-options {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.option-label {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  background: #f9fafb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.option-label:hover {
  background: #f3f4f6;
}

.option-label input {
  accent-color: #6366f1;
}

.option-label.correct {
  background: #dcfce7;
  border-color: #22c55e;
}

.option-label.incorrect {
  background: #fee2e2;
  border-color: #ef4444;
}

.question-feedback {
  margin-top: 0.5rem;
  font-size: 0.875rem;
  min-height: 1.25rem;
}

.question-feedback.correct {
  color: #16a34a;
}

.question-feedback.incorrect {
  color: #dc2626;
}

@media (max-width: 768px) {
  .reading-wrapper {
    height: calc(100vh - 200px);
  }
  .reading-content {
    padding: 1.25rem;
  }
  .passage-text {
    font-size: 1rem;
  }
}

/* ==================== Audio Player ==================== */

.audio-player-section {
  margin-top: 1.5rem;
  margin-bottom: 1.5rem;
}

.audio-player-container {
  background: var(--bg-secondary);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 1.5rem;
  box-shadow: var(--shadow-sm);
}

.audio-player-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  font-weight: 600;
  color: var(--text-primary);
}

.audio-icon {
  font-size: 1.25rem;
}

.audio-player {
  width: 100%;
  height: 48px;
  margin-bottom: 1rem;
  border-radius: 8px;
}

.audio-controls {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.audio-btn {
  display: flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.5rem 1rem;
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  color: var(--text-secondary);
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.audio-btn:hover {
  background: var(--gray-100);
  border-color: var(--gray-300);
  color: var(--text-primary);
}

.audio-btn:active {
  transform: scale(0.95);
}

.audio-speed-btn {
  min-width: 60px;
  justify-content: center;
}

.audio-progress-bar {
  position: relative;
  width: 100%;
  height: 8px;
  background: var(--gray-200);
  border-radius: 10px;
  cursor: pointer;
  margin-bottom: 0.75rem;
}

.audio-progress-fill {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  background: linear-gradient(90deg, var(--primary-500), var(--primary-400));
  border-radius: 10px;
  transition: width 0.1s linear;
}

.audio-progress-handle {
  position: absolute;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 16px;
  height: 16px;
  background: var(--primary-600);
  border: 2px solid var(--bg-primary);
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: left 0.1s linear;
}

.audio-time-display {
  display: flex;
  justify-content: space-between;
  font-size: 0.8125rem;
  color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}

@media (max-width: 768px) {
  .audio-controls {
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .audio-btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
  }

  .audio-btn svg {
    width: 16px;
    height: 16px;
  }
}
</style>
{% endblock %}
