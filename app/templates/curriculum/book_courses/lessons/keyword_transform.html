{% extends "curriculum/book_courses/lessons/_lesson_base.html" %}

{% block lesson_type %}üîÑ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏{% endblock %}

{% block lesson_content %}
<div class="lesson-intro">
  <h1>–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–æ–º</h1>
  <p>–ü–µ—Ä–µ–ø–∏—à–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ</p>
</div>

<div class="lesson-instructions">
  <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –ó–∞–≤–µ—Ä—à–∏—Ç–µ –≤—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–æ –∏–º–µ–ª–æ —Ç–æ—Ç –∂–µ —Å–º—ã—Å–ª,
  —á—Ç–æ –∏ –ø–µ—Ä–≤–æ–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–∞–Ω–Ω–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç 2 –¥–æ 5 —Å–ª–æ–≤, –≤–∫–ª—é—á–∞—è –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ.
</div>

<div class="transform-container" id="transform-container">
  <!-- Will be populated -->
</div>

<div class="transform-summary" id="summary" style="display: none;">
  <div class="summary-score">
    <span id="correct-count">0</span> / <span id="total-count">6</span> –ø—Ä–∞–≤–∏–ª—å–Ω–æ
  </div>
</div>
{% endblock %}

{% block lesson_footer %}
<div class="lesson-footer-actions">
  <a href="{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}" class="btn-footer btn-secondary">
    <i class="fas fa-arrow-left"></i> –ö —É—Ä–æ–∫–∞–º
  </a>
  <button id="check-btn" class="btn-footer btn-primary" onclick="checkAnswers()">
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
  </button>
  <button id="complete-btn" class="btn-footer btn-primary" onclick="finishLesson()" style="display: none;">
    {% if has_next_lesson %}–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i>{% else %}–ó–∞–≤–µ—Ä—à–∏—Ç—å <i class="fas fa-check"></i>{% endif %}
  </button>
</div>
{% endblock %}

{% block lesson_scripts %}
<script>
// Transformation data
const transformData = [
  {
    id: 1,
    original: "I started learning English three years ago.",
    keyword: "BEEN",
    target: "I ____________ English for three years.",
    answers: ["have been learning", "have been studying"],
    hint: "–ù–∞—Å—Ç–æ—è—â–µ–µ —Å–æ–≤–µ—Ä—à—ë–Ω–Ω–æ–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ"
  },
  {
    id: 2,
    original: "\"I will call you tomorrow,\" she said.",
    keyword: "WOULD",
    target: "She said she ____________ the next day.",
    answers: ["would call me", "would call him", "would call her"],
    hint: "–ö–æ—Å–≤–µ–Ω–Ω–∞—è —Ä–µ—á—å"
  },
  {
    id: 3,
    original: "It's possible that he forgot about the meeting.",
    keyword: "MAY",
    target: "He ____________ about the meeting.",
    answers: ["may have forgotten", "might have forgotten"],
    hint: "–ú–æ–¥–∞–ª—å–Ω—ã–π –≥–ª–∞–≥–æ–ª + –ø–µ—Ä—Ñ–µ–∫—Ç–Ω—ã–π –∏–Ω—Ñ–∏–Ω–∏—Ç–∏–≤"
  },
  {
    id: 4,
    original: "I regret not accepting the job offer.",
    keyword: "WISH",
    target: "I ____________ the job offer.",
    answers: ["wish i had accepted", "wish i'd accepted"],
    hint: "Wish + Past Perfect"
  },
  {
    id: 5,
    original: "The last time I saw her was in December.",
    keyword: "SINCE",
    target: "I ____________ December.",
    answers: ["haven't seen her since", "have not seen her since"],
    hint: "Present Perfect + since"
  },
  {
    id: 6,
    original: "It wasn't necessary for you to wait.",
    keyword: "NEED",
    target: "You ____________ waited.",
    answers: ["needn't have", "didn't need to have", "need not have"],
    hint: "Needn't have + –ø—Ä–∏—á–∞—Å—Ç–∏–µ"
  }
];

let userAnswers = {};
let isChecked = false;

// localStorage key –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
const lessonId = {{ daily_lesson.id if daily_lesson else 0 }};
const storageKey = `transform_progress_${lessonId}`;

function init() {
  loadProgress();
  renderItems();
}

function saveProgress() {
  if (lessonId && !isChecked) {
    localStorage.setItem(storageKey, JSON.stringify({
      userAnswers: userAnswers,
      timestamp: Date.now()
    }));
  }
}

function loadProgress() {
  if (!lessonId) return;

  try {
    const saved = localStorage.getItem(storageKey);
    if (saved) {
      const data = JSON.parse(saved);
      if (data.timestamp && (Date.now() - data.timestamp) < 24 * 60 * 60 * 1000) {
        userAnswers = data.userAnswers || {};
      } else {
        clearProgress();
      }
    }
  } catch (e) {
    console.error('Error loading progress:', e);
  }
}

function clearProgress() {
  localStorage.removeItem(storageKey);
}

function renderItems() {
  const container = document.getElementById('transform-container');
  container.innerHTML = transformData.map(item => {
    const parts = item.target.split('____________');
    return `
      <div class="transform-item" id="item-${item.id}">
        <div class="item-number">${item.id}</div>
        <div class="item-content">
          <div class="original-sentence">
            <span class="sentence-label">–û—Ä–∏–≥–∏–Ω–∞–ª:</span>
            ${item.original}
          </div>
          <div class="keyword-badge">${item.keyword}</div>
          <div class="target-sentence">
            <span class="sentence-label">–ü–µ—Ä–µ–ø–∏—à–∏—Ç–µ:</span>
            ${parts[0]}<input type="text"
                              class="transform-input"
                              id="input-${item.id}"
                              data-id="${item.id}"
                              oninput="onInputChange(${item.id})"
                              autocomplete="off"
                              placeholder="2-5 —Å–ª–æ–≤">${parts[1]}
          </div>
        </div>
      </div>
    `;
  }).join('');

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
  Object.keys(userAnswers).forEach(itemId => {
    const input = document.getElementById(`input-${itemId}`);
    if (input && userAnswers[itemId]) {
      input.value = userAnswers[itemId];
    }
  });
}

function onInputChange(itemId) {
  const input = document.getElementById(`input-${itemId}`);
  userAnswers[itemId] = input.value.trim().toLowerCase();
  saveProgress();
}

function normalizeAnswer(answer) {
  return answer.toLowerCase()
    .replace(/['']/g, "'")
    .replace(/\s+/g, ' ')
    .trim();
}

function checkAnswers() {
  if (isChecked) return;
  isChecked = true;

  let correctCount = 0;

  transformData.forEach(item => {
    const input = document.getElementById(`input-${item.id}`);
    const userAnswer = normalizeAnswer(userAnswers[item.id] || '');
    const isCorrect = item.answers.some(ans => normalizeAnswer(ans) === userAnswer);

    input.disabled = true;
    input.classList.add(isCorrect ? 'correct' : 'incorrect');

    if (isCorrect) {
      correctCount++;
    } else {
      // Show correct answer
      const itemEl = document.getElementById(`item-${item.id}`);
      const correction = document.createElement('div');
      correction.className = 'correction';
      correction.innerHTML = `<span class="correction-label">–í–æ–∑–º–æ–∂–Ω—ã–π –æ—Ç–≤–µ—Ç:</span> ${item.answers[0]}`;
      itemEl.querySelector('.item-content').appendChild(correction);
    }
  });

  // Show summary
  document.getElementById('correct-count').textContent = correctCount;
  document.getElementById('total-count').textContent = transformData.length;
  document.getElementById('summary').style.display = 'block';

  // Calculate score
  window.finalScore = Math.round((correctCount / transformData.length) * 100);

  // Show complete button
  document.getElementById('check-btn').style.display = 'none';
  document.getElementById('complete-btn').style.display = 'inline-block';
}

const nextLessonUrl = {{ next_lesson_url | tojson | safe if next_lesson_url else 'null' }};
const hasNextLesson = {{ 'true' if has_next_lesson else 'false' }};
const moduleUrl = "{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}";

async function finishLesson() {
  const btn = document.getElementById('complete-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω—è–µ–º...';

  try {
    {% if daily_lesson %}
    const response = await fetch(`/curriculum/api/v1/lesson/{{ daily_lesson.id }}/complete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    if (response.status === 201 || response.ok) {
      clearProgress();
      if (hasNextLesson && nextLessonUrl) {
        window.location.href = nextLessonUrl;
      } else {
        window.location.href = moduleUrl;
      }
    } else {
      throw new Error('Failed to save');
    }
    {% else %}
    clearProgress();
    if (hasNextLesson && nextLessonUrl) {
      window.location.href = nextLessonUrl;
    } else {
      window.location.href = moduleUrl;
    }
    {% endif %}
  } catch (error) {
    console.error('Error:', error);
    btn.disabled = false;
    btn.innerHTML = hasNextLesson ? '–î–∞–ª–µ–µ <i class="fas fa-arrow-right"></i>' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å <i class="fas fa-check"></i>';
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
  }
}

document.addEventListener('DOMContentLoaded', function() {
  init();
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.target.classList.contains('transform-input') && !isChecked) {
      e.preventDefault();
      checkAnswers();
    }
  });
});
</script>

<style>
/* Transform Specific Styles */
.transform-container {
  max-width: 800px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.transform-item {
  display: flex;
  gap: 1rem;
  padding: 1.5rem;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
}

.item-number {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border-radius: 50%;
  font-weight: 600;
  flex-shrink: 0;
}

.item-content {
  flex: 1;
}

.sentence-label {
  display: block;
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-bottom: 0.25rem;
}

.original-sentence {
  font-size: 1rem;
  line-height: 1.5;
  margin-bottom: 1rem;
  padding: 0.75rem;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
}

.keyword-badge {
  display: inline-block;
  padding: 0.25rem 1rem;
  background: var(--accent-color);
  color: white;
  border-radius: var(--radius-full);
  font-weight: 700;
  font-size: 0.875rem;
  margin-bottom: 1rem;
}

.target-sentence {
  font-size: 1rem;
  line-height: 1.5;
}

.transform-input {
  width: 200px;
  padding: 0.25rem 0.5rem;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 1rem;
  background: var(--bg-primary);
  margin: 0 0.25rem;
}

.transform-input:focus {
  outline: none;
  border-color: var(--accent-color);
}

.transform-input.correct {
  border-color: #4caf50;
  background: rgba(76, 175, 80, 0.1);
}

.transform-input.incorrect {
  border-color: #f44336;
  background: rgba(244, 67, 54, 0.1);
}

.correction {
  margin-top: 1rem;
  padding: 0.5rem 0.75rem;
  background: #e8f5e9;
  border-radius: var(--radius-sm);
  font-size: 0.875rem;
}

.correction-label {
  color: #2e7d32;
  font-weight: 500;
  margin-right: 0.5rem;
}

.transform-summary {
  margin-top: 2rem;
  text-align: center;
}

.summary-score {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--accent-color);
}

/* Responsive */
@media (max-width: 768px) {
  .transform-item {
    flex-direction: column;
    gap: 0.75rem;
  }

  .item-number {
    align-self: flex-start;
  }

  .transform-input {
    width: 150px;
  }
}
</style>
{% endblock %}
