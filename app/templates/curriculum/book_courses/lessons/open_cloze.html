{% extends "curriculum/book_courses/lessons/_lesson_base.html" %}

{% block lesson_type %}✏️ Заполнение пропусков{% endblock %}

{% block lesson_content %}
<div class="lesson-intro">
  <h1>Заполнение пропусков</h1>
  <p>Заполните пропуски в тексте подходящими словами</p>
</div>

<div class="lesson-instructions">
  <strong>Инструкция:</strong> Прочитайте текст и заполните каждый пропуск одним словом.
  Используйте контекст предложения для определения правильного ответа.
</div>

<div class="cloze-container" id="cloze-container">
  <!-- Will be populated by JavaScript -->
</div>

<div class="cloze-summary" id="summary" style="display: none;">
  <div class="summary-score">
    <span id="correct-count">0</span> / <span id="total-count">8</span> правильно
  </div>
</div>
{% endblock %}

{% block lesson_footer %}
<div class="lesson-footer-actions">
  <a href="{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}" class="btn-footer btn-secondary">
    <i class="fas fa-arrow-left"></i> К урокам
  </a>
  <button id="check-btn" class="btn-footer btn-primary" onclick="checkAnswers()">
    Проверить
  </button>
  <button id="complete-btn" class="btn-footer btn-primary" onclick="finishLesson()" style="display: none;">
    {% if has_next_lesson %}Далее <i class="fas fa-arrow-right"></i>{% else %}Завершить <i class="fas fa-check"></i>{% endif %}
  </button>
</div>
{% endblock %}

{% block lesson_scripts %}
<!-- Server data -->
<script>
const serverClozeData = {{ cloze_data | tojson | safe if cloze_data else 'null' }};
</script>

<script>
// Cloze data - load from server or use fallback
const clozeData = serverClozeData || {
  text: `The importance of reading cannot (1) ______ overstated. When we read, we not only gain knowledge (2) ______ also improve our vocabulary and critical thinking skills. Many successful people attribute their achievements (3) ______ the habit of reading regularly.

Reading fiction, (4) ______ particular, helps us develop empathy by allowing us to see the world through different perspectives. It has (5) ______ shown that regular readers are more likely to understand and relate to others' emotions.

Furthermore, reading is one of the (6) ______ effective ways to reduce stress. Studies have found that just six minutes of reading can reduce stress levels (7) ______ up to 68 percent. This makes it even more beneficial (8) ______ watching television or listening to music.`,
  gaps: [
    { id: 1, answer: 'be', hint: 'вспомогательный глагол' },
    { id: 2, answer: 'but', hint: 'союз' },
    { id: 3, answer: 'to', hint: 'предлог' },
    { id: 4, answer: 'in', hint: 'предлог (фраза)' },
    { id: 5, answer: 'been', hint: 'причастие прошедшего времени' },
    { id: 6, answer: 'most', hint: 'превосходная степень' },
    { id: 7, answer: 'by', hint: 'предлог' },
    { id: 8, answer: 'than', hint: 'слово сравнения' }
  ]
};

let userAnswers = {};
let isChecked = false;

// localStorage key для сохранения прогресса
const lessonId = {{ daily_lesson.id if daily_lesson else 0 }};
const storageKey = `cloze_progress_${lessonId}`;

function init() {
  loadProgress();
  renderClozeText();
}

function saveProgress() {
  if (lessonId && !isChecked) {
    localStorage.setItem(storageKey, JSON.stringify({
      userAnswers: userAnswers,
      timestamp: Date.now()
    }));
  }
}

function loadProgress() {
  if (!lessonId) return;

  try {
    const saved = localStorage.getItem(storageKey);
    if (saved) {
      const data = JSON.parse(saved);
      // Проверяем, что данные не старше 24 часов
      if (data.timestamp && (Date.now() - data.timestamp) < 24 * 60 * 60 * 1000) {
        userAnswers = data.userAnswers || {};
      } else {
        clearProgress();
      }
    }
  } catch (e) {
    console.error('Error loading progress:', e);
  }
}

function clearProgress() {
  localStorage.removeItem(storageKey);
}

function renderClozeText() {
  const container = document.getElementById('cloze-container');
  let html = clozeData.text;

  // Replace gaps with input fields
  clozeData.gaps.forEach(gap => {
    const placeholder = `(${gap.id}) ______`;
    const input = `<span class="gap-wrapper">
      <span class="gap-number">(${gap.id})</span>
      <input type="text"
             class="gap-input"
             id="gap-${gap.id}"
             data-id="${gap.id}"
             placeholder="..."
             oninput="onInputChange(${gap.id})"
             autocomplete="off">
    </span>`;
    html = html.replace(placeholder, input);
  });

  container.innerHTML = `<div class="cloze-text">${html}</div>`;

  // Восстанавливаем сохранённые ответы
  Object.keys(userAnswers).forEach(gapId => {
    const input = document.getElementById(`gap-${gapId}`);
    if (input && userAnswers[gapId]) {
      input.value = userAnswers[gapId];
    }
  });
}

function onInputChange(gapId) {
  const input = document.getElementById(`gap-${gapId}`);
  userAnswers[gapId] = input.value.trim().toLowerCase();
  saveProgress();
}

function checkAnswers() {
  if (isChecked) return;
  isChecked = true;

  let correctCount = 0;

  clozeData.gaps.forEach(gap => {
    const input = document.getElementById(`gap-${gap.id}`);
    const userAnswer = (userAnswers[gap.id] || '').toLowerCase();
    const isCorrect = userAnswer === gap.answer.toLowerCase();

    input.disabled = true;
    input.classList.add(isCorrect ? 'correct' : 'incorrect');

    if (isCorrect) {
      correctCount++;
    } else {
      // Show correct answer
      const wrapper = input.parentElement;
      const correction = document.createElement('span');
      correction.className = 'correction';
      correction.textContent = gap.answer;
      wrapper.appendChild(correction);
    }
  });

  // Show summary
  document.getElementById('correct-count').textContent = correctCount;
  document.getElementById('total-count').textContent = clozeData.gaps.length;
  document.getElementById('summary').style.display = 'block';

  // Hide check button, show complete button
  document.getElementById('check-btn').style.display = 'none';
  document.getElementById('complete-btn').style.display = 'inline-block';

  // Calculate score
  const score = Math.round((correctCount / clozeData.gaps.length) * 100);
  window.finalScore = score;
}

const nextLessonUrl = {{ next_lesson_url | tojson | safe if next_lesson_url else 'null' }};
const hasNextLesson = {{ 'true' if has_next_lesson else 'false' }};
const moduleUrl = "{{ url_for('book_courses.view_module', course_id=course.id, module_id=module.id) }}";

async function finishLesson() {
  const btn = document.getElementById('complete-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохраняем...';

  try {
    {% if daily_lesson %}
    const response = await fetch(`/curriculum/api/v1/lesson/{{ daily_lesson.id }}/complete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    if (response.status === 201 || response.ok) {
      clearProgress();
      if (hasNextLesson && nextLessonUrl) {
        window.location.href = nextLessonUrl;
      } else {
        window.location.href = moduleUrl;
      }
    } else {
      throw new Error('Failed to save');
    }
    {% else %}
    clearProgress();
    if (hasNextLesson && nextLessonUrl) {
      window.location.href = nextLessonUrl;
    } else {
      window.location.href = moduleUrl;
    }
    {% endif %}
  } catch (error) {
    console.error('Error:', error);
    btn.disabled = false;
    btn.innerHTML = hasNextLesson ? 'Далее <i class="fas fa-arrow-right"></i>' : 'Завершить <i class="fas fa-check"></i>';
    alert('Ошибка сохранения. Попробуйте ещё раз.');
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>

<style>
/* Cloze Specific Styles */
.cloze-container {
  max-width: 800px;
  margin: 0 auto;
}

.cloze-text {
  background: var(--card-bg);
  padding: 2rem;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
  font-size: 1.125rem;
  line-height: 2;
  white-space: pre-wrap;
}

.gap-wrapper {
  display: inline-flex;
  align-items: baseline;
  gap: 0.25rem;
}

.gap-number {
  font-size: 0.75rem;
  color: var(--accent-color);
  font-weight: 600;
}

.gap-input {
  width: 100px;
  padding: 0.25rem 0.5rem;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 1rem;
  background: var(--bg-primary);
  text-align: center;
  transition: border-color 0.2s;
}

.gap-input:focus {
  outline: none;
  border-color: var(--accent-color);
}

.gap-input.correct {
  border-color: #4caf50;
  background: rgba(76, 175, 80, 0.1);
}

.gap-input.incorrect {
  border-color: #f44336;
  background: rgba(244, 67, 54, 0.1);
}

.correction {
  display: inline-block;
  margin-left: 0.5rem;
  padding: 0.25rem 0.5rem;
  background: #e8f5e9;
  color: #2e7d32;
  border-radius: var(--radius-sm);
  font-size: 0.875rem;
  font-weight: 500;
}

.cloze-summary {
  margin-top: 2rem;
  text-align: center;
}

.summary-score {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--accent-color);
}
</style>
{% endblock %}
