{% extends "curriculum/book_courses/lessons/_lesson_base.html" %}

{% block lesson_type %}üìù –°–ª–æ–≤–∞—Ä—å{% endblock %}

{% block lesson_content %}
<div class="lesson-intro">
  <h1>–ò–∑—É—á–µ–Ω–∏–µ —Å–ª–æ–≤</h1>
  <p>–ò–∑—É—á–∏—Ç–µ {{ total_words }} –Ω–æ–≤—ã—Ö —Å–ª–æ–≤ –∏–∑ —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞</p>
</div>

<div class="vocabulary-container">
  <!-- Progress -->
  <div class="vocab-progress">
    <div class="progress-info">
      <span class="progress-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
      <span class="progress-count"><span id="current-word">1</span> –∏–∑ {{ total_words }}</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="vocab-progress" style="width: 0%"></div>
    </div>
  </div>

  <!-- Flashcard -->
  <div class="vocab-card-container">
    <div class="vocab-card" id="flashcard" onclick="flipCard()">
      <div class="vocab-card-front">
        <div class="card-badge" id="word-pos"></div>
        <div class="word-english" id="word-english"></div>
        <div class="word-transcription" id="word-transcription"></div>
        <button class="audio-btn-inline" id="audio-btn-front" onclick="event.stopPropagation(); playAudio()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
          </svg>
        </button>
        <div class="word-hint">
          <span class="hint-icon">üëÜ</span> –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
        </div>
      </div>
      <div class="vocab-card-back">
        <div class="card-badge translation-badge">–ü–µ—Ä–µ–≤–æ–¥</div>
        <div class="word-translation" id="word-translation"></div>
        <div class="word-details">
          <div class="detail-item" id="word-level-container">
            <span class="detail-label">–£—Ä–æ–≤–µ–Ω—å</span>
            <span class="detail-value level-badge" id="word-level"></span>
          </div>
          <div class="detail-item" id="word-freq-container">
            <span class="detail-label">–ß–∞—Å—Ç–æ—Ç–∞</span>
            <span class="detail-value" id="word-frequency"></span>
          </div>
        </div>
        <div class="word-context-section" id="context-section">
          <div class="example-label">üìñ –í —Ç–µ–∫—Å—Ç–µ</div>
          <div class="word-context" id="word-context"></div>
        </div>
        <div class="word-example-section" id="example-section">
          <div class="example-label">üí° –ü—Ä–∏–º–µ—Ä —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º</div>
          <div class="word-example" id="word-example"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rating Buttons (shown after flip) -->
  <div class="rating-section" id="rating-section" style="display: none;">
    <div class="rating-label">–ù–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –≤—ã –∑–Ω–∞–µ—Ç–µ —ç—Ç–æ —Å–ª–æ–≤–æ?</div>
    <div class="rating-buttons" id="rating-buttons">
      <button class="rating-btn hard" onclick="rateWord(1)">
        <span class="rating-icon">üòï</span>
        <span class="rating-text">–ù–µ –∑–Ω–∞—é</span>
      </button>
      <button class="rating-btn good" onclick="rateWord(3)">
        <span class="rating-icon">ü§î</span>
        <span class="rating-text">–°–æ–º–Ω–µ–≤–∞—é—Å—å</span>
      </button>
      <button class="rating-btn easy" onclick="rateWord(5)">
        <span class="rating-icon">üòä</span>
        <span class="rating-text">–ó–Ω–∞—é</span>
      </button>
    </div>
  </div>

  <!-- Navigation Dots -->
  <div class="nav-dots" id="nav-dots"></div>
</div>
{% endblock %}

{% block lesson_footer %}
<div class="footer-info">
  –ò–∑—É—á–∏—Ç–µ –≤—Å–µ —Å–ª–æ–≤–∞, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫
</div>
<button id="complete-btn" class="btn btn-primary btn-lg" onclick="completeLesson()" disabled>
  –ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫
</button>
{% endblock %}

{% block lesson_scripts %}
<script>
// Vocabulary data
const vocabularyData = {{ vocabulary_data | tojson | safe }};
let currentIndex = 0;
let isFlipped = false;
let studiedWords = new Set();

// Part of speech translations
const posLabels = {
  'noun': '—Å—É—â.',
  'verb': '–≥–ª.',
  'adjective': '–ø—Ä–∏–ª.',
  'adverb': '–Ω–∞—Ä–µ—á.',
  'preposition': '–ø—Ä–µ–¥–ª.',
  'conjunction': '—Å–æ—é–∑',
  'pronoun': '–º–µ—Å—Ç.',
  'interjection': '–º–µ–∂–¥.',
  'unknown': ''
};

function init() {
  if (vocabularyData.length > 0) {
    createNavDots();
    showWord(0);
  } else {
    document.querySelector('.vocabulary-container').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üìù</div>
        <h4>–°–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
        <p>–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–ª–æ–≤–∞—Ä–Ω—ã—Ö —Å–ª–æ–≤</p>
      </div>
    `;
    enableCompleteButton();
  }
}

function createNavDots() {
  const dotsContainer = document.getElementById('nav-dots');
  if (!dotsContainer) return;

  dotsContainer.innerHTML = '';
  const maxDots = Math.min(vocabularyData.length, 10);

  for (let i = 0; i < maxDots; i++) {
    const dot = document.createElement('span');
    dot.className = 'nav-dot' + (i === 0 ? ' active' : '');
    dot.onclick = () => showWord(i);
    dotsContainer.appendChild(dot);
  }
}

function updateNavDots() {
  const dots = document.querySelectorAll('.nav-dot');
  dots.forEach((dot, i) => {
    dot.classList.remove('active', 'completed');
    if (i === currentIndex) {
      dot.classList.add('active');
    } else if (studiedWords.has(i)) {
      dot.classList.add('completed');
    }
  });
}

function showWord(index) {
  const word = vocabularyData[index];
  if (!word) return;

  currentIndex = index;
  isFlipped = false;

  // Front side
  document.getElementById('word-english').textContent = word.lemma;

  // Part of speech
  const posEl = document.getElementById('word-pos');
  const pos = word.part_of_speech || 'unknown';
  posEl.textContent = posLabels[pos] || pos;
  posEl.style.display = posLabels[pos] ? 'inline-block' : 'none';

  // Transcription (if available)
  const transcEl = document.getElementById('word-transcription');
  if (word.transcription) {
    transcEl.textContent = `/${word.transcription}/`;
    transcEl.style.display = 'block';
  } else {
    transcEl.style.display = 'none';
  }

  // Back side
  document.getElementById('word-translation').textContent = word.translation || '–ù–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞';

  // Level badge
  const levelEl = document.getElementById('word-level');
  const levelContainer = document.getElementById('word-level-container');
  if (word.level) {
    levelEl.textContent = word.level;
    levelEl.className = 'detail-value level-badge level-' + word.level.toLowerCase();
    levelContainer.style.display = 'flex';
  } else {
    levelContainer.style.display = 'none';
  }

  // Frequency
  const freqEl = document.getElementById('word-frequency');
  const freqContainer = document.getElementById('word-freq-container');
  if (word.frequency) {
    freqEl.textContent = word.frequency + 'x –≤ —Ç–µ–∫—Å—Ç–µ';
    freqContainer.style.display = 'flex';
  } else {
    freqContainer.style.display = 'none';
  }

  // Context from book
  const contextSection = document.getElementById('context-section');
  const contextEl = document.getElementById('word-context');
  if (word.context) {
    let context = word.context.replace(/\\n/g, ' ').replace(/<br\s*\/?>/gi, ' ');
    contextEl.textContent = context;
    contextSection.style.display = 'block';
  } else {
    contextSection.style.display = 'none';
  }

  // Example with translation from DB
  const exampleSection = document.getElementById('example-section');
  const exampleEl = document.getElementById('word-example');
  if (word.example) {
    // Handle escaped newlines
    let example = word.example.replace(/\\n/g, '\n').replace(/<br\s*\/?>/gi, '\n');
    exampleEl.textContent = example;
    exampleSection.style.display = 'block';
  } else {
    exampleSection.style.display = 'none';
  }

  // Reset card state
  document.getElementById('flashcard').classList.remove('flipped');
  document.getElementById('rating-section').style.display = 'none';

  // Update progress
  document.getElementById('current-word').textContent = index + 1;
  document.getElementById('vocab-progress').style.width =
    ((studiedWords.size) / vocabularyData.length * 100) + '%';

  updateNavDots();
}

function flipCard() {
  isFlipped = !isFlipped;
  document.getElementById('flashcard').classList.toggle('flipped');

  if (isFlipped) {
    document.getElementById('rating-section').style.display = 'block';
    studiedWords.add(currentIndex);

    // Update progress bar
    document.getElementById('vocab-progress').style.width =
      ((studiedWords.size) / vocabularyData.length * 100) + '%';

    updateNavDots();
    checkCompletion();
  } else {
    document.getElementById('rating-section').style.display = 'none';
  }
}

function nextWord() {
  if (currentIndex < vocabularyData.length - 1) {
    showWord(currentIndex + 1);
  } else {
    studiedWords.add(currentIndex);
    checkCompletion();
  }
}

function rateWord(rating) {
  const word = vocabularyData[currentIndex];
  console.log(`Word "${word.lemma}" rated: ${rating}`);

  // Visual feedback
  const btn = event.target.closest('.rating-btn');
  btn.classList.add('selected');

  setTimeout(() => {
    btn.classList.remove('selected');
    nextWord();
  }, 200);
}

function playAudio() {
  const word = vocabularyData[currentIndex];
  if (word && word.audio_url) {
    const audio = new Audio(word.audio_url);
    audio.play().catch(e => console.log('Audio not available'));
  }
}

function checkCompletion() {
  if (studiedWords.size >= vocabularyData.length) {
    enableCompleteButton();
  }
}

// Initialize
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

<style>
/* Vocabulary Container */
.vocabulary-container {
  max-width: 550px;
  margin: 0 auto;
}

/* Progress Section */
.vocab-progress {
  margin-bottom: 1.5rem;
}

.progress-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.progress-label {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
}

.progress-count {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--accent-color);
}

.vocab-progress .progress-bar {
  height: 8px;
  background: var(--bg-secondary);
  border-radius: 4px;
  overflow: hidden;
}

.vocab-progress .progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-color), #10b981);
  border-radius: 4px;
  transition: width 0.4s ease;
}

/* Flashcard */
.vocab-card-container {
  perspective: 1000px;
  margin-bottom: 1.5rem;
}

.vocab-card {
  width: 100%;
  height: 450px;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
}

.vocab-card.flipped {
  transform: rotateY(180deg);
}

.vocab-card-front,
.vocab-card-back {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 1.5rem;
  background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  text-align: center;
  box-sizing: border-box;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.vocab-card-back {
  transform: rotateY(180deg);
  background: linear-gradient(145deg, #f0fdf4 0%, #dcfce7 100%);
  justify-content: flex-start;
  padding-top: 2rem;
}

/* Card Badge */
.card-badge {
  position: absolute;
  top: 1rem;
  left: 1rem;
  padding: 0.25rem 0.75rem;
  background: var(--bg-secondary);
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.translation-badge {
  background: #dcfce7;
  color: #166534;
}

/* Front Side */
.word-english {
  font-size: 2.25rem;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 0.5rem;
  line-height: 1.2;
}

.word-transcription {
  font-size: 1rem;
  color: var(--text-secondary);
  font-family: 'Courier New', monospace;
  margin-bottom: 1rem;
}

.audio-btn-inline {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #6366f1;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 1rem;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

.audio-btn-inline svg {
  fill: white;
}

.audio-btn-inline:hover {
  transform: scale(1.1);
  background: #4f46e5;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
}

.word-hint {
  font-size: 0.8rem;
  color: var(--text-tertiary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.hint-icon {
  font-size: 1rem;
}

/* Back Side */
.word-translation {
  font-size: 1.75rem;
  font-weight: 700;
  color: #166534;
  margin-bottom: 1rem;
}

.word-details {
  display: flex;
  gap: 1.5rem;
  margin-bottom: 1rem;
  padding: 0.75rem 1rem;
  background: rgba(255,255,255,0.7);
  border-radius: 12px;
}

.detail-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
}

.detail-label {
  font-size: 0.65rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-tertiary);
}

.detail-value {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-primary);
}

.level-badge {
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  font-size: 0.75rem;
}

.level-a1, .level-a2 { background: #dbeafe; color: #1e40af; }
.level-b1, .level-b2 { background: #fef3c7; color: #92400e; }
.level-c1, .level-c2 { background: #fee2e2; color: #991b1b; }

.word-context-section,
.word-example-section {
  width: 100%;
  padding: 0.75rem 1rem;
  background: rgba(255,255,255,0.7);
  border-radius: 12px;
  text-align: left;
  margin-bottom: 0.5rem;
}

.word-context-section:last-child,
.word-example-section:last-child {
  margin-bottom: 0;
}

.word-context {
  font-size: 0.85rem;
  color: var(--text-secondary);
  line-height: 1.4;
}

.example-label {
  font-size: 0.65rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-tertiary);
  margin-bottom: 0.5rem;
}

.word-example {
  font-size: 0.9rem;
  color: var(--text-secondary);
  font-style: italic;
  line-height: 1.5;
  white-space: pre-wrap;
}

/* Rating Section */
.rating-section {
  background: var(--bg-secondary);
  border-radius: 16px;
  padding: 1rem;
  margin-bottom: 1.5rem;
  text-align: center;
}

.rating-label {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 0.75rem;
}

.rating-buttons {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
}

.rating-btn {
  flex: 1;
  max-width: 120px;
  padding: 0.75rem 0.5rem;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  transition: all 0.2s;
}

.rating-icon {
  font-size: 1.5rem;
}

.rating-text {
  font-size: 0.75rem;
  font-weight: 600;
}

.rating-btn.hard {
  background: #fef2f2;
  color: #991b1b;
}

.rating-btn.hard:hover, .rating-btn.hard.selected {
  background: #fecaca;
  transform: scale(1.05);
}

.rating-btn.good {
  background: #fffbeb;
  color: #92400e;
}

.rating-btn.good:hover, .rating-btn.good.selected {
  background: #fde68a;
  transform: scale(1.05);
}

.rating-btn.easy {
  background: #f0fdf4;
  color: #166534;
}

.rating-btn.easy:hover, .rating-btn.easy.selected {
  background: #bbf7d0;
  transform: scale(1.05);
}

/* Navigation Dots */
.nav-dots {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  margin-top: 1rem;
}

.nav-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--border-color);
  cursor: pointer;
  transition: all 0.2s;
}

.nav-dot:hover {
  background: var(--text-secondary);
}

.nav-dot.active {
  background: var(--accent-color);
  transform: scale(1.2);
}

.nav-dot.completed {
  background: #10b981;
}

/* Footer */
.footer-info {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 3rem;
  background: var(--bg-secondary);
  border-radius: 16px;
}

.empty-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

/* Responsive */
@media (max-width: 480px) {
  .vocab-card {
    height: 420px;
  }

  .word-english {
    font-size: 1.75rem;
  }

  .word-translation {
    font-size: 1.5rem;
  }

  .word-context,
  .word-example {
    font-size: 0.8rem;
  }
}
</style>
{% endblock %}
