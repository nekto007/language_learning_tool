{% extends "base.html" %}

{% block title %}{{ module.title }} - {{ course.title }}{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="module-hero">
    <div class="hero-bg-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <div class="container">
        <!-- Breadcrumb -->
        <nav class="hero-breadcrumb">
            <a href="{{ url_for('book_courses.list_book_courses') }}">–ö–Ω–∏–∂–Ω—ã–µ –∫—É—Ä—Å—ã</a>
            <span class="sep">/</span>
            <a href="{{ url_for('book_courses.view_course', course_id=course.id) }}">{{ course.title }}</a>
            <span class="sep">/</span>
            <span class="current">–ú–æ–¥—É–ª—å {{ module.module_number }}</span>
        </nav>

        <div class="hero-content">
            <div class="module-badge">
                <span class="module-num">{{ module.module_number }}</span>
            </div>

            <div class="hero-text">
                <h1 class="hero-title">{{ module.title }}</h1>
                {% if module.description %}
                <p class="hero-description">{{ module.description }}</p>
                {% endif %}

                <div class="hero-stats">
                    <div class="hero-stat">
                        <span class="stat-icon">üìö</span>
                        <span class="stat-text">{{ lessons|length }} —É—Ä–æ–∫–æ–≤</span>
                    </div>
                    {% if module.estimated_reading_time %}
                    <div class="hero-stat">
                        <span class="stat-icon">‚è±Ô∏è</span>
                        <span class="stat-text">~{{ module.estimated_reading_time }} –º–∏–Ω.</span>
                    </div>
                    {% endif %}
                    {% if module_progress %}
                    <div class="hero-stat highlight">
                        <span class="stat-icon">üéØ</span>
                        <span class="stat-text">{{ module_progress.progress_percentage|round|int }}% –ø—Ä–æ–π–¥–µ–Ω–æ</span>
                    </div>
                    {% endif %}
                    {% if due_cards_count and due_cards_count > 0 %}
                    <div class="hero-stat srs-badge">
                        <span class="stat-icon">üîÑ</span>
                        <span class="stat-text">{{ due_cards_count }} —Å–ª–æ–≤ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if module_progress %}
        <div class="hero-progress">
            <div class="progress-track">
                <div class="progress-fill" style="width: {{ module_progress.progress_percentage }}%"></div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="container module-content">
    <!-- Learning Objectives -->
    {% if module.learning_objectives %}
    <div class="objectives-section">
        <div class="section-header">
            <h2><span class="section-icon">üéì</span> –ß—Ç–æ –≤—ã –∏–∑—É—á–∏—Ç–µ</h2>
        </div>
        <div class="objectives-grid">
            {% for objective in module.learning_objectives %}
            <div class="objective-card">
                <span class="objective-check">‚úì</span>
                <span class="objective-text">{{ objective }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Focus Areas -->
    {% if module.vocabulary_focus or module.grammar_focus %}
    <div class="focus-section">
        {% if module.vocabulary_focus %}
        <div class="focus-card vocab-focus">
            <div class="focus-header">
                <span class="focus-icon">üìù</span>
                <h3>–ö–ª—é—á–µ–≤–∞—è –ª–µ–∫—Å–∏–∫–∞</h3>
            </div>
            <div class="focus-tags">
                {% for word in module.vocabulary_focus[:10] %}
                <span class="focus-tag">{{ word }}</span>
                {% endfor %}
                {% if module.vocabulary_focus|length > 10 %}
                <span class="focus-tag more">+{{ module.vocabulary_focus|length - 10 }} —Å–ª–æ–≤</span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if module.grammar_focus %}
        <div class="focus-card grammar-focus">
            <div class="focus-header">
                <span class="focus-icon">üìñ</span>
                <h3>–ì—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–æ–∫—É—Å</h3>
            </div>
            <div class="focus-tags">
                {% for point in module.grammar_focus %}
                <span class="focus-tag">{{ point|replace('_', ' ') }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Lessons Section -->
    <div class="lessons-section">
        <div class="section-header">
            <h2><span class="section-icon">üìñ</span> –£—Ä–æ–∫–∏ –º–æ–¥—É–ª—è</h2>
            <p class="section-desc">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ —É—Ä–æ–∫–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</p>
        </div>

        <div class="lessons-list">
            {% set completed_lessons = module_progress.lessons_completed or [] if module_progress else [] %}
            {% set completed_ids = completed_lessons | map('string') | list %}
            {% set ns = namespace(found_current=false) %}

            {% for lesson in lessons %}
                {% set is_completed = (lesson.id|string) in completed_ids %}
                {# Current = first uncompleted lesson #}
                {% set is_current = not is_completed and not ns.found_current %}
                {% if is_current %}
                    {% set ns.found_current = true %}
                {% endif %}

                <div class="lesson-row {{ 'completed' if is_completed else 'current' if is_current else 'available' }}">
                    <div class="lesson-status-dot">
                        {% if is_completed %}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <path d="M5 12l5 5L20 7"/>
                        </svg>
                        {% else %}
                        <span>{{ loop.index }}</span>
                        {% endif %}
                    </div>

                    <div class="lesson-content">
                        <div class="lesson-header">
                            <div class="lesson-title-row">
                                <span class="lesson-icon">
                                    {% if lesson.type == 'vocabulary' %}üìù
                                    {% elif lesson.type in ['reading_passage', 'reading'] %}üìñ
                                    {% elif lesson.type in ['reading_mcq', 'mcq'] %}‚ùì
                                    {% elif lesson.type == 'match_headings' %}üîó
                                    {% elif lesson.type in ['open_cloze', 'cloze'] %}‚úèÔ∏è
                                    {% elif lesson.type == 'word_formation' %}üî§
                                    {% elif lesson.type == 'keyword_transform' %}üîÑ
                                    {% elif lesson.type in ['grammar_sheet', 'grammar_focus', 'grammar'] %}üìö
                                    {% elif lesson.type == 'final_test' %}üèÜ
                                    {% elif lesson.type == 'summary' %}üìã
                                    {% elif lesson.type == 'discussion' %}üí¨
                                    {% else %}üìÑ
                                    {% endif %}
                                </span>
                                <h4 class="lesson-title">
                                    {% set type_name %}
                                        {% if lesson.type == 'vocabulary' %}–°–ª–æ–≤–∞—Ä—å
                                        {% elif lesson.type in ['reading_passage', 'reading'] %}–ß—Ç–µ–Ω–∏–µ
                                        {% elif lesson.type in ['reading_mcq', 'mcq'] %}–¢–µ—Å—Ç
                                        {% elif lesson.type == 'match_headings' %}–ó–∞–≥–æ–ª–æ–≤–∫–∏
                                        {% elif lesson.type in ['open_cloze', 'cloze'] %}–ü—Ä–æ–ø—É—Å–∫–∏
                                        {% elif lesson.type == 'word_formation' %}–°–ª–æ–≤–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
                                        {% elif lesson.type == 'keyword_transform' %}–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
                                        {% elif lesson.type in ['grammar_sheet', 'grammar_focus', 'grammar'] %}–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞
                                        {% elif lesson.type == 'final_test' %}–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç
                                        {% elif lesson.type == 'summary' %}–†–µ–∑—é–º–µ
                                        {% elif lesson.type == 'discussion' %}–û–±—Å—É–∂–¥–µ–Ω–∏–µ
                                        {% else %}–£—Ä–æ–∫
                                        {% endif %}
                                    {% endset %}
                                    –£—Ä–æ–∫ {{ loop.index }}: {{ type_name|trim }}
                                </h4>
                            </div>
                            {% if lesson.estimated_time %}
                            <span class="lesson-time">~{{ lesson.estimated_time }} –º–∏–Ω</span>
                            {% endif %}
                        </div>

                        <div class="lesson-actions">
                            {% set lesson_url = url_for('book_courses.view_lesson_by_slug', course_slug=course.slug, module_number=module.module_number, lesson_number=loop.index) if course.slug else url_for('book_courses.view_lesson_by_id', course_id=course.id, module_id=module.id, lesson_id=lesson.id) %}
                            {% if is_completed %}
                                <span class="lesson-badge completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                                <a href="{{ lesson_url }}" class="lesson-btn secondary">
                                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                                </a>
                            {% elif is_current %}
                                <span class="lesson-badge current">–¢–µ–∫—É—â–∏–π</span>
                                <a href="{{ lesson_url }}" class="lesson-btn primary">
                                    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                                </a>
                            {% else %}
                                <a href="{{ lesson_url }}" class="lesson-btn primary">
                                    –ù–∞—á–∞—Ç—å
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Navigation -->
    <div class="module-nav">
        {% if prev_module %}
        {% set prev_url = url_for('book_courses.view_module_by_slug', course_slug=course.slug, module_number=prev_module.module_number) if course.slug else url_for('book_courses.view_module', course_id=course.id, module_id=prev_module.id) %}
        <a href="{{ prev_url }}" class="nav-link prev">
            <span class="nav-arrow">‚Üê</span>
            <div class="nav-text">
                <span class="nav-label">–ü—Ä–µ–¥—ã–¥—É—â–∏–π</span>
                <span class="nav-title">{{ prev_module.title|truncate(25) }}</span>
            </div>
        </a>
        {% else %}
        <div class="nav-link disabled"></div>
        {% endif %}

        {% set course_url = url_for('book_courses.view_course_by_slug', course_slug=course.slug) if course.slug else url_for('book_courses.view_course', course_id=course.id) %}
        <a href="{{ course_url }}" class="nav-link center">
            <span class="nav-icon">üìö</span>
            <span>–ö –∫—É—Ä—Å—É</span>
        </a>

        {% if next_module %}
        {% set next_url = url_for('book_courses.view_module_by_slug', course_slug=course.slug, module_number=next_module.module_number) if course.slug else url_for('book_courses.view_module', course_id=course.id, module_id=next_module.id) %}
        <a href="{{ next_url }}" class="nav-link next {{ 'locked' if next_module.is_locked else '' }}">
            <div class="nav-text">
                <span class="nav-label">–°–ª–µ–¥—É—é—â–∏–π</span>
                <span class="nav-title">{{ next_module.title|truncate(25) }}</span>
            </div>
            <span class="nav-arrow">‚Üí</span>
        </a>
        {% else %}
        <div class="nav-link disabled"></div>
        {% endif %}
    </div>
</div>

<style>
/* Hero Section */
.module-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3rem 0 2.5rem;
    position: relative;
    overflow: hidden;
}

.hero-bg-shapes {
    position: absolute;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
}

.hero-bg-shapes .shape {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
}

.shape-1 {
    width: 300px;
    height: 300px;
    top: -100px;
    right: -50px;
    animation: float 8s ease-in-out infinite;
}

.shape-2 {
    width: 200px;
    height: 200px;
    bottom: -50px;
    left: 10%;
    animation: float 10s ease-in-out infinite reverse;
}

.shape-3 {
    width: 150px;
    height: 150px;
    top: 50%;
    right: 20%;
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(5deg); }
}

.hero-breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
    opacity: 0.9;
}

.hero-breadcrumb a {
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    transition: opacity 0.2s;
}

.hero-breadcrumb a:hover {
    opacity: 1;
    text-decoration: underline;
}

.hero-breadcrumb .sep {
    opacity: 0.5;
}

.hero-breadcrumb .current {
    opacity: 0.7;
}

.hero-content {
    display: flex;
    align-items: flex-start;
    gap: 1.5rem;
}

.module-badge {
    flex-shrink: 0;
}

.module-num {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 64px;
    height: 64px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    font-size: 1.75rem;
    font-weight: 700;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.hero-text {
    flex: 1;
}

.hero-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    line-height: 1.2;
}

.hero-description {
    font-size: 1rem;
    opacity: 0.9;
    margin-bottom: 1rem;
    max-width: 600px;
    line-height: 1.5;
}

.hero-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
}

.hero-stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.hero-stat .stat-icon {
    font-size: 1.1rem;
}

.hero-stat.highlight {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
}

.hero-stat.srs-badge {
    background: rgba(255, 193, 7, 0.3);
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

.hero-progress {
    margin-top: 1.5rem;
}

.progress-track {
    height: 6px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: white;
    border-radius: 10px;
    transition: width 0.5s ease;
}

/* Content */
.module-content {
    padding: 2rem 1rem;
    max-width: 900px;
    margin: 0 auto;
}

/* Objectives Section */
.objectives-section {
    margin-bottom: 2rem;
}

.section-header {
    margin-bottom: 1rem;
}

.section-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-icon {
    font-size: 1.25rem;
}

.section-desc {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-top: 0.25rem;
}

.objectives-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 0.75rem;
}

.objective-card {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.objective-check {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    font-size: 0.75rem;
    font-weight: bold;
}

.objective-text {
    font-size: 0.9rem;
    color: var(--text-primary);
    line-height: 1.4;
}

/* Focus Section */
.focus-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.focus-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 1.25rem;
    border: 1px solid var(--border-color);
}

.focus-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.focus-header .focus-icon {
    font-size: 1.5rem;
}

.focus-header h3 {
    font-size: 1rem;
    font-weight: 600;
}

.focus-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.focus-tag {
    padding: 0.35rem 0.75rem;
    background: var(--bg-secondary);
    border-radius: 20px;
    font-size: 0.8rem;
    color: var(--text-primary);
}

.vocab-focus .focus-tag {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

.grammar-focus .focus-tag {
    background: rgba(118, 75, 162, 0.1);
    color: #764ba2;
}

.focus-tag.more {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

/* Lessons Section */
.lessons-section {
    margin-bottom: 2rem;
}

.lessons-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.lesson-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: var(--card-bg);
    border-radius: 10px;
    border: 1px solid var(--border-color);
    transition: all 0.2s;
}

.lesson-row:hover {
    border-color: #667eea;
}

.lesson-row.completed {
    border-left: 3px solid #4caf50;
}

.lesson-row.current {
    border-left: 3px solid #667eea;
    background: rgba(102, 126, 234, 0.03);
}

.lesson-status-dot {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.75rem;
    flex-shrink: 0;
    background: var(--bg-secondary);
    color: var(--text-secondary);
}

.lesson-row.completed .lesson-status-dot {
    background: #4caf50;
    color: white;
}

.lesson-row.completed .lesson-status-dot svg {
    width: 14px;
    height: 14px;
}

.lesson-row.current .lesson-status-dot {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.lesson-content {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
}

.lesson-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.lesson-title-row {
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.lesson-icon {
    font-size: 1rem;
}

.lesson-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
    margin: 0;
}

.lesson-time {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.lesson-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
}

.lesson-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    font-weight: 500;
}

.lesson-badge.completed {
    background: #e8f5e9;
    color: #2e7d32;
}

.lesson-badge.current {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

.lesson-btn {
    padding: 0.35rem 0.85rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
}

.lesson-btn.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.lesson-btn.primary:hover {
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
}

.lesson-btn.secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.lesson-btn.secondary:hover {
    background: var(--bg-tertiary);
}

/* Responsive lessons */
@media (max-width: 600px) {
    .lesson-row {
        flex-wrap: wrap;
    }

    .lesson-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .lesson-actions {
        width: 100%;
        justify-content: space-between;
    }
}

/* Navigation */
.module-nav {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 1rem;
    padding: 1.5rem 0;
    border-top: 1px solid var(--border-color);
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    text-decoration: none;
    color: var(--text-primary);
    transition: all 0.2s;
}

.nav-link:hover:not(.disabled):not(.locked) {
    border-color: #667eea;
    color: #667eea;
}

.nav-link.disabled {
    visibility: hidden;
}

.nav-link.locked {
    opacity: 0.5;
    pointer-events: none;
}

.nav-link.prev {
    justify-self: start;
}

.nav-link.next {
    justify-self: end;
    flex-direction: row;
    text-align: right;
}

.nav-link.center {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
    gap: 0.5rem;
}

.nav-link.center:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    color: white;
}

.nav-arrow {
    font-size: 1.25rem;
    font-weight: 600;
}

.nav-text {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
}

.nav-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.nav-link:hover .nav-label {
    color: #667eea;
}

.nav-link.center:hover .nav-label {
    color: rgba(255, 255, 255, 0.8);
}

.nav-title {
    font-weight: 500;
    font-size: 0.9rem;
}

.nav-icon {
    font-size: 1.25rem;
}

/* Responsive */
@media (max-width: 768px) {
    .module-hero {
        padding: 2rem 0;
    }

    .hero-content {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .hero-title {
        font-size: 1.5rem;
    }

    .hero-stats {
        justify-content: center;
    }

    .module-content {
        padding: 1.5rem 1rem;
    }

    .lesson-main {
        flex-wrap: wrap;
    }

    .lesson-time {
        width: 100%;
        text-align: center;
        margin-top: 0.5rem;
    }

    .lesson-footer {
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch;
    }

    .lesson-btn {
        text-align: center;
    }

    .module-nav {
        grid-template-columns: 1fr;
    }

    .nav-link.prev,
    .nav-link.next {
        justify-self: stretch;
        text-align: left;
    }

    .nav-link.next {
        flex-direction: row-reverse;
    }

    .nav-link.disabled {
        display: none;
    }
}
</style>
{% endblock %}
