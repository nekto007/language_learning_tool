{% extends "base.html" %}

{% block title %}{{ _('Модуль') }} {{ module.number }}: {{ module.title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Минималистичная навигация -->
  <nav aria-label="{{ _('Навигация') }}" class="mb-4">
    <ol class="breadcrumb-minimal" role="list">
      <li><a href="/learn/">{{ _('Курсы') }}</a></li>
      <li aria-hidden="true">/</li>
      <li><a href="/learn/{{ module.level.code|lower }}/">{{ module.level.code }}</a></li>
      <li aria-hidden="true">/</li>
      <li class="active" aria-current="page">{{ _('Модуль') }} {{ module.number }}</li>
    </ol>
  </nav>

  <!-- Заголовок модуля с прогрессом -->
  <div class="module-header-main mb-5">
    <div class="row align-items-center">
      <div class="col-md-8">
        <div class="module-info">
          <div class="module-label">{{ module.level.code }} - {{ module.level.name }}</div>
          <h1>{{ _('Модуль') }} {{ module.number }}: {{ module.title }}</h1>
          {% if module.description %}
            <p class="module-description">{{ module.description }}</p>
          {% endif %}
        </div>
      </div>
      <div class="col-md-4">
        {% set counter = namespace(completed=0) %}
        {% for lesson in lessons %}
          {% if lesson.id in user_lesson_progress and user_lesson_progress[lesson.id].status == 'completed' %}
            {% set counter.completed = counter.completed + 1 %}
          {% endif %}
        {% endfor %}

        <div class="progress-circle-container" role="progressbar"
             aria-valuenow="{{ counter.completed }}"
             aria-valuemin="0"
             aria-valuemax="{{ lessons|length }}"
             aria-label="{{ _('Прогресс модуля') }}: {{ counter.completed }} из {{ lessons|length }} уроков">
          <svg class="progress-circle" viewBox="0 0 120 120" aria-hidden="true">
            <circle cx="60" cy="60" r="50" fill="none" class="progress-circle-bg" stroke-width="8"></circle>
            <circle cx="60" cy="60" r="50" fill="none" class="progress-circle-fill" stroke-width="8"
                    stroke-dasharray="{{ ((counter.completed / lessons|length) * 314)|round if lessons|length > 0 else 0 }} 314"
                    stroke-dashoffset="0"
                    stroke-linecap="round"
                    transform="rotate(-90 60 60)"></circle>
          </svg>
          <div class="progress-info">
            <div class="progress-number">{{ counter.completed }}/{{ lessons|length }}</div>
            <div class="progress-label">{{ _('уроков') }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Список уроков -->
  <div class="lessons-container">
    {% set current_lesson_found = false %}
    {% for lesson in lessons %}
      {% set is_completed = lesson.id in user_lesson_progress and user_lesson_progress[lesson.id].status == 'completed' %}
      {% set is_in_progress = lesson.id in user_lesson_progress and user_lesson_progress[lesson.id].status == 'in_progress' %}

      {# Урок доступен если: 1) это первый урок, 2) урок завершён, 3) предыдущий урок завершён #}
      {% set is_available = false %}
      {% if lesson.number == 1 %}
        {% set is_available = true %}
      {% elif is_completed %}
        {# Завершённые уроки всегда доступны для повторения #}
        {% set is_available = true %}
      {% else %}
        {# Проверяем, завершён ли предыдущий урок #}
        {% for l in lessons %}
          {% if l.number == lesson.number - 1 %}
            {% if l.id in user_lesson_progress and user_lesson_progress[l.id].status == 'completed' %}
              {% set is_available = true %}
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endif %}

      {# Текущий урок - первый доступный незавершённый #}
      {% set is_current = is_available and not is_completed and not current_lesson_found %}

      {% if is_current %}
        {% set current_lesson_found = true %}
      {% endif %}

      <div class="lesson-item {{ 'completed' if is_completed else 'current' if is_current else 'locked' if not is_available else 'available' }}">
        <div class="lesson-number-container">
          <div class="lesson-number">{{ lesson.number }}</div>
          {% if is_completed %}
            <div class="lesson-check"><i class="fas fa-check"></i></div>
          {% elif is_current %}
            <div class="lesson-arrow"><i class="fas fa-arrow-right"></i></div>
          {% elif not is_available %}
            <div class="lesson-lock"><i class="fas fa-lock"></i></div>
          {% endif %}
        </div>

        <div class="lesson-content">
          <div class="lesson-type">
            {% if lesson.type == 'vocabulary' %}
              <i class="fas fa-book"></i> {{ _('Словарь') }}
            {% elif lesson.type == 'grammar' %}
              <i class="fas fa-pen"></i> {{ _('Грамматика') }}
            {% elif lesson.type == 'quiz' %}
              <i class="fas fa-question-circle"></i> {{ _('Викторина') }}
            {% elif lesson.type == 'matching' %}
              <i class="fas fa-random"></i> {{ _('Сопоставление') }}
            {% elif lesson.type == 'text' %}
              <i class="fas fa-file-alt"></i> {{ _('Чтение') }}
            {% elif lesson.type == 'card' or lesson.type == 'anki_cards' %}
              <i class="fas fa-clone"></i> {{ _('Карточки') }}
            {% elif lesson.type == 'checkpoint' %}
              <i class="fas fa-flag-checkered"></i> {{ _('Контрольная точка') }}
            {% endif %}
          </div>
          <h3 class="lesson-title">{{ lesson.title }}</h3>
          {% if lesson.id in user_lesson_progress and user_lesson_progress[lesson.id].score %}
            <div class="lesson-score">
              <i class="fas fa-star"></i> {{ user_lesson_progress[lesson.id].score|round }}%
            </div>
          {% endif %}
        </div>

        <div class="lesson-action">
          {% if is_available %}
            <a href="/learn/{{ lesson.id }}/"
               class="btn {{ 'btn-success' if is_completed else 'btn-primary' if is_current else 'btn-outline-primary' }}">
              {% if is_completed %}
                {{ _('Повторить') }}
              {% elif is_current or is_in_progress %}
                {{ _('Продолжить') }}
              {% else %}
                {{ _('Начать') }}
              {% endif %}
            </a>
          {% else %}
            <span class="text-muted">{{ _('Заблокировано') }}</span>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Навигация -->
  <div class="module-navigation mt-5">
    <a href="/learn/{{ module.level.code|lower }}/"
       class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>{{ _('К модулям') }}
    </a>

    {% if counter.completed == lessons|length and lessons|length > 0 %}
      <div class="completion-message">
        <i class="fas fa-trophy text-warning me-2"></i>
        <span>{{ _('Поздравляем! Вы завершили все уроки в этом модуле.') }}</span>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

