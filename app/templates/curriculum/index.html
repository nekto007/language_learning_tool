{% extends "base.html" %}

{% block title %}{{ _('–û–±—É—á–µ–Ω–∏–µ') }}{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Hero Section: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –≥–ª–∞–≤–Ω–∞—è CTA -->
  {% if current_user.is_authenticated %}
    <div class="hero-section mb-3">
      <div class="hero-content">
        <div class="hero-greeting">
          <h1>üëã –ü—Ä–∏–≤–µ—Ç, {{ current_user.name or current_user.username }}!</h1>
        </div>
      </div>

      <!-- Gamification Stats -->
      {% if gamification %}
        <div class="gamification-stats">
          <div class="stat-card streak">
            <div class="stat-icon">üî•</div>
            <div class="stat-value">{{ gamification.streak }}</div>
            <div class="stat-label">{{ '–¥–µ–Ω—å' if gamification.streak == 1 else '–¥–Ω—è' if gamification.streak < 5 else '–¥–Ω–µ–π' }} –ø–æ–¥—Ä—è–¥</div>
          </div>

          <div class="stat-card points">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-value">{{ gamification.total_points }}</div>
            <div class="stat-label">–æ—á–∫–æ–≤</div>
          </div>

          <div class="stat-card level">
            <div class="stat-icon">üéØ</div>
            <div class="stat-value">{{ total_stats.progress_percent }}%</div>
            <div class="stat-label">–ø—Ä–æ–π–¥–µ–Ω–æ</div>
          </div>

          <div class="stat-card daily">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value">{{ gamification.daily_progress }}/{{ gamification.daily_goal }}</div>
            <div class="stat-label">—É—Ä–æ–∫–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}

  <!-- Learning Levels -->
  <div class="section-card mb-4">
    <div class="section-header">
      <h2>üìö {{ _('–£—Ä–æ–≤–Ω–∏ –æ–±—É—á–µ–Ω–∏—è') }}</h2>
      <p class="section-subtitle">{{ _('–í—ã–±–µ—Ä–∏ —Å–≤–æ–π —É—Ä–æ–≤–µ–Ω—å –∏ –Ω–∞—á–Ω–∏ –æ–±—É—á–µ–Ω–∏–µ') }}</p>
    </div>
    <div class="section-content">
      {% if levels_data %}
        <div class="levels-list">
          {% for level_data in levels_data %}
            {% set is_current = level_data.progress_percent and 0 < level_data.progress_percent < 100 %}
            {% set is_completed = level_data.progress_percent and level_data.progress_percent == 100 %}
            {% set is_new = level_data.progress_percent == 0 %}
            {% set is_next = loop.index0 > 0 and levels_data[loop.index0 - 1].progress_percent == 100 and is_new %}
            {% set should_show = is_current or is_next or (is_completed and loop.index == levels_data|length) %}

            <div class="level-card {{ 'current' if is_current else 'completed' if is_completed else 'new' }}"
                 style="{{ 'display: none;' if not should_show else '' }}"
                 data-level-card>
              <div class="level-header">
                <div class="level-badge level-{{ level_data.level.code[0]|lower }}">
                  {{ level_data.level.code }}
                </div>
                <div class="level-title">
                  <h3>{{ level_data.level.name }}</h3>
                  <span class="level-desc">{{ level_data.level.description }}</span>
                </div>

                <!-- Stats inline -->
                <div class="level-stat">
                  <span class="level-stat-icon">üìä</span>
                  <span class="level-stat-value">{{ level_data.completed_lessons }}/{{ level_data.total_lessons }}</span>
                  <span class="level-stat-label">—É—Ä–æ–∫–æ–≤</span>
                </div>

                {% if level_data.estimated_hours > 0 %}
                  <div class="level-stat">
                    <span class="level-stat-icon">‚è±Ô∏è</span>
                    <span class="level-stat-value">~{{ level_data.estimated_hours }} —á</span>
                    <span class="level-stat-label">–¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</span>
                  </div>
                {% endif %}

                {% if level_data.progress_percent > 0 %}
                  <div class="level-stat">
                    <span class="level-stat-icon">üéØ</span>
                    <span class="level-stat-value">{{ level_data.progress_percent }}%</span>
                    <span class="level-stat-label">–ø—Ä–æ–≥—Ä–µ—Å—Å</span>
                  </div>
                {% endif %}

                {% if is_completed %}
                  <div class="level-status-badge completed">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω</div>
                {% elif is_current %}
                  <div class="level-status-badge current">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                {% endif %}

                <!-- Action buttons -->
                {% if is_current and recent_activity %}
                  <!-- Special button for current level with recent activity -->
                  <a href="{{ get_lesson_url(recent_activity[0]['lesson']) }}"
                     class="btn-level btn-primary">
                    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Ä–æ–∫: {{ recent_activity[0]['lesson'].title }} ‚Üí
                  </a>
                {% elif level_data.next_lesson and (is_current or is_new) %}
                  <a href="{{ get_lesson_url(level_data.next_lesson) }}"
                     class="btn-level btn-primary">
                    {% if is_current %}–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí{% else %}–ù–∞—á–∞—Ç—å ‚Üí{% endif %}
                  </a>
                {% else %}
                  <a href="/learn/{{ level_data.level.code|lower }}/"
                     class="btn-level {{ 'btn-primary' if is_current or is_new else 'btn-secondary' }}">
                    {% if is_current %}–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí{% elif is_completed %}–ü–æ–≤—Ç–æ—Ä–∏—Ç—å{% else %}–ù–∞—á–∞—Ç—å ‚Üí{% endif %}
                  </a>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Show All Levels Toggle -->
        <div style="text-align: center; margin-top: var(--space-4);">
          <button id="toggleLevelsBtn" class="btn-level btn-outline" onclick="toggleAllLevels()" style="display: inline-block;">
            <span id="toggleText">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —É—Ä–æ–≤–Ω–∏</span>
          </button>
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">üìö</div>
          <h4>{{ _('–£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã') }}</h4>
          <p>{{ _('–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—É—Ä—Å–∞') }}</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Recent Activity (Compact) -->
  {% if current_user.is_authenticated and recent_activity and recent_activity|length > 1 %}
    <div class="section-card">
      <div class="section-header">
        <h2>üìù {{ _('–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å') }}</h2>
      </div>
      <div class="section-content p-0">
        <div class="activity-list">
          {% for activity in recent_activity[:5] %}
            <a href="{{ get_lesson_url(activity.lesson) }}" class="activity-item activity-link">
              <div class="activity-dot {{ 'completed' if activity.status == 'completed' else 'in-progress' }}"></div>
              <div class="activity-info">
                <div class="activity-title">{{ activity.lesson.title }}</div>
                <div class="activity-meta">
                  {{ activity.level.code }} ‚Ä¢ {{ _('–ú–æ–¥—É–ª—å') }} {{ activity.module.number }} ‚Ä¢
                  {{ activity.last_activity.strftime('%d.%m %H:%M') }}
                </div>
              </div>
              {% if activity.score %}
                <div class="activity-score">{{ activity.score }}%</div>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
</div>

<script>
let allLevelsVisible = false;

function toggleAllLevels() {
  const levelCards = document.querySelectorAll('[data-level-card]');
  const toggleBtn = document.getElementById('toggleText');

  allLevelsVisible = !allLevelsVisible;

  levelCards.forEach(card => {
    if (allLevelsVisible) {
      card.style.display = '';
    } else {
      // Hide cards that were originally hidden
      const isHidden = card.style.display === 'none' || card.getAttribute('data-originally-hidden') === 'true';
      if (!card.classList.contains('current') &&
          !(card.nextElementSibling && card.classList.contains('new'))) {
        card.style.display = 'none';
      }
    }
  });

  toggleBtn.textContent = allLevelsVisible ? '–°–∫—Ä—ã—Ç—å —É—Ä–æ–≤–Ω–∏' : '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —É—Ä–æ–≤–Ω–∏';
}

// Mark originally hidden cards on page load
document.addEventListener('DOMContentLoaded', function() {
  const levelCards = document.querySelectorAll('[data-level-card]');
  levelCards.forEach(card => {
    if (card.style.display === 'none') {
      card.setAttribute('data-originally-hidden', 'true');
    }
  });
});
</script>
{% endblock %}

