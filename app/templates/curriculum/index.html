{% extends "base.html" %}

{% block title %}{{ _('–û–±—É—á–µ–Ω–∏–µ') }}{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Hero Section: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –≥–ª–∞–≤–Ω–∞—è CTA -->
  {% if current_user.is_authenticated %}
    <div class="hero-section mb-3">
      <div class="hero-content">
        <div class="hero-greeting">
          <h1>üëã –ü—Ä–∏–≤–µ—Ç, {{ current_user.name or current_user.username }}!</h1>
        </div>
      </div>

      <!-- Gamification Stats -->
      {% if gamification %}
        <div class="gamification-stats">
          <div class="stat-card streak">
            <div class="stat-icon">üî•</div>
            <div class="stat-value">{{ gamification.streak }}</div>
            <div class="stat-label">{{ '–¥–µ–Ω—å' if gamification.streak == 1 else '–¥–Ω—è' if gamification.streak < 5 else '–¥–Ω–µ–π' }} –ø–æ–¥—Ä—è–¥</div>
          </div>

          <div class="stat-card points">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-value">{{ gamification.total_points }}</div>
            <div class="stat-label">–æ—á–∫–æ–≤</div>
          </div>

          <div class="stat-card level">
            <div class="stat-icon">üéØ</div>
            <div class="stat-value">{{ total_stats.progress_percent }}%</div>
            <div class="stat-label">–ø—Ä–æ–π–¥–µ–Ω–æ</div>
          </div>

          <div class="stat-card daily">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value">{{ gamification.daily_progress }}/{{ gamification.daily_goal }}</div>
            <div class="stat-label">—É—Ä–æ–∫–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}

  <!-- Learning Modules -->
  <div class="section-card mb-4">
    <div class="section-header">
      <h2>üìö {{ _('–ú–æ–¥—É–ª–∏ –æ–±—É—á–µ–Ω–∏—è') }}</h2>
      <p class="section-subtitle">{{ _('–í—ã–±–µ—Ä–∏ –º–æ–¥—É–ª—å –∏ –Ω–∞—á–Ω–∏ –æ–±—É—á–µ–Ω–∏–µ') }}</p>
    </div>
    <div class="section-content">
      {% if levels_data %}
        <div class="modules-list">
          {% for level_data in levels_data %}
            {% for module_data in level_data.modules %}
              {# Check module availability #}
              {% set is_module_available = module_data.is_available %}
              {# Check if module has any in_progress or available lessons #}
              {% set has_in_progress = module_data.lessons | selectattr('status', 'equalto', 'in_progress') | list | length > 0 %}
              {% set has_available = module_data.lessons | selectattr('status', 'equalto', 'available') | list | length > 0 %}
              {% set is_current = is_module_available and (has_in_progress or has_available or (module_data.progress_percent > 0 and module_data.progress_percent < 100)) %}
              {% set is_completed = module_data.progress_percent == 100 %}
              {% set is_new = module_data.progress_percent == 0 and not has_in_progress and not has_available %}
              {% set is_locked = not is_module_available %}

              <div class="module-card-main {{ 'locked' if is_locked else 'current' if is_current else 'completed' if is_completed else 'new' }}">
                <div class="module-header-main" onclick="{{ '' if is_locked else 'toggleModule(\'module-' ~ module_data.module.id ~ '\')' }}">
                  <div class="module-number">{{ module_data.module.number }}</div>
                  <div class="module-info">
                    <h3>{{ module_data.module.title }}</h3>
                    <p>{{ is_locked and '–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–¥—É–ª—å —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' or module_data.module.description }}</p>
                  </div>

                  <!-- Stats inline -->
                  {% if not is_locked %}
                  <div class="module-stat">
                    <span class="module-stat-icon">üìä</span>
                    <span class="module-stat-value">{{ module_data.completed_lessons }}/{{ module_data.total_lessons }}</span>
                    <span class="module-stat-label">—É—Ä–æ–∫–æ–≤</span>
                  </div>

                  {% if module_data.progress_percent > 0 %}
                    <div class="module-stat">
                      <span class="module-stat-icon">üéØ</span>
                      <span class="module-stat-value">{{ module_data.progress_percent }}%</span>
                      <span class="module-stat-label">–ø—Ä–æ–≥—Ä–µ—Å—Å</span>
                    </div>
                  {% endif %}
                  {% endif %}

                  {% if is_locked %}
                    <div class="module-status-badge locked">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</div>
                  {% elif is_completed %}
                    <div class="module-status-badge completed">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω</div>
                  {% elif is_current %}
                    <div class="module-status-badge current">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                  {% endif %}

                  <!-- Expand/Collapse icon -->
                  {% if not is_locked %}
                  <div class="expand-icon">
                    <span class="icon-collapsed" style="display:{{ 'none' if is_current else 'inline' }};">‚ñº</span>
                    <span class="icon-expanded" style="display:{{ 'inline' if is_current else 'none' }};">‚ñ≤</span>
                  </div>
                  {% endif %}
                </div>

                <!-- Lessons List -->
                <div class="module-lessons-main" id="module-{{ module_data.module.id }}" style="display:{{ 'block' if is_current else 'none' }};">
                  {% for lesson_data in module_data.lessons %}
                    {% set is_locked = lesson_data.status == 'locked' %}
                    {% set is_completed = lesson_data.status == 'completed' %}
                    {% set is_current = lesson_data.status == 'in_progress' %}
                    {% set is_available = lesson_data.status == 'available' %}

                    <div class="lesson-item {{ lesson_data.status }}">
                      <div class="lesson-number">{{ lesson_data.lesson.number }}</div>
                      <div class="lesson-info">
                        <div class="lesson-title">{{ lesson_data.lesson.title }}</div>
                        <div class="lesson-type">{{ lesson_data.lesson.type }}</div>
                      </div>
                      <div class="lesson-status">
                        {% if is_completed %}
                          <span class="status-icon completed">‚úì</span>
                        {% elif is_current %}
                          <span class="status-icon current">‚ñ∂</span>
                        {% elif is_locked %}
                          <span class="status-icon locked">üîí</span>
                        {% else %}
                          <span class="status-icon available">‚óã</span>
                        {% endif %}
                      </div>
                      {% if not is_locked %}
                        <a href="{{ get_lesson_url(lesson_data.lesson) }}" class="lesson-link">
                          {% if is_completed %}
                            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                          {% elif is_current %}
                            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                          {% else %}
                            –ù–∞—á–∞—Ç—å
                          {% endif %}
                        </a>
                      {% else %}
                        <span class="lesson-locked">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">üìö</div>
          <h4>{{ _('–£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã') }}</h4>
          <p>{{ _('–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—É—Ä—Å–∞') }}</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Recent Activity (Compact) -->
  {% if current_user.is_authenticated and recent_activity and recent_activity|length > 1 %}
    <div class="section-card">
      <div class="section-header">
        <h2>üìù {{ _('–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å') }}</h2>
      </div>
      <div class="section-content p-0">
        <div class="activity-list">
          {% for activity in recent_activity[:5] %}
            <a href="{{ get_lesson_url(activity.lesson) }}" class="activity-item activity-link">
              <div class="activity-dot {{ 'completed' if activity.status == 'completed' else 'in-progress' }}"></div>
              <div class="activity-info">
                <div class="activity-title">{{ activity.lesson.title }}</div>
                <div class="activity-meta">
                  {{ activity.level.code }} ‚Ä¢ {{ _('–ú–æ–¥—É–ª—å') }} {{ activity.module.number }} ‚Ä¢
                  {{ activity.last_activity.strftime('%d.%m %H:%M') }}
                </div>
              </div>
              {% if activity.score %}
                <div class="activity-score">{{ activity.score|round(1) }}%</div>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
</div>

<script>
let allLevelsVisible = false;

function toggleLevel(levelId) {
  const content = document.getElementById(levelId);
  const header = content.previousElementSibling;
  const iconCollapsed = header.querySelector('.expand-icon .icon-collapsed');
  const iconExpanded = header.querySelector('.expand-icon .icon-expanded');

  if (content.style.display === 'none' || content.style.display === '') {
    content.style.display = 'block';
    iconCollapsed.style.display = 'none';
    iconExpanded.style.display = 'inline';
  } else {
    content.style.display = 'none';
    iconCollapsed.style.display = 'inline';
    iconExpanded.style.display = 'none';
  }
}

function toggleModule(moduleId) {
  const content = document.getElementById(moduleId);
  const header = content.previousElementSibling;
  const iconCollapsed = header.querySelector('.expand-icon .icon-collapsed');
  const iconExpanded = header.querySelector('.expand-icon .icon-expanded');

  if (content.style.display === 'none' || content.style.display === '') {
    content.style.display = 'block';
    iconCollapsed.style.display = 'none';
    iconExpanded.style.display = 'inline';

    // Auto-scroll to first non-completed lesson
    setTimeout(() => {
      const firstActiveLesson = content.querySelector('.lesson-item.in_progress, .lesson-item.available');
      if (firstActiveLesson) {
        firstActiveLesson.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }
    }, 100);
  } else {
    content.style.display = 'none';
    iconCollapsed.style.display = 'inline';
    iconExpanded.style.display = 'none';
  }
}

function toggleAllLevels() {
  const levelCards = document.querySelectorAll('[data-level-card]');
  const toggleBtn = document.getElementById('toggleText');

  allLevelsVisible = !allLevelsVisible;

  levelCards.forEach(card => {
    if (allLevelsVisible) {
      card.style.display = '';
    } else {
      // Hide cards that were originally hidden
      const isHidden = card.style.display === 'none' || card.getAttribute('data-originally-hidden') === 'true';
      if (!card.classList.contains('current') &&
          !(card.nextElementSibling && card.classList.contains('new'))) {
        card.style.display = 'none';
      }
    }
  });

  toggleBtn.textContent = allLevelsVisible ? '–°–∫—Ä—ã—Ç—å —É—Ä–æ–≤–Ω–∏' : '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —É—Ä–æ–≤–Ω–∏';
}

// Mark originally hidden cards on page load
document.addEventListener('DOMContentLoaded', function() {
  const levelCards = document.querySelectorAll('[data-level-card]');
  levelCards.forEach(card => {
    if (card.style.display === 'none') {
      card.setAttribute('data-originally-hidden', 'true');
    }
  });
});
</script>
{% endblock %}

