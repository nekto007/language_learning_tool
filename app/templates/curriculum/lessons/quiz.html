{% extends "lesson_base_template.html" %}

{% set component_name = _('–í–∏–∫—Ç–æ—Ä–∏–Ω–∞') %}
{% set instruction_text = _('–û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ–¥–Ω–æ–º—É. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.') %}
{% set block_description = _('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã') %}
{% set show_score = true %}

{% macro format_answer(answer, question) %}
  {% if question.type == 'multiple_choice' %}
    {# –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç - –∏–Ω–¥–µ–∫—Å, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ç–µ–∫—Å—Ç –æ–ø—Ü–∏–∏ #}
    {% if answer is number or (answer|string).isdigit() %}
      {{ question.options[answer|int] }}
    {% else %}
      {{ answer }}
    {% endif %}
  {% elif question.type == 'true_false' %}
    {# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º true/false –≤ —Ä—É—Å—Å–∫–∏–π #}
    {% if answer == 'true' or answer == true %}
      –ü—Ä–∞–≤–¥–∞
    {% elif answer == 'false' or answer == false %}
      –õ–æ–∂—å
    {% else %}
      {{ answer }}
    {% endif %}
  {% else %}
    {{ answer }}
  {% endif %}
{% endmacro %}

{% block lesson_content %}
{% set previous_data = None %}
{% set previous_feedback = {} %}
{% set is_completed = False %}
{% if progress and progress.data %}
  {% set previous_data = progress.data %}
  {% set previous_feedback = previous_data.get('feedback', {}) %}
  {% set is_completed = progress.status == 'completed' %}
{% endif %}

<div class="quiz-lesson">
  {% if is_completed and previous_data %}
    <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="quiz-results-compact">
      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫ -->
      <div class="quiz-stats-cards">
        <div class="stat-card points">
          <div class="stat-icon">‚≠ê</div>
          <div class="stat-value">{{ previous_data.get('points_earned', (previous_data.correct_count * 10))|int }}</div>
          <div class="stat-label">–æ—á–∫–æ–≤</div>
        </div>

        <div class="stat-card percentage">
          <div class="stat-icon">üéØ</div>
          <div class="stat-value">{{ previous_data.score|round(0)|int }}%</div>
          <div class="stat-label">–ø—Ä–∞–≤–∏–ª—å–Ω–æ</div>
        </div>

        {% if previous_data.get('time_spent') %}
        <div class="stat-card time">
          <div class="stat-icon">‚è±Ô∏è</div>
          <div class="stat-value">{{ previous_data.time_spent }}—Å</div>
          <div class="stat-label">–≤—Ä–µ–º—è</div>
        </div>
        {% endif %}
      </div>

      <!-- –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
      {% set errors = [] %}
      {% for question in questions %}
        {% set q_idx = loop.index0|string %}
        {% set feedback = previous_feedback.get(q_idx, {}) %}
        {% if feedback.status != 'correct' %}
          {% set _ = errors.append((loop.index, question, feedback)) %}
        {% endif %}
      {% endfor %}

      {% if errors|length > 0 %}
      <div class="errors-section">
        <h3 class="section-title">‚ùå –û—à–∏–±–∫–∏ ({{ errors|length }})</h3>
        {% for idx, question, feedback in errors %}
          <div class="error-item">
            <div class="error-header">
              <span class="q-num">‚Ññ{{ idx }}</span>
              <span class="q-text">{{ (question.text or question.question or question.prompt)[:80] }}{% if (question.text or question.question or question.prompt)|length > 80 %}...{% endif %}</span>
            </div>
            <div class="error-answers">
              <div class="wrong">‚ùå {{ format_answer(feedback.user_answer, question) }}</div>
              <div class="correct">‚úì {{ format_answer(feedback.correct_answer, question) }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
      {% else %}
        <div class="perfect-score">üéâ –û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ!</div>
      {% endif %}

      <!-- –û–ø—Ü–∏—è –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã -->
      <details class="all-answers-toggle">
        <summary>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã ({{ questions|length }})</summary>
        <div class="all-answers">
          {% for question in questions %}
            {% set q_idx = loop.index0|string %}
            {% set feedback = previous_feedback.get(q_idx, {}) %}
            <div class="answer-item {% if feedback.status == 'correct' %}correct{% else %}incorrect{% endif %}">
              <span class="num">{{ loop.index }}.</span>
              <span class="status">{% if feedback.status == 'correct' %}‚úì{% else %}‚ùå{% endif %}</span>
              <span class="question">{{ question.text or question.question or question.prompt }}</span>
              <span class="your-answer">{{ format_answer(feedback.user_answer, question) }}</span>
            </div>
          {% endfor %}
        </div>
      </details>
    </div>

  {% else %}
    <!-- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞ -->
    <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
    <div class="quiz-screen" id="start-screen">
      <div class="quiz-start-content">
        <div class="quiz-icon">
          <i class="fas fa-question-circle"></i>
        </div>
        <h2>{{ _('–ì–æ—Ç–æ–≤—ã –∫ –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ?') }}</h2>
        <p class="text-muted mb-4">
          {{ _('–í —ç—Ç–æ–π –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ') }} <strong>{{ questions|length }}</strong> {{ _('–≤–æ–ø—Ä–æ—Å–æ–≤') }}.<br>
          {{ _('–û—Ç–≤–µ—á–∞–π—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.') }}
        </p>
        <button type="button" class="btn btn-primary btn-lg" id="start-quiz-btn">
          <i class="fas fa-play"></i> {{ _('–ù–∞—á–∞—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É') }}
        </button>
      </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –≤–æ–ø—Ä–æ—Å–æ–≤ -->
    <div class="quiz-screen" id="quiz-screen" style="display: none;">
      <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã -->
      <div class="quiz-progress-section mb-4">
        <div class="progress-info">
          <span>{{ _('–í–æ–ø—Ä–æ—Å') }} <span id="current-num">1</span> {{ _('–∏–∑') }} {{ questions|length }}</span>
        </div>
        <div class="quiz-progress-bar">
          <div class="quiz-progress-fill" id="quiz-progress-bar" style="width: 0%"></div>
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ -->
      <div class="questions-container">
        {% for question in questions %}
          {% set question_index = loop.index0 %}
          <div class="question-card" id="question-{{ question_index }}" style="display: none;" data-index="{{ question_index }}">
            <h3 class="question-text">{{ question.text or question.question or question.prompt }}</h3>

            {% if question.type == 'multiple_choice' %}
              <div class="answer-options">
                {% for option in question.options %}
                  <button type="button"
                          class="answer-option"
                          data-question="{{ question_index }}"
                          data-value="{{ loop.index0 }}"
                          data-text="{{ option }}">
                    <span class="option-letter">{{ 'ABCD'[loop.index0] }}</span>
                    <span class="option-text">{{ option }}</span>
                  </button>
                {% endfor %}
              </div>

            {% elif question.type == 'true_false' %}
              <div class="answer-options">
                <button type="button"
                        class="answer-option"
                        data-question="{{ question_index }}"
                        data-value="true">
                  <span class="option-letter">T</span>
                  <span class="option-text">{{ _('–ü—Ä–∞–≤–¥–∞') }}</span>
                </button>
                <button type="button"
                        class="answer-option"
                        data-question="{{ question_index }}"
                        data-value="false">
                  <span class="option-letter">F</span>
                  <span class="option-text">{{ _('–õ–æ–∂—å') }}</span>
                </button>
              </div>

            {% elif question.type in ['fill_in_blank', 'translation'] %}
              <div class="text-answer">
                <input type="text"
                       class="form-control"
                       id="text-answer-{{ question_index }}"
                       placeholder="{{ _('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç...') }}">
                <button type="button"
                        class="btn btn-primary mt-3 text-submit-btn"
                        data-question="{{ question_index }}">
                  {{ _('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç') }}
                </button>
              </div>

            {% elif question.type == 'reorder' %}
              <div class="reorder-answer">
                <div class="words-container" id="words-container-{{ question_index }}">
                  {% for word in question.words %}
                    <button type="button" 
                            class="word-button" 
                            data-word="{{ word }}"
                            onclick="addWordToSentence({{ question_index }}, '{{ word }}', this)">
                      {{ word }}
                    </button>
                  {% endfor %}
                </div>
                <div class="sentence-container">
                  <div class="sentence-display" id="sentence-{{ question_index }}" 
                       onclick="clearSentence({{ question_index }})">
                    <span class="placeholder-text">{{ _('–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–ª–æ–≤–∞ –≤—ã—à–µ, —á—Ç–æ–±—ã —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ') }}</span>
                  </div>
                </div>
                <button type="button"
                        class="btn btn-primary mt-3 reorder-submit-btn"
                        data-question="{{ question_index }}"
                        onclick="submitReorderAnswer({{ question_index }})">
                  {{ _('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç') }}
                </button>
              </div>
            {% endif %}

            <!-- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å -->
            <div class="question-feedback" id="feedback-{{ question_index }}" style="display: none;">
              <div class="feedback-content">
                <div class="feedback-icon"></div>
                <div class="feedback-text"></div>
                <button type="button" class="btn btn-primary mt-3" onclick="QuizApp.nextQuestion()">
                  <span class="btn-text">{{ _('–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å') }}</span>
                  <i class="fas fa-arrow-right ms-2"></i>
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% endif %}
</div>

<script>
window.quizData = {
  questions: {{ questions|tojson|safe }},
  totalQuestions: {{ questions|length }},
  isCompleted: {{ is_completed|tojson|safe }}
};

// Quiz data is loaded

function retryQuiz() {
  if (confirm('{{ _("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–π—Ç–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –∑–∞–Ω–æ–≤–æ? –¢–µ–∫—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã.") }}')) {
    window.location.href = '{{ url_for("curriculum_lessons.quiz_lesson", lesson_id=lesson.id, reset="true") }}';
  }
}

// Reorder question functions
function addWordToSentence(questionIndex, word, button) {
  const sentenceDiv = document.getElementById(`sentence-${questionIndex}`);
  const placeholder = sentenceDiv.querySelector('.placeholder-text');
  
  // Remove placeholder if it exists
  if (placeholder) {
    placeholder.remove();
  }
  
  // Create word element
  const wordElement = document.createElement('span');
  wordElement.className = 'sentence-word';
  wordElement.textContent = word;
  wordElement.onclick = () => removeWordFromSentence(wordElement, button);
  
  // Add word to sentence
  sentenceDiv.appendChild(wordElement);
  
  // Add space after word (except for punctuation)
  if (!word.match(/[.,!?;:]/)) {
    const space = document.createElement('span');
    space.textContent = ' ';
    space.className = 'word-space';
    sentenceDiv.appendChild(space);
  }
  
  // Disable the word button
  button.disabled = true;
  button.classList.add('used');
}

function removeWordFromSentence(wordElement, originalButton) {
  // Re-enable the original button
  originalButton.disabled = false;
  originalButton.classList.remove('used');
  
  // Remove the word and any trailing space
  const nextElement = wordElement.nextSibling;
  if (nextElement && nextElement.classList && nextElement.classList.contains('word-space')) {
    nextElement.remove();
  }
  wordElement.remove();
  
  // Add placeholder if sentence is empty
  const sentenceDiv = wordElement.parentElement;
  if (!sentenceDiv.textContent.trim()) {
    const placeholder = document.createElement('span');
    placeholder.className = 'placeholder-text';
    placeholder.textContent = '{{ _("–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–ª–æ–≤–∞ –≤—ã—à–µ, —á—Ç–æ–±—ã —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ") }}';
    sentenceDiv.appendChild(placeholder);
  }
}

function clearSentence(questionIndex) {
  const sentenceDiv = document.getElementById(`sentence-${questionIndex}`);
  const wordsContainer = document.getElementById(`words-container-${questionIndex}`);
  
  // Re-enable all word buttons
  const wordButtons = wordsContainer.querySelectorAll('.word-button');
  wordButtons.forEach(button => {
    button.disabled = false;
    button.classList.remove('used');
  });
  
  // Clear sentence and add placeholder
  sentenceDiv.innerHTML = '<span class="placeholder-text">{{ _("–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–ª–æ–≤–∞ –≤—ã—à–µ, —á—Ç–æ–±—ã —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ") }}</span>';
}

function submitReorderAnswer(questionIndex) {
  const sentenceDiv = document.getElementById(`sentence-${questionIndex}`);
  const placeholder = sentenceDiv.querySelector('.placeholder-text');
  
  if (placeholder) {
    // No sentence formed
    sentenceDiv.classList.add('error');
    setTimeout(() => sentenceDiv.classList.remove('error'), 1000);
    return;
  }
  
  // Get the formed sentence
  const sentence = sentenceDiv.textContent.trim();
  
  // Store the answer in QuizApp state
  QuizApp.state.answers[questionIndex] = {
    value: sentence,
    text: sentence,
    correct: false // Will be determined in showFeedback
  };
  
  // Get correct answer and check
  const question = window.quizData.questions[questionIndex];
  const correctAnswer = question.correct_answer;
  
  // Normalize for comparison
  const normalize = (text) => text.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim();
  const isCorrect = normalize(sentence) === normalize(correctAnswer);
  
  QuizApp.state.answers[questionIndex].correct = isCorrect;
  if (isCorrect) QuizApp.state.correctCount++;
  
  // Disable all word buttons
  const wordsContainer = document.getElementById(`words-container-${questionIndex}`);
  const wordButtons = wordsContainer.querySelectorAll('.word-button');
  wordButtons.forEach(button => button.disabled = true);
  
  // Disable submit button
  const submitBtn = document.querySelector(`.reorder-submit-btn[data-question="${questionIndex}"]`);
  submitBtn.disabled = true;
  
  QuizApp.showFeedback(questionIndex, isCorrect, correctAnswer);
}

// –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
window.QuizApp = {
  state: {
    currentQuestion: 0,
    answers: [],
    correctCount: 0,
    started: false
  },

  init() {
    if (window.quizData.isCompleted) return;

    document.getElementById('start-quiz-btn')?.addEventListener('click', () => this.startQuiz());

    document.querySelectorAll('.answer-option').forEach(btn => {
      btn.addEventListener('click', (e) => this.selectAnswer(e.target.closest('.answer-option')));
    });

    document.querySelectorAll('.text-submit-btn').forEach(btn => {
      btn.addEventListener('click', () => this.submitTextAnswer(parseInt(btn.dataset.question)));
    });
  },

  startQuiz() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('quiz-screen').style.display = 'block';
    this.state.started = true;
    this.state.currentQuestion = 0;
    this.updateProgress();
    this.showQuestion(0);
  },

  showQuestion(index) {
    document.querySelectorAll('.question-card').forEach(card => card.style.display = 'none');
    const currentCard = document.getElementById(`question-${index}`);
    if (currentCard) {
      currentCard.style.display = 'block';
      currentCard.querySelectorAll('.answer-option').forEach(btn => {
        btn.classList.remove('selected', 'correct', 'incorrect');
        btn.disabled = false;
      });
      const textarea = currentCard.querySelector('input[type="text"]');
      if (textarea) {
        textarea.value = '';
        textarea.disabled = false;
      }
      document.getElementById(`feedback-${index}`).style.display = 'none';
      this.updateProgress();
    }
  },

  selectAnswer(button) {
    const questionIndex = parseInt(button.dataset.question);
    const value = button.dataset.value;
    const text = button.dataset.text || value;

    button.closest('.answer-options').querySelectorAll('.answer-option').forEach(btn => {
      btn.disabled = true;
    });

    const question = window.quizData.questions[questionIndex];
    
    // Get correct answer from various possible fields
    let correctAnswer = null;
    if (question.correct_index !== undefined) {
      correctAnswer = question.correct_index;
    } else if (question.correct !== undefined) {
      correctAnswer = question.correct;
    } else if (question.answer !== undefined) {
      correctAnswer = question.answer;
    } else if (question.correct_answer !== undefined) {
      correctAnswer = question.correct_answer;
    }
    
    // Debug logging (can be removed in production)
    
    let isCorrect = false;
    
    if (question.type === 'true_false') {
      // For true/false questions
      if (typeof correctAnswer === 'boolean') {
        isCorrect = (value === 'true') === correctAnswer;
      } else if (typeof correctAnswer === 'string') {
        isCorrect = value === correctAnswer;
      } else {
        isCorrect = (value === 'true') === (correctAnswer == true);
      }
    } else if (question.type === 'multiple_choice') {
      // For multiple choice questions
      const userIndex = parseInt(value);
      
      // If correctAnswer is the actual text of the correct option
      if (typeof correctAnswer === 'string' && !correctAnswer.match(/^\d+$/)) {
        // Find the index of the correct answer in options
        const correctIndex = question.options.findIndex(opt => opt === correctAnswer);
        isCorrect = userIndex === correctIndex;
        // Correct answer is text, found at index
      } else {
        // correctAnswer is an index (number or string number)
        const correctIndex = typeof correctAnswer === 'string' ? parseInt(correctAnswer) : correctAnswer;
        isCorrect = userIndex === correctIndex;
        // Correct answer is index
      }
    } else {
      // For other question types
      isCorrect = parseInt(value) === correctAnswer;
    }


    // Add visual classes based on correctness
    button.classList.add('selected');
    if (isCorrect) {
      button.classList.add('correct');
      this.state.correctCount++;
    }

    this.state.answers[questionIndex] = {
      value: value,
      text: text,
      correct: isCorrect
    };
    

    this.showFeedback(questionIndex, isCorrect, correctAnswer);
  },

  submitTextAnswer(questionIndex) {
    const input = document.getElementById(`text-answer-${questionIndex}`);
    const answer = input.value.trim();

    if (!answer) {
      input.classList.add('is-invalid');
      return;
    }

    input.disabled = true;
    document.querySelector(`.text-submit-btn[data-question="${questionIndex}"]`).disabled = true;

    const question = window.quizData.questions[questionIndex];
    
    // Get correct answer from various possible fields
    let correctAnswer = question.correct_answer || question.answer;
    
    // Normalize text while preserving Cyrillic characters
    const normalize = (text) => {
      if (!text) return '';
      return text.toLowerCase()
        .replace(/[^\w\s–∞-—è—ë–ê-–Ø–Å]/g, '') // Include Cyrillic characters
        .replace(/\s+/g, ' ')
        .trim();
    };

    let isCorrect = false;
    if (Array.isArray(correctAnswer)) {
      isCorrect = correctAnswer.some(ans => normalize(ans) === normalize(answer));
    } else {
      isCorrect = normalize(answer) === normalize(correctAnswer);
    }

    if (!isCorrect && question.alternative_answers) {
      isCorrect = question.alternative_answers.some(ans => normalize(ans) === normalize(answer));
    }

    this.state.answers[questionIndex] = {
      value: answer,
      text: answer,
      correct: isCorrect
    };
    

    if (isCorrect) this.state.correctCount++;

    this.showFeedback(questionIndex, isCorrect, correctAnswer);
  },

  showFeedback(questionIndex, isCorrect, correctAnswer) {
    const feedbackEl = document.getElementById(`feedback-${questionIndex}`);
    const iconEl = feedbackEl.querySelector('.feedback-icon');
    const textEl = feedbackEl.querySelector('.feedback-text');

    if (isCorrect) {
      feedbackEl.className = 'question-feedback correct';
      iconEl.innerHTML = '<i class="fas fa-check-circle"></i>';
      textEl.innerHTML = '<strong>{{ _("–ü—Ä–∞–≤–∏–ª—å–Ω–æ!") }}</strong>';
    } else {
      feedbackEl.className = 'question-feedback incorrect';
      iconEl.innerHTML = '<i class="fas fa-times-circle"></i>';

      let correctText = '';
      const question = window.quizData.questions[questionIndex];

      if (question.type === 'multiple_choice' && question.options) {
        // Get the correct option text
        if (typeof correctAnswer === 'number' && correctAnswer >= 0 && correctAnswer < question.options.length) {
          correctText = question.options[correctAnswer];
        } else if (typeof correctAnswer === 'string' && correctAnswer.match(/^\d+$/)) {
          // correctAnswer is a string number
          const index = parseInt(correctAnswer);
          if (index >= 0 && index < question.options.length) {
            correctText = question.options[index];
          } else {
            correctText = correctAnswer;
          }
        } else {
          // correctAnswer is the actual text
          correctText = correctAnswer;
        }
      } else if (question.type === 'true_false') {
        // Convert boolean to text
        if (typeof correctAnswer === 'boolean') {
          correctText = correctAnswer ? '{{ _("–ü—Ä–∞–≤–¥–∞") }}' : '{{ _("–õ–æ–∂—å") }}';
        } else if (typeof correctAnswer === 'string') {
          correctText = (correctAnswer === 'true' || correctAnswer === true) ? '{{ _("–ü—Ä–∞–≤–¥–∞") }}' : '{{ _("–õ–æ–∂—å") }}';
        } else {
          correctText = correctAnswer ? '{{ _("–ü—Ä–∞–≤–¥–∞") }}' : '{{ _("–õ–æ–∂—å") }}';
        }
      } else {
        // For text questions (fill_in_blank, translation)
        if (Array.isArray(correctAnswer)) {
          correctText = correctAnswer.join(' / ');
        } else {
          correctText = correctAnswer || '{{ _("–û—Ç–≤–µ—Ç –Ω–µ —É–∫–∞–∑–∞–Ω") }}';
        }
      }

      textEl.innerHTML = `<strong>{{ _("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ") }}</strong><br>{{ _("–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:") }} <strong>${correctText}</strong>`;
      
      // Add explanation if available
      if (question.explanation) {
        textEl.innerHTML += `<br><br><strong>{{ _("–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:") }}</strong> ${question.explanation}`;
      }
    }

    const isLastQuestion = questionIndex >= window.quizData.totalQuestions - 1;
    feedbackEl.querySelector('.btn-text').textContent = isLastQuestion ? '{{ _("–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã") }}' : '{{ _("–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å") }}';

    feedbackEl.style.display = 'block';
  },

  nextQuestion() {
    this.state.currentQuestion++;
    if (this.state.currentQuestion >= window.quizData.totalQuestions) {
      this.showResults();
    } else {
      this.showQuestion(this.state.currentQuestion);
    }
  },

  updateProgress() {
    const currentNum = this.state.currentQuestion + 1;
    const percent = (currentNum / window.quizData.totalQuestions) * 100;
    document.getElementById('quiz-progress-bar').style.width = percent + '%';
    document.getElementById('current-num').textContent = currentNum;
  },

  showResults() {
    // Instead of showing a separate results screen, submit the results
    this.submitResults();
  },

  submitResults() {
    const score = (this.state.correctCount / window.quizData.totalQuestions) * 100;
    const formData = new FormData();
    const csrfToken = document.querySelector('meta[name="csrf-token"]');


    if (csrfToken) formData.append('csrf_token', csrfToken.content);

    for (let i = 0; i < window.quizData.totalQuestions; i++) {
      const answer = this.state.answers[i];
      if (answer) {
        formData.append(`answer_${i}`, answer.value);
      } else {
      }
    }

    fetch(window.location.href, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show results at the bottom of the page
        this.showResultsAndNavigation(data);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('{{ _("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤") }}');
    });
  },

  showResultsAndNavigation(data) {
    // Hide the quiz screen
    document.getElementById('quiz-screen').style.display = 'none';
    
    // Remove existing results if any
    const existingResults = document.querySelector('.quiz-results-summary');
    if (existingResults) {
      existingResults.remove();
    }
    
    // Create results summary
    const resultsDiv = document.createElement('div');
    resultsDiv.className = 'quiz-results-summary mt-4';
    
    const score = data.score || (this.state.correctCount / window.quizData.totalQuestions) * 100;
    const correctCount = data.correct_count || this.state.correctCount;
    const totalCount = data.total_count || window.quizData.totalQuestions;
    const isPassed = score >= 70;
    
    resultsDiv.innerHTML = `
      <div class="results-summary ${isPassed ? 'success' : 'warning'}">
        <h3>{{ _('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã') }}</h3>
        <div class="score-display">
          <i class="fas fa-${isPassed ? 'trophy' : 'exclamation'}-circle"></i>
          <span class="score-value">${Math.round(score)}%</span>
        </div>
        <p class="score-details">
          {{ _('–ü—Ä–∞–≤–∏–ª—å–Ω–æ') }}: ${correctCount} {{ _('–∏–∑') }} ${totalCount}
        </p>
        ${isPassed ? `
          <div class="feedback-message success">
            <i class="fas fa-check-circle"></i>
            <p>{{ _('–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É.') }}</p>
          </div>
        ` : `
          <div class="feedback-message">
            <i class="fas fa-info-circle"></i>
            <p>{{ _('–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.') }}</p>
          </div>
        `}
      </div>
    `;
    
    // Add results to the page
    const lessonContent = document.querySelector('.lesson-content-wrapper');
    const lessonFooter = document.querySelector('#lesson-footer');
    
    if (lessonContent) {
      if (lessonFooter) {
        lessonContent.insertBefore(resultsDiv, lessonFooter);
      } else {
        lessonContent.appendChild(resultsDiv);
      }
    } else {
      // Fallback: add to quiz lesson container
      const quizLesson = document.querySelector('.quiz-lesson');
      if (quizLesson) {
        quizLesson.appendChild(resultsDiv);
      }
    }
    
    // Scroll to results
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Show navigation buttons with delay to ensure DOM is ready
    setTimeout(() => {
      const retryBtn = document.getElementById('retry-button');
      const nextBtn = document.getElementById('complete-exercise');
      const completeModuleBtn = document.getElementById('complete-module');
      
      // Show retry button
      if (retryBtn) {
        retryBtn.style.display = 'inline-flex';
      } else {
        console.error('Retry button not found in DOM');
      }
      
      // Show next/complete button if passed
      if (isPassed) {
        if (nextBtn) {
          nextBtn.style.display = 'inline-flex';
          nextBtn.disabled = false;
        } else if (completeModuleBtn) {
          completeModuleBtn.style.display = 'inline-flex';
          completeModuleBtn.disabled = false;
        } else {
          console.error('Navigation buttons not found in DOM');
        }
      }
      
      // Force redraw to ensure buttons are visible
      const footer = document.getElementById('lesson-footer');
      if (footer) {
        footer.style.display = 'none';
        footer.offsetHeight; // Force reflow
        footer.style.display = '';
      }
    }, 100); // Small delay to ensure DOM is ready
  }
};

document.addEventListener('DOMContentLoaded', () => {
  QuizApp.init();

  {% if is_completed %}
    const nextBtn = document.getElementById('complete-exercise');
    if (nextBtn) {
      nextBtn.style.display = 'inline-flex';
      nextBtn.disabled = false;
    }
  {% endif %}
});
</script>
{% endblock %}

