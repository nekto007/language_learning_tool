{% extends "lesson_base_template.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/vocabulary-cards.css') }}?v=8">
<style>
/* Modern Card Styles Enhancement */
.vocabulary-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
  border-radius: 1.5rem !important;
  box-shadow: 0 10px 40px rgba(220, 38, 38, 0.12),
              0 2px 8px rgba(0, 0, 0, 0.08) !important;
  border: 2px solid transparent !important;
}

.vocabulary-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: 1.5rem;
  padding: 2px;
  background: linear-gradient(135deg, #dc2626, #ef4444, #f87171);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  opacity: 0.3;
  pointer-events: none;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .vocabulary-card {
    border-radius: 1rem !important;
  }

  .vocabulary-card::before {
    border-radius: 1rem;
  }
}
</style>
{% endblock %}

{% set component_name = _('Словарь') %}
{% set instruction_text = _('Пролистай все карточки и запомни слова') %}
{% set block_description = _('Изучение новых слов') %}

{% block lesson_content %}
<!-- Получаем данные о предыдущей сессии -->
{% set previous_data = None %}
{% set is_completed_raw = false %}
{% if progress %}
  {% if progress.data %}
    {% set previous_data = progress.data %}
  {% endif %}
  {% if progress.status is defined and progress.status is not none %}
    {% set is_completed_raw = (progress.status == 'completed') %}
  {% endif %}
{% endif %}

{# Ensure is_completed is always a boolean #}
{% if is_completed_raw is sameas true %}
  {% set is_completed = true %}
{% else %}
  {% set is_completed = false %}
{% endif %}

<div class="vocabulary-cards-lesson">
  <!-- Progress Header -->
  <div class="cards-progress-header">
    <div class="progress-info" role="status" aria-live="polite" aria-atomic="true">
      <span class="progress-current">{{ _('Карточка') }} <span id="current-card-num">1</span></span>
      <span class="progress-divider">/</span>
      <span class="progress-total">{{ words|length }}</span>
    </div>
    <div class="progress-bar-container" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Прогресс изучения слов">
      <div class="progress-bar-fill" id="cards-progress-bar" style="width: 0%"></div>
    </div>
  </div>

  <!-- Cards Container -->
  <div class="cards-stack-container" id="cards-container">
    {% for word in words %}
    <div class="vocabulary-card" data-word-id="{{ word.id }}" data-index="{{ loop.index0 }}" data-viewed="false">
      <div class="card-inner">
        <!-- Front Side (English) -->
        <div class="card-face card-front">
          <div class="card-content-wrapper">
            <div class="word-english">{{ word.english }}</div>
            {% if word.pronunciation %}
            <div class="word-pronunciation">{{ word.pronunciation }}</div>
            {% endif %}
            {% if word.get('audio_url') %}
            {% set audio_file = word.audio_url.replace('[sound:', '').replace(']', '') if word.audio_url and '[sound:' in word.audio_url else (word.audio_url if word.get('audio_url') else 'pronunciation_en_' + word.english.replace(' ', '_').lower() + '.mp3') %}
            <button class="audio-btn-card" data-audio="{{ url_for('static', filename='audio/' + audio_file) }}" aria-label="Play pronunciation for {{ word.english }}">
              <i class="fas fa-volume-up"></i>
            </button>
            {% endif %}
          </div>
          <div class="card-flip-hint">
            <i class="fas fa-sync-alt"></i>
            {{ _('Нажми, чтобы перевернуть') }}
          </div>
        </div>

        <!-- Back Side (Russian + Example) -->
        <div class="card-face card-back">
          <div class="card-content-wrapper">
            <div class="word-russian">{{ word.russian }}</div>
            {% if word.example %}
            <div class="word-example">
              <div class="example-text">{{ word.example }}</div>
              {% if word.usage or word.example_translation %}
              <div class="example-translation">{{ word.usage or word.example_translation }}</div>
              {% endif %}
            </div>
            {% endif %}
          </div>
          <div class="card-flip-hint">
            <i class="fas fa-sync-alt"></i>
            {{ _('Нажми, чтобы перевернуть') }}
          </div>
        </div>
      </div>

      <!-- Swipe Indicators -->
      <div class="swipe-indicator swipe-left">
        <i class="fas fa-arrow-left"></i>
      </div>
      <div class="swipe-indicator swipe-right">
        <i class="fas fa-arrow-right"></i>
      </div>
    </div>
    {% endfor %}

    <!-- Placeholder when no cards -->
    <div class="no-cards-message" id="no-cards-message" style="display: none;">
      <div class="completion-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3>{{ _('Все карточки просмотрены!') }}</h3>
      <p>{{ _('Отличная работа! Вы изучили все слова урока') }}</p>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="cards-navigation" id="cards-navigation" role="navigation" aria-label="Навигация по карточкам">
    <button class="nav-btn btn-prev" id="btn-prev" disabled aria-label="Предыдущая карточка">
      <i class="fas fa-chevron-left" aria-hidden="true"></i>
      <span>{{ _('Назад') }}</span>
    </button>

    <button class="nav-btn btn-flip" id="btn-flip" aria-label="Перевернуть карточку для просмотра перевода">
      <i class="fas fa-sync-alt" aria-hidden="true"></i>
      <span>{{ _('Перевернуть') }}</span>
    </button>

    <button class="nav-btn btn-next" id="btn-next" aria-label="Следующая карточка">
      <span>{{ _('Вперед') }}</span>
      <i class="fas fa-chevron-right" aria-hidden="true"></i>
    </button>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Lesson configuration
const lessonConfig = {
  isCompleted: {% if is_completed %}true{% else %}false{% endif %},
  totalWords: {{ words|length }},
  lessonId: {{ lesson.id }},
  csrfToken: '{{ csrf_token() }}'
};

// State management
const cardsState = {
  currentIndex: 0,
  totalCards: {{ words|length }},
  viewedCards: new Set(),
  allViewed: false
};

// DOM elements
const cardsContainer = document.getElementById('cards-container');
const cards = document.querySelectorAll('.vocabulary-card');
const btnPrev = document.getElementById('btn-prev');
const btnNext = document.getElementById('btn-next');
const btnFlip = document.getElementById('btn-flip');
const progressBar = document.getElementById('cards-progress-bar');
const currentCardNum = document.getElementById('current-card-num');
const noCardsMessage = document.getElementById('no-cards-message');

// Audio player
const audioPlayer = new Audio();

// Initialize
function init() {
  if (cards.length === 0) return;

  // Show first card
  showCard(0);

  // Add event listeners
  btnPrev.addEventListener('click', prevCard);
  btnNext.addEventListener('click', nextCard);
  btnFlip.addEventListener('click', flipCurrentCard);

  // Card click to flip
  cards.forEach(card => {
    card.addEventListener('click', (e) => {
      if (!e.target.closest('.audio-btn-card')) {
        flipCard(card);
      }
    });
  });

  // Audio buttons
  document.querySelectorAll('.audio-btn-card').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const audioSrc = btn.getAttribute('data-audio');
      if (audioSrc) {
        audioPlayer.src = audioSrc;
        audioPlayer.play();
      }
    });
  });

  // Touch/Swipe support
  addSwipeSupport();
}

// Show specific card
function showCard(index) {
  cards.forEach((card, i) => {
    if (i === index) {
      card.classList.add('active');
      card.classList.remove('prev', 'next');
    } else if (i < index) {
      card.classList.add('prev');
      card.classList.remove('active', 'next');
    } else {
      card.classList.add('next');
      card.classList.remove('active', 'prev');
    }
  });

  cardsState.currentIndex = index;

  // Mark as viewed
  cardsState.viewedCards.add(index);
  cards[index].setAttribute('data-viewed', 'true');

  // Update UI
  updateUI();
  updateProgress();
}

// Update UI elements
function updateUI() {
  currentCardNum.textContent = cardsState.currentIndex + 1;

  // Enable/disable buttons
  btnPrev.disabled = cardsState.currentIndex === 0;
  btnNext.disabled = cardsState.currentIndex === cardsState.totalCards - 1;

  // Check if all viewed
  if (cardsState.viewedCards.size === cardsState.totalCards && !cardsState.allViewed) {
    cardsState.allViewed = true;
    setTimeout(completeLesson, 500);
  }
}

// Update progress bar
function updateProgress() {
  const progress = (cardsState.viewedCards.size / cardsState.totalCards) * 100;
  progressBar.style.width = progress + '%';

  // Update aria-valuenow for accessibility
  const progressBarContainer = progressBar.parentElement;
  progressBarContainer.setAttribute('aria-valuenow', Math.round(progress));
}

// Navigation
function prevCard() {
  if (cardsState.currentIndex > 0) {
    showCard(cardsState.currentIndex - 1);
  }
}

function nextCard() {
  if (cardsState.currentIndex < cardsState.totalCards - 1) {
    showCard(cardsState.currentIndex + 1);
  }
}

// Flip cards
function flipCard(card) {
  card.classList.toggle('flipped');
}

function flipCurrentCard() {
  const currentCard = cards[cardsState.currentIndex];
  flipCard(currentCard);
}

// Swipe support
function addSwipeSupport() {
  let touchStartX = 0;
  let touchEndX = 0;
  let isDragging = false;

  cards.forEach(card => {
    card.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
      isDragging = true;
    });

    card.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      touchEndX = e.changedTouches[0].screenX;
      const diff = touchEndX - touchStartX;

      // Show swipe indicators
      if (Math.abs(diff) > 20) {
        if (diff > 0) {
          card.classList.add('swipe-hint-right');
          card.classList.remove('swipe-hint-left');
        } else {
          card.classList.add('swipe-hint-left');
          card.classList.remove('swipe-hint-right');
        }
      }
    });

    card.addEventListener('touchend', () => {
      const diff = touchEndX - touchStartX;

      card.classList.remove('swipe-hint-left', 'swipe-hint-right');

      if (Math.abs(diff) > 100) {
        if (diff > 0 && cardsState.currentIndex > 0) {
          prevCard();
        } else if (diff < 0 && cardsState.currentIndex < cardsState.totalCards - 1) {
          nextCard();
        }
      }

      isDragging = false;
      touchStartX = 0;
      touchEndX = 0;
    });
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (cardsState.allViewed) return;

    if (e.key === 'ArrowLeft') {
      prevCard();
    } else if (e.key === 'ArrowRight') {
      nextCard();
    } else if (e.key === ' ') {
      e.preventDefault();
      flipCurrentCard();
    }
  });
}

// Complete lesson
async function completeLesson() {
  // Hide cards and navigation
  document.getElementById('cards-navigation').style.display = 'none';
  cards.forEach(card => card.style.display = 'none');

  // Show completion message
  noCardsMessage.style.display = 'flex';
  noCardsMessage.scrollIntoView({ behavior: 'smooth' });

  // Save progress
  try {
    await fetch('{{ url_for("curriculum_lessons.update_lesson_progress", lesson_id=lesson.id) }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': lessonConfig.csrfToken
      },
      body: JSON.stringify({
        score: 100,
        status: 'completed',
        data: {
          cards_viewed: cardsState.totalCards,
          total_cards: cardsState.totalCards
        }
      })
    });

    // Show navigation buttons
    const nextBtn = document.getElementById('complete-exercise');
    const completeModuleBtn = document.getElementById('complete-module');

    if (nextBtn) {
      nextBtn.style.display = 'inline-flex';
      nextBtn.disabled = false;
    } else if (completeModuleBtn) {
      completeModuleBtn.style.display = 'inline-flex';
      completeModuleBtn.disabled = false;
    }
  } catch (error) {
    console.error('Error completing lesson:', error);
  }
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}
