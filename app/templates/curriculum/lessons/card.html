{% extends "lesson_base_template.html" %}

{% set component_name = _('Карточки для запоминания') %}
{% set instruction_text = _('Изучайте слова методом интервальных повторений. Оценивайте, насколько хорошо вы помните каждое слово.') %}
{% set block_description = _('Умная система запоминания с оптимальными интервалами повторения') %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/lesson-styles.css') }}?v=20251028-3">
{% endblock %}

{% block lesson_content %}

  <!-- Получаем данные о предыдущей сессии -->
  {% set previous_data = None %}
  {% set is_completed = False %}
  {% if progress and progress.data %}
    {% set previous_data = progress.data %}
    {% set is_completed = progress.status == 'completed' %}
  {% endif %}

  <div class="srs-lesson">
    {% if is_completed and previous_data %}
      <!-- Режим просмотра результатов -->
      <div class="session-results-review">
        <div class="results-header">
          <h3>{{ _('Результаты сессии') }}</h3>
          <div class="session-stats">
            <div class="stat-card">
              <i class="fas fa-graduation-cap"></i>
              <div class="stat-content">
                <span class="stat-value">{{ previous_data.get('cardsStudied', previous_data.get('cards_studied', 0)) }}</span>
                <span class="stat-label">{{ _('Карточек изучено') }}</span>
              </div>
            </div>
            <div class="stat-card">
              <i class="fas fa-percentage"></i>
              <div class="stat-content">
                <span class="stat-value">{{ previous_data.get('accuracy', 0) }}%</span>
                <span class="stat-label">{{ _('Точность') }}</span>
              </div>
            </div>
            <div class="stat-card">
              <i class="fas fa-clock"></i>
              <div class="stat-content">
                <span class="stat-value">{{ ((previous_data.get('timeSpent', previous_data.get('time_spent', 0)) / 60)|round(0)|int) }}м</span>
                <span class="stat-label">{{ _('Время') }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="retry-section">
          <p class="text-muted">{{ _('Хотите изучить больше карточек или улучшить результат?') }}</p>
          <button type="button" class="btn btn-outline-primary" onclick="retrySession()">
            <i class="fas fa-redo"></i> {{ _('Начать новую сессию') }}
          </button>
        </div>
      </div>

    {% elif cards_data.cards|length == 0 %}
      <!-- Нет доступных карточек -->
      <div class="empty-state">
        <div class="empty-state-icon">
          <i class="fas fa-check-double"></i>
        </div>
        <h3>{{ _('Все карточки изучены!') }}</h3>
        <p>{{ _('У вас нет карточек для повторения сейчас. Отличная работа!') }}</p>
        <div class="next-review-info">
          <i class="fas fa-clock"></i>
          <span>{{ _('Следующее повторение через') }} <strong id="next-review-time">--</strong></span>
        </div>
      </div>

    {% else %}
      <!-- Активная сессия изучения -->
      <!-- Статистика сессии -->
      <div class="session-stats-bar">
        <div class="stat-item">
          <i class="fas fa-layer-group"></i>
          <div class="stat-content">
            <span class="stat-value" id="total-cards">{{ cards_data.cards|length if cards_data else 0 }}</span>
            <span class="stat-label">{{ _('Всего') }}</span>
          </div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <i class="fas fa-sparkles"></i>
          <div class="stat-content">
            <span class="stat-value text-info" id="new-cards">0</span>
            <span class="stat-label">{{ _('Новых') }}</span>
          </div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <i class="fas fa-sync-alt"></i>
          <div class="stat-content">
            <span class="stat-value text-warning" id="due-cards">0</span>
            <span class="stat-label">{{ _('Повторить') }}</span>
          </div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <i class="fas fa-check-circle"></i>
          <div class="stat-content">
            <span class="stat-value text-success" id="studied-cards">0</span>
            <span class="stat-label">{{ _('Изучено') }}</span>
          </div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <i class="fas fa-percentage"></i>
          <div class="stat-content">
            <span class="stat-value" id="accuracy">100%</span>
            <span class="stat-label">{{ _('Точность') }}</span>
          </div>
        </div>
      </div>

      <!-- Прогресс урока -->
      <div class="lesson-progress-detailed">
        <div class="progress-bar-wrapper">
          <div class="progress-bar-fill" id="lesson-progress" style="width: 0%"></div>
        </div>
        <div class="progress-text" id="progress-text">{{ _('Начните изучение карточек') }}</div>
      </div>

      <!-- Контейнер для карточек -->
      <div class="srs-card-container" id="srs-container">
        <!-- Состояние загрузки -->
        <div class="loading-state" id="loading-state">
          <div class="spinner">
            <div class="spinner-circle"></div>
          </div>
          <p class="loading-text">{{ _('Подготовка карточек...') }}</p>
        </div>

        <!-- Карточка (фронт) -->
        <div class="srs-card" id="card-front" style="display: none;">
          <div class="card-header">
          <span class="card-badge" id="card-type-badge">
            <i class="fas fa-sparkles"></i>
            <span>{{ _('Новая') }}</span>
          </span>
            <span class="card-direction" id="card-direction">ENG → RUS</span>
          </div>

          <div class="card-body">
            <h2 class="card-word" id="front-word"></h2>

            <button class="audio-btn" id="front-audio-btn" style="display: none;" title="{{ _('Произношение') }}">
              <i class="fas fa-volume-up"></i>
            </button>

            <div class="hint-container" id="hint-container" style="display: none;">
              <div class="hint-label">{{ _('Подсказка:') }}</div>
              <p class="card-hint-text" id="hint-text"></p>
            </div>
          </div>

          <div class="card-footer">
            <button class="btn btn-primary btn-lg show-answer-btn" id="show-answer-btn">
              {{ _('Показать ответ') }}
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>

        <!-- Карточка (обратная сторона) -->
        <div class="srs-card" id="card-back" style="display: none;">
          <div class="card-header">
          <span class="card-badge" id="card-type-badge-back">
            <i class="fas fa-sparkles"></i>
            <span>{{ _('Новая') }}</span>
          </span>
            <span class="card-direction" id="card-direction-back">ENG → RUS</span>
          </div>

          <div class="card-body">
            <h2 class="card-word" id="back-word"></h2>

            <button class="audio-btn" id="back-audio-btn" style="display: none;" title="{{ _('Произношение') }}">
              <i class="fas fa-volume-up"></i>
            </button>

            <div class="card-divider"></div>

            <div class="translation-section">
              <p class="translation-label">{{ _('Перевод:') }}</p>
              <p class="translation-text" id="translation-text"></p>
            </div>

            <div class="example-section" id="example-section" style="display: none;">
              <p class="example-label">{{ _('Пример:') }}</p>
              <p class="example-text" id="example-text"></p>
              <p class="example-translation" id="example-translation"></p>
            </div>
          </div>

          <div class="card-footer">
            <div class="rating-section">
              <p class="rating-prompt">{{ _('Насколько хорошо вы знаете это слово?') }}</p>
              <div class="rating-buttons">
                <button class="rating-btn rating-again" data-rating="0">
                  <i class="fas fa-times"></i>
                  <span class="rating-text">{{ _('Снова') }}</span>
                  <span class="interval-hint">{{ _('Повтор') }}</span>
                </button>
                <button class="rating-btn rating-hard" data-rating="2">
                  <i class="fas fa-frown"></i>
                  <span class="rating-text">{{ _('Трудно') }}</span>
                  <span class="interval-hint" id="hard-interval"></span>
                </button>
                <button class="rating-btn rating-easy" data-rating="4">
                  <i class="fas fa-grin"></i>
                  <span class="rating-text">{{ _('Легко') }}</span>
                  <span class="interval-hint" id="easy-interval"></span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Состояние завершения сессии -->
        <div class="session-complete" id="session-complete" style="display: none;">
          <div class="complete-icon">
            <i class="fas fa-trophy"></i>
          </div>
          <h3>{{ _('Отличная работа!') }}</h3>

          <div class="session-summary">
            <div class="summary-item">
              <span class="summary-value" id="summary-studied">0</span>
              <span class="summary-label">{{ _('Карточек изучено') }}</span>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-item">
              <span class="summary-value" id="summary-accuracy">0%</span>
              <span class="summary-label">{{ _('Точность') }}</span>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-item">
              <span class="summary-value" id="summary-time">0м</span>
              <span class="summary-label">{{ _('Время') }}</span>
            </div>
          </div>

          <div class="session-actions">
            <button type="button" class="btn btn-success btn-lg" id="complete-session-btn">
              <i class="fas fa-check-circle"></i> {{ _('Завершить сессию') }}
            </button>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Аудио элемент -->
  <audio id="word-audio" style="display: none;"></audio>

  <!-- CSRF Token -->
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <script>
      // Конфигурация урока
      const lessonConfig = {
          lessonId: {{ lesson.id }},
          cards: {{ cards_data.cards|tojson if cards_data and cards_data.cards else []|tojson }},
          srsSettings: {{ cards_data.srs_settings|tojson if cards_data and cards_data.srs_settings else srs_settings|tojson if srs_settings else {}|tojson }},
          lessonSettings: {{ cards_data.lesson_settings|tojson if cards_data and cards_data.lesson_settings else {}|tojson }},
          stats: {{ cards_data.stats|tojson if cards_data and cards_data.stats else {}|tojson }},
          showHintTime: {{ (cards_data.srs_settings.show_hint_time * 1000) if cards_data and cards_data.srs_settings and cards_data.srs_settings.show_hint_time else 5000 }},
      };

      {% if next_lesson %}
          const nextLessonUrl = "{{ url_for('curriculum_lessons.lesson_detail', lesson_id=next_lesson.id) }}";
      {% else %}
          const nextLessonUrl = null;
      {% endif %}

      // Состояние сессии
      let sessionState = {
          startTime: Date.now(),
          cardsStudied: 0,
          correctAnswers: 0,
          totalAnswers: 0,
          currentCard: null,
          currentIndex: 0,
          availableCards: [],
          studiedCards: new Set(),
          cardProgress: {},
          newCardsStudied: 0,
          reviewsStudied: 0,
          sessionActive: true,
          repeatQueue: [],
      };

      // Автосохранение прогресса в localStorage
      const STORAGE_KEY = `lesson_${lessonConfig.lessonId}_session`;

      function saveSessionState() {
          try {
              const stateToSave = {
                  startTime: sessionState.startTime,
                  cardsStudied: sessionState.cardsStudied,
                  correctAnswers: sessionState.correctAnswers,
                  totalAnswers: sessionState.totalAnswers,
                  currentIndex: sessionState.currentIndex,
                  studiedCards: Array.from(sessionState.studiedCards),
                  cardProgress: sessionState.cardProgress,
                  newCardsStudied: sessionState.newCardsStudied,
                  reviewsStudied: sessionState.reviewsStudied,
                  repeatQueue: sessionState.repeatQueue,
              };
              localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
          } catch (e) {
              console.warn('Failed to save session state:', e);
          }
      }

      function loadSessionState() {
          try {
              const saved = localStorage.getItem(STORAGE_KEY);
              if (saved) {
                  const state = JSON.parse(saved);
                  sessionState.startTime = state.startTime || Date.now();
                  sessionState.cardsStudied = state.cardsStudied || 0;
                  sessionState.correctAnswers = state.correctAnswers || 0;
                  sessionState.totalAnswers = state.totalAnswers || 0;
                  sessionState.currentIndex = state.currentIndex || 0;
                  sessionState.studiedCards = new Set(state.studiedCards || []);
                  sessionState.cardProgress = state.cardProgress || {};
                  sessionState.newCardsStudied = state.newCardsStudied || 0;
                  sessionState.reviewsStudied = state.reviewsStudied || 0;
                  sessionState.repeatQueue = state.repeatQueue || [];
                  return true;
              }
          } catch (e) {
              console.warn('Failed to load session state:', e);
          }
          return false;
      }

      function clearSessionState() {
          try {
              localStorage.removeItem(STORAGE_KEY);
          } catch (e) {
              console.warn('Failed to clear session state:', e);
          }
      }

      // Элементы DOM
      const elements = {
          loading: document.getElementById('loading-state'),
          cardFront: document.getElementById('card-front'),
          cardBack: document.getElementById('card-back'),
          sessionComplete: document.getElementById('session-complete'),

          // Статистика
          totalCards: document.getElementById('total-cards'),
          dueCards: document.getElementById('due-cards'),
          newCards: document.getElementById('new-cards'),
          studiedCards: document.getElementById('studied-cards'),
          accuracy: document.getElementById('accuracy'),
          progressBar: document.getElementById('lesson-progress'),
          progressText: document.getElementById('progress-text'),

          // Карточка
          frontWord: document.getElementById('front-word'),
          backWord: document.getElementById('back-word'),
          translationText: document.getElementById('translation-text'),
          hintText: document.getElementById('hint-text'),
          hintContainer: document.getElementById('hint-container'),
          exampleSection: document.getElementById('example-section'),
          exampleText: document.getElementById('example-text'),
          exampleTranslation: document.getElementById('example-translation'),
          cardTypeBadge: document.getElementById('card-type-badge'),
          cardTypeBadgeBack: document.getElementById('card-type-badge-back'),
          cardDirection: document.getElementById('card-direction'),
          cardDirectionBack: document.getElementById('card-direction-back'),

          // Кнопки
          showAnswerBtn: document.getElementById('show-answer-btn'),
          frontAudioBtn: document.getElementById('front-audio-btn'),
          backAudioBtn: document.getElementById('back-audio-btn'),
          completeSessionBtn: document.getElementById('complete-session-btn'),

          // Аудио
          wordAudio: document.getElementById('word-audio'),
      };

      let hintTimeout = null;

      // Функция для повторной сессии
      function retrySession() {
          if (confirm('{{ _("Вы уверены, что хотите начать новую сессию?") }}')) {
              clearSessionState(); // Очищаем сохранённый прогресс
              window.location.href = '{{ url_for("curriculum_lessons.card_lesson", lesson_id=lesson.id, reset="true") }}';
          }
      }

      // Функция для откладывания карточки удалена, так как кнопка "Отложить" убрана

      // Global retry function for navigation button
      function retryLesson() {
          retrySession();
      }

      // Инициализация
      async function initializeSRS() {

          if (!lessonConfig.cards || lessonConfig.cards.length === 0) {
              elements.loading.style.display = 'none';
              return;
          }

          // Инициализируем состояние сессии из серверных данных
          if (lessonConfig.stats) {
              sessionState.cardsStudied = (lessonConfig.stats.new_cards_shown || 0) + (lessonConfig.stats.review_cards_shown || 0);
              sessionState.newCardsStudied = lessonConfig.stats.new_cards_shown || 0;
              sessionState.reviewsStudied = lessonConfig.stats.review_cards_shown || 0;
          }

          // Пытаемся восстановить сессию из localStorage
          const sessionRestored = loadSessionState();
          if (sessionRestored) {
              console.log('Session restored from localStorage');
          }

          // Обрабатываем карточки
          processCardsStatus();
          updateStatistics();

          // Показываем первую карточку
          elements.loading.style.display = 'none';
          showNextCard();
      }

      // Обработка статуса карточек
      function processCardsStatus() {
          sessionState.availableCards = [];

          lessonConfig.cards.forEach((card, index) => {
              const direction = card.direction || 'eng-rus';

              // Подготовка front/back в зависимости от направления
              let front, back;
              if (direction === 'eng-rus') {
                  front = card.english || card.front || card.word || '';
                  back = card.russian || card.back || card.translation || '';
              } else {
                  front = card.russian || card.front || card.word || '';
                  back = card.english || card.back || card.translation || '';
              }

              const cardData = {
                  ...card,
                  index: index,
                  front: front,
                  back: back,
                  word: front,
                  translation: back,
                  isNew: card.is_new !== undefined ? card.is_new : true,
                  direction: direction,
                  interval: card.interval || 0,
                  easeFactor: card.ease_factor || card.easeFactor || 2.5,
                  repetitions: card.repetitions || 0,
                  session_attempts: card.session_attempts || 0,
                  calculated_intervals: card.calculated_intervals || null
              };

              // Не добавляем карточку если она уже была изучена в этой сессии
              const cardKey = `${card.word_id}-${direction}`;
              if (!sessionState.studiedCards.has(cardKey)) {
                  sessionState.availableCards.push(cardData);
              }
          });

          // Перемешиваем карточки
          sessionState.availableCards = shuffleArray(sessionState.availableCards);

          // Инициализируем счетчики согласно серверной логике
          if (lessonConfig.stats) {
              // Используем данные от сервера, которые точно отражают текущее состояние
              const serverNewCount = lessonConfig.stats.new_cards_count || 0;
              const serverReviewCount = lessonConfig.stats.review_cards_count || 0;
              const serverNewShown = lessonConfig.stats.new_cards_shown || 0;
              const serverReviewShown = lessonConfig.stats.review_cards_shown || 0;
              const serverTotalDue = lessonConfig.stats.total_due || 0;

              // Всего карточек = то что доступно сейчас + уже изученные в этой сессии
              const totalStudied = serverNewShown + serverReviewShown;
              const totalCards = serverTotalDue + totalStudied;

              // Обновляем элементы точно согласно серверным данным
              if (elements.newCards) elements.newCards.textContent = serverNewCount;
              if (elements.dueCards) elements.dueCards.textContent = serverReviewCount;
              if (elements.totalCards) elements.totalCards.textContent = totalCards;
              if (elements.studiedCards) elements.studiedCards.textContent = totalStudied;
          } else {
              // Fallback если нет серверных данных
              const newCount = sessionState.availableCards.filter(c => c.isNew).length;
              const reviewCount = sessionState.availableCards.filter(c => !c.isNew).length;
              const totalStudied = sessionState.cardsStudied;
              // Используем общее количество карточек из конфига
              const totalCards = lessonConfig.cards ? lessonConfig.cards.length : (newCount + reviewCount + totalStudied);

              if (elements.newCards) elements.newCards.textContent = newCount;
              if (elements.dueCards) elements.dueCards.textContent = reviewCount;
              if (elements.totalCards) elements.totalCards.textContent = totalCards;
              if (elements.studiedCards) elements.studiedCards.textContent = totalStudied;
          }
      }

      // Показать следующую карточку
      function showNextCard() {
          if (!sessionState.sessionActive) return;

          // Проверяем очередь повтора
          if (sessionState.repeatQueue.length > 0 && sessionState.availableCards.length === 0) {
              sessionState.currentCard = sessionState.repeatQueue.shift();
              updateStatistics();
              showCardFront();
              return;
          }

          // Если нет доступных карточек и нет повторов - завершаем
          if (!sessionState.availableCards || sessionState.availableCards.length === 0) {
              if (sessionState.repeatQueue.length > 0) {
                  // Добавляем карточки из очереди повтора обратно
                  sessionState.availableCards.push(...sessionState.repeatQueue);
                  sessionState.repeatQueue = [];
                  sessionState.currentIndex = 0; // Сбрасываем индекс
                  updateStatistics();
              } else {
                  completeSession();
                  return;
              }
          }

          // Сбрасываем индекс если он больше доступных карточек
          if (sessionState.currentIndex >= sessionState.availableCards.length) {
              sessionState.currentIndex = 0;
          }

          // Берем первую доступную карточку (индекс всегда 0, так как удаляем изученные)
          sessionState.currentCard = sessionState.availableCards[0];
          sessionState.currentIndex = 0;
          showCardFront();
      }

      // Показать фронт карточки
      function showCardFront() {
          const card = sessionState.currentCard;

          elements.cardBack.style.display = 'none';
          elements.sessionComplete.style.display = 'none';
          elements.cardFront.style.display = 'block';

          // Обновляем бейдж типа карточки
          const badge = elements.cardTypeBadge;
          const badgeSpan = badge.querySelector('span');

          if (card.isNew) {
              badge.querySelector('i').className = 'fas fa-sparkles';
              badgeSpan.textContent = 'Новая';
              badge.className = 'card-badge new';
          } else if (card.repeatAttempt) {
              badge.querySelector('i').className = 'fas fa-redo';
              badgeSpan.textContent = 'Повтор';
              badge.className = 'card-badge repeat';
          } else {
              badge.querySelector('i').className = 'fas fa-sync-alt';
              badgeSpan.textContent = 'Повторение';
              badge.className = 'card-badge review';
          }

          // Обновляем направление
          elements.cardDirection.textContent = card.direction === 'eng-rus' ? 'ENG → RUS' : 'RUS → ENG';

          // Устанавливаем содержимое
          elements.frontWord.textContent = card.front || card.word;
          elements.translationText.textContent = card.back || card.translation;

          // Аудио - показываем кнопку только для eng-rus карточек на фронтальной стороне
          if (card.audio && card.direction === 'eng-rus') {
              elements.frontAudioBtn.style.display = 'inline-flex';
              elements.wordAudio.src = `/static/audio/${card.audio}`;
              
              // Автовоспроизведение для eng-rus карточек
              setTimeout(() => {
                  elements.wordAudio.play().catch(e => {
                  });
              }, 300);
          } else {
              elements.frontAudioBtn.style.display = 'none';
              // Для rus-eng карточек аудио будет доступно только на обратной стороне
              if (card.audio) {
                  elements.wordAudio.src = `/static/audio/${card.audio}`;
              }
          }

          // Подсказка
          setupHint();

          // Примеры
          if (card.examples) {
              const examples = parseExamples(card.examples);
              elements.exampleText.textContent = examples.en;
              elements.exampleTranslation.textContent = examples.ru;
              elements.exampleSection.style.display = 'block';
          } else {
              elements.exampleSection.style.display = 'none';
          }

          // Анимация появления
          elements.cardFront.style.animation = 'slideInCard 0.3s ease-out';
      }

      // Настройка подсказки
      function setupHint() {
          const card = sessionState.currentCard;
          const translation = card.back || card.translation || '';

          // Защита от пустого перевода
          if (!translation || translation.trim().length === 0) {
              elements.hintContainer.style.display = 'none';
              return;
          }

          const firstWord = translation.split(',')[0].trim();
          const firstLetter = firstWord.charAt(0);
          const wordLength = firstWord.length;

          // Защита от слишком короткого слова
          if (wordLength < 1) {
              elements.hintContainer.style.display = 'none';
              return;
          }

          const underscores = wordLength > 1 ? '_'.repeat(wordLength - 1) : '';
          elements.hintText.textContent = `${firstLetter}${underscores} (${wordLength} букв)`;
          elements.hintContainer.style.display = 'none';

          if (hintTimeout) clearTimeout(hintTimeout);
          hintTimeout = setTimeout(() => {
              elements.hintContainer.style.display = 'block';
              elements.hintContainer.style.animation = 'fadeInUp 0.3s ease-out';
          }, lessonConfig.showHintTime);
      }

      // Показать обратную сторону карточки
      function showCardBack() {
          if (hintTimeout) clearTimeout(hintTimeout);

          elements.cardFront.style.display = 'none';
          elements.cardBack.style.display = 'block';

          // Копируем информацию
          const badge = elements.cardTypeBadgeBack;
          const frontBadge = elements.cardTypeBadge;
          badge.querySelector('i').className = frontBadge.querySelector('i').className;
          badge.querySelector('span').textContent = frontBadge.querySelector('span').textContent;
          badge.className = frontBadge.className;
          elements.cardDirectionBack.textContent = elements.cardDirection.textContent;

          elements.backWord.textContent = elements.frontWord.textContent;

          // Аудио на обратной стороне - показываем всегда, если есть аудио
          if (sessionState.currentCard.audio) {
              elements.backAudioBtn.style.display = 'inline-flex';
              // Убеждаемся, что аудио src правильно установлен
              elements.wordAudio.src = `/static/audio/${sessionState.currentCard.audio}`;

              // Для rus-eng карточек автоматически воспроизводим при показе ответа
              if (sessionState.currentCard.direction === 'rus-eng') {
                  setTimeout(() => {
                      elements.wordAudio.play().catch(e => {
                      });
                  }, 300);
              }
          } else {
              elements.backAudioBtn.style.display = 'none';
          }

          // Примеры использования
          const card = sessionState.currentCard;
          if (card.example_en || card.examples) {
              let exampleEn = card.example_en || '';
              let exampleRu = card.example_ru || '';

              // Поддержка старого формата с разделителем |
              if (!exampleEn && card.examples) {
                  const parts = card.examples.split('|');
                  if (parts.length >= 2) {
                      exampleEn = parts[0];
                      exampleRu = parts[1];
                  }
              }

              if (exampleEn || exampleRu) {
                  elements.exampleText.textContent = exampleEn;
                  elements.exampleTranslation.textContent = exampleRu;
                  elements.exampleSection.style.display = 'block';
              } else {
                  elements.exampleSection.style.display = 'none';
              }
          } else {
              elements.exampleSection.style.display = 'none';
          }

          // Обновляем интервалы на кнопках
          updateIntervalHints();

          // Анимация переворота
          elements.cardBack.style.animation = 'flipInCard 0.4s ease-out';
      }

      // Обновить подсказки интервалов
      function updateIntervalHints() {
          const card = sessionState.currentCard;

          // Используем рассчитанные интервалы от сервера, если доступны
          let intervals;
          if (card.calculated_intervals) {
              intervals = {
                  hard: card.calculated_intervals.hard,
                  easy: card.calculated_intervals.easy
              };
          } else {
              intervals = calculateIntervals(card);
          }

          const hardEl = document.getElementById('hard-interval');
          const easyEl = document.getElementById('easy-interval');

          if (hardEl) hardEl.textContent = formatInterval(intervals.hard);
          if (easyEl) easyEl.textContent = formatInterval(intervals.easy);
      }

      // Рассчитать интервалы (соответствует серверному алгоритму)
      function calculateIntervals(card) {
          const easeFactor = card.easeFactor || card.ease_factor || 2.5;
          const currentInterval = card.interval || 0;
          const repetitions = card.repetitions || 0;

          if (card.isNew || repetitions === 0) {
              return {
                  hard: 1,  // rating 2 -> 1 день
                  easy: 6   // rating 4 -> 6 дней (второе повторение сразу)
              };
          } else if (repetitions === 1) {
              return {
                  hard: 1,
                  easy: Math.max(1, Math.round(6 * easeFactor * 1.3))
              };
          } else {
              // Для последующих повторений
              return {
                  hard: Math.max(1, Math.round(currentInterval * easeFactor * 0.8)),
                  easy: Math.max(1, Math.round(currentInterval * easeFactor * 1.3))
              };
          }
      }

      // Форматирование интервала
      function formatInterval(days) {
          if (days === 0) return '< 1д';
          if (days === 1) return '1д';
          if (days < 7) return `${days}д`;
          if (days < 30) return `${Math.round(days / 7)}н`;
          if (days < 365) return `${Math.round(days / 30)}м`;
          return `${Math.round(days / 365)}г`;
      }

      // Оценить карточку
      async function rateCard(rating) {
          const card = sessionState.currentCard;
          const cardKey = `${card.word_id}-${card.direction}`;

          // Анимация нажатия кнопки
          const btn = event.currentTarget;
          btn.classList.add('clicked');
          setTimeout(() => btn.classList.remove('clicked'), 300);

          if (rating === 0) {
              // "Снова" - добавляем в очередь повтора с перетасовкой
              sessionState.repeatQueue.push({
                  ...card,
                  repeatAttempt: (card.repeatAttempt || 0) + 1
              });
              sessionState.totalAnswers++;
              sessionState.currentIndex++;
              
              // Перетасовываем доступные карточки, чтобы не показывать ту же карточку сразу
              if (sessionState.availableCards.length > 1) {
                  sessionState.availableCards = shuffleArray(sessionState.availableCards);
              }
          } else {
              // Обычная обработка
              sessionState.totalAnswers++;
              if (rating >= 3) {
                  sessionState.correctAnswers++;
              }

              sessionState.studiedCards.add(cardKey);
              sessionState.cardsStudied++;

              if (card.isNew) {
                  sessionState.newCardsStudied++;
              } else {
                  sessionState.reviewsStudied++;
              }

              // Удаляем изученную карточку из списка доступных
              const cardIndex = sessionState.availableCards.findIndex(c =>
                  c.word_id === card.word_id && c.direction === card.direction
              );
              if (cardIndex !== -1) {
                  sessionState.availableCards.splice(cardIndex, 1);
              }

              // Для успешных ответов карточка удаляется из массива, индекс не увеличиваем
              // (currentIndex будет указывать на следующую карточку)

              try {
                  const response = await fetch('/study/api/update-study-item', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                      },
                      body: JSON.stringify({
                          word_id: card.word_id,
                          direction: card.direction,
                          quality: rating,
                          session_id: null
                      })
                  });

                  const result = await response.json();

                  if (!response.ok) {
                      console.error('Rate card failed:', result);
                  }
              } catch (error) {
                  console.error('Error rating card:', error);
              }
          }

          updateStatistics();
          saveSessionState(); // Сохраняем прогресс после каждого рейтинга
          showNextCard();
      }

      // Обновить статистику
      function updateStatistics() {
          const accuracy = sessionState.totalAnswers > 0
              ? Math.round((sessionState.correctAnswers / sessionState.totalAnswers) * 100)
              : 100;

          // Подсчитываем текущие доступные карточки
          const currentNewCards = sessionState.availableCards.filter(c => c.isNew).length;
          const currentReviewCards = sessionState.availableCards.filter(c => !c.isNew).length;

          // Используем изначальные данные от сервера для постоянного общего количества
          let totalCards, initialTotal;
          if (lessonConfig.stats && lessonConfig.stats.new_cards_count !== undefined) {
              // Изначальное общее количество = изначально доступные + уже изученные
              const initialNew = lessonConfig.stats.new_cards_count || 0;
              const initialReview = lessonConfig.stats.review_cards_count || 0;
              const initialStudied = (lessonConfig.stats.new_cards_shown || 0) + (lessonConfig.stats.review_cards_shown || 0);

              initialTotal = initialNew + initialReview + initialStudied;
              totalCards = initialTotal; // Общее остается константой
          } else {
              // Fallback - используем общее количество карточек из конфига
              totalCards = lessonConfig.cards ? lessonConfig.cards.length : 0;
              initialTotal = totalCards;
          }

          // Обновляем счетчики
          elements.studiedCards.textContent = sessionState.cardsStudied;
          elements.newCards.textContent = currentNewCards;
          elements.dueCards.textContent = currentReviewCards;
          elements.totalCards.textContent = totalCards;
          elements.accuracy.textContent = accuracy + '%';

          // Прогресс-бар - прогресс относительно изначального количества карточек
          const progress = initialTotal > 0 ? Math.min(100, (sessionState.cardsStudied / initialTotal) * 100) : 0;
          elements.progressBar.style.width = progress + '%';
          elements.progressText.textContent = `Изучено ${sessionState.cardsStudied} из ${initialTotal}`;
      }

      // Завершить сессию
      function completeSession() {
          sessionState.sessionActive = false;
          const timeSpent = Math.round((Date.now() - sessionState.startTime) / 1000);

          elements.cardFront.style.display = 'none';
          elements.cardBack.style.display = 'none';
          elements.sessionComplete.style.display = 'block';

          const accuracy = sessionState.totalAnswers > 0
              ? Math.round((sessionState.correctAnswers / sessionState.totalAnswers) * 100)
              : 100;

          document.getElementById('summary-studied').textContent = sessionState.cardsStudied;
          document.getElementById('summary-accuracy').textContent = accuracy + '%';
          document.getElementById('summary-time').textContent = Math.round(timeSpent / 60) + 'м';

          elements.sessionComplete.style.animation = 'fadeInScale 0.5s ease-out';
      }

      // Утилиты
      function shuffleArray(array) {
          const shuffled = [...array];
          for (let i = shuffled.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
          }
          return shuffled;
      }

      function parseExamples(examples) {
          if (typeof examples === 'object' && examples.en && examples.ru) {
              return examples;
          }

          if (typeof examples === 'string') {
              const parts = examples.split(' / ');
              return {
                  en: parts[0] || '',
                  ru: parts[1] || ''
              };
          }

          return { en: '', ru: '' };
      }

      // Обработчики событий
      elements.showAnswerBtn?.addEventListener('click', showCardBack);
      elements.frontAudioBtn?.addEventListener('click', () => elements.wordAudio.play());
      elements.backAudioBtn?.addEventListener('click', () => elements.wordAudio.play());

      document.querySelectorAll('.rating-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
              const rating = parseInt(e.currentTarget.dataset.rating);
              rateCard(rating);
          });
      });

      elements.completeSessionBtn?.addEventListener('click', async () => {
          const timeSpent = Math.round((Date.now() - sessionState.startTime) / 1000);
          const accuracy = sessionState.totalAnswers > 0
              ? Math.round((sessionState.correctAnswers / sessionState.totalAnswers) * 100)
              : 100;

          try {
              const response = await fetch(`/learn/lessons/${lessonConfig.lessonId}/complete-srs`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                  },
                  body: JSON.stringify({
                      cards_studied: sessionState.cardsStudied,
                      accuracy: accuracy,
                      time_spent: timeSpent,
                      new_cards_studied: sessionState.newCardsStudied,
                      reviews_studied: sessionState.reviewsStudied
                  })
              });

              const result = await response.json();

              if (result.success) {
                  clearSessionState(); // Очищаем сохранённый прогресс
                  if (nextLessonUrl) {
                      window.location.href = nextLessonUrl;
                  } else {
                      window.location.href = '{{ url_for("curriculum.module_lessons", module_id=lesson.module_id) }}';
                  }
              } else {
                  alert('Ошибка при сохранении прогресса');
              }
          } catch (error) {
              console.error('Error completing session:', error);
              alert('Ошибка при сохранении прогресса');
          }
      });

      // Инициализация при загрузке
      document.addEventListener('DOMContentLoaded', initializeSRS);

      {% if is_completed %}
          document.addEventListener('DOMContentLoaded', () => {
              const retryBtn = document.getElementById('retry-button');
              if (retryBtn) {
                  retryBtn.style.display = 'inline-flex';
              }
          });
      {% endif %}
  </script>
{% endblock %}
