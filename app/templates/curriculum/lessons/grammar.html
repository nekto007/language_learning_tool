{% extends "lesson_base_template.html" %}

{% block extra_css %}
<style>
/* Modern Card Styles */
.grammar-section, .theory-section, .practice-section {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
  border-radius: 1.25rem !important;
  box-shadow: 0 8px 24px rgba(220, 38, 38, 0.1),
              0 2px 8px rgba(0, 0, 0, 0.06) !important;
  padding: 2rem !important;
  margin-bottom: 1.5rem !important;
}

.grammar-intro {
  background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%) !important;
  border-radius: 1rem !important;
  border-left: 4px solid #dc2626 !important;
  padding: 1.5rem !important;
  margin: 1.5rem 0 !important;
}

.example-card {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
  border-radius: 0.75rem !important;
  padding: 1.25rem !important;
  margin: 1rem 0 !important;
  border-left: 3px solid #3b82f6 !important;
}

/* Grammar lesson specific styles */
.grammar-lesson .theory-section {
  margin-bottom: 2rem;
}

.grammar-lesson .grammar-intro {
  margin: 1.5rem 0;
  padding: 1rem;
  background: #f8f9fa;
  border-left: 4px solid #4f46e5;
  border-radius: 0.5rem;
}

.grammar-lesson .grammar-section {
  margin: 2rem 0;
  padding: 1.5rem;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 0.75rem;
}

.grammar-lesson .grammar-section h4 {
  color: #4f46e5;
  margin-bottom: 1rem;
  font-size: 1.3rem;
  font-weight: 600;
}

.grammar-lesson .grammar-section > p {
  margin-bottom: 1rem;
  color: #4b5563;
  line-height: 1.6;
}

.grammar-lesson .grammar-table {
  width: 100%;
  margin: 1.5rem 0;
  border-collapse: separate;
  border-spacing: 0;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  overflow: hidden;
}

.grammar-lesson .grammar-table td {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #e5e7eb;
  line-height: 1.5;
}

.grammar-lesson .grammar-table tr:last-child td {
  border-bottom: none;
}

.grammar-lesson .grammar-table td:first-child {
  background: #f9fafb;
  font-weight: 600;
  width: 20%;
}

.grammar-lesson .grammar-table td:nth-child(2) {
  background: #fef3c7;
  color: #92400e;
  width: 15%;
}

.grammar-lesson .rules-list,
.grammar-lesson .usage-list {
  margin: 1.5rem 0;
}

.grammar-lesson .rule-item,
.grammar-lesson .use-case {
  margin: 1.5rem 0;
  padding: 1rem;
  background: #f9fafb;
  border-radius: 0.5rem;
}

.grammar-lesson .rule-item p:first-child,
.grammar-lesson .use-case p:first-child {
  color: #1f2937;
  margin-bottom: 0.75rem;
}

.grammar-lesson .examples-list {
  margin: 0.75rem 0;
  padding-left: 1.5rem;
}

.grammar-lesson .examples-list li {
  margin: 0.5rem 0;
  color: #4b5563;
  line-height: 1.6;
}

.grammar-lesson .note {
  margin-top: 0.75rem;
  padding: 0.5rem 1rem;
  background: #fef3c7;
  border-left: 3px solid #f59e0b;
  border-radius: 0.25rem;
  color: #92400e;
  font-size: 0.95rem;
}

.grammar-lesson .important-notes {
  margin: 2rem 0;
  padding: 1.5rem;
  background: #fef2f2;
  border: 2px solid #fca5a5;
  border-radius: 0.75rem;
}

.grammar-lesson .important-notes h4 {
  color: #dc2626;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.grammar-lesson .important-notes ul {
  margin: 0;
  padding-left: 1.5rem;
}

.grammar-lesson .important-notes li {
  margin: 0.75rem 0;
  color: #991b1b;
  line-height: 1.6;
}

.grammar-lesson .summary-section {
  margin: 2rem 0;
  padding: 1.5rem;
  background: #eff6ff;
  border: 2px solid #93c5fd;
  border-radius: 0.75rem;
}

.grammar-lesson .summary-section h4 {
  color: #1e40af;
  margin-bottom: 1rem;
}

.grammar-lesson .grammar-table.summary {
  background: white;
}

.grammar-lesson .grammar-table.summary thead th {
  background: #dbeafe;
  color: #1e40af;
  font-weight: 600;
  padding: 0.75rem 1rem;
  border-bottom: 2px solid #93c5fd;
  text-align: left;
}

.grammar-lesson .grammar-table.summary tbody td {
  background: white;
}

.grammar-lesson .theory-completion-message {
  margin: 3rem 0;
  padding: 2rem;
  text-align: center;
  background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
  border: 2px solid #c7d2fe;
  border-radius: 1rem;
}

.grammar-lesson .theory-completion-message .completion-icon {
  font-size: 4rem;
  color: #10b981;
  margin-bottom: 1rem;
}

.grammar-lesson .theory-completion-message h3 {
  color: #1f2937;
  margin-bottom: 0.5rem;
  font-size: 1.5rem;
}

.grammar-lesson .theory-completion-message p {
  color: #6b7280;
  margin: 0;
}
</style>
{% endblock %}

{% set component_name = _('Грамматика') %}
{% set instruction_text = _('Изучите грамматическое правило и выполните упражнения для его закрепления.') %}
{% set block_description = _('Изучение грамматических правил с примерами и упражнениями') %}

{% block lesson_content %}
<!-- Получаем данные о предыдущих ответах -->
{% set previous_data = None %}
{% set previous_feedback = {} %}
{% set is_completed = False %}
{% if progress and progress.data %}
  {% set previous_data = progress.data %}
  {% set previous_feedback = previous_data.get('feedback', {}) %}
  {% set is_completed = progress.status == 'completed' %}
{% endif %}

<div class="grammar-lesson">
  <!-- Теория (всегда показываем) -->
  <div class="theory-section">
    {% if grammar_explanation %}
      <!-- Отображаем сложную структуру grammar_explanation -->
      <h3 class="section-title">{{ grammar_explanation.title }}</h3>

      {% if grammar_explanation.introduction %}
        <div class="grammar-intro">
          <p>{{ grammar_explanation.introduction }}</p>
        </div>
      {% endif %}

      {% if grammar_explanation.sections %}
        {% for section in grammar_explanation.sections %}
          <div class="grammar-section">
            <h4>{{ section.subtitle }}</h4>

            {% if section.description %}
              <p>{{ section.description }}</p>
            {% endif %}

            {% if section.table %}
              <table class="grammar-table">
                {% for row in section.table %}
                  <tr>
                    <td><strong>{{ row.pronoun|safe }}</strong></td>
                    <td><strong>{{ row.form|safe }}</strong></td>
                    <td>{{ row.example|safe }}</td>
                    <td class="text-muted">{{ row.translation|safe }}</td>
                  </tr>
                {% endfor %}
              </table>
            {% endif %}

            {% if section.rules %}
              <div class="rules-list">
                {% for rule_item in section.rules %}
                  <div class="rule-item">
                    <p><strong>{{ rule_item.rule }}</strong></p>
                    {% if rule_item.examples %}
                      <ul class="examples-list">
                        {% for ex in rule_item.examples %}
                          <li>{{ ex }}</li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                    {% if rule_item.note %}
                      <p class="note"><em>{{ rule_item.note }}</em></p>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            {% if section.usage %}
              <div class="usage-list">
                {% for use_case in section.usage %}
                  <div class="use-case">
                    <p><strong>{{ use_case.case }}</strong></p>
                    {% if use_case.examples %}
                      <ul class="examples-list">
                        {% for ex in use_case.examples %}
                          <li>{{ ex }}</li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% endif %}

      {% if grammar_explanation.important_notes %}
        <div class="important-notes">
          <h4><i class="fas fa-exclamation-triangle"></i> {{ _('Важно') }}</h4>
          <ul>
            {% for note in grammar_explanation.important_notes %}
              <li>{{ note }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      {% if grammar_explanation.summary and grammar_explanation.summary.table %}
        <div class="summary-section">
          <h4>{{ grammar_explanation.summary.title }}</h4>
          <table class="grammar-table summary">
            <thead>
              <tr>
                <th>{{ _('Подлежащее') }}</th>
                <th>{{ _('Утверждение') }}</th>
                <th>{{ _('Отрицание') }}</th>
                <th>{{ _('Вопрос') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for row in grammar_explanation.summary.table %}
                <tr>
                  <td><strong>{{ row.subject }}</strong></td>
                  <td>{{ row.affirmative }}</td>
                  <td>{{ row.negative }}</td>
                  <td>{{ row.question }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

    {% else %}
      <!-- Fallback to simple format -->
      <h3 class="section-title">{{ grammar_rule }}</h3>
      <div class="grammar-content">{{ grammar_description|safe }}</div>

      {% if examples %}
        <div class="examples-block">
          <h4 class="examples-title">
            <i class="fas fa-lightbulb"></i>
            {{ _('Примеры') }}
          </h4>
          <div class="examples-list">
            {% for example in examples %}
              <div class="example-item">
                <i class="fas fa-chevron-right"></i>
                <span>{{ example }}</span>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    {% endif %}
  </div>

  <!-- Автоматически завершаем урок без упражнений -->
  {% if not exercises and not is_completed %}
    <div class="theory-completion-message">
      <div class="completion-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3>{{ _('Теория изучена!') }}</h3>
      <p>{{ _('Отличная работа! Переходите к следующему уроку') }}</p>
    </div>
  {% endif %}

  <!-- Упражнения -->
  {% if exercises %}
    <div class="exercises-section">
      <h3 class="section-title">{{ _('Упражнения') }} ({{ exercises|length }})</h3>

      <form id="grammarForm">
        {% for exercise in exercises %}
          <div class="exercise-item" data-index="{{ loop.index0 }}">
            <div class="exercise-header">
              <span class="exercise-number">{{ loop.index }}</span>
              <span class="exercise-status" id="status-{{ loop.index0 }}">
                {% if is_completed and previous_feedback.get(loop.index0|string) %}
                  {% if previous_feedback.get(loop.index0|string).status == 'correct' %}
                    <i class="fas fa-check-circle text-success"></i>
                  {% else %}
                    <i class="fas fa-times-circle text-danger"></i>
                  {% endif %}
                {% endif %}
              </span>
            </div>

            <div class="exercise-content">
              {% if exercise.type in ['fill-blank', 'fill_in_blank', 'translation'] %}
                <p class="exercise-prompt">{{ exercise.prompt or exercise.text }}</p>
                <div class="answer-input">
                  {% set prev_answer = previous_feedback.get(loop.index0|string, {}).get('user_answer', '') %}
                  <input type="text"
                         class="form-control"
                         name="answer_{{ loop.index0 }}"
                         id="answer_{{ loop.index0 }}"
                         placeholder="{{ _('Ваш ответ') }}"
                         autocomplete="off"
                         value="{{ prev_answer }}"
                         {% if is_completed %}readonly{% endif %}>
                </div>

              {% elif exercise.type == 'multiple_choice' %}
                <p class="exercise-prompt">{{ exercise.question or exercise.prompt or exercise.text }}</p>
                <div class="answer-options">
                  {% set exercise_idx = loop.index0 %}
                  {% set prev_answer = previous_feedback.get(exercise_idx|string, {}).get('user_answer', '') %}
                  {% for option in exercise.options %}
                    {% set option_id = "q" ~ exercise_idx ~ "_opt" ~ loop.index0 %}
                    <label class="option-label" for="{{ option_id }}">
                      <input type="radio"
                             id="{{ option_id }}"
                             name="answer_{{ exercise_idx }}"
                             value="{{ option }}"
                             class="option-input"
                             {% if prev_answer == option or prev_answer == loop.index0|string %}checked{% endif %}
                             {% if is_completed %}disabled{% endif %}>
                      <span class="option-content">
                        <span class="option-marker"></span>
                        <span class="option-text">{{ option }}</span>
                      </span>
                    </label>
                  {% endfor %}
                </div>

              {% elif exercise.type == 'true_false' %}
                <p class="exercise-prompt">{{ exercise.question or exercise.prompt or exercise.text }}</p>
                <div class="answer-options binary">
                  {% set exercise_idx = loop.index0 %}
                  {% set prev_answer = previous_feedback.get(exercise_idx|string, {}).get('user_answer', '') %}
                  <label class="option-label binary-option" for="q{{ exercise_idx }}_true">
                    <input type="radio"
                           id="q{{ exercise_idx }}_true"
                           name="answer_{{ exercise_idx }}"
                           value="true"
                           class="option-input"
                           {% if prev_answer == 'true' %}checked{% endif %}
                           {% if is_completed %}disabled{% endif %}>
                    <span class="option-content">
                      <span class="option-marker"></span>
                      <span class="option-text">{{ _('Верно') }}</span>
                    </span>
                  </label>
                  <label class="option-label binary-option" for="q{{ exercise_idx }}_false">
                    <input type="radio"
                           id="q{{ exercise_idx }}_false"
                           name="answer_{{ exercise_idx }}"
                           value="false"
                           class="option-input"
                           {% if prev_answer == 'false' %}checked{% endif %}
                           {% if is_completed %}disabled{% endif %}>
                    <span class="option-content">
                      <span class="option-marker"></span>
                      <span class="option-text">{{ _('Неверно') }}</span>
                    </span>
                  </label>
                </div>
                
              {% elif exercise.type == 'reorder' %}
                <p class="exercise-prompt">{{ exercise.text or exercise.prompt }}</p>
                {% if exercise.words %}
                  {% set prev_answer = previous_feedback.get(loop.index0|string, {}).get('user_answer', '') %}
                  <div class="reorder-exercise" data-exercise-index="{{ loop.index0 }}">
                    <small class="text-muted">{{ _('Кликайте на слова для составления предложения:') }}</small>
                    <div class="word-chips available-words mt-2" id="available-words-{{ loop.index0 }}">
                      {% for word in exercise.words %}
                        <button type="button" 
                                class="word-chip"
                                data-word="{{ word }}"
                                {% if is_completed %}disabled{% endif %}>
                          {{ word }}
                        </button>
                      {% endfor %}
                    </div>
                    
                    <div class="selected-words-container mt-3">
                      <small class="text-muted">{{ _('Ваше предложение:') }}</small>
                      <div class="selected-words" id="selected-words-{{ loop.index0 }}">
                        <!-- Selected words will appear here -->
                      </div>
                    </div>
                    
                    <input type="hidden"
                           name="answer_{{ loop.index0 }}"
                           id="answer_{{ loop.index0 }}"
                           value="{{ prev_answer }}">
                    
                    {% if not is_completed %}
                      <button type="button" 
                              class="btn btn-sm btn-outline-secondary mt-2"
                              onclick="clearReorderExercise({{ loop.index0 }})">
                        <i class="fas fa-undo"></i> {{ _('Очистить') }}
                      </button>
                    {% else %}
                      <!-- Show the answer for completed lessons -->
                      {% if prev_answer %}
                        <div class="mt-2 text-muted">
                          <small>{{ _('Ваш ответ:') }} <strong>{{ prev_answer }}</strong></small>
                        </div>
                      {% endif %}
                    {% endif %}
                  </div>
                {% else %}
                  <!-- Fallback to text input if no words provided -->
                  <div class="answer-input">
                    {% set prev_answer = previous_feedback.get(loop.index0|string, {}).get('user_answer', '') %}
                    <input type="text"
                           class="form-control"
                           name="answer_{{ loop.index0 }}"
                           id="answer_{{ loop.index0 }}"
                           placeholder="{{ _('Составьте предложение') }}"
                           autocomplete="off"
                           value="{{ prev_answer }}"
                           {% if is_completed %}readonly{% endif %}>
                  </div>
                {% endif %}
                
              {% elif exercise.type == 'match' %}
                <p class="exercise-prompt">{{ exercise.text or exercise.prompt or _('Соедините пары') }}</p>
                <div class="match-exercise">
                  <p class="text-info"><small>{{ _('Функция сопоставления пар в разработке. Пожалуйста, используйте другие упражнения.') }}</small></p>
                </div>
              {% endif %}

              <!-- Обратная связь -->
              <div class="exercise-feedback" id="feedback-{{ loop.index0 }}"
                   {% if not is_completed or not previous_feedback.get(loop.index0|string) %}style="display: none;"{% endif %}>
                {% if is_completed and previous_feedback.get(loop.index0|string) %}
                  {% set feedback_item = previous_feedback.get(loop.index0|string) %}
                  {% if feedback_item.status == 'correct' %}
                    <div class="feedback-message feedback-correct">
                      <i class="fas fa-check-circle"></i>
                      <div>
                        <p>{{ feedback_item.message }}</p>
                        {% if exercise.explanation %}
                          <p class="explanation"><strong>{{ _('Пояснение:') }}</strong> {{ exercise.explanation }}</p>
                        {% endif %}
                        {% if exercise.alternative_answers %}
                          <p class="alternative_answers"><strong>{{ _('Дополнительные варианты ответа:') }}</strong> {{ exercise.alternative_answers }}</p>
                        {% endif %}
                      </div>
                    </div>
                  {% else %}
                    <div class="feedback-message feedback-incorrect">
                      <i class="fas fa-times-circle"></i>
                      <div>
                        <p>{{ feedback_item.message }}</p>
                        {% if exercise.explanation %}
                          <p class="explanation"><strong>{{ _('Объяснение:') }}</strong> {{ exercise.explanation }}</p>
                        {% endif %}
                      </div>
                    </div>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </form>

      <div class="exercises-actions">
        {% if not is_completed %}
          <button type="button" class="btn btn-primary btn-lg" id="check-btn" onclick="checkAnswers()">
            <i class="fas fa-check"></i> {{ _('Проверить ответы') }}
          </button>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

<script>
// Функция retryLesson перенесена в базовый шаблон

// Глобальная переменная для упражнений
const exercises = {{ exercises|tojson|safe }};

function checkAnswers() {
  let allAnswered = true;

  exercises.forEach((exercise, index) => {
    const answerInput = document.querySelector(`[name="answer_${index}"]`);
    let userAnswer = null;

    if (exercise.type === 'fill-blank' || exercise.type === 'fill_in_blank' || exercise.type === 'translation' || exercise.type === 'reorder') {
      userAnswer = answerInput.value.trim();
    } else {
      const checked = document.querySelector(`[name="answer_${index}"]:checked`);
      userAnswer = checked ? checked.value : null;
    }

    if (!userAnswer) {
      allAnswered = false;
      markExerciseEmpty(index);
    }
  });

  if (!allAnswered) {
    showNotification('{{ _("Пожалуйста, ответьте на все вопросы") }}', 'warning');
    return;
  }

  submitResults();
}

function markExerciseEmpty(index) {
  const exerciseEl = document.querySelector(`[data-index="${index}"]`);
  exerciseEl.classList.add('empty');
  exerciseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function submitResults() {
  const formData = new FormData(document.getElementById('grammarForm'));
  const csrfToken = document.querySelector('meta[name="csrf-token"]');
  if (csrfToken) {
    formData.append('csrf_token', csrfToken.content);
  }

  const checkBtn = document.getElementById('check-btn');
  checkBtn.disabled = true;
  checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {{ _("Проверка...") }}';

  fetch(window.location.href, {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    // Check if response is ok and has JSON content-type
    const contentType = response.headers.get("content-type");
    if (response.status === 401) {
      throw new Error("Authentication required. Please log in again.");
    }
    if (response.status === 400 && contentType && contentType.includes("application/json")) {
      // Try to parse JSON error (might be CSRF error)
      return response.json().then(data => {
        throw new Error(data.error || "Bad request");
      });
    }
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    if (!contentType || !contentType.includes("application/json")) {
      throw new Error("Server returned non-JSON response");
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      const feedback = data.feedback || {};
      Object.keys(feedback).forEach(index => {
        const exerciseData = feedback[index];
        const statusEl = document.getElementById(`status-${index}`);
        const feedbackEl = document.getElementById(`feedback-${index}`);
        const exerciseEl = document.querySelector(`[data-index="${index}"]`);

        if (exerciseData.status === 'correct') {
          statusEl.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
          
          // Получаем объяснение из упражнения
          const exercise = exercises[parseInt(index)];
          let explanationHtml = '';
          if (exercise && exercise.explanation) {
            explanationHtml = `<p class="explanation"><strong>{{ _('Пояснение:') }}</strong> ${exercise.explanation}</p>`;
          }
          if (exercise && exercise.alternative_answers) {
            explanationHtml = `<p class="alternative_answers"><strong>{{ _('Дополнительные варианты ответа:') }}</strong> ${exercise.alternative_answers}</p>`;
          }

          feedbackEl.innerHTML = `
            <div class="feedback-message feedback-correct">
              <i class="fas fa-check-circle"></i>
              <div>
                <p>{{ _('Правильно!') }}</p>
                ${explanationHtml}
              </div>
            </div>
          `;
          exerciseEl.classList.add('correct');
        } else {
          statusEl.innerHTML = '<i class="fas fa-times-circle text-danger"></i>';
          
          // Получаем объяснение из упражнения
          const exercise = exercises[parseInt(index)];
          let explanationHtml = '';
          if (exercise && exercise.explanation) {
            explanationHtml = `<p class="explanation"><strong>{{ _('Объяснение:') }}</strong> ${exercise.explanation}</p>`;
          }
          
          feedbackEl.innerHTML = `
            <div class="feedback-message feedback-incorrect">
              <i class="fas fa-times-circle"></i>
              <div>
                <p>${exerciseData.message}</p>
                ${explanationHtml}
              </div>
            </div>
          `;
          exerciseEl.classList.add('incorrect');
        }

        feedbackEl.style.display = 'block';
        exerciseEl.classList.remove('empty');
      });

      checkBtn.style.display = 'none';
      
      // Показываем результаты и кнопки навигации
      showResultsAndNavigation(data);
    }
  })
  .catch(error => {
    console.error('Error submitting grammar exercise:', error);
    
    // More detailed error message
    let errorMessage = '{{ _("Ошибка при сохранении результатов") }}';
    if (error.message.includes('Authentication required')) {
      errorMessage = '{{ _("Требуется авторизация. Пожалуйста, войдите в систему заново.") }}';
      // Optionally redirect to login after a delay
      setTimeout(() => {
        window.location.href = '{{ url_for("auth.login", next=request.url) }}';
      }, 2000);
    } else if (error.message.includes('CSRF token')) {
      errorMessage = '{{ _("Ошибка безопасности. Пожалуйста, обновите страницу и попробуйте снова.") }}';
    } else if (error.message.includes('non-JSON response')) {
      errorMessage = '{{ _("Ошибка: сервер вернул некорректный ответ. Попробуйте обновить страницу.") }}';
      console.error('The server returned HTML instead of JSON. This might be due to:');
      console.error('1. Authentication issue - you might need to log in again');
      console.error('2. CSRF token issue - the token might be invalid');
      console.error('3. Server error - check server logs');
    } else if (error.message.includes('HTTP error')) {
      errorMessage = `{{ _("Ошибка сервера") }}: ${error.message}`;
    }
    
    showNotification(errorMessage, 'error');
    checkBtn.disabled = false;
    checkBtn.innerHTML = '<i class="fas fa-check"></i> {{ _("Проверить ответы") }}';
  });
}

function showResultsAndNavigation(data) {
  // Удаляем предыдущий блок результатов, если есть
  const existingResults = document.querySelector('.exercise-results');
  if (existingResults) {
    existingResults.remove();
  }
  
  // Создаем блок с результатами
  const resultsDiv = document.createElement('div');
  resultsDiv.className = 'exercise-results mt-4';
  
  const score = data.score || 0;
  const correctCount = data.correct_answers || 0;
  const totalCount = data.total_count || 0;
  const isPassed = score >= 70;
  
  resultsDiv.innerHTML = `
    <div class="results-summary ${isPassed ? 'success' : 'warning'}">
      <h3>{{ _('Результаты упражнений') }}</h3>
      <div class="score-display">
        <i class="fas fa-${isPassed ? 'check' : 'exclamation'}-circle"></i>
        <span class="score-value">${Math.round(score)}%</span>
      </div>
      <p class="score-details">
        {{ _('Правильно') }}: ${correctCount} {{ _('из') }} ${totalCount}
      </p>
      ${!isPassed ? `
        <div class="feedback-message">
          <i class="fas fa-info-circle"></i>
          <p>{{ _('Изучите свои ошибки выше. Вы можете попробовать еще раз или продолжить дальше.') }}</p>
        </div>
      ` : `
        <div class="feedback-message success">
          <i class="fas fa-trophy"></i>
          <p>{{ _('Отличная работа! Вы успешно выполнили все упражнения.') }}</p>
        </div>
      `}
    </div>
  `;
  
  // Добавляем результаты в конец страницы, перед lesson-footer
  const lessonContent = document.querySelector('.lesson-content') || document.querySelector('.lesson-content-wrapper') || document.querySelector('.grammar-lesson');
  const lessonFooter = document.querySelector('.lesson-footer') || document.querySelector('#lesson-footer');
  
  if (lessonContent) {
    if (lessonFooter) {
      lessonContent.insertBefore(resultsDiv, lessonFooter);
    } else {
      lessonContent.appendChild(resultsDiv);
    }
  } else {
    // Fallback: добавляем в конец body
    console.warn('Could not find lesson content container, appending to body');
    document.body.appendChild(resultsDiv);
  }
  
  // Прокручиваем к результатам
  resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  
  // Показываем кнопки навигации с задержкой для обеспечения готовности DOM
  setTimeout(() => {
    const retryBtn = document.getElementById('retry-button');
    const nextBtn = document.getElementById('complete-exercise');
    const completeModuleBtn = document.getElementById('complete-module');
    
    // Показываем кнопку "Пройти заново"
    if (retryBtn) {
      retryBtn.style.display = 'inline-flex';
    } else {
      console.error('Retry button not found in DOM');
    }
    
    // Показываем кнопку "Далее" или "Завершить модуль" всегда после проверки
    if (nextBtn) {
      nextBtn.style.display = 'inline-flex';
      nextBtn.disabled = false;
    } else if (completeModuleBtn) {
      completeModuleBtn.style.display = 'inline-flex';
      completeModuleBtn.disabled = false;
    } else {
      console.error('Navigation buttons not found in DOM');
    }
    
    // Принудительная перерисовка для обеспечения видимости кнопок
    const footer = document.getElementById('lesson-footer');
    if (footer) {
      footer.style.display = 'none';
      footer.offsetHeight; // Force reflow
      footer.style.display = '';
    }
  }, 100); // Небольшая задержка для обеспечения готовности DOM
}

function completeAndReturn() {
  // Отмечаем урок как завершенный и возвращаемся к модулю
  const completeBtn = document.getElementById('complete-exercise');
  if (completeBtn) {
    completeBtn.click();
  } else {
    window.location.href = '/learn/';
  }
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <i class="fas fa-${type === 'error' ? 'exclamation' : type === 'warning' ? 'exclamation-triangle' : 'info'}-circle"></i>
    <span>${message}</span>
  `;
  document.body.appendChild(notification);

  setTimeout(() => notification.classList.add('show'), 10);
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Инициализация reorder упражнений
function initializeReorderExercises() {
  exercises.forEach((exercise, index) => {
    if (exercise.type === 'reorder') {
      const availableWordsEl = document.getElementById(`available-words-${index}`);
      const selectedWordsEl = document.getElementById(`selected-words-${index}`);
      const answerInput = document.getElementById(`answer_${index}`);
      
      if (!availableWordsEl || !selectedWordsEl) return;
      
      // Добавляем placeholder
      selectedWordsEl.setAttribute('data-placeholder', '{{ _("Кликните на слова выше") }}');
      
      // Если есть предыдущий ответ, восстанавливаем его
      if (answerInput.value) {
        const words = answerInput.value.split(' ');
        words.forEach(word => {
          const chip = availableWordsEl.querySelector(`[data-word="${word}"]:not(.used)`);
          if (chip) {
            chip.classList.add('used');
            addWordToSelected(index, word);
          }
        });
      }
      
      // Обработчики кликов на доступные слова
      availableWordsEl.querySelectorAll('.word-chip').forEach(chip => {
        chip.addEventListener('click', function() {
          if (this.classList.contains('used') || this.disabled) return;
          
          const word = this.getAttribute('data-word');
          this.classList.add('used');
          addWordToSelected(index, word);
          updateReorderAnswer(index);
        });
      });
    }
  });
}

function addWordToSelected(exerciseIndex, word) {
  const selectedWordsEl = document.getElementById(`selected-words-${exerciseIndex}`);
  
  const selectedWord = document.createElement('span');
  selectedWord.className = 'selected-word';
  selectedWord.innerHTML = `
    ${word}
    <span class="remove-word" onclick="removeSelectedWord(${exerciseIndex}, '${word}', this.parentElement)">×</span>
  `;
  
  selectedWordsEl.appendChild(selectedWord);
}

function removeSelectedWord(exerciseIndex, word, element) {
  // Удаляем слово из выбранных
  element.remove();
  
  // Возвращаем слово в доступные
  const availableWordsEl = document.getElementById(`available-words-${exerciseIndex}`);
  const chip = availableWordsEl.querySelector(`[data-word="${word}"]`);
  if (chip) {
    chip.classList.remove('used');
  }
  
  updateReorderAnswer(exerciseIndex);
}

function updateReorderAnswer(exerciseIndex) {
  const selectedWordsEl = document.getElementById(`selected-words-${exerciseIndex}`);
  const answerInput = document.getElementById(`answer_${exerciseIndex}`);
  
  const words = [];
  selectedWordsEl.querySelectorAll('.selected-word').forEach(el => {
    const word = el.textContent.trim().replace('×', '').trim();
    words.push(word);
  });
  
  answerInput.value = words.join(' ');
}

function clearReorderExercise(exerciseIndex) {
  const availableWordsEl = document.getElementById(`available-words-${exerciseIndex}`);
  const selectedWordsEl = document.getElementById(`selected-words-${exerciseIndex}`);
  const answerInput = document.getElementById(`answer_${exerciseIndex}`);
  
  // Очищаем выбранные слова
  selectedWordsEl.innerHTML = '';
  
  // Возвращаем все слова в доступные
  availableWordsEl.querySelectorAll('.word-chip').forEach(chip => {
    chip.classList.remove('used');
  });
  
  // Очищаем ответ
  answerInput.value = '';
}

// Auto-complete theory-only lesson (without exercises)
async function autoCompleteTheoryLesson() {
  const csrfToken = document.querySelector('meta[name="csrf-token"]');

  try {
    const response = await fetch('{{ url_for("curriculum_lessons.update_lesson_progress", lesson_id=lesson.id) }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken ? csrfToken.content : ''
      },
      body: JSON.stringify({
        score: 100,
        status: 'completed',
        data: {
          theory_studied: true
        }
      })
    });

    const data = await response.json();

    if (data.success) {
      // Show navigation buttons
      const nextBtn = document.getElementById('complete-exercise');
      const completeModuleBtn = document.getElementById('complete-module');

      if (nextBtn) {
        nextBtn.style.display = 'inline-flex';
        nextBtn.disabled = false;
      } else if (completeModuleBtn) {
        completeModuleBtn.style.display = 'inline-flex';
        completeModuleBtn.disabled = false;
      }
    }
  } catch (error) {
    console.error('Error completing lesson:', error);
  }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  // Инициализируем reorder упражнения
  initializeReorderExercises();

  // Для уроков без упражнений автоматически завершаем урок и показываем кнопки
  {% if not exercises and not is_completed %}
    autoCompleteTheoryLesson();
  {% endif %}

  // Для завершенных уроков показываем кнопки навигации сразу
  {% if is_completed %}
    const retryBtn = document.getElementById('retry-button');
    const nextBtn = document.getElementById('complete-exercise');
    const completeModuleBtn = document.getElementById('complete-module');

    if (retryBtn) {
      retryBtn.style.display = 'inline-flex';
    }

    if (nextBtn) {
      nextBtn.style.display = 'inline-flex';
      nextBtn.disabled = false;
    } else if (completeModuleBtn) {
      completeModuleBtn.style.display = 'inline-flex';
      completeModuleBtn.disabled = false;
    }
  {% endif %}
});
</script>
{% endblock %}

